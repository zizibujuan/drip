//>>built
define("dojo/back",["./_base/config","./_base/lang","./sniff","./dom","./dom-construct","./_base/window","require"],function(config,lang,has,dom,domConstruct,baseWindow,require){function handleBackButton(){var current=historyStack.pop();if(!current)return;var last=historyStack[historyStack.length-1];!last&&historyStack.length==0&&(last=initialState),last&&(last.kwArgs.back?last.kwArgs.back():last.kwArgs.backButton?last.kwArgs.backButton():last.kwArgs.handle&&last.kwArgs.handle("back")),forwardStack.push(current)}function handleForwardButton(){var last=forwardStack.pop();if(!last)return;last.kwArgs.forward?last.kwArgs.forward():last.kwArgs.forwardButton?last.kwArgs.forwardButton():last.kwArgs.handle&&last.kwArgs.handle("forward"),historyStack.push(last)}function createState(url,args,hash){return{url:url,kwArgs:args,urlHash:hash}}function getUrlQuery(url){var segments=url.split("?");return segments.length<2?null:segments[1]}function loadIframeHistory(){var url=(config.dojoIframeHistoryUrl||require.toUrl("./resources/iframe_history.html"))+"?"+(new Date).getTime();return moveForward=!0,historyIframe&&(has("webkit")?historyIframe.location=url:window.frames[historyIframe.name].location=url),url}function checkLocation(){if(!changingUrl){var hsl=historyStack.length,hash=getHash();if((hash===initialHash||window.location.href==initialHref)&&hsl==1){handleBackButton();return}if(forwardStack.length>0&&forwardStack[forwardStack.length-1].urlHash===hash){handleForwardButton();return}hsl>=2&&historyStack[hsl-2]&&historyStack[hsl-2].urlHash===hash&&handleBackButton()}}var back={};lang.setObject("dojo.back",back);var getHash=back.getHash=function(){var h=window.location.hash;return h.charAt(0)=="#"&&(h=h.substring(1)),has("mozilla")?h:decodeURIComponent(h)},setHash=back.setHash=function(h){h||(h=""),window.location.hash=encodeURIComponent(h),historyCounter=history.length},initialHref=typeof window!="undefined"?window.location.href:"",initialHash=typeof window!="undefined"?getHash():"",initialState=null,locationTimer=null,bookmarkAnchor=null,historyIframe=null,forwardStack=[],historyStack=[],moveForward=!1,changingUrl=!1,historyCounter;return back.goBack=handleBackButton,back.goForward=handleForwardButton,back.init=function(){if(dom.byId("dj_history"))return;var src=config.dojoIframeHistoryUrl||require.toUrl("./resources/iframe_history.html");config.afterOnLoad?0:document.write('<iframe style="border:0;width:1px;height:1px;position:absolute;visibility:hidden;bottom:0;right:0;" name="dj_history" id="dj_history" src="'+src+'"></iframe>')},back.setInitialState=function(args){initialState=createState(initialHref,args,initialHash)},back.addToHistory=function(args){forwardStack=[];var hash=null,url=null;historyIframe||(config.useXDomain&&!config.dojoIframeHistoryUrl&&0,historyIframe=window.frames.dj_history),bookmarkAnchor||(bookmarkAnchor=domConstruct.create("a",{style:{display:"none"}},baseWindow.body()));if(args.changeUrl){hash=""+(args.changeUrl!==!0?args.changeUrl:(new Date).getTime());if(historyStack.length==0&&initialState.urlHash==hash){initialState=createState(url,args,hash);return}if(historyStack.length>0&&historyStack[historyStack.length-1].urlHash==hash){historyStack[historyStack.length-1]=createState(url,args,hash);return}changingUrl=!0,setTimeout(function(){setHash(hash),changingUrl=!1},1),bookmarkAnchor.href=hash;if(has("ie")){url=loadIframeHistory();var oldCB=args.back||args.backButton||args.handle,tcb=function(handleName){getHash()!=""&&setTimeout(function(){setHash(hash)},1),oldCB.apply(this,[handleName])};args.back?args.back=tcb:args.backButton?args.backButton=tcb:args.handle&&(args.handle=tcb);var oldFW=args.forward||args.forwardButton||args.handle,tfw=function(handleName){getHash()!=""&&setHash(hash),oldFW&&oldFW.apply(this,[handleName])};args.forward?args.forward=tfw:args.forwardButton?args.forwardButton=tfw:args.handle&&(args.handle=tfw)}else has("ie")||locationTimer||(locationTimer=setInterval(checkLocation,200))}else url=loadIframeHistory();historyStack.push(createState(url,args,hash))},back._iframeLoaded=function(evt,ifrLoc){var query=getUrlQuery(ifrLoc.href);if(query==null){historyStack.length==1&&handleBackButton();return}if(moveForward){moveForward=!1;return}historyStack.length>=2&&query==getUrlQuery(historyStack[historyStack.length-2].url)?handleBackButton():forwardStack.length>0&&query==getUrlQuery(forwardStack[forwardStack.length-1].url)&&handleForwardButton()},back})