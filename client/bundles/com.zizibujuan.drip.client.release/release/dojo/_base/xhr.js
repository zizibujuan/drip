//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(dojo,has,require,ioq,dom,domForm,Deferred,config,json,lang,array,on,aspect,watch,_xhr,util){dojo._xhrObj=_xhr._create;var cfg=dojo.config;dojo.objectToQuery=ioq.objectToQuery,dojo.queryToObject=ioq.queryToObject,dojo.fieldToObject=domForm.fieldToObject,dojo.formToObject=domForm.toObject,dojo.formToQuery=domForm.toQuery,dojo.formToJson=domForm.toJson,dojo._blockAsync=!1;var handlers=dojo._contentHandlers=dojo.contentHandlers={text:function(xhr){return xhr.responseText},json:function(xhr){return json.fromJson(xhr.responseText||null)},"json-comment-filtered":function(xhr){config.useCommentedJson||0;var value=xhr.responseText,cStartIdx=value.indexOf("/*"),cEndIdx=value.lastIndexOf("*/");if(cStartIdx==-1||cEndIdx==-1)throw new Error("JSON was not comment filtered");return json.fromJson(value.substring(cStartIdx+2,cEndIdx))},javascript:function(xhr){return dojo.eval(xhr.responseText)},xml:function(xhr){var result=xhr.responseXML;if(has("ie"))if(!result||!result.documentElement){var ms=function(n){return"MSXML"+n+".DOMDocument"},dp=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)];array.some(dp,function(p){try{var dom=new ActiveXObject(p);dom.async=!1,dom.loadXML(xhr.responseText),result=dom}catch(e){return!1}return!0})}return result},"json-comment-optional":function(xhr){return xhr.responseText&&/^[^{\[]*\/\*/.test(xhr.responseText)?handlers["json-comment-filtered"](xhr):handlers.json(xhr)}};dojo._ioSetArgs=function(args,canceller,okHandler,errHandler){var ioArgs={args:args,url:args.url},formObject=null;if(args.form){var form=dom.byId(args.form),actnNode=form.getAttributeNode("action");ioArgs.url=ioArgs.url||(actnNode?actnNode.value:null),formObject=domForm.toObject(form)}var miArgs=[{}];formObject&&miArgs.push(formObject),args.content&&miArgs.push(args.content),args.preventCache&&miArgs.push({"dojo.preventCache":(new Date).valueOf()}),ioArgs.query=ioq.objectToQuery(lang.mixin.apply(null,miArgs)),ioArgs.handleAs=args.handleAs||"text";var d=new Deferred(function(dfd){dfd.canceled=!0,canceller&&canceller(dfd);var err=dfd.ioArgs.error;return err||(err=new Error("request cancelled"),err.dojoType="cancel",dfd.ioArgs.error=err),err});d.addCallback(okHandler);var ld=args.load;ld&&lang.isFunction(ld)&&d.addCallback(function(value){return ld.call(args,value,ioArgs)});var err=args.error;err&&lang.isFunction(err)&&d.addErrback(function(value){return err.call(args,value,ioArgs)});var handle=args.handle;return handle&&lang.isFunction(handle)&&d.addBoth(function(value){return handle.call(args,value,ioArgs)}),d.addErrback(function(error){return errHandler(error,d)}),cfg.ioPublish&&dojo.publish&&ioArgs.args.ioPublish!==!1&&(d.addCallbacks(function(res){return dojo.publish("/dojo/io/load",[d,res]),res},function(res){return dojo.publish("/dojo/io/error",[d,res]),res}),d.addBoth(function(res){return dojo.publish("/dojo/io/done",[d,res]),res})),d.ioArgs=ioArgs,d};var _deferredOk=function(dfd){var ret=handlers[dfd.ioArgs.handleAs](dfd.ioArgs.xhr);return ret===undefined?null:ret},_deferError=function(error,dfd){return dfd.ioArgs.args.failOk||0,error},_checkPubCount=function(dfd){_pubCount<=0&&(_pubCount=0,cfg.ioPublish&&dojo.publish&&(!dfd||dfd&&dfd.ioArgs.args.ioPublish!==!1)&&dojo.publish("/dojo/io/stop"))},_pubCount=0;aspect.after(watch,"_onAction",function(){_pubCount-=1}),aspect.after(watch,"_onInFlight",_checkPubCount),dojo._ioCancelAll=watch.cancelAll,dojo._ioNotifyStart=function(dfd){cfg.ioPublish&&dojo.publish&&dfd.ioArgs.args.ioPublish!==!1&&(_pubCount||dojo.publish("/dojo/io/start"),_pubCount+=1,dojo.publish("/dojo/io/send",[dfd]))},dojo._ioWatch=function(dfd,validCheck,ioCheck,resHandle){var args=dfd.ioArgs.options=dfd.ioArgs.args;lang.mixin(dfd,{response:dfd.ioArgs,isValid:function(response){return validCheck(dfd)},isReady:function(response){return ioCheck(dfd)},handleResponse:function(response){return resHandle(dfd)}}),watch(dfd),_checkPubCount(dfd)};var _defaultContentType="application/x-www-form-urlencoded";return dojo._ioAddQueryToUrl=function(ioArgs){ioArgs.query.length&&(ioArgs.url+=(ioArgs.url.indexOf("?")==-1?"?":"&")+ioArgs.query,ioArgs.query=null)},dojo.xhr=function(method,args,hasBody){var rDfd,dfd=dojo._ioSetArgs(args,function(dfd){rDfd&&rDfd.cancel()},_deferredOk,_deferError),ioArgs=dfd.ioArgs;"postData"in args?ioArgs.query=args.postData:"putData"in args?ioArgs.query=args.putData:"rawBody"in args?ioArgs.query=args.rawBody:(arguments.length>2&&!hasBody||"POST|PUT".indexOf(method.toUpperCase())===-1)&&dojo._ioAddQueryToUrl(ioArgs);var options={method:method,handleAs:"text",timeout:args.timeout,withCredentials:args.withCredentials,ioArgs:ioArgs};typeof args.headers!="undefined"&&(options.headers=args.headers),typeof args.contentType!="undefined"&&(options.headers||(options.headers={}),options.headers["Content-Type"]=args.contentType),typeof ioArgs.query!="undefined"&&(options.data=ioArgs.query),typeof args.sync!="undefined"&&(options.sync=args.sync),dojo._ioNotifyStart(dfd);try{rDfd=_xhr(ioArgs.url,options,!0)}catch(e){return dfd.cancel(),dfd}return dfd.ioArgs.xhr=rDfd.response.xhr,rDfd.then(function(){dfd.resolve(dfd)}).otherwise(function(error){ioArgs.error=error,error.response&&(error.status=error.response.status,error.responseText=error.response.text,error.xhr=error.response.xhr),dfd.reject(error)}),dfd},dojo.xhrGet=function(args){return dojo.xhr("GET",args)},dojo.rawXhrPost=dojo.xhrPost=function(args){return dojo.xhr("POST",args,!0)},dojo.rawXhrPut=dojo.xhrPut=function(args){return dojo.xhr("PUT",args,!0)},dojo.xhrDelete=function(args){return dojo.xhr("DELETE",args)},dojo._isDocumentOk=function(x){return util.checkStatus(x.status)},dojo._getText=function(url){var result;return dojo.xhrGet({url:url,sync:!0,load:function(text){result=text}}),result},lang.mixin(dojo.xhr,{_xhrObj:dojo._xhrObj,fieldToObject:domForm.fieldToObject,formToObject:domForm.toObject,objectToQuery:ioq.objectToQuery,formToQuery:domForm.toQuery,formToJson:domForm.toJson,queryToObject:ioq.queryToObject,contentHandlers:handlers,_ioSetArgs:dojo._ioSetArgs,_ioCancelAll:dojo._ioCancelAll,_ioNotifyStart:dojo._ioNotifyStart,_ioWatch:dojo._ioWatch,_ioAddQueryToUrl:dojo._ioAddQueryToUrl,_isDocumentOk:dojo._isDocumentOk,_getText:dojo._getText,get:dojo.xhrGet,post:dojo.xhrPost,put:dojo.xhrPut,del:dojo.xhrDelete}),dojo.xhr})