//>>built
define("dojo/dnd/Source",["../_base/array","../_base/declare","../_base/kernel","../_base/lang","../dom-class","../dom-geometry","../mouse","../ready","../topic","./common","./Selector","./Manager"],function(array,declare,kernel,lang,domClass,domGeom,mouse,ready,topic,dnd,Selector,Manager){kernel.isAsync||ready(0,function(){var requires=["dojo/dnd/AutoSource","dojo/dnd/Target"];require(requires)});var Source=declare("dojo.dnd.Source",Selector,{isSource:!0,horizontal:!1,copyOnly:!1,selfCopy:!1,selfAccept:!0,skipForm:!1,withHandles:!1,autoSync:!1,delay:0,accept:["text"],generateText:!0,constructor:function(node,params){lang.mixin(this,lang.mixin({},params));var type=this.accept;if(type.length){this.accept={};for(var i=0;i<type.length;++i)this.accept[type[i]]=1}this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.before=!0,this._lastX=0,this._lastY=0,this.sourceState="",this.isSource&&domClass.add(this.node,"dojoDndSource"),this.targetState="",this.accept&&domClass.add(this.node,"dojoDndTarget"),this.horizontal&&domClass.add(this.node,"dojoDndHorizontal"),this.topics=[topic.subscribe("/dnd/source/over",lang.hitch(this,"onDndSourceOver")),topic.subscribe("/dnd/start",lang.hitch(this,"onDndStart")),topic.subscribe("/dnd/drop",lang.hitch(this,"onDndDrop")),topic.subscribe("/dnd/cancel",lang.hitch(this,"onDndCancel"))]},checkAcceptance:function(source,nodes){if(this==source)return!this.copyOnly||this.selfAccept;for(var i=0;i<nodes.length;++i){var type=source.getItem(nodes[i].id).type,flag=!1;for(var j=0;j<type.length;++j)if(type[j]in this.accept){flag=!0;break}if(!flag)return!1}return!0},copyState:function(keyPressed,self){return keyPressed?!0:(arguments.length<2&&(self=this==Manager.manager().target),self?this.copyOnly?this.selfCopy:!1:this.copyOnly)},destroy:function(){Source.superclass.destroy.call(this),array.forEach(this.topics,function(t){t.remove()}),this.targetAnchor=null},onMouseMove:function(e){if(this.isDragging&&this.targetState=="Disabled")return;Source.superclass.onMouseMove.call(this,e);var m=Manager.manager();if(!this.isDragging&&this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>this.delay||Math.abs(e.pageY-this._lastY)>this.delay)){var nodes=this.getSelectedNodes();nodes.length&&m.startDrag(this,nodes,this.copyState(dnd.getCopyKeyState(e),!0))}if(this.isDragging){var before=!1;if(this.current){if(!this.targetBox||this.targetAnchor!=this.current)this.targetBox=domGeom.position(this.current,!0);this.horizontal?before=e.pageX-this.targetBox.x<this.targetBox.w/2==domGeom.isBodyLtr(this.current.ownerDocument):before=e.pageY-this.targetBox.y<this.targetBox.h/2}if(this.current!=this.targetAnchor||before!=this.before)this._markTargetAnchor(before),m.canDrop(!this.current||m.source!=this||!(this.current.id in this.selection))}},onMouseDown:function(e){!this.mouseDown&&this._legalMouseDown(e)&&(!this.skipForm||!dnd.isFormElement(e))&&(this.mouseDown=!0,this._lastX=e.pageX,this._lastY=e.pageY,Source.superclass.onMouseDown.call(this,e))},onMouseUp:function(e){this.mouseDown&&(this.mouseDown=!1,Source.superclass.onMouseUp.call(this,e))},onDndSourceOver:function(source){if(this!==source)this.mouseDown=!1,this.targetAnchor&&this._unmarkTargetAnchor();else if(this.isDragging){var m=Manager.manager();m.canDrop(this.targetState!="Disabled"&&(!this.current||m.source!=this||!(this.current.id in this.selection)))}},onDndStart:function(source,nodes,copy){this.autoSync&&this.sync(),this.isSource&&this._changeState("Source",this==source?copy?"Copied":"Moved":"");var accepted=this.accept&&this.checkAcceptance(source,nodes);this._changeState("Target",accepted?"":"Disabled"),this==source&&Manager.manager().overSource(this),this.isDragging=!0},onDndDrop:function(source,nodes,copy,target){this==target&&this.onDrop(source,nodes,copy),this.onDndCancel()},onDndCancel:function(){this.targetAnchor&&(this._unmarkTargetAnchor(),this.targetAnchor=null),this.before=!0,this.isDragging=!1,this.mouseDown=!1,this._changeState("Source",""),this._changeState("Target","")},onDrop:function(source,nodes,copy){this!=source?this.onDropExternal(source,nodes,copy):this.onDropInternal(nodes,copy)},onDropExternal:function(source,nodes,copy){var oldCreator=this._normalizedCreator;this.creator?this._normalizedCreator=function(node,hint){return oldCreator.call(this,source.getItem(node.id).data,hint)}:copy?this._normalizedCreator=function(node){var t=source.getItem(node.id),n=node.cloneNode(!0);return n.id=dnd.getUniqueId(),{node:n,data:t.data,type:t.type}}:this._normalizedCreator=function(node){var t=source.getItem(node.id);return source.delItem(node.id),{node:node,data:t.data,type:t.type}},this.selectNone(),!copy&&!this.creator&&source.selectNone(),this.insertNodes(!0,nodes,this.before,this.current),!copy&&this.creator&&source.deleteSelectedNodes(),this._normalizedCreator=oldCreator},onDropInternal:function(nodes,copy){var oldCreator=this._normalizedCreator;if(this.current&&this.current.id in this.selection)return;if(copy)this.creator?this._normalizedCreator=function(node,hint){return oldCreator.call(this,this.getItem(node.id).data,hint)}:this._normalizedCreator=function(node){var t=this.getItem(node.id),n=node.cloneNode(!0);return n.id=dnd.getUniqueId(),{node:n,data:t.data,type:t.type}};else{if(!this.current)return;this._normalizedCreator=function(node){var t=this.getItem(node.id);return{node:node,data:t.data,type:t.type}}}this._removeSelection(),this.insertNodes(!0,nodes,this.before,this.current),this._normalizedCreator=oldCreator},onDraggingOver:function(){},onDraggingOut:function(){},onOverEvent:function(){Source.superclass.onOverEvent.call(this),Manager.manager().overSource(this),this.isDragging&&this.targetState!="Disabled"&&this.onDraggingOver()},onOutEvent:function(){Source.superclass.onOutEvent.call(this),Manager.manager().outSource(this),this.isDragging&&this.targetState!="Disabled"&&this.onDraggingOut()},_markTargetAnchor:function(before){if(this.current==this.targetAnchor&&this.before==before)return;this.targetAnchor&&this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=this.current,this.targetBox=null,this.before=before,this.targetAnchor&&this._addItemClass(this.targetAnchor,this.before?"Before":"After")},_unmarkTargetAnchor:function(){if(!this.targetAnchor)return;this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=null,this.targetBox=null,this.before=!0},_markDndStatus:function(copy){this._changeState("Source",copy?"Copied":"Moved")},_legalMouseDown:function(e){if(e.type!="touchstart"&&!mouse.isLeft(e))return!1;if(!this.withHandles)return!0;for(var node=e.target;node&&node!==this.node;node=node.parentNode){if(domClass.contains(node,"dojoDndHandle"))return!0;if(domClass.contains(node,"dojoDndItem")||domClass.contains(node,"dojoDndIgnore"))break}return!1}});return Source})