//>>built
define("dojo/request/iframe",["module","require","./watch","./util","./handlers","../_base/lang","../io-query","../query","../has","../dom","../dom-construct","../_base/window"],function(module,require,watch,util,handlers,lang,ioQuery,query,has,dom,domConstruct,win){function create(name,onloadstr,uri){if(win.global[name])return win.global[name];if(win.global.frames[name])return win.global.frames[name];uri||(has("config-useXDomain")&&!has("config-dojoBlankHtmlUrl")&&0,uri=has("config-dojoBlankHtmlUrl")||require.toUrl("dojo/resources/blank.html"));var frame=domConstruct.place('<iframe id="'+name+'" name="'+name+'" src="'+uri+'" onload="'+onloadstr+'" style="position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden">',win.body());return win.global[name]=frame,frame}function setSrc(_iframe,src,replace){var frame=win.global.frames[_iframe.name];frame.contentWindow&&(frame=frame.contentWindow);try{replace?frame.location.replace(src):frame.location=src}catch(e){0}}function doc(iframeNode){if(iframeNode.contentDocument)return iframeNode.contentDocument;var name=iframeNode.name;if(name){var iframes=win.doc.getElementsByTagName("iframe");if(iframeNode.document&&iframes[name].contentWindow&&iframes[name].contentWindow.document)return iframes[name].contentWindow.document;if(win.doc.frames[name]&&win.doc.frames[name].document)return win.doc.frames[name].document}return null}function createForm(){return domConstruct.create("form",{name:mid+"_form",style:{position:"absolute",top:"-1000px",left:"-1000px"}},win.body())}function fireNextRequest(){var dfd;try{if(iframe._currentDfd||!iframe._dfdQueue.length)return;do dfd=iframe._currentDfd=iframe._dfdQueue.shift();while(dfd&&(dfd.canceled||dfd.isCanceled&&dfd.isCanceled())&&iframe._dfdQueue.length);if(!dfd||dfd.canceled||dfd.isCanceled&&dfd.isCanceled()){iframe._currentDfd=null;return}var response=dfd.response,options=response.options,c2c=dfd._contentToClean=[],formNode=dom.byId(options.form),notify=util.notify,data=options.data||null,queryStr;!dfd._legacy&&options.method==="POST"&&!formNode?formNode=dfd._tmpForm=createForm():options.method==="GET"&&formNode&&response.url.indexOf("?")>-1&&(queryStr=response.url.slice(response.url.indexOf("?")+1),data=lang.mixin(ioQuery.queryToObject(queryStr),data));if(formNode){if(!dfd._legacy){var parentNode=formNode;do parentNode=parentNode.parentNode;while(parentNode!==win.doc.documentElement);parentNode||(formNode.style.position="absolute",formNode.style.left="-1000px",formNode.style.top="-1000px",win.body().appendChild(formNode)),formNode.name||(formNode.name=mid+"_form")}if(data){var createInput=function(name,value){domConstruct.create("input",{type:"hidden",name:name,value:value},formNode),c2c.push(name)};for(var x in data){var val=data[x];if(lang.isArray(val)&&val.length>1)for(var i=0;i<val.length;i++)createInput(x,val[i]);else formNode[x]?formNode[x].value=val:createInput(x,val)}}var actionNode=formNode.getAttributeNode("action"),methodNode=formNode.getAttributeNode("method"),targetNode=formNode.getAttributeNode("target");response.url&&(dfd._originalAction=actionNode?actionNode.value:null,actionNode?actionNode.value=response.url:formNode.setAttribute("action",response.url));if(!dfd._legacy)dfd._originalMethod=methodNode?methodNode.value:null,methodNode?methodNode.value=options.method:formNode.setAttribute("method",options.method);else if(!methodNode||!methodNode.value)mthdNode?mthdNode.value=options.method:fn.setAttribute("method",options.method);dfd._originalTarget=targetNode?targetNode.value:null,targetNode?targetNode.value=iframe._iframeName:formNode.setAttribute("target",iframe._iframeName),formNode.target=iframe._iframeName,notify&&notify.emit("send",response,dfd.promise.cancel),iframe._notifyStart(response),formNode.submit()}else{var extra="";response.options.data&&(extra=response.options.data,typeof extra!="string"&&(extra=ioQuery.objectToQuery(extra)));var tmpUrl=response.url+(response.url.indexOf("?")>-1?"&":"?")+extra;notify&&notify.emit("send",response,dfd.promise.cancel),iframe._notifyStart(response),iframe.setSrc(iframe._frame,tmpUrl,!0)}}catch(e){dfd.reject(e)}}function isValid(response){return!this.isFulfilled()}function isReady(response){return!!this._finished}function handleResponse(response,error){if(!error)try{var options=response.options,doc=iframe.doc(iframe._frame),handleAs=options.handleAs;if(handleAs!=="html"){if(handleAs==="xml")if(doc.documentElement.tagName.toLowerCase()==="html"){query("a",doc.documentElement).orphan();var xmlText=doc.documentElement.innerText;xmlText=xmlText.replace(/>\s+</g,"><"),response.text=lang.trim(xmlText)}else response.data=doc;else response.text=doc.getElementsByTagName("textarea")[0].value;handlers(response)}else response.data=doc}catch(e){error=e}error?this.reject(error):this._finished?this.resolve(response):this.reject(new Error("Invalid dojo/request/iframe request state"))}function last(response){this._callNext()}function iframe(url,options,returnDeferred){var response=util.parseArgs(url,util.deepCreate(defaultOptions,options),!0);url=response.url,options=response.options;if(options.method!=="GET"&&options.method!=="POST")throw new Error(options.method+" not supported by dojo/request/iframe");iframe._frame||(iframe._frame=iframe.create(iframe._iframeName,onload+"();"));var dfd=util.deferred(response,null,isValid,isReady,handleResponse,last);return dfd._callNext=function(){this._calledNext||(this._calledNext=!0,iframe._currentDfd=null,iframe._fireNextRequest())},dfd._legacy=returnDeferred,iframe._dfdQueue.push(dfd),iframe._fireNextRequest(),watch(dfd),returnDeferred?dfd:dfd.promise}var mid=module.id.replace(/[\/\.\-]/g,"_"),onload=mid+"_onload";win.global[onload]||(win.global[onload]=function(){var dfd=iframe._currentDfd;if(!dfd){iframe._fireNextRequest();return}var response=dfd.response,options=response.options,formNode=dom.byId(options.form)||dfd._tmpForm;if(formNode){var toClean=dfd._contentToClean;for(var i=0;i<toClean.length;i++){var key=toClean[i];for(var j=0;j<formNode.childNodes.length;j++){var childNode=formNode.childNodes[j];if(childNode.name===key){domConstruct.destroy(childNode);break}}}dfd._originalAction&&formNode.setAttribute("action",dfd._originalAction),dfd._originalMethod&&(formNode.setAttribute("method",dfd._originalMethod),formNode.method=dfd._originalMethod),dfd._originalTarget&&(formNode.setAttribute("target",dfd._originalTarget),formNode.target=dfd._originalTarget)}dfd._tmpForm&&(domConstruct.destroy(dfd._tmpForm),delete dfd._tmpForm),dfd._finished=!0});var defaultOptions={method:"POST"};return iframe.create=create,iframe.doc=doc,iframe.setSrc=setSrc,iframe._iframeName=mid+"_IoIframe",iframe._notifyStart=function(){},iframe._dfdQueue=[],iframe._currentDfd=null,iframe._fireNextRequest=fireNextRequest,util.addCommonMethods(iframe,["GET","POST"]),iframe})