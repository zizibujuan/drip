//>>built
define("dojo/request/xhr",["../errors/RequestError","./watch","./handlers","./util","../has"],function(RequestError,watch,handlers,util,has){function handleResponse(response,error){var _xhr=response.xhr;response.status=response.xhr.status,response.text=_xhr.responseText,response.options.handleAs==="xml"&&(response.data=_xhr.responseXML);if(!error)try{handlers(response)}catch(e){error=e}error?this.reject(error):util.checkStatus(_xhr.status)?this.resolve(response):(error=new RequestError("Unable to load "+response.url+" status: "+_xhr.status,response),this.reject(error))}function xhr(url,options,returnDeferred){var response=util.parseArgs(url,util.deepCreate(defaultOptions,options),has("native-formdata")&&options&&options.data&&options.data instanceof FormData);url=response.url,options=response.options;var remover,last=function(){remover&&remover()},dfd=util.deferred(response,cancel,isValid,isReady,handleResponse,last),_xhr=response.xhr=xhr._create();if(!_xhr)return dfd.cancel(new RequestError("XHR was not created")),returnDeferred?dfd:dfd.promise;response.getHeader=function(headerName){return this.xhr.getResponseHeader(headerName)},addListeners&&(remover=addListeners(_xhr,dfd,response));var data=options.data,async=!options.sync,method=options.method;try{_xhr.open(method,url,async,options.user||undefined,options.password||undefined),options.withCredentials&&(_xhr.withCredentials=options.withCredentials);var headers=options.headers,contentType;if(headers)for(var hdr in headers)hdr.toLowerCase()==="content-type"?contentType=headers[hdr]:headers[hdr]&&_xhr.setRequestHeader(hdr,headers[hdr]);contentType&&contentType!==!1&&_xhr.setRequestHeader("Content-Type",contentType),(!headers||!("X-Requested-With"in headers))&&_xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),util.notify&&util.notify.emit("send",response,dfd.promise.cancel),_xhr.send(data)}catch(e){dfd.reject(e)}return watch(dfd),_xhr=null,returnDeferred?dfd:dfd.promise}has.add("native-xhr",function(){return typeof XMLHttpRequest!="undefined"}),has.add("dojo-force-activex-xhr",function(){return has("activex")&&!document.addEventListener&&window.location.protocol==="file:"}),has.add("native-xhr2",function(){if(!has("native-xhr"))return;var x=new XMLHttpRequest;return typeof x.addEventListener!="undefined"&&(typeof opera=="undefined"||typeof x.upload!="undefined")}),has.add("native-formdata",function(){return typeof FormData=="function"});var isValid,isReady,addListeners,cancel;has("native-xhr2")?(isValid=function(response){return!this.isFulfilled()},cancel=function(dfd,response){response.xhr.abort()},addListeners=function(_xhr,dfd,response){function onLoad(evt){dfd.handleResponse(response)}function onError(evt){var _xhr=evt.target,error=new RequestError("Unable to load "+response.url+" status: "+_xhr.status,response);dfd.handleResponse(response,error)}function onProgress(evt){evt.lengthComputable&&(response.loaded=evt.loaded,response.total=evt.total,dfd.progress(response))}return _xhr.addEventListener("load",onLoad,!1),_xhr.addEventListener("error",onError,!1),_xhr.addEventListener("progress",onProgress,!1),function(){_xhr.removeEventListener("load",onLoad,!1),_xhr.removeEventListener("error",onError,!1),_xhr.removeEventListener("progress",onProgress,!1)}}):(isValid=function(response){return response.xhr.readyState},isReady=function(response){return 4===response.xhr.readyState},cancel=function(dfd,response){var xhr=response.xhr,_at=typeof xhr.abort;(_at==="function"||_at==="object"||_at==="unknown")&&xhr.abort()});var undefined,defaultOptions={data:null,query:null,sync:!1,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded"}};xhr._create=function(){throw new Error("XMLHTTP not available")};if(has("native-xhr")&&!has("dojo-force-activex-xhr"))xhr._create=function(){return new XMLHttpRequest};else if(has("activex"))try{new ActiveXObject("Msxml2.XMLHTTP"),xhr._create=function(){return new ActiveXObject("Msxml2.XMLHTTP")}}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP"),xhr._create=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}catch(e){}}return util.addCommonMethods(xhr),xhr})