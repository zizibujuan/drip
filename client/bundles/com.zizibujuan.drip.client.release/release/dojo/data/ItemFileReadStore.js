//>>built
define("dojo/data/ItemFileReadStore",["../_base/kernel","../_base/lang","../_base/declare","../_base/array","../_base/xhr","../Evented","./util/filter","./util/simpleFetch","../date/stamp"],function(kernel,lang,declare,array,xhr,Evented,filterUtil,simpleFetch,dateStamp){var ItemFileReadStore=declare("dojo.data.ItemFileReadStore",[Evented],{constructor:function(keywordParameters){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=keywordParameters.url,this._ccUrl=keywordParameters.url,this.url=keywordParameters.url,this._jsonData=keywordParameters.data,this.data=null,this._datatypeMap=keywordParameters.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(value){return dateStamp.fromISOString(value)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._reverseRefMap="_RRM",this._loadInProgress=!1,this._queuedFetches=[],keywordParameters.urlPreventCache!==undefined&&(this.urlPreventCache=keywordParameters.urlPreventCache?!0:!1),keywordParameters.hierarchical!==undefined&&(this.hierarchical=keywordParameters.hierarchical?!0:!1),keywordParameters.clearOnClose&&(this.clearOnClose=!0),"failOk"in keywordParameters&&(this.failOk=keywordParameters.failOk?!0:!1)},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(item){if(!this.isItem(item))throw new Error(this.declaredClass+": Invalid item argument.")},_assertIsAttribute:function(attribute){if(typeof attribute!="string")throw new Error(this.declaredClass+": Invalid attribute argument.")},getValue:function(item,attribute,defaultValue){var values=this.getValues(item,attribute);return values.length>0?values[0]:defaultValue},getValues:function(item,attribute){return this._assertIsItem(item),this._assertIsAttribute(attribute),(item[attribute]||[]).slice(0)},getAttributes:function(item){this._assertIsItem(item);var attributes=[];for(var key in item)key!==this._storeRefPropName&&key!==this._itemNumPropName&&key!==this._rootItemPropName&&key!==this._reverseRefMap&&attributes.push(key);return attributes},hasAttribute:function(item,attribute){return this._assertIsItem(item),this._assertIsAttribute(attribute),attribute in item},containsValue:function(item,attribute,value){var regexp=undefined;return typeof value=="string"&&(regexp=filterUtil.patternToRegExp(value,!1)),this._containsValue(item,attribute,value,regexp)},_containsValue:function(item,attribute,value,regexp){return array.some(this.getValues(item,attribute),function(possibleValue){if(possibleValue!==null&&!lang.isObject(possibleValue)&&regexp){if(possibleValue.toString().match(regexp))return!0}else if(value===possibleValue)return!0})},isItem:function(something){return something&&something[this._storeRefPropName]===this&&this._arrayOfAllItems[something[this._itemNumPropName]]===something?!0:!1},isItemLoaded:function(something){return this.isItem(something)},loadItem:function(keywordArgs){this._assertIsItem(keywordArgs.item)},getFeatures:function(){return this._features},getLabel:function(item){return this._labelAttr&&this.isItem(item)?this.getValue(item,this._labelAttr):undefined},getLabelAttributes:function(item){return this._labelAttr?[this._labelAttr]:null},filter:function(requestArgs,arrayOfItems,findCallback){var items=[],i,key;if(requestArgs.query){var value,ignoreCase=requestArgs.queryOptions?requestArgs.queryOptions.ignoreCase:!1,regexpList={};for(key in requestArgs.query)value=requestArgs.query[key],typeof value=="string"?regexpList[key]=filterUtil.patternToRegExp(value,ignoreCase):value instanceof RegExp&&(regexpList[key]=value);for(i=0;i<arrayOfItems.length;++i){var match=!0,candidateItem=arrayOfItems[i];if(candidateItem===null)match=!1;else for(key in requestArgs.query)value=requestArgs.query[key],this._containsValue(candidateItem,key,value,regexpList[key])||(match=!1);match&&items.push(candidateItem)}findCallback(items,requestArgs)}else{for(i=0;i<arrayOfItems.length;++i){var item=arrayOfItems[i];item!==null&&items.push(item)}findCallback(items,requestArgs)}},_fetchItems:function(keywordArgs,findCallback,errorCallback){var self=this;if(this._loadFinished)this.filter(keywordArgs,this._getItemsArray(keywordArgs.queryOptions),findCallback);else{this._jsonFileUrl!==this._ccUrl?(kernel.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),this.data!=null&&(this._jsonData=this.data,this.data=null);if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:keywordArgs,filter:lang.hitch(self,"filter"),findCallback:lang.hitch(self,findCallback)});else{this._loadInProgress=!0;var getArgs={url:self._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){try{self._getItemsFromLoadedData(data),self._loadFinished=!0,self._loadInProgress=!1,self.filter(keywordArgs,self._getItemsArray(keywordArgs.queryOptions),findCallback),self._handleQueuedFetches()}catch(e){self._loadFinished=!0,self._loadInProgress=!1,errorCallback(e,keywordArgs)}}),getHandler.addErrback(function(error){self._loadInProgress=!1,errorCallback(error,keywordArgs)});var oldAbort=null;keywordArgs.abort&&(oldAbort=keywordArgs.abort),keywordArgs.abort=function(){var df=getHandler;df&&df.fired===-1&&(df.cancel(),df=null),oldAbort&&oldAbort.call(keywordArgs)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,self.filter(keywordArgs,this._getItemsArray(keywordArgs.queryOptions),findCallback)}catch(e){errorCallback(e,keywordArgs)}else errorCallback(new Error(this.declaredClass+": No JSON source data was provided as either URL or a nested Javascript object."),keywordArgs)}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var fData=this._queuedFetches[i],delayedQuery=fData.args,delayedFilter=fData.filter,delayedFindCallback=fData.findCallback;delayedFilter?delayedFilter(delayedQuery,this._getItemsArray(delayedQuery.queryOptions),delayedFindCallback):this.fetchItemByIdentity(delayedQuery)}this._queuedFetches=[]}},_getItemsArray:function(queryOptions){return queryOptions&&queryOptions.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(request){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&((this._jsonFileUrl==""||this._jsonFileUrl==null)&&(this.url==""||this.url==null)&&this.data==null&&0,this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(dataObject){function valueIsAnItem(aValue){return aValue!==null&&typeof aValue=="object"&&(!lang.isArray(aValue)||addingArrays)&&!lang.isFunction(aValue)&&(aValue.constructor==Object||lang.isArray(aValue))&&typeof aValue._reference=="undefined"&&typeof aValue._type=="undefined"&&typeof aValue._value=="undefined"&&self.hierarchical}function addItemAndSubItemsToArrayOfAllItems(anItem){self._arrayOfAllItems.push(anItem);for(var attribute in anItem){var valueForAttribute=anItem[attribute];if(valueForAttribute)if(lang.isArray(valueForAttribute)){var valueArray=valueForAttribute;for(var k=0;k<valueArray.length;++k){var singleValue=valueArray[k];valueIsAnItem(singleValue)&&addItemAndSubItemsToArrayOfAllItems(singleValue)}}else valueIsAnItem(valueForAttribute)&&addItemAndSubItemsToArrayOfAllItems(valueForAttribute)}}var addingArrays=!1,self=this;this._labelAttr=dataObject.label;var i,item;this._arrayOfAllItems=[],this._arrayOfTopLevelItems=dataObject.items;for(i=0;i<this._arrayOfTopLevelItems.length;++i)item=this._arrayOfTopLevelItems[i],lang.isArray(item)&&(addingArrays=!0),addItemAndSubItemsToArrayOfAllItems(item),item[this._rootItemPropName]=!0;var allAttributeNames={},key;for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];for(key in item){if(key!==this._rootItemPropName){var value=item[key];value!==null?lang.isArray(value)||(item[key]=[value]):item[key]=[null]}allAttributeNames[key]=key}}while(allAttributeNames[this._storeRefPropName])this._storeRefPropName+="_";while(allAttributeNames[this._itemNumPropName])this._itemNumPropName+="_";while(allAttributeNames[this._reverseRefMap])this._reverseRefMap+="_";var arrayOfValues,identifier=dataObject.identifier;if(identifier){this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=identifier;for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i],arrayOfValues=item[identifier];var identity=arrayOfValues[0];if(!Object.hasOwnProperty.call(this._itemsByIdentity,identity))this._itemsByIdentity[identity]=item;else{if(this._jsonFileUrl)throw new Error(this.declaredClass+":  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+identifier+"].  Value collided: ["+identity+"]");if(this._jsonData)throw new Error(this.declaredClass+":  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+identifier+"].  Value collided: ["+identity+"]")}}}else this._features["dojo.data.api.Identity"]=Number;for(i=0;i<this._arrayOfAllItems.length;++i)item=this._arrayOfAllItems[i],item[this._storeRefPropName]=this,item[this._itemNumPropName]=i;for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];for(key in item){arrayOfValues=item[key];for(var j=0;j<arrayOfValues.length;++j){value=arrayOfValues[j];if(value!==null&&typeof value=="object"){if("_type"in value&&"_value"in value){var type=value._type,mappingObj=this._datatypeMap[type];if(!mappingObj)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+type+"'");if(lang.isFunction(mappingObj))arrayOfValues[j]=new mappingObj(value._value);else{if(!lang.isFunction(mappingObj.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");arrayOfValues[j]=mappingObj.deserialize(value._value)}}if(value._reference){var referenceDescription=value._reference;if(!lang.isObject(referenceDescription))arrayOfValues[j]=this._getItemByIdentity(referenceDescription);else for(var k=0;k<this._arrayOfAllItems.length;++k){var candidateItem=this._arrayOfAllItems[k],found=!0;for(var refKey in referenceDescription)candidateItem[refKey]!=referenceDescription[refKey]&&(found=!1);found&&(arrayOfValues[j]=candidateItem)}if(this.referenceIntegrity){var refItem=arrayOfValues[j];this.isItem(refItem)&&this._addReferenceToMap(refItem,item,key)}}else this.isItem(value)&&this.referenceIntegrity&&this._addReferenceToMap(value,item,key)}}}}},_addReferenceToMap:function(refItem,parentItem,attribute){},getIdentity:function(item){var identifier=this._features["dojo.data.api.Identity"];if(identifier===Number)return item[this._itemNumPropName];var arrayOfValues=item[identifier];return arrayOfValues?arrayOfValues[0]:null},fetchItemByIdentity:function(keywordArgs){var item,scope;if(!this._loadFinished){var self=this;this._jsonFileUrl!==this._ccUrl?(kernel.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),this.data!=null&&this._jsonData==null&&(this._jsonData=this.data,this.data=null);if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:keywordArgs});else{this._loadInProgress=!0;var getArgs={url:self._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){var scope=keywordArgs.scope?keywordArgs.scope:kernel.global;try{self._getItemsFromLoadedData(data),self._loadFinished=!0,self._loadInProgress=!1,item=self._getItemByIdentity(keywordArgs.identity),keywordArgs.onItem&&keywordArgs.onItem.call(scope,item),self._handleQueuedFetches()}catch(error){self._loadInProgress=!1,keywordArgs.onError&&keywordArgs.onError.call(scope,error)}}),getHandler.addErrback(function(error){self._loadInProgress=!1;if(keywordArgs.onError){var scope=keywordArgs.scope?keywordArgs.scope:kernel.global;keywordArgs.onError.call(scope,error)}})}else this._jsonData&&(self._getItemsFromLoadedData(self._jsonData),self._jsonData=null,self._loadFinished=!0,item=self._getItemByIdentity(keywordArgs.identity),keywordArgs.onItem&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onItem.call(scope,item)))}else item=this._getItemByIdentity(keywordArgs.identity),keywordArgs.onItem&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onItem.call(scope,item))},_getItemByIdentity:function(identity){var item=null;return this._itemsByIdentity?Object.hasOwnProperty.call(this._itemsByIdentity,identity)&&(item=this._itemsByIdentity[identity]):Object.hasOwnProperty.call(this._arrayOfAllItems,identity)&&(item=this._arrayOfAllItems[identity]),item===undefined&&(item=null),item},getIdentityAttributes:function(item){var identifier=this._features["dojo.data.api.Identity"];return identifier===Number?null:[identifier]},_forceLoad:function(){var self=this;this._jsonFileUrl!==this._ccUrl?(kernel.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),this.data!=null&&(this._jsonData=this.data,this.data=null);if(this._jsonFileUrl){var getArgs={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){try{if(self._loadInProgress!==!0&&!self._loadFinished)self._getItemsFromLoadedData(data),self._loadFinished=!0;else if(self._loadInProgress)throw new Error(this.declaredClass+":  Unable to perform a synchronous load, an async load is in progress.")}catch(e){throw 0,e}}),getHandler.addErrback(function(error){throw error})}else this._jsonData&&(self._getItemsFromLoadedData(self._jsonData),self._jsonData=null,self._loadFinished=!0)}});return lang.extend(ItemFileReadStore,simpleFetch),ItemFileReadStore})