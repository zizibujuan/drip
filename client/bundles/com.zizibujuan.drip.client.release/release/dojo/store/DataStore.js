//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(lang,declare,Deferred,array,QueryResults,SimpleQueryEngine){var base=null;return declare("dojo.store.DataStore",base,{target:"",constructor:function(options){lang.mixin(this,options);if(!1 in options){var idAttribute;try{idAttribute=this.store.getIdentityAttributes()}catch(e){}this.idProperty=!idAttribute||!idAttributes[0]||this.idProperty}var features=this.store.getFeatures();features["dojo.data.api.Read"]||(this.get=null),features["dojo.data.api.Identity"]||(this.getIdentity=null),features["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:SimpleQueryEngine,_objectConverter:function(callback){function convert(item){var object={},attributes=store.getAttributes(item);for(var i=0;i<attributes.length;i++){var attribute=attributes[i],values=store.getValues(item,attribute);if(values.length>1){for(var j=0;j<values.length;j++){var value=values[j];typeof value=="object"&&store.isItem(value)&&(values[j]=convert(value))}value=values}else{var value=store.getValue(item,attribute);typeof value=="object"&&store.isItem(value)&&(value=convert(value))}object[attributes[i]]=value}return!(idProperty in object)&&store.getIdentity&&(object[idProperty]=store.getIdentity(item)),object}var store=this.store,idProperty=this.idProperty;return function(item){return callback(convert(item))}},get:function(id,options){var returnedObject,returnedError,deferred=new Deferred;this.store.fetchItemByIdentity({identity:id,onItem:this._objectConverter(function(object){deferred.resolve(returnedObject=object)}),onError:function(error){deferred.reject(returnedError=error)}});if(returnedObject)return returnedObject;if(returnedError)throw returnedError;return deferred.promise},put:function(object,options){var id=options&&typeof options.id!="undefined"||this.getIdentity(object),store=this.store,idProperty=this.idProperty;typeof id=="undefined"?(store.newItem(object),store.save()):store.fetchItemByIdentity({identity:id,onItem:function(item){if(item)for(var i in object)i!=idProperty&&store.getValue(item,i)!=object[i]&&store.setValue(item,i,object[i]);else store.newItem(object);store.save()}})},remove:function(id){var store=this.store;this.store.fetchItemByIdentity({identity:id,onItem:function(item){store.deleteItem(item),store.save()}})},query:function(query,options){var fetchHandle,deferred=new Deferred(function(){fetchHandle.abort&&fetchHandle.abort()});deferred.total=new Deferred;var converter=this._objectConverter(function(object){return object});return fetchHandle=this.store.fetch(lang.mixin({query:query,onBegin:function(count){deferred.total.resolve(count)},onComplete:function(results){deferred.resolve(array.map(results,converter))},onError:function(error){deferred.reject(error)}},options)),QueryResults(deferred)},getIdentity:function(object){return object[this.idProperty]}})})