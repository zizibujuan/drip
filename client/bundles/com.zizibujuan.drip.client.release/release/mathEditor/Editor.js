//>>built
require({cache:{"mathEditor/Model":function(){define("mathEditor/Model",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojox/xml/parser","mathEditor/string","mathEditor/dataUtil","mathEditor/lang","mathEditor/xmlUtil"],function(declare,lang,array,domConstruct,xmlParser,dripString,dataUtil,dripLang,xmlUtil){var EMPTY_XML="<root><line></line></root>";return declare(null,{path:null,xmlString:null,doc:null,cursorPosition:null,constructor:function(options){this._init(),lang.mixin(this,options)},_init:function(){this.doc=xmlParser.parse(EMPTY_XML),this.path=[],this.cursorPosition={},this.cursorPosition.node=this.doc.documentElement.firstChild,this.cursorPosition.offset=0,this.path.push({nodeName:"root"}),this.path.push({nodeName:"line",offset:1})},clear:function(){this._init(),this.onChange()},loadData:function(xmlString){},setData:function(insertInfo){var data=insertInfo.data,nodeName=insertInfo.nodeName,removeCount=insertInfo.removeCount;if(removeCount&&removeCount>0)for(var i=0;i<removeCount;i++)this.removeLeft();var xmlDoc=this.doc;if(nodeName!=""&&nodeName=="mfrac"){this._splitNodeIfNeed();var node=this.cursorPosition.node,offset=this.cursorPosition.offset,newOffset=1,position="last";if(!this._isLineNode(node)&&this._isTextNode(node)){var _offset=this.path.pop().offset;newOffset=_offset+1,position="after"}this.path.push({nodeName:"math",offset:newOffset}),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1});var math=xmlDoc.createElement("math"),fracData=xmlUtil.createEmptyFrac(xmlDoc);math.appendChild(fracData.rootNode),domConstruct.place(math,node,position),this.cursorPosition.node=fracData.focusNode,this.cursorPosition.offset=0,this.onChange();return}var dataArray=[];lang.isString(data)?dataArray=dripString.splitData(data):lang.isArray(data)&&(dataArray=data),array.forEach(dataArray,lang.hitch(this,function(eachData,index){var c=eachData,node=this.cursorPosition.node;if(dripLang.isNumber(c)){nodeName="mn";function isLineOrText(node){var nodeName=node.nodeName;return nodeName=="line"||nodeName=="text"}if(isLineOrText(node)){var offset=this.cursorPosition.offset,position="last",pathOffset=1;if(this._isLineNode(node))position="last",pathOffset=1;else if(this._isTextNode(node)){this._splitNodeIfNeed();var pos=this.path.pop();offset>0?(position="after",pathOffset=pos.offset+1):position="before"}var mathNode=xmlDoc.createElement("math"),mnNode=xmlDoc.createElement(nodeName);mathNode.appendChild(mnNode),domConstruct.place(mathNode,node,position),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"math",offset:pathOffset}),this.path.push({nodeName:nodeName,offset:1})}else if(dripLang.isMathTokenNode(node)){var node=this.cursorPosition.node;if(node.nodeName!=nodeName){var mnNode=xmlDoc.createElement(nodeName);dripLang.insertNodeAfter(mnNode,node),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0;var pos=this.path.pop();this.path.push({nodeName:nodeName,offset:pos.offset+1})}this._insertChar(c)}}else if(dripLang.isOperator(c)){if(this._isLineNode(node)){var mathNode=xmlDoc.createElement("math");node.appendChild(mathNode);var mnNode=xmlDoc.createElement("mo");mathNode.appendChild(mnNode),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1})}else if(dripLang.isMathTokenNode(node)){var node=this.cursorPosition.node,moNode=xmlDoc.createElement("mo");dripLang.insertNodeAfter(moNode,node),this.cursorPosition.node=moNode,this.cursorPosition.offset=0,this._insertChar(c);var pos=this.path.pop();this.path.push({nodeName:"mo",offset:pos.offset+1})}else if(this._isTextNode(node)){var mathNode=xmlDoc.createElement("math");dripLang.insertNodeAfter(mathNode,node);var mnNode=xmlDoc.createElement("mo");mathNode.appendChild(mnNode),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c);var pos=this.path.pop();this.path.push({nodeName:"math",offset:pos.offset+1}),this.path.push({nodeName:"mo",offset:1})}}else if(dripLang.isNewLine(c)){var focusedLine=this._getFocusLine(),newLineNode=this.doc.createElement("line");dripLang.insertNodeAfter(newLineNode,focusedLine),this.cursorPosition.node=newLineNode,this.cursorPosition.offset=0;var pos=this.path.pop();while(pos.nodeName!="line")pos=this.path.pop();this.path.push({nodeName:"line",offset:pos.offset+1})}else if(this._isLineNode(node)){var textSpanNode=xmlDoc.createElement("text");node.appendChild(textSpanNode),this.cursorPosition.node=textSpanNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"text",offset:1})}else if(this._isTextNode(node))this._insertChar(c);else if(dripLang.isMathTokenNode(node)){var pos=null;do pos=this.path.pop();while(pos&&pos.nodeName!="math");var textSpanNode=xmlDoc.createElement("text"),mathNode=node;while(mathNode.nodeName!="math")mathNode=mathNode.parentNode;dripLang.insertNodeAfter(textSpanNode,mathNode),this.cursorPosition.node=textSpanNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"text",offset:pos.offset+1})}})),this.onChange(data)},doDelete:function(){var removed=this.removeLeft();removed!=""&&this.onChange()},removeLeft:function(){var offset=this.cursorPosition.offset,node=this.cursorPosition.node,oldText=node.textContent;0;if(offset==0){var _node=node;if(node.nodeName!="text"&&node.nodeName!="line"){while(_node.nodeName!="math")_node=_node.parentNode;var previousNode=_node.previousSibling;if(previousNode){var textContent=previousNode.textContent,oldLength=textContent.length,newText=dripString.insertAtOffset(textContent,oldLength,"",1),newLength=oldLength-1;newText==""?(previousNode.parentNode.removeChild(previousNode),this.path.pop()):(previousNode.textContent=newText,this.cursorPosition.node=previousNode,this.cursorPosition.offset=newLength);var removed=textContent.charAt(newLength);return removed}}else if(node.nodeName=="line"){if(this.getLineCount()>1){var previousNode=node.previousSibling,childCount=previousNode.childNodes.length;if(childCount==0){this.cursorPosition.node=previousNode,this.cursorPosition.offset=0;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),node.parentNode.removeChild(node)}else{previousNode=previousNode.lastChild;if(previousNode.nodeName=="text"){this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),this.path.push({nodeName:previousNode.nodeName,offset:childCount}),node.parentNode.removeChild(node)}else if(previousNode.nodeName=="math"){var mathChildCount=previousNode.childNodes.length;previousNode=previousNode.lastChild,this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),this.path.push({nodeName:"math",offset:childCount}),this.path.push({nodeName:previousNode.nodeName,offset:mathChildCount}),node.parentNode.removeChild(node)}}return"\n"}return""}return""}var removed="",newText="";node.nodeName=="mo"?(removed=node.textContent,newText=""):(removed=oldText.charAt(offset-1),newText=dripString.insertAtOffset(oldText,offset,"",1));if(newText==""){var previousNode=node.previousSibling,_offset=0;if(previousNode)if(previousNode.nodeName=="math"){var mathChildCount=previousNode.childNodes.length;previousNode=previousNode.lastChild,this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop(),lastOffset=lastPath.offset-1;this.path.push({nodeName:"math",offset:lastOffset}),this.path.push({nodeName:previousNode.nodeName,offset:mathChildCount}),node.parentNode.removeChild(node)}else{this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length,node.parentNode.removeChild(node);var old=this.path.pop();this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:old.offset-1})}else{var p=node,c=node;if(node.nodeName!="text"&&node.nodeName!="line")while(c.nodeName!="math")p=c.parentNode,p.removeChild(c),c=p,this.path.pop();previousNode=c.previousSibling,p=c.parentNode,p.removeChild(c);var oldOffset=this.path.pop().offset;previousNode?(this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length,this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:oldOffset-1})):(this.cursorPosition.node=p,this.cursorPosition.offset=p.childElementCount)}}else this.cursorPosition.node.textContent=newText,this.cursorPosition.offset-=1;return removed},moveLeft:function(){var node=this.cursorPosition.node,offset=this.cursorPosition.offset,nodeName=node.nodeName;if(nodeName=="line"){var previousNode=node.previousSibling;if(!previousNode)return;previousNode=previousNode.lastChild,previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length;return}if(offset>0){this.cursorPosition.offset--;return}if(offset==0){var previousNode=node.previousSibling;if(previousNode){previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length-1;return}var parentNode=node.parentNode,previousNode=parentNode.previousSibling;if(previousNode)if(previousNode.nodeName=="line"){previousNode=previousNode.lastChild,previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length}else{var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length-1}}},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},_splitNodeIfNeed:function(){var offset=this.cursorPosition.offset,node=this.cursorPosition.node,textContent=node.textContent,textLength=textContent.length;if(0<offset&&offset<textLength){var part1=textContent.substring(0,offset),part2=textContent.substring(offset),node2=this.doc.createElement(node.nodeName);node.textContent=part1,node2.textContent=part2,dripLang.insertNodeAfter(node2,node)}},_getFocusLine:function(){var focusNode=this.getFocusNode(),lineNode=focusNode;while(lineNode&&lineNode.nodeName!="line")lineNode=lineNode.parentNode;return lineNode},_isNotSameNode:function(newNodeName,node){var nodeName=node.nodeName;return newNodeName==nodeName},_isLineNode:function(node){return node.nodeName=="line"},_isTextNode:function(node){return node.nodeName=="text"},_insertChar:function(charData){var offset=this.cursorPosition.offset,oldText=this.cursorPosition.node.textContent,newText=dripString.insertAtOffset(oldText,offset,charData);this.cursorPosition.node.textContent=newText,this.cursorPosition.offset+=1},getXML:function(){var doc=this.doc;return doc.firstChild.firstChild.childNodes.length==0?"":xmlParser.innerXML(this.doc)},getPath:function(){var xpath="";return array.forEach(this.path,function(path,index){xpath+="/",xpath+=path.nodeName,path.offset&&(xpath+="["+path.offset+"]")}),xpath},getFocusNode:function(){return this.cursorPosition.node},getOffset:function(){return this.cursorPosition.offset},getLineAt:function(lineIndex){return this.doc.documentElement.childNodes[lineIndex]},getHTML:function(){return dataUtil.xmlDocToHtml(this.doc)},onChange:function(data){}})})},"dojox/xml/parser":function(){define("dojox/xml/parser",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/array","dojo/_base/window","dojo/_base/sniff"],function(dojo){return dojo.getObject("xml.parser",!0,dojox),dojox.xml.parser.parse=function(str,mimetype){var _document=dojo.doc,doc;mimetype=mimetype||"text/xml";if(str&&dojo.trim(str)&&"DOMParser"in dojo.global){var parser=new DOMParser;doc=parser.parseFromString(str,mimetype);var de=doc.documentElement,errorNS="http://www.mozilla.org/newlayout/xml/parsererror.xml";if(de.nodeName=="parsererror"&&de.namespaceURI==errorNS){var sourceText=de.getElementsByTagNameNS(errorNS,"sourcetext")[0];throw sourceText&&(sourceText=sourceText.firstChild.data),new Error("Error parsing text "+de.firstChild.data+" \n"+sourceText)}return doc}if("ActiveXObject"in dojo.global){var ms=function(n){return"MSXML"+n+".DOMDocument"},dp=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)];dojo.some(dp,function(p){try{doc=new ActiveXObject(p)}catch(e){return!1}return!0});if(str&&doc){doc.async=!1,doc.loadXML(str);var pe=doc.parseError;if(pe.errorCode!==0)throw new Error("Line: "+pe.line+"\n"+"Col: "+pe.linepos+"\n"+"Reason: "+pe.reason+"\n"+"Error Code: "+pe.errorCode+"\n"+"Source: "+pe.srcText)}if(doc)return doc}else if(_document.implementation&&_document.implementation.createDocument){if(str&&dojo.trim(str)&&_document.createElement){var tmp=_document.createElement("xml");tmp.innerHTML=str;var xmlDoc=_document.implementation.createDocument("foo","",null);return dojo.forEach(tmp.childNodes,function(child){xmlDoc.importNode(child,!0)}),xmlDoc}return _document.implementation.createDocument("","",null)}return null},dojox.xml.parser.textContent=function(node,text){if(arguments.length>1){var _document=node.ownerDocument||dojo.doc;return dojox.xml.parser.replaceChildren(node,_document.createTextNode(text)),text}if(node.textContent!==undefined)return node.textContent;var _result="";return node&&dojo.forEach(node.childNodes,function(child){switch(child.nodeType){case 1:case 5:_result+=dojox.xml.parser.textContent(child);break;case 3:case 2:case 4:_result+=child.nodeValue}}),_result},dojox.xml.parser.replaceChildren=function(node,newChildren){var nodes=[];dojo.isIE&&dojo.forEach(node.childNodes,function(child){nodes.push(child)}),dojox.xml.parser.removeChildren(node),dojo.forEach(nodes,dojo.destroy),dojo.isArray(newChildren)?dojo.forEach(newChildren,function(child){node.appendChild(child)}):node.appendChild(newChildren)},dojox.xml.parser.removeChildren=function(node){var count=node.childNodes.length;while(node.hasChildNodes())node.removeChild(node.firstChild);return count},dojox.xml.parser.innerXML=function(node){return node.innerXML?node.innerXML:node.xml?node.xml:typeof XMLSerializer!="undefined"?(new XMLSerializer).serializeToString(node):null},dojox.xml.parser})},"mathEditor/string":function(){define([],function(){var string={};return string.splitData=function(data){var len=data.length,result=[],index=0,append=!1,cache="",span=0;for(var i=0;i<len;i++){var c=data.charAt(i);c=="&"?(span=0,append=!0,cache=c):append&&c==";"?(span==0?(result[index]=cache,index++,result[index]=c,index++):(cache+=c,result[index]=cache,index++),append=!1,cache=""):append?(cache+=c,span++):(result[index]=data.charAt(i),index++)}return result},string.insertAtOffset=function(target,offset,source,removeCount){var removeCount=removeCount||0,len=target.length;if(offset<0||len<offset)return target;var part1=target.substring(0,offset-removeCount),part2=target.substring(offset);return part1+source+part2},string})},"mathEditor/dataUtil":function(){define(["dojox/xml/parser","dojo/_base/array"],function(xmlParser,array){var dataUtil={};return dataUtil.xmlDocToHtml=function(xmlDoc){var xmlString="",root=xmlDoc.documentElement,lines=root.childNodes;return array.forEach(lines,function(line,index){var lineString="<div class='drip_line'>",spans=line.childNodes;array.forEach(spans,function(span,index){if(span.nodeName=="text")lineString+="<span>"+span.textContent+"</span>";else if(span.nodeName=="math"){var tmp=xmlParser.innerXML(span);lineString+=tmp.replace(/&amp;/g,"&")}}),lineString+="</div>",xmlString+=lineString}),xmlString},dataUtil.xmlStringToHtml=function(xmlString){var doc=xmlParser.parse(xmlString);return this.xmlDocToHtml(doc)},dataUtil})},"mathEditor/lang":function(){define("mathEditor/lang",["dojo/_base/array"],function(array){var lang={};return lang.isNumber=function(obj){return!isNaN(parseFloat(obj))&&isFinite(obj)},lang.isOperator=function(obj){return obj=="+"||obj=="="||obj=="-"||obj=="&#xD7;"||obj=="&#xF7;"?!0:!1},lang.isNewLine=function(obj){return obj==="\n"},lang.isTab=function(obj){return obj==="	"},lang.insertNodeAfter=function(newNode,existingNode){var parentNode=existingNode.parentNode;parentNode.lastChild==existingNode?parentNode.appendChild(newNode):parentNode.insertBefore(newNode,existingNode.nextSibling)},lang._fontStyles={fontFamily:1,fontSize:1,fontWeight:1,fontStyle:1,lineHeight:1},lang.isMathTokenNode=function(node){var nodeName=node.nodeName;return this.isMathTokenName(nodeName)},lang.isMathTokenName=function(nodeName){var isTokenNode=!1,tokenNames=["mi","mn","mo","mtext","mspace","ms"];return array.forEach(tokenNames,function(name,index){if(nodeName==name){isTokenNode=!0;return}}),isTokenNode},lang.measureTextSize=function(elem,text){if(!this.measureNode){var _measureNode=document.createElement("div"),style=_measureNode.style;style.width=style.height="auto",style.left=style.top="-1000px",style.visibility="hidden",style.position="absolute",style.overflow="visible",style.whiteSpace="nowrap",document.body.appendChild(_measureNode),this.measureNode=_measureNode}var measureNode=this.measureNode;measureNode.innerHTML=text;var style=measureNode.style,computedStyle=window.getComputedStyle(elem,null);for(var prop in this._fontStyles)style[prop]=computedStyle[prop];var size={height:measureNode.offsetHeight,width:measureNode.offsetWidth};return size},lang})},"mathEditor/xmlUtil":function(){define("mathEditor/xmlUtil",{createEmptyFrac:function(xmlDoc){var mstyle=xmlDoc.createElement("mstyle");mstyle.setAttribute("displaystyle","true");var mfrac=xmlDoc.createElement("mfrac"),mrow1=xmlDoc.createElement("mrow"),mrow2=xmlDoc.createElement("mrow"),mn1=this._getPlaceHolder(xmlDoc),mn2=this._getPlaceHolder(xmlDoc);return mstyle.appendChild(mfrac),mfrac.appendChild(mrow1),mfrac.appendChild(mrow2),mrow1.appendChild(mn1),mrow2.appendChild(mn2),{rootNode:mstyle,focusNode:mn1}},_getPlaceHolder:function(xmlDoc){var node=xmlDoc.createElement("mn");return node.setAttribute("class","drip_placeholder_box"),node.setAttribute("style","border:1px dotted black; padding:1px;background-color: #cccccc;color: #cccccc;"),node.textContent="8",node}})},"mathEditor/View":function(){define("mathEditor/View",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/event","dojo/dom","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/on","dojo/aspect","mathEditor/Model","mathEditor/layer/Cursor","mathEditor/lang"],function(declare,lang,array,event,dom,domStyle,domClass,domConstruct,domGeom,on,aspect,Model,Cursor,dripLang){var ELEMENT=1,TEXT=3;return declare("mathEditor.View",null,{model:null,editorDiv:null,parentNode:null,textarea:null,readOnly:!1,focused:!1,constructor:function(options){lang.mixin(this,options);var style={"border-radius":"3px",height:"100%",width:"100%",border:"solid 1px #CCC",position:"absolute",cursor:"text"},editorDiv=this.editorDiv=domConstruct.create("div",{style:style},this.parentNode),textLayer=this.textLayer=domConstruct.create("div",{"class":"drip_layer drip_text"},editorDiv),cursor=this.cursor=new Cursor({parentEl:editorDiv});on(editorDiv,"mousedown",lang.hitch(this,this._onMouseDownHandler)),textLayer.innerHTML=this.model.getHTML(),aspect.after(this.model,"onChange",lang.hitch(this,this._onChange))},_onMouseDownHandler:function(e){0,this._focus(),event.stop(e)},_focus:function(){if(this.focused==0){this.focused=!0;var textarea=this.textarea,cursor=this.cursor;domClass.add(this.editorDiv,"drip_editor_focus"),setTimeout(function(){textarea.focus(),cursor.show()})}},_onChange:function(){this.textLayer.innerHTML=this.model.getHTML(),MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.textLayer]),MathJax.Hub.Queue(lang.hitch(this,this.showCursor))},blur:function(){this.focused==1&&(this.focused=!1,domClass.remove(this.editorDiv,"drip_editor_focus"),this.cursor.hide())},showCursor:function(){0,0;var cursorConfig=this._getCursorConfig();this.cursor.move(cursorConfig),this.textarea?domStyle.set(this.textarea,{top:cursorConfig.top+"px",left:cursorConfig.left+"px"}):0},moveLeft:function(){this.model.moveLeft(),this.showCursor()},_getFocusInfo:function(){var pathes=this.model.path,focusDomNode=this.textLayer,elementJax=null,mrowNode=null;return array.forEach(pathes,function(path,index){if(path.nodeName=="root")return;if(path.nodeName=="line")focusDomNode=focusDomNode.childNodes[path.offset-1];else if(path.nodeName=="text"||path.nodeName=="math"){var childNodes=focusDomNode.childNodes,filtered=array.filter(childNodes,function(node,i){return node.nodeName.toLowerCase()=="span"});focusDomNode=filtered[path.offset-1];if(path.nodeName=="math"){var scriptNode=focusDomNode.nextSibling;elementJax=scriptNode.MathJax.elementJax.root}}else elementJax&&(dripLang.isMathTokenName(path.nodeName)?elementJax=elementJax.data[0]:elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID),domClass.contains(focusDomNode,"mstyle")?path!="mstyle"&&(elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID)):domClass.contains(focusDomNode,"mrow")&&(mrowNode=focusDomNode,path!="mrow"&&(elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID))))}),{node:focusDomNode,offset:this.model.getOffset(),mrowNode:mrowNode}},_getCursorConfig:function(){var top=0,left=0,height=0,width=0,focusInfo=this._getFocusInfo(),node=focusInfo.node,offset=focusInfo.offset,textLayerPosition=this.getTextLayerPosition(),mrowNode=focusInfo.mrowNode;if(mrowNode){var mrowPosition=domGeom.position(mrowNode);top=mrowPosition.y-textLayerPosition.y,height=mrowPosition.h;var position=domGeom.position(node);left=position.x-textLayerPosition.x}else{var position=domGeom.position(node);top=position.y-textLayerPosition.y,height=position.h,left=position.x-textLayerPosition.x}if(node.nodeType==ELEMENT){var childNodes=node.childNodes;if(childNodes.length==1&&childNodes[0].nodeType==TEXT)if(node.textContent.length==offset)left+=node.offsetWidth;else{var text=node.textContent.substring(0,offset),width=dripLang.measureTextSize(node,text).width;left+=width}}return{top:top,left:left,height:height,width:width}},getCursorPosition:function(){var textLayerPosition=this.getTextLayerPosition(),x=textLayerPosition.x,y=textLayerPosition.y,cursorConfig=this.cursor.getCursorConfig();return x+=cursorConfig.left,y+=cursorConfig.top+cursorConfig.height,{x:x,y:y}},getTextLayerPosition:function(){return this.textLayerPosition||(this.textLayerPosition=domGeom.position(this.textLayer)),this.textLayerPosition}})})},"mathEditor/layer/Cursor":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/dom-geometry"],function(declare,lang,domConstruct,domClass,domStyle,domGeom){return declare("mathEditor.layer.Cursor",null,{parentEl:null,caret:null,isVisible:!1,cursorConfig:{top:0,left:0},constructor:function(kwArgs){lang.mixin(this,kwArgs);var caret=this.caret=domConstruct.create("div",{"class":"drip_cursor"},this.parentEl);caret.style.visibility="hidden",this.defaultHeight=caret.clientHeight,this.cursorConfig.height=this.defaultHeight},show:function(){this.isVisible=!0,this.caret.style.visibility="",this._restartTimer()},move:function(cursorConfig){if(this.isVisible==0)return;this.cursorConfig=cursorConfig;var top=cursorConfig.top,left=cursorConfig.left,height=cursorConfig.height,style=this.caret.style;style.top=top+"px",style.left=left+"px",height&&height>0&&(style.height=height+"px"),this.caret.style.visibility="",this._restartTimer()},getCursorConfig:function(){return this.cursorConfig},hide:function(){this.caret.style.visibility="hidden",this.isVisible=!1,clearInterval(this.intervalId),this.intervalId=null,clearTimeout(this.timeoutId),this.timeoutId=null},_restartTimer:function(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=null);var caret=this.caret,self=this;this.intervalId=setInterval(function(){caret.style.visibility="hidden",self.timeoutId=setTimeout(function(){caret.style.visibility="",0},400)},1e3)},destroy:function(){this.intervalId!=null&&clearInterval(this.intervalId),domConstruct.destroy(this.caret)}})})},"mathEditor/ContentAssist":function(){define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/on","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dijit/popup","dijit/DropDownMenu","dijit/MenuItem","mathEditor/mathContentAssist"],function(declare,array,lang,on,domConstruct,domClass,domStyle,popup,DropDownMenu,MenuItem,mathContentAssist){return declare("mathEditor.ContentAssist",DropDownMenu,{proposals:null,view:null,cacheString:"",opened:!1,postCreate:function(){this.inherited(arguments),on(this.view.editorDiv,"mousedown",lang.hitch(this,function(e){this.opened&&popup.close(this)}))},startup:function(){this.inherited(arguments)},_scheduleOpen:function(target,x,y){view=this.view;var self=this;this._openTimer||(this._openTimer=this.defer(function(){delete this._openTimer,popup.open({popup:target,x:x,y:y,onExecute:function(){popup.close(target),view.focus(),self.opened=!1},onCancel:function(){popup.close(target),self.opened=!1,view.focus()},onClose:function(){view.focus(),self.opened=!1}}),this.opened=!0,target.select()},0))},_open:function(){var cursorPosition=this.view.getCursorPosition(),x=cursorPosition.x,y=cursorPosition.y;this._scheduleOpen(this,x,y)},_clear:function(){var children=this.getChildren();array.forEach(children,lang.hitch(this,function(child,index){this.removeChild(child)}))},_setProposals:function(proposals){this._clear(),this.proposals=proposals,array.forEach(proposals,lang.hitch(this,function(jsonObject,index){var menuItem=new MenuItem({label:jsonObject.label,iconClass:jsonObject.iconClass});menuItem.on("click",lang.hitch(this,this._onApplyProposal,jsonObject.map,jsonObject.nodeName)),this.addChild(menuItem)}))},show:function(data){this.opened==0?this.cacheString=data:this.cacheString+=data;var proposals=mathContentAssist.getProposals(this.cacheString);this._setProposals(proposals);if(proposals.length>0){this._open();var result=proposals[0].map;return result}return this.cacheString="",this.opened&&(popup.close(this),this.opened=!1),null},_onApplyProposal:function(data,nodeName,evt){this.apply(data,nodeName,this.cacheString.length,evt)},apply:function(data,nodeName,cacheCount,evt){0},enter:function(evt){this.onItemClick(this.selectedChild,evt)},select:function(){this.selectFirstChild()},selectFirstChild:function(){this.selectChild(this._getFirstSelectableChild())},selectPrev:function(){this.selectChild(this._getNextSelectableChild(this.selectedChild,-1),!0)},selectNext:function(){this.selectChild(this._getNextSelectableChild(this.selectedChild,1))},_getFirstSelectableChild:function(){return this._getNextSelectableChild(null,1)},_getLastFocusableChild:function(){return this._getNextSelectableChild(null,-1)},_getNextSelectableChild:function(child,dir){child&&(child=this._getSiblingOfChild(child,dir));var children=this.getChildren();for(var i=0;i<children.length;i++){child||(child=children[dir>0?0:children.length-1]);if(child.isFocusable())return child;child=this._getSiblingOfChild(child,dir)}return null},selectChild:function(widget,last){if(!widget)return;this.selectedChild&&widget!==this.selectedChild&&this.selectedChild._setSelected(!1),this.selectedChild=widget,widget._setSelected(!0)}})})},"dijit/popup":function(){define("dijit/popup",["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/dom","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/has","dojo/keys","dojo/_base/lang","dojo/on","./place","./BackgroundIframe","./main"],function(array,aspect,declare,dom,domAttr,domConstruct,domGeometry,domStyle,has,keys,lang,on,place,BackgroundIframe,dijit){function destroyWrapper(){this._popupWrapper&&(domConstruct.destroy(this._popupWrapper),delete this._popupWrapper)}var PopupManager=declare(null,{_stack:[],_beginZIndex:1e3,_idGen:1,_createWrapper:function(widget){var wrapper=widget._popupWrapper,node=widget.domNode;if(!wrapper){wrapper=domConstruct.create("div",{"class":"dijitPopup",style:{display:"none"},role:"region","aria-label":widget["aria-label"]||widget.label||widget.name||widget.id},widget.ownerDocumentBody),wrapper.appendChild(node);var s=node.style;s.display="",s.visibility="",s.position="",s.top="0px",widget._popupWrapper=wrapper,aspect.after(widget,"destroy",destroyWrapper,!0)}return wrapper},moveOffScreen:function(widget){var wrapper=this._createWrapper(widget);domStyle.set(wrapper,{visibility:"hidden",top:"-9999px",display:""})},hide:function(widget){var wrapper=this._createWrapper(widget);domStyle.set(wrapper,"display","none")},getTopPopup:function(){var stack=this._stack;for(var pi=stack.length-1;pi>0&&stack[pi].parent===stack[pi-1].widget;pi--);return stack[pi]},open:function(args){var stack=this._stack,widget=args.popup,orient=args.orient||["below","below-alt","above","above-alt"],ltr=args.parent?args.parent.isLeftToRight():domGeometry.isBodyLtr(widget.ownerDocument),around=args.around,id=args.around&&args.around.id?args.around.id+"_dropdown":"popup_"+this._idGen++;while(stack.length&&(!args.parent||!dom.isDescendant(args.parent.domNode,stack[stack.length-1].widget.domNode)))this.close(stack[stack.length-1].widget);var wrapper=this._createWrapper(widget);domAttr.set(wrapper,{id:id,style:{zIndex:this._beginZIndex+stack.length},"class":"dijitPopup "+(widget.baseClass||widget["class"]||"").split(" ")[0]+"Popup",dijitPopupParent:args.parent?args.parent.id:""}),has("config-bgIframe")&&!widget.bgIframe&&(widget.bgIframe=new BackgroundIframe(wrapper));var layoutFunc=widget.orient?lang.hitch(widget,"orient"):null,best=around?place.around(wrapper,around,orient,ltr,layoutFunc):place.at(wrapper,args,orient=="R"?["TR","BR","TL","BL"]:["TL","BL","TR","BR"],args.padding,layoutFunc);wrapper.style.display="",wrapper.style.visibility="visible",widget.domNode.style.visibility="visible";var handlers=[];return handlers.push(on(wrapper,"keydown",lang.hitch(this,function(evt){if(evt.keyCode==keys.ESCAPE&&args.onCancel)evt.stopPropagation(),evt.preventDefault(),args.onCancel();else if(evt.keyCode==keys.TAB){evt.stopPropagation(),evt.preventDefault();var topPopup=this.getTopPopup();topPopup&&topPopup.onCancel&&topPopup.onCancel()}}))),widget.onCancel&&args.onCancel&&handlers.push(widget.on("cancel",args.onCancel)),handlers.push(widget.on(widget.onExecute?"execute":"change",lang.hitch(this,function(){var topPopup=this.getTopPopup();topPopup&&topPopup.onExecute&&topPopup.onExecute()}))),stack.push({widget:widget,parent:args.parent,onExecute:args.onExecute,onCancel:args.onCancel,onClose:args.onClose,handlers:handlers}),widget.onOpen&&widget.onOpen(best),best},close:function(popup){var stack=this._stack;while(popup&&array.some(stack,function(elem){return elem.widget==popup})||!popup&&stack.length){var top=stack.pop(),widget=top.widget,onClose=top.onClose;widget.onClose&&widget.onClose();var h;while(h=top.handlers.pop())h.remove();widget&&widget.domNode&&this.hide(widget),onClose&&onClose()}}});return dijit.popup=new PopupManager})},"dijit/place":function(){define("dijit/place",["dojo/_base/array","dojo/dom-geometry","dojo/dom-style","dojo/_base/kernel","dojo/_base/window","dojo/window","./main"],function(array,domGeometry,domStyle,kernel,win,winUtils,dijit){function _place(node,choices,layoutNode,aroundNodeCoords){var view=winUtils.getBox(node.ownerDocument);(!node.parentNode||String(node.parentNode.tagName).toLowerCase()!="body")&&win.body(node.ownerDocument).appendChild(node);var best=null;array.some(choices,function(choice){var corner=choice.corner,pos=choice.pos,overflow=0,spaceAvailable={w:{L:view.l+view.w-pos.x,R:pos.x-view.l,M:view.w}[corner.charAt(1)],h:{T:view.t+view.h-pos.y,B:pos.y-view.t,M:view.h}[corner.charAt(0)]},s=node.style;s.left=s.right="auto";if(layoutNode){var res=layoutNode(node,choice.aroundCorner,corner,spaceAvailable,aroundNodeCoords);overflow=typeof res=="undefined"?0:res}var style=node.style,oldDisplay=style.display,oldVis=style.visibility;style.display=="none"&&(style.visibility="hidden",style.display="");var bb=domGeometry.position(node);style.display=oldDisplay,style.visibility=oldVis;var startXpos={L:pos.x,R:pos.x-bb.w,M:Math.max(view.l,Math.min(view.l+view.w,pos.x+(bb.w>>1))-bb.w)}[corner.charAt(1)],startYpos={T:pos.y,B:pos.y-bb.h,M:Math.max(view.t,Math.min(view.t+view.h,pos.y+(bb.h>>1))-bb.h)}[corner.charAt(0)],startX=Math.max(view.l,startXpos),startY=Math.max(view.t,startYpos),endX=Math.min(view.l+view.w,startXpos+bb.w),endY=Math.min(view.t+view.h,startYpos+bb.h),width=endX-startX,height=endY-startY;overflow+=bb.w-width+(bb.h-height);if(best==null||overflow<best.overflow)best={corner:corner,aroundCorner:choice.aroundCorner,x:startX,y:startY,w:width,h:height,overflow:overflow,spaceAvailable:spaceAvailable};return!overflow}),best.overflow&&layoutNode&&layoutNode(node,best.aroundCorner,best.corner,best.spaceAvailable,aroundNodeCoords);var l=domGeometry.isBodyLtr(node.ownerDocument),top=best.y,side=l?best.x:view.w-best.x-best.w;/relative|absolute/.test(domStyle.get(win.body(node.ownerDocument),"position"))&&(top-=domStyle.get(win.body(node.ownerDocument),"marginTop"),side-=(l?1:-1)*domStyle.get(win.body(node.ownerDocument),l?"marginLeft":"marginRight"));var s=node.style;return s.top=top+"px",s[l?"left":"right"]=side+"px",s[l?"right":"left"]="auto",best}var reverse={TL:"BR",TR:"BL",BL:"TR",BR:"TL"},place={at:function(node,pos,corners,padding,layoutNode){var choices=array.map(corners,function(corner){var c={corner:corner,aroundCorner:reverse[corner],pos:{x:pos.x,y:pos.y}};return padding&&(c.pos.x+=corner.charAt(1)=="L"?padding.x:-padding.x,c.pos.y+=corner.charAt(0)=="T"?padding.y:-padding.y),c});return _place(node,choices,layoutNode)},around:function(node,anchor,positions,leftToRight,layoutNode){function push(aroundCorner,corner){choices.push({aroundCorner:aroundCorner,corner:corner,pos:{x:{L:x,R:x+width,M:x+(width>>1)}[aroundCorner.charAt(1)],y:{T:y,B:y+height,M:y+(height>>1)}[aroundCorner.charAt(0)]}})}var aroundNodePos=typeof anchor=="string"||"offsetWidth"in anchor?domGeometry.position(anchor,!0):anchor;if(anchor.parentNode){var sawPosAbsolute=domStyle.getComputedStyle(anchor).position=="absolute",parent=anchor.parentNode;while(parent&&parent.nodeType==1&&parent.nodeName!="BODY"){var parentPos=domGeometry.position(parent,!0),pcs=domStyle.getComputedStyle(parent);/relative|absolute/.test(pcs.position)&&(sawPosAbsolute=!1);if(!sawPosAbsolute&&/hidden|auto|scroll/.test(pcs.overflow)){var bottomYCoord=Math.min(aroundNodePos.y+aroundNodePos.h,parentPos.y+parentPos.h),rightXCoord=Math.min(aroundNodePos.x+aroundNodePos.w,parentPos.x+parentPos.w);aroundNodePos.x=Math.max(aroundNodePos.x,parentPos.x),aroundNodePos.y=Math.max(aroundNodePos.y,parentPos.y),aroundNodePos.h=bottomYCoord-aroundNodePos.y,aroundNodePos.w=rightXCoord-aroundNodePos.x}pcs.position=="absolute"&&(sawPosAbsolute=!0),parent=parent.parentNode}}var x=aroundNodePos.x,y=aroundNodePos.y,width="w"in aroundNodePos?aroundNodePos.w:aroundNodePos.w=aroundNodePos.width,height="h"in aroundNodePos?aroundNodePos.h:(kernel.deprecated("place.around: dijit/place.__Rectangle: { x:"+x+", y:"+y+", height:"+aroundNodePos.height+", width:"+width+" } has been deprecated.  Please use { x:"+x+", y:"+y+", h:"+aroundNodePos.height+", w:"+width+" }","","2.0"),aroundNodePos.h=aroundNodePos.height),choices=[];array.forEach(positions,function(pos){var ltr=leftToRight;switch(pos){case"above-centered":push("TM","BM");break;case"below-centered":push("BM","TM");break;case"after-centered":ltr=!ltr;case"before-centered":push(ltr?"ML":"MR",ltr?"MR":"ML");break;case"after":ltr=!ltr;case"before":push(ltr?"TL":"TR",ltr?"TR":"TL"),push(ltr?"BL":"BR",ltr?"BR":"BL");break;case"below-alt":ltr=!ltr;case"below":push(ltr?"BL":"BR",ltr?"TL":"TR"),push(ltr?"BR":"BL",ltr?"TR":"TL");break;case"above-alt":ltr=!ltr;case"above":push(ltr?"TL":"TR",ltr?"BL":"BR"),push(ltr?"TR":"TL",ltr?"BR":"BL");break;default:push(pos.aroundCorner,pos.corner)}});var position=_place(node,choices,layoutNode,{w:width,h:height});return position.aroundNodePos=aroundNodePos,position}};return dijit.place=place})},"dijit/BackgroundIframe":function(){define("dijit/BackgroundIframe",["require","./main","dojo/_base/config","dojo/dom-construct","dojo/dom-style","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window"],function(require,dijit,config,domConstruct,domStyle,lang,on,has,win){has.add("config-bgIframe",!has("touch"));var _frames=new function(){var queue=[];this.pop=function(){var iframe;if(queue.length)iframe=queue.pop(),iframe.style.display="";else{if(has("ie")<9){var burl=config.dojoBlankHtmlUrl||require.toUrl("dojo/resources/blank.html")||'javascript:""',html="<iframe src='"+burl+"' role='presentation'"+" style='position: absolute; left: 0px; top: 0px;"+'z-index: -1; filter:Alpha(Opacity="0");\'>';iframe=win.doc.createElement(html)}else iframe=domConstruct.create("iframe"),iframe.src='javascript:""',iframe.className="dijitBackgroundIframe",iframe.setAttribute("role","presentation"),domStyle.set(iframe,"opacity",.1);iframe.tabIndex=-1}return iframe},this.push=function(iframe){iframe.style.display="none",queue.push(iframe)}};return dijit.BackgroundIframe=function(node){if(!node.id)throw new Error("no id");if(has("config-bgIframe")){var iframe=this.iframe=_frames.pop();node.appendChild(iframe),has("ie")<7||has("quirks")?(this.resize(node),this._conn=on(node,"resize",lang.hitch(this,function(){this.resize(node)}))):domStyle.set(iframe,{width:"100%",height:"100%"})}},lang.extend(dijit.BackgroundIframe,{resize:function(node){this.iframe&&domStyle.set(this.iframe,{width:node.offsetWidth+"px",height:node.offsetHeight+"px"})},destroy:function(){this._conn&&(this._conn.remove(),this._conn=null),this.iframe&&(_frames.push(this.iframe),delete this.iframe)}}),dijit.BackgroundIframe})},"dijit/DropDownMenu":function(){require({cache:{"url:dijit/templates/Menu.html":'<table class="dijit dijitMenu dijitMenuPassive dijitReset dijitMenuTable" role="menu" tabIndex="${tabIndex}"\n	   data-dojo-attach-event="onkeydown:_onKeyDown" cellspacing="0">\n	<tbody class="dijitReset" data-dojo-attach-point="containerNode"></tbody>\n</table>\n'}}),define("dijit/DropDownMenu",["dojo/_base/declare","dojo/keys","dojo/text!./templates/Menu.html","./_OnDijitClickMixin","./_MenuBase"],function(declare,keys,template,_OnDijitClickMixin,_MenuBase){return declare("dijit.DropDownMenu",[_MenuBase,_OnDijitClickMixin],{templateString:template,baseClass:"dijitMenu",postCreate:function(){this.inherited(arguments);var l=this.isLeftToRight();this._openSubMenuKey=l?keys.RIGHT_ARROW:keys.LEFT_ARROW,this._closeSubMenuKey=l?keys.LEFT_ARROW:keys.RIGHT_ARROW,this.connectKeyNavHandlers([keys.UP_ARROW],[keys.DOWN_ARROW])},_onKeyDown:function(evt){if(evt.ctrlKey||evt.altKey)return;switch(evt.keyCode){case this._openSubMenuKey:this._moveToPopup(evt),evt.stopPropagation(),evt.preventDefault();break;case this._closeSubMenuKey:this.parentMenu?this.parentMenu._isMenuBar?this.parentMenu.focusPrev():this.onCancel(!1):(evt.stopPropagation(),evt.preventDefault())}}})})},"url:dijit/templates/Menu.html":'<table class="dijit dijitMenu dijitMenuPassive dijitReset dijitMenuTable" role="menu" tabIndex="${tabIndex}"\n	   data-dojo-attach-event="onkeydown:_onKeyDown" cellspacing="0">\n	<tbody class="dijitReset" data-dojo-attach-point="containerNode"></tbody>\n</table>\n',"dijit/_MenuBase":function(){define("dijit/_MenuBase",["dojo/_base/array","dojo/_base/declare","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/_base/lang","dojo/mouse","dojo/on","dojo/window","./a11yclick","./popup","./registry","./_Widget","./_CssStateMixin","./_KeyNavContainer","./_TemplatedMixin"],function(array,declare,dom,domAttr,domClass,lang,mouse,on,winUtils,a11yclick,pm,registry,_Widget,_CssStateMixin,_KeyNavContainer,_TemplatedMixin){return declare("dijit._MenuBase",[_Widget,_TemplatedMixin,_KeyNavContainer,_CssStateMixin],{parentMenu:null,popupDelay:500,autoFocus:!1,childSelector:function(node){var widget=registry.byNode(node);return node.parentNode==this.containerNode&&widget&&widget.focus},postCreate:function(){var self=this,matches=typeof this.childSelector=="string"?this.childSelector:lang.hitch(this,"childSelector");this.own(on(this.containerNode,on.selector(matches,mouse.enter),function(){self.onItemHover(registry.byNode(this))}),on(this.containerNode,on.selector(matches,mouse.leave),function(){self.onItemUnhover(registry.byNode(this))}),on(this.containerNode,on.selector(matches,a11yclick),function(evt){self.onItemClick(registry.byNode(this),evt),evt.stopPropagation(),evt.preventDefault()})),this.inherited(arguments)},onKeyboardSearch:function(item,evt,searchString,numMatches){this.inherited(arguments),!!item&&(numMatches==-1||!!item.popup&&numMatches==1)&&this.onItemClick(item,evt)},_keyboardSearchCompare:function(item,searchString){return item.shortcutKey?searchString==item.shortcutKey.toLowerCase()?-1:0:this.inherited(arguments)?1:0},onExecute:function(){},onCancel:function(){},_moveToPopup:function(evt){if(this.focusedChild&&this.focusedChild.popup&&!this.focusedChild.disabled)this.onItemClick(this.focusedChild,evt);else{var topMenu=this._getTopMenu();topMenu&&topMenu._isMenuBar&&topMenu.focusNext()}},_onPopupHover:function(){if(this.currentPopup&&this.currentPopup._pendingClose_timer){var parentMenu=this.currentPopup.parentMenu;parentMenu.focusedChild&&parentMenu.focusedChild._setSelected(!1),parentMenu.focusedChild=this.currentPopup.from_item,parentMenu.focusedChild._setSelected(!0),this._stopPendingCloseTimer(this.currentPopup)}},onItemHover:function(item){this.isActive&&(this.focusChild(item),item.popup&&!item.disabled&&!this.hover_timer&&(this.hover_timer=this.defer(lang.hitch(this,"_openPopup",item),this.popupDelay))),this.focusedChild&&this.focusChild(item),this._hoveredChild=item,item._set("hovering",!0)},_onChildBlur:function(item){this._stopPopupTimer(),item._setSelected(!1);var itemPopup=item.popup;itemPopup&&(this._stopPendingCloseTimer(itemPopup),itemPopup._pendingClose_timer=this.defer(function(){itemPopup._pendingClose_timer=null,itemPopup.parentMenu&&(itemPopup.parentMenu.currentPopup=null),pm.close(itemPopup)},this.popupDelay))},onItemUnhover:function(item){this.isActive&&this._stopPopupTimer(),this._hoveredChild==item&&(this._hoveredChild=null),item._set("hovering",!1)},_stopPopupTimer:function(){this.hover_timer&&(this.hover_timer=this.hover_timer.remove())},_stopPendingCloseTimer:function(popup){popup._pendingClose_timer&&(popup._pendingClose_timer=popup._pendingClose_timer.remove())},_stopFocusTimer:function(){this._focus_timer&&(this._focus_timer=this._focus_timer.remove())},_getTopMenu:function(){for(var top=this;top.parentMenu;top=top.parentMenu);return top},onItemClick:function(item,evt){typeof this.isShowingNow=="undefined"&&this._markActive(),this.focusChild(item);if(item.disabled)return!1;item.popup?this._openPopup(item,/^key/.test(evt.type)):(this.onExecute(),item._onClick?item._onClick(evt):item.onClick(evt))},_openPopup:function(from_item,focus){this._stopPopupTimer();var popup=from_item.popup;if(!popup.isShowingNow){this.currentPopup&&(this._stopPendingCloseTimer(this.currentPopup),pm.close(this.currentPopup)),popup.parentMenu=this,popup.from_item=from_item;var self=this;pm.open({parent:this,popup:popup,around:from_item.domNode,orient:this._orient||["after","before"],onCancel:function(){self.focusChild(from_item),self._cleanUp(),from_item._setSelected(!0),self.focusedChild=from_item},onExecute:lang.hitch(this,"_cleanUp")}),this.currentPopup=popup,popup.connect(popup.domNode,"onmouseenter",lang.hitch(self,"_onPopupHover"))}focus&&popup.focus&&(popup._focus_timer=this.defer(lang.hitch(popup,function(){this._focus_timer=null,this.focus()})))},_markActive:function(){this.isActive=!0,domClass.replace(this.domNode,"dijitMenuActive","dijitMenuPassive")},onOpen:function(){this.isShowingNow=!0,this._markActive()},_markInactive:function(){this.isActive=!1,domClass.replace(this.domNode,"dijitMenuPassive","dijitMenuActive")},onClose:function(){this._stopFocusTimer(),this._markInactive(),this.isShowingNow=!1,this.parentMenu=null},_closeChild:function(){this._stopPopupTimer(),this.currentPopup&&(array.indexOf(this._focusManager.activeStack,this.id)>=0&&(domAttr.set(this.focusedChild.focusNode,"tabIndex",this.tabIndex),this.focusedChild.focusNode.focus()),pm.close(this.currentPopup),this.currentPopup=null),this.focusedChild&&(this.focusedChild._setSelected(!1),this.onItemUnhover(this.focusedChild)),domAttr.set(this.domNode,"tabIndex",this.tabIndex),this.focusedChild&&(this.focusedChild.set("tabIndex","-1"),this._set("focusedChild",null))},_onItemFocus:function(item){this._hoveredChild&&this._hoveredChild!=item&&this.onItemUnhover(this._hoveredChild)},_onBlur:function(){this._cleanUp(),this.inherited(arguments)},_cleanUp:function(){this._closeChild(),typeof this.isShowingNow=="undefined"&&this._markInactive()}})})},"dijit/_KeyNavContainer":function(){define("dijit/_KeyNavContainer",["dojo/_base/array","dojo/_base/declare","dojo/dom-attr","dojo/_base/kernel","dojo/keys","dojo/_base/lang","./registry","./_Container","./_FocusMixin","./_KeyNavMixin"],function(array,declare,domAttr,kernel,keys,lang,registry,_Container,_FocusMixin,_KeyNavMixin){return declare("dijit._KeyNavContainer",[_FocusMixin,_Container,_KeyNavMixin],{connectKeyNavHandlers:function(prevKeyCodes,nextKeyCodes){var keyCodes=this._keyNavCodes={},prev=lang.hitch(this,"focusPrev"),next=lang.hitch(this,"focusNext");array.forEach(prevKeyCodes,function(code){keyCodes[code]=prev}),array.forEach(nextKeyCodes,function(code){keyCodes[code]=next}),keyCodes[keys.HOME]=lang.hitch(this,"focusFirstChild"),keyCodes[keys.END]=lang.hitch(this,"focusLastChild")},startupKeyNavChildren:function(){kernel.deprecated("startupKeyNavChildren() call no longer needed","","2.0")},startup:function(){this.inherited(arguments),array.forEach(this.getChildren(),lang.hitch(this,"_startupChild"))},addChild:function(widget,insertIndex){this.inherited(arguments),this._startupChild(widget)},_startupChild:function(widget){widget.set("tabIndex","-1")},_getFirstFocusableChild:function(){return this._getNextFocusableChild(null,1)},_getLastFocusableChild:function(){return this._getNextFocusableChild(null,-1)},focusFirstChild:function(){this.focusChild(this._getFirstFocusableChild())},focusLastChild:function(){this.focusChild(this._getLastFocusableChild())},focusNext:function(){this.focusChild(this._getNextFocusableChild(this.focusedChild,1))},focusPrev:function(){this.focusChild(this._getNextFocusableChild(this.focusedChild,-1),!0)},_getNextFocusableChild:function(child,dir){child&&(child=this._getSiblingOfChild(child,dir));var children=this.getChildren();for(var i=0;i<children.length;i++){child||(child=children[dir>0?0:children.length-1]);if(child.isFocusable())return child;child=this._getSiblingOfChild(child,dir)}return null},childSelector:function(node){var node=registry.byNode(node);return node&&node.getParent()==this}})})},"dijit/_Container":function(){define("dijit/_Container",["dojo/_base/array","dojo/_base/declare","dojo/dom-construct"],function(array,declare,domConstruct){return declare("dijit._Container",null,{buildRendering:function(){this.inherited(arguments),this.containerNode||(this.containerNode=this.domNode)},addChild:function(widget,insertIndex){var refNode=this.containerNode;if(insertIndex>0){refNode=refNode.firstChild;while(insertIndex>0)refNode.nodeType==1&&insertIndex--,refNode=refNode.nextSibling;refNode?insertIndex="before":(refNode=this.containerNode,insertIndex="last")}domConstruct.place(widget.domNode,refNode,insertIndex),this._started&&!widget._started&&widget.startup()},removeChild:function(widget){typeof widget=="number"&&(widget=this.getChildren()[widget]);if(widget){var node=widget.domNode;node&&node.parentNode&&node.parentNode.removeChild(node)}},hasChildren:function(){return this.getChildren().length>0},_getSiblingOfChild:function(child,dir){var children=this.getChildren(),idx=array.indexOf(this.getChildren(),child);return children[idx+dir]},getIndexOfChild:function(child){return array.indexOf(this.getChildren(),child)}})})},"dijit/_KeyNavMixin":function(){define("dijit/_KeyNavMixin",["dojo/_base/array","dojo/_base/declare","dojo/dom-attr","dojo/keys","dojo/_base/lang","dojo/on","dijit/registry","dijit/_FocusMixin"],function(array,declare,domAttr,keys,lang,on,registry,_FocusMixin){return declare("dijit._KeyNavMixin",_FocusMixin,{tabIndex:"0",childSelector:null,postCreate:function(){this.inherited(arguments),domAttr.set(this.domNode,"tabIndex",this.tabIndex);if(!this._keyNavCodes){var keyCodes=this._keyNavCodes={};keyCodes[keys.HOME]=lang.hitch(this,"focusFirstChild"),keyCodes[keys.END]=lang.hitch(this,"focusLastChild"),keyCodes[this.isLeftToRight()?keys.LEFT_ARROW:keys.RIGHT_ARROW]=lang.hitch(this,"_onLeftArrow"),keyCodes[this.isLeftToRight()?keys.RIGHT_ARROW:keys.LEFT_ARROW]=lang.hitch(this,"_onRightArrow"),keyCodes[keys.UP_ARROW]=lang.hitch(this,"_onUpArrow"),keyCodes[keys.DOWN_ARROW]=lang.hitch(this,"_onDownArrow")}var self=this,childSelector=typeof this.childSelector=="string"?this.childSelector:lang.hitch(this,"childSelector");this.own(on(this.domNode,"keypress",lang.hitch(this,"_onContainerKeypress")),on(this.domNode,"keydown",lang.hitch(this,"_onContainerKeydown")),on(this.domNode,"focus",lang.hitch(this,"_onContainerFocus")),on(this.containerNode,on.selector(childSelector,"focusin"),function(evt){self._onChildFocus(registry.getEnclosingWidget(this),evt)}))},_onLeftArrow:function(){},_onRightArrow:function(){},_onUpArrow:function(){},_onDownArrow:function(){},focus:function(){this.focusFirstChild()},focusFirstChild:function(){},focusLastChild:function(){},focusChild:function(widget,last){if(!widget)return;this.focusedChild&&widget!==this.focusedChild&&this._onChildBlur(this.focusedChild),widget.set("tabIndex",this.tabIndex),widget.focus(last?"end":"start")},_onContainerFocus:function(evt){if(evt.target!==this.domNode||this.focusedChild)return;this.focusFirstChild()},_onFocus:function(){domAttr.set(this.domNode,"tabIndex","-1"),this.inherited(arguments)},_onBlur:function(evt){domAttr.set(this.domNode,"tabIndex",this.tabIndex),this.focusedChild&&(this.focusedChild.set("tabIndex","-1"),this._set("focusedChild",null)),this.inherited(arguments)},_onChildFocus:function(child){child&&child!=this.focusedChild&&(this.focusedChild&&!this.focusedChild._destroyed&&this.focusedChild.set("tabIndex","-1"),child.set("tabIndex",this.tabIndex),this.lastFocused=child,this._set("focusedChild",child))},_searchString:"",multiCharSearchDuration:1e3,onKeyboardSearch:function(item,evt,searchString,numMatches){item&&this.focusChild(item)},_keyboardSearchCompare:function(item,searchString){var element=item.domNode,text=item.label||(element.focusNode?element.focusNode.label:"")||element.innerText||element.textContent||"",currentString=text.replace(/^\s+/,"").substr(0,searchString.length).toLowerCase();return!searchString.length||currentString!=searchString?0:-1},_onContainerKeydown:function(evt){var func=this._keyNavCodes[evt.keyCode];func&&(func(evt,this.focusedChild),evt.stopPropagation(),evt.preventDefault(),this._searchString="")},_onContainerKeypress:function(evt){if(evt.charCode<=32)return;if(evt.ctrlKey||evt.altKey)return;var matchedItem=null,searchString,numMatches=0,search=lang.hitch(this,function(){this._searchTimer&&this._searchTimer.remove(),this._searchString+=keyChar;var allSameLetter=/^(.)\1*$/.test(this._searchString),searchLen=allSameLetter?1:this._searchString.length;searchString=this._searchString.substr(0,searchLen),this._searchTimer=this.defer(function(){this._searchTimer=null,this._searchString=""},this.multiCharSearchDuration);var currentItem=this.focusedChild||null;if(searchLen==1||!currentItem){currentItem=this._getNextFocusableChild(currentItem,1);if(!currentItem)return}var stop=currentItem;do{var rc=this._keyboardSearchCompare(currentItem,searchString);!!rc&&numMatches++==0&&(matchedItem=currentItem);if(rc==-1){numMatches=-1;break}currentItem=this._getNextFocusableChild(currentItem,1)}while(currentItem!=stop)}),keyChar=String.fromCharCode(evt.charCode).toLowerCase();search(),this.onKeyboardSearch(matchedItem,evt,searchString,numMatches)},_onChildBlur:function(){},_getNextFocusableChild:function(child){return null}})})},"dijit/MenuItem":function(){require({cache:{"url:dijit/templates/MenuItem.html":'<tr class="dijitReset dijitMenuItem" data-dojo-attach-point="focusNode" role="menuitem" tabIndex="-1">\n	<td class="dijitReset dijitMenuItemIconCell" role="presentation">\n		<img src="${_blankGif}" alt="" class="dijitIcon dijitMenuItemIcon" data-dojo-attach-point="iconNode"/>\n	</td>\n	<td class="dijitReset dijitMenuItemLabel" colspan="2" data-dojo-attach-point="containerNode,textDirNode"></td>\n	<td class="dijitReset dijitMenuItemAccelKey" style="display: none" data-dojo-attach-point="accelKeyNode"></td>\n	<td class="dijitReset dijitMenuArrowCell" role="presentation">\n		<div data-dojo-attach-point="arrowWrapper" style="visibility: hidden">\n			<img src="${_blankGif}" alt="" class="dijitMenuExpand"/>\n			<span class="dijitMenuExpandA11y">+</span>\n		</div>\n	</td>\n</tr>\n'}}),define("dijit/MenuItem",["dojo/_base/declare","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/_base/kernel","dojo/sniff","dojo/_base/lang","./_Widget","./_TemplatedMixin","./_Contained","./_CssStateMixin","dojo/text!./templates/MenuItem.html"],function(declare,dom,domAttr,domClass,kernel,has,lang,_Widget,_TemplatedMixin,_Contained,_CssStateMixin,template){var MenuItem=declare("dijit.MenuItem"+(has("dojo-bidi")?"_NoBidi":""),[_Widget,_TemplatedMixin,_Contained,_CssStateMixin],{templateString:template,baseClass:"dijitMenuItem",label:"",_setLabelAttr:function(val){this._set("label",val);var shortcutKey="",text,ndx=val.search(/{\S}/);if(ndx>=0){shortcutKey=val.charAt(ndx+1);var prefix=val.substr(0,ndx),suffix=val.substr(ndx+3);text=prefix+shortcutKey+suffix,val=prefix+'<span class="dijitMenuItemShortcutKey">'+shortcutKey+"</span>"+suffix}else text=val;this.domNode.setAttribute("aria-label",text+" "+this.accelKey),this.containerNode.innerHTML=val,this._set("shortcutKey",shortcutKey)},iconClass:"dijitNoIcon",_setIconClassAttr:{node:"iconNode",type:"class"},accelKey:"",disabled:!1,_fillContent:function(source){source&&!("label"in this.params)&&this._set("label",source.innerHTML)},buildRendering:function(){this.inherited(arguments);var label=this.id+"_text";domAttr.set(this.containerNode,"id",label),this.accelKeyNode&&domAttr.set(this.accelKeyNode,"id",this.id+"_accel"),dom.setSelectable(this.domNode,!1)},onClick:function(){},focus:function(){try{has("ie")==8&&this.containerNode.focus(),this.focusNode.focus()}catch(e){}},_onFocus:function(){this._setSelected(!0),this.getParent()._onItemFocus(this),this.inherited(arguments)},_setSelected:function(selected){domClass.toggle(this.domNode,"dijitMenuItemSelected",selected)},setLabel:function(content){kernel.deprecated("dijit.MenuItem.setLabel() is deprecated.  Use set('label', ...) instead.","","2.0"),this.set("label",content)},setDisabled:function(disabled){kernel.deprecated("dijit.Menu.setDisabled() is deprecated.  Use set('disabled', bool) instead.","","2.0"),this.set("disabled",disabled)},_setDisabledAttr:function(value){this.focusNode.setAttribute("aria-disabled",value?"true":"false"),this._set("disabled",value)},_setAccelKeyAttr:function(value){this.accelKeyNode&&(this.accelKeyNode.style.display=value?"":"none",this.accelKeyNode.innerHTML=value,domAttr.set(this.containerNode,"colSpan",value?"1":"2")),this._set("accelKey",value)}});return has("dojo-bidi")&&(MenuItem=declare("dijit.MenuItem",MenuItem,{_setLabelAttr:function(val){this.inherited(arguments),this.textDir==="auto"&&this.applyTextDir(this.textDirNode)}})),MenuItem})},"dijit/_Contained":function(){define("dijit/_Contained",["dojo/_base/declare","./registry"],function(declare,registry){return declare("dijit._Contained",null,{_getSibling:function(which){var node=this.domNode;do node=node[which+"Sibling"];while(node&&node.nodeType!=1);return node&&registry.byNode(node)},getPreviousSibling:function(){return this._getSibling("previous")},getNextSibling:function(){return this._getSibling("next")},getIndexInParent:function(){var p=this.getParent();return!p||!p.getIndexOfChild?-1:p.getIndexOfChild(this)}})})},"url:dijit/templates/MenuItem.html":'<tr class="dijitReset dijitMenuItem" data-dojo-attach-point="focusNode" role="menuitem" tabIndex="-1">\n	<td class="dijitReset dijitMenuItemIconCell" role="presentation">\n		<img src="${_blankGif}" alt="" class="dijitIcon dijitMenuItemIcon" data-dojo-attach-point="iconNode"/>\n	</td>\n	<td class="dijitReset dijitMenuItemLabel" colspan="2" data-dojo-attach-point="containerNode,textDirNode"></td>\n	<td class="dijitReset dijitMenuItemAccelKey" style="display: none" data-dojo-attach-point="accelKeyNode"></td>\n	<td class="dijitReset dijitMenuArrowCell" role="presentation">\n		<div data-dojo-attach-point="arrowWrapper" style="visibility: hidden">\n			<img src="${_blankGif}" alt="" class="dijitMenuExpand"/>\n			<span class="dijitMenuExpandA11y">+</span>\n		</div>\n	</td>\n</tr>\n',"mathEditor/mathContentAssist":function(){define(["dojo/_base/array"],function(array){return{keywords:[{input:"/",map:"&#xF7;",nodeName:"mo",freq:0,label:"除号",iconClass:"drip_equation_icon drip_division"},{input:"/",map:"/",nodeName:"text",freq:0,label:"/",iconClass:""},{input:"/",map:"",nodeName:"mfrac",freq:0,label:"分数",iconClass:"drip_equation_icon drip_frac"},{input:"*",map:"&#xD7;",nodeName:"mo",freq:0,label:"乘号",iconClass:"drip_equation_icon drip_multiplication"},{input:"*",map:"*",nodeName:"text",freq:0,label:"*",iconClass:""}],getProposals:function(prefix){return array.filter(this.keywords,function(data,index,array){return data.input.indexOf(prefix)==0})}}})}}}),define("mathEditor/Editor",["dojo/_base/declare","dojo/_base/lang","dojo/_base/event","dijit/_WidgetBase","dojo/on","dojo/sniff","dojo/keys","dojo/aspect","dojo/dom-construct","dojo/dom-style","dojo/dom-class","mathEditor/Model","mathEditor/View","mathEditor/ContentAssist"],function(declare,lang,event,_WidgetBase,on,sniff,keys,aspect,domConstruct,domStyle,domClass,Model,View,ContentAssist){return declare("mathEditor.Editor",[_WidgetBase],{model:null,view:null,textarea:null,value:"",_getValueAttr:function(){return this.model.getXML()},_setValueAttr:function(value){this.model.clear(),value&&value!=""&&this.model.setData({data:value})},postCreate:function(){this.inherited(arguments),domStyle.set(this.domNode,{position:"relative"});var textarea=this.textarea=domConstruct.create("textarea",{style:{position:"absolute"}},this.domNode);domClass.add(textarea,"drip_text_input"),textarea.wrap="off",textarea.autocorrect="off",textarea.autocapitalize="off",textarea.spellcheck=!1;var model=this.model=new Model;this.view=new View({model:this.model,parentNode:this.domNode,textarea:this.textarea});var contentAssist=this.contentAssist=new ContentAssist({view:this.view});aspect.after(contentAssist,"apply",function(input,nodeName,cacheCount,event){model.setData({data:input,nodeName:nodeName,removeCount:cacheCount}),setTimeout(function(){textarea.value=""})},!0);if(sniff("chrome"))0,on(textarea,"textInput",lang.hitch(this,function(e){var inputData=e.data;this._onTextInput(inputData)}));else{0;var inCompostion=!1;on(textarea,"input",lang.hitch(this,function(e){if(inCompostion)return;inputData=textarea.value;if(inputData=="")return;this._onTextInput(inputData)})),on(textarea,"compositionstart",lang.hitch(this,function(e){inCompostion=!0})),on(textarea,"compositionend",lang.hitch(this,function(e){inCompostion=!1}))}on(textarea,"blur",lang.hitch(this,function(e){this.view.blur()})),on(textarea,"keydown",lang.hitch(this,function(e){0,e.keyCode===keys.LEFT_ARROW?(this.model.moveLeft(),this.view.showCursor()):e.keyCode===keys.RIGHT_ARROW?this.model.moveRight():e.keyCode===keys.UP_ARROW?this.contentAssist.opened?this.contentAssist.selectPrev():this.model.moveUp():e.keyCode===keys.DOWN_ARROW?this.contentAssist.opened?this.contentAssist.selectNext():this.model.moveDown():e.keyCode===keys.BACKSPACE?this.model.doDelete():e.altKey&&e.keyCode===191?(this.contentAssist.open(),event.stop(e)):e.keyCode===keys.ENTER&&(this.contentAssist.opened?this.contentAssist.enter(e):this.model.setData({data:"\n"}),event.stop(e))}))},_onTextInput:function(inputData){var adviceData=this.contentAssist.show(inputData);adviceData!=null&&(inputData=adviceData);var model=this.model;model.setData({data:inputData});var textarea=this.textarea;setTimeout(function(){textarea.value=""})}})})