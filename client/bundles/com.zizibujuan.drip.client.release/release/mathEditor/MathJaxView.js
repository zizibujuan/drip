//>>built
define("mathEditor/MathJaxView","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/event dojo/_base/window dojo/dom dojo/dom-style dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/on dojo/aspect mathEditor/Model mathEditor/layer/Cursor mathEditor/lang mathEditor/dom".split(" "),function(r,m,s,t,u,v,f,p,n,l,w,x,A,y,q,z){return r("mathEditor.MathJaxView",null,{model:null,contentDiv:null,parentNode:null,textarea:null,readOnly:!1,mathBound:null,focused:!1,hScrollBarAlwaysVisible:!1,
paddingTop:0,paddingLeft:0,borderWidth:0,constructor:function(a){m.mixin(this,a);a={position:"absolute",height:"100%",width:"100%"};this.hScrollBarAlwaysVisible?a["overflow-x"]="scroll":a.overflow="auto";debugger;a=this.scrollerDiv=n.create("div",{style:a},this.parentNode);var c=this.contentDiv=n.create("div",{style:{position:"absolute",cursor:"text"}},a);this.scrollbarWidth=z.scrollbarWidth();f.set(c,{width:a.clientWidth-this.paddingRight+"px",height:a.clientHeight-this.paddingTop+"px",paddingTop:this.paddingTop+
"px",paddingRight:this.paddingRight+"px"});this.minHeight=c.clientHeight;this.minWidth=a.clientWidth;var b=this.textLayer=n.create("div",{"class":"drip_layer drip_text"},c);f.set(b,"width",a.clientWidth-this.paddingRight+"px");this.cursor=new y({parentEl:c});w(this.parentNode,"mousedown",m.hitch(this,this._onMouseDownHandler));b.innerHTML=this.model.getHTML();x.after(this.model,"onChanged",m.hitch(this,this._onModelChanged))},_onMouseDownHandler:function(a){this.focus();t.stop(a)},focus:function(){if(!1==
this.focused){this.focused=!0;var a=this.textarea,c=this.cursor;p.add(this.parentNode,"drip_editor_focus");setTimeout(function(){a.focus();c.show()},0)}},blur:function(){!0==this.focused&&(this.focused=!1,p.remove(this.parentNode,"drip_editor_focus"),this.cursor.hide())},switchInputMode:function(){this.model.switchMode();this.model.onChanged()},_onModelChanged:function(){this.asyncRender();this.asyncShowCursor()},asyncRender:function(){debugger;this.textLayer.innerHTML=this.model.getHTML();this._asyncExecute(["Typeset",
MathJax.Hub,this.textLayer])},_asyncExecute:function(a){MathJax.Hub.Queue(a)},asyncShowCursor:function(){this._asyncExecute(m.hitch(this,this.showCursor))},showCursor:function(){debugger;this._autoHeight();this._scrollToLeft();var a=this._getFocusInfo(),c=this._getCursorConfig(a);this.cursor.move(c);this.textarea&&f.set(this.textarea,{top:c.top+"px",left:c.left+"px"});if(this.model.isMathMLMode()){var c=l.position(a.mathNodeContainer),a=this._getMathBound(),c={left:c.x+"px",top:c.y+"px",width:c.w+
"px",height:c.h+"px"},b=this.model.getFocusNode();c["background-color"]="math"===b.nodeName&&0===b.childElementCount?"rgb(204, 203, 203)":"";f.set(a,c)}else a=this._getMathBound(),f.set(a,{left:"-10000px"})},_autoHeight:function(){var a=this.contentDiv,c=this.scrollerDiv;if(a.scrollHeight>a.clientHeight){debugger;var b=a.scrollHeight+"px";f.set(this.parentNode,"height",a.scrollHeight+"px");f.set(c,"height",b);f.set(a,"height",a.scrollHeight-this.paddingTop+"px");c.clientHeight<a.clientHeight&&f.set(c,
{height:a.scrollHeight+this.scrollbarWidth+"px"})}else if(!(a.clientHeight<=this.minHeight)){for(var b=this.textLayer.childNodes,h=b.length,d=0,e=0;e<h;e++)d+=b[e].clientHeight;a.clientHeight>d&&(b=d+this.scrollbarWidth+1+"px",f.set(a,"height",d+"px"),f.set(c,"height",b),f.set(this.parentNode,"height",b))}},_scrollToLeft:function(){var a=this.contentDiv,c=this.scrollerDiv;if(0<a.scrollWidth-a.clientWidth)c.scrollLeft+=a.scrollWidth-a.clientWidth,f.set(a,"width",a.scrollWidth+"px");else if(!(a.scrollWidth<=
this.minWidth)){for(var b=this.textLayer.childNodes,h=b.length,d=this.minWidth,e=0,e=null,g=0;g<h;g++)0<b[g].childElementCount&&(e=b[g].lastChild,e=e.offsetLeft+e.offsetWidth,e>d&&(d=e));f.set(a,"width",d+"px");c.scrollLeft=a.scrollWidth-this.minWidth}},_getMathBound:function(){if(this.mathBound)return this.mathBound;this.mathBound=n.create("div",null,u.body());f.set(this.mathBound,{position:"absolute",border:"solid 1px green","z-index":"-1"});return this.mathBound},moveLeft:function(){this.model.moveLeft();
this.showCursor()},_getFocusInfo:function(){var a=this.textLayer,c=null,b=null,f=null;s.forEach(this.model.path,function(b,d){if("root"!=b.nodeName)if("line"==b.nodeName)a=a.childNodes[b.offset-1];else if("text"==b.nodeName){var k=a.childNodes;a=k[b.offset-1]}else"math"==b.nodeName?(k=a.childNodes,f=k[b.offset-1],c=f.lastChild.MathJax.elementJax.root,c=c.data[0]):c&&(c=c.data[b.offset-1],c.displaystyle&&(c=c.data[0],c=c.data[0]),q.containsInferredMrow(b.nodeName)&&(c=c.data[0]))});c&&(a=v.byId("MathJax-Span-"+
c.spanID));var d=this.model.getOffset(),b=this.model.getFocusNode();"mo"==this.model.getFocusNode().nodeName&&0!=d&&(d=b.textContent.length);b=null;"mrow"===a.parentNode.className&&(b=a.parentNode);return{node:a,offset:d,mrowNode:b,mathNodeContainer:f}},_getCursorConfig:function(a){var c=0,b=0,h=0,d=0,e=a.node,g=a.offset,k=null,b=this.getTextLayerPosition();(c=a.mrowNode)?(h=l.position(c),c=h.y-b.y+this.paddingTop,h=h.h,k=l.position(e)):(k=l.position(e),c=k.y-b.y+this.paddingTop,h=k.h);b=k.x-b.x;
1==e.nodeType&&(a=e.childNodes,1==a.length&&3==a[0].nodeType?e.textContent.length==g?b+=e.offsetWidth:(d=0,g=e.textContent.substring(0,g),""!=g&&(d=f.get(e,"padding-left"),b+=Math.floor(d),d=q.measureTextSize(e,g).width),b+=d):0!=g&&(b+=k.w));b+=this.scrollerDiv.scrollLeft;return{top:c,left:b,height:h,width:d}},getCursorPosition:function(){var a=this.getTextLayerPosition(),c=a.x,a=a.y,b=this.cursor.getCursorConfig(),c=c+b.left,a=a+(b.top+b.height);return{x:c,y:a}},getTextLayerPosition:function(){this.textLayerPosition||
(this.textLayerPosition=l.position(this.textLayer));return this.textLayerPosition}})});
//@ sourceMappingURL=MathJaxView.js.map