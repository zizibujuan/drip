//>>built
define("mathEditor/MathJaxView","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/event dojo/_base/window dojo/dom dojo/dom-style dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/on dojo/aspect mathEditor/Model mathEditor/layer/Cursor mathEditor/lang mathEditor/dom".split(" "),function(r,n,s,t,u,v,d,q,p,m,w,x,z,y,l,A){return r("mathEditor.MathJaxView",null,{model:null,contentDiv:null,parentNode:null,textarea:null,readOnly:!1,mathBound:null,focused:!1,hScrollBarAlwaysVisible:!1,
paddingTop:0,paddingRight:0,borderWidth:0,editorWidth:0,constructor:function(a){n.mixin(this,a);a={position:"absolute",height:"100%",width:this.editorWidth+"px"};this.hScrollBarAlwaysVisible?a["overflow-x"]="scroll":(a["overflow-x"]="auto",a["overflow-y"]="visible");a=this.scrollerDiv=p.create("div",{style:a,"class":"scroller"},this.parentNode);a=this.contentDiv=p.create("div",{style:{position:"absolute",cursor:"text"},"class":"content"},a);var b=this.textLayer=p.create("div",{"class":"drip_layer drip_text"},
a);this.cursor=new y({parentEl:a});w(this.parentNode,"mousedown",n.hitch(this,this._onMouseDownHandler));b.innerHTML=this.model.getHTML();x.after(this.model,"onChanged",n.hitch(this,this._onModelChanged))},resize:function(a){this.borderWidth=a;a=this.contentDiv;var b=this.scrollerDiv,c=this.textLayer;this.minHeight=a.clientHeight;this.minWidth=b.clientWidth;d.set(a,{width:b.clientWidth-this.paddingRight+"px",height:b.clientHeight-this.paddingTop+"px",paddingTop:this.paddingTop+"px",paddingRight:this.paddingRight+
"px"});d.set(c,"width",b.clientWidth-this.paddingRight+"px")},_onMouseDownHandler:function(a){this.focus();t.stop(a)},focus:function(){if(!1==this.focused){this.focused=!0;var a=this.textarea,b=this.cursor;q.add(this.parentNode,"drip_editor_focus");setTimeout(function(){a.focus();b.show()},0)}},blur:function(){!0==this.focused&&(this.focused=!1,q.remove(this.parentNode,"drip_editor_focus"),this.cursor.hide())},switchInputMode:function(){this.model.switchMode();this.model.onChanged()},_onModelChanged:function(){this.asyncRender();
this.asyncShowCursor()},asyncRender:function(){this.textLayer.innerHTML=this.model.getHTML();this._asyncExecute(["Typeset",MathJax.Hub,this.textLayer])},_asyncExecute:function(a){MathJax.Hub.Queue(a)},asyncShowCursor:function(){this._asyncExecute(n.hitch(this,this.showCursor))},showCursor:function(){this._autoHeight();this._scrollToLeft();var a=this._getFocusInfo(),b=this._getCursorConfig(a);this.cursor.move(b);this.textarea&&d.set(this.textarea,{top:b.top+"px",left:b.left+"px"});if(this.model.isMathMLMode()){var b=
m.position(a.mathNodeContainer),a=this._getMathBound(),b={left:b.x+"px",top:b.y+"px",width:b.w+"px",height:b.h+"px"},c=this.model.getFocusNode();"math"===c.nodeName&&0===l.getChildLength(c)?b["background-color"]="rgb(204, 203, 203)":b["background-color"]="";d.set(a,b)}else a=this._getMathBound(),d.set(a,{left:"-10000px"})},_autoHeight:function(){var a=this.contentDiv,b=this.scrollerDiv;if(a.scrollHeight>a.clientHeight){var c=a.scrollHeight+"px";d.set(this.parentNode,"height",a.scrollHeight+"px");
d.set(b,"height",c);d.set(a,"height",a.scrollHeight-this.paddingTop+"px");b.clientHeight<a.clientHeight&&(d.set(b,{height:a.scrollHeight+this.scrollbarWidth+"px"}),d.set(b,{height:a.scrollHeight+"px"}))}else if(!(a.clientHeight<=this.minHeight)){for(var c=this.textLayer.childNodes,k=c.length,e=0,f=0;f<k;f++)e+=c[f].clientHeight;a.clientHeight>e&&(c=e+this.scrollbarWidth+1+"px",d.set(a,"height",e+"px"),d.set(b,"height",c),d.set(this.parentNode,"height",c))}},_scrollToLeft:function(){var a=this.contentDiv,
b=this.scrollerDiv;if(0<a.scrollWidth-a.clientWidth)b.scrollLeft+=a.scrollWidth-a.clientWidth+4,d.set(a,"width",a.scrollWidth+"px"),d.set(b,"height",a.scrollHeight+this.scrollbarWidth+"px");else if(!(a.scrollWidth<=this.minWidth)){for(var c=this.textLayer.childNodes,k=c.length,e=this.minWidth,f=0,f=null,h=0;h<k;h++)0<l.getChildLength(c[h])&&(f=c[h].lastChild,f=f.offsetLeft+f.offsetWidth,f>e&&(e=f));d.set(a,"width",e+"px");b.scrollLeft=a.scrollWidth-this.minWidth}},_getMathBound:function(){if(this.mathBound)return this.mathBound;
this.mathBound=p.create("div",null,u.body());d.set(this.mathBound,{position:"absolute",border:"solid 1px green","z-index":"-1"});return this.mathBound},moveLeft:function(){this.model.moveLeft();this.showCursor()},_getFocusInfo:function(){var a=this.textLayer,b=null,c=null,d=null;s.forEach(this.model.path,function(c,e){if("root"!=c.nodeName)if("line"==c.nodeName)a=a.childNodes[c.offset-1];else if("text"==c.nodeName){var g=a.childNodes;a=g[c.offset-1]}else"math"==c.nodeName?(g=a.childNodes,d=g[c.offset-
1],b=d.lastChild.MathJax.elementJax.root,b=b.data[0]):b&&(b=b.data[c.offset-1],b.displaystyle&&(b=b.data[0],b=b.data[0]),l.containsInferredMrow(c.nodeName)&&(b=b.data[0]))});b&&(a=v.byId("MathJax-Span-"+b.spanID));var e=this.model.getOffset(),c=this.model.getFocusNode();"mo"==this.model.getFocusNode().nodeName&&0!=e&&(e=l.getText(c).length);c=null;"mrow"===a.parentNode.className&&(c=a.parentNode);return{node:a,offset:e,mrowNode:c,mathNodeContainer:d}},_getCursorConfig:function(a){var b=0,c=0,k=0,
e=0,f=a.node,h=a.offset,g=null,c=this.getTextLayerPosition();(b=a.mrowNode)?(k=m.position(b),b=k.y-c.y+this.paddingTop,k=k.h,g=m.position(f)):(g=m.position(f),b=g.y-c.y+this.paddingTop,k=g.h);c=g.x-c.x;1==f.nodeType&&(a=f.childNodes,1==a.length&&3==a[0].nodeType?(g=l.getText(f),g.length==h?c+=f.offsetWidth:(e=0,h=g.substring(0,h),""!=h&&(e=d.get(f,"padding-left"),c+=Math.floor(e),e=l.measureTextSize(f,h).width),c+=e)):0!=h&&(c+=g.w));c+=this.scrollerDiv.scrollLeft;return{top:b,left:c,height:k,width:e}},
getCursorPosition:function(){var a=this.getTextLayerPosition(),b=a.x,a=a.y,c=this.cursor.getCursorConfig(),b=b+c.left,a=a+(c.top+c.height);return{x:b,y:a}},getTextLayerPosition:function(){this.textLayerPosition||(this.textLayerPosition=m.position(this.textLayer));return this.textLayerPosition}})});
//@ sourceMappingURL=MathJaxView.js.map