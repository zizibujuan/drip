//>>built
define("mathEditor/MathJaxView","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/event dojo/_base/window dojo/dom dojo/dom-style dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/on dojo/aspect mathEditor/Model mathEditor/layer/Cursor mathEditor/lang mathEditor/dom".split(" "),function(r,m,s,t,u,v,f,p,n,l,w,x,A,y,q,z){return r("mathEditor.MathJaxView",null,{model:null,contentDiv:null,parentNode:null,textarea:null,readOnly:!1,mathBound:null,focused:!1,_scrollable:!1,constructor:function(a){m.mixin(this,
a);var c=this.scrollerDiv=n.create("div",{style:{position:"absolute",height:"100%",width:"100%","overflow-x":"scroll"}},this.parentNode);a=this.contentDiv=n.create("div",{style:{position:"absolute",cursor:"text"}},c);var b=this.scrollbarWidth=z.scrollbarWidth();f.set(a,{width:c.clientWidth-b+"px",height:c.clientHeight+"px"});this.minHeight=a.clientHeight;this.minWidth=c.clientWidth-b;c=this.textLayer=n.create("div",{"class":"drip_layer drip_text"},a);this.cursor=new y({parentEl:a});w(this.parentNode,
"mousedown",m.hitch(this,this._onMouseDownHandler));c.innerHTML=this.model.getHTML();x.after(this.model,"onChanged",m.hitch(this,this._onModelChanged))},_onMouseDownHandler:function(a){this.focus();t.stop(a)},focus:function(){if(!1==this.focused){this.focused=!0;var a=this.textarea,c=this.cursor;p.add(this.parentNode,"drip_editor_focus");setTimeout(function(){a.focus();c.show()},0)}},blur:function(){!0==this.focused&&(this.focused=!1,p.remove(this.parentNode,"drip_editor_focus"),this.cursor.hide())},
_onModelChanged:function(){this.asyncRender();this.asyncShowCursor()},asyncRender:function(){this.textLayer.innerHTML=this.model.getHTML();this._asyncExecute(["Typeset",MathJax.Hub,this.textLayer])},_asyncExecute:function(a){MathJax.Hub.Queue(a)},asyncShowCursor:function(){this._asyncExecute(m.hitch(this,this.showCursor))},showCursor:function(){this._autoHeight();this._scrollToLeft();var a=this._getFocusInfo(),c=this._getCursorConfig(a);this.cursor.move(c);this.textarea&&f.set(this.textarea,{top:c.top+
"px",left:c.left+"px"});if(this.model.isMathMLMode()){var c=l.position(a.mathNodeContainer),a=this._getMathBound(),c={left:c.x+"px",top:c.y+"px",width:c.w+"px",height:c.h+"px"},b=this.model.getFocusNode();c["background-color"]="math"===b.nodeName&&0===b.childElementCount?"rgb(204, 203, 203)":"";f.set(a,c)}else a=this._getMathBound(),f.set(a,{left:"-10000px"})},_autoHeight:function(){var a=this.contentDiv,c=this.scrollerDiv;if(a.scrollHeight>a.clientHeight){var b=a.scrollHeight+"px",d=a.scrollHeight+
this.scrollbarWidth+"px";f.set(this.parentNode,"height",d);f.set(c,"height",d);f.set(a,"height",b)}else if(!(a.clientHeight<=this.minHeight)){for(var d=this.textLayer.childNodes,g=d.length,e=b=0;e<g;e++)b+=d[e].clientHeight;a.clientHeight>b&&(d=b+this.scrollbarWidth+1+"px",f.set(a,"height",b+"px"),f.set(c,"height",d),f.set(this.parentNode,"height",d))}},_scrollToLeft:function(){var a=this.contentDiv,c=this.scrollerDiv;if(0<a.scrollWidth-a.clientWidth)c.scrollLeft+=a.scrollWidth-a.clientWidth,f.set(a,
"width",a.scrollWidth+"px");else if(!(a.scrollWidth<=this.minWidth)){for(var b=this.textLayer.childNodes,d=b.length,g=this.minWidth,e=0,e=null,h=0;h<d;h++)0<b[h].childElementCount&&(e=b[h].lastChild,e=e.offsetLeft+e.offsetWidth,e>g&&(g=e));f.set(a,"width",g+"px");c.scrollLeft=a.scrollWidth-this.minWidth}},_getMathBound:function(){if(this.mathBound)return this.mathBound;this.mathBound=n.create("div",null,u.body());f.set(this.mathBound,{position:"absolute",border:"solid 1px green","z-index":"-1"});
return this.mathBound},moveLeft:function(){this.model.moveLeft();this.showCursor()},_getFocusInfo:function(){var a=this.textLayer,c=null,b=null,d=null;s.forEach(this.model.path,function(b,g){if("root"!=b.nodeName)if("line"==b.nodeName)a=a.childNodes[b.offset-1];else if("text"==b.nodeName){var f=a.childNodes;a=f[b.offset-1]}else"math"==b.nodeName?(f=a.childNodes,d=f[b.offset-1],c=d.lastChild.MathJax.elementJax.root,c=c.data[0]):c&&(c=c.data[b.offset-1],c.displaystyle&&(c=c.data[0],c=c.data[0]),q.containsInferredMrow(b.nodeName)&&
(c=c.data[0]))});c&&(a=v.byId("MathJax-Span-"+c.spanID));var g=this.model.getOffset(),b=this.model.getFocusNode();"mo"==this.model.getFocusNode().nodeName&&0!=g&&(g=b.textContent.length);b=null;"mrow"===a.parentNode.className&&(b=a.parentNode);return{node:a,offset:g,mrowNode:b,mathNodeContainer:d}},_getCursorConfig:function(a){var c=0,b=0,d=0,g=0,e=a.node,h=a.offset,k=null,b=this.getTextLayerPosition();(c=a.mrowNode)?(d=l.position(c),c=d.y-b.y,d=d.h,k=l.position(e)):(k=l.position(e),c=k.y-b.y,d=k.h);
b=k.x-b.x;1==e.nodeType&&(a=e.childNodes,1==a.length&&3==a[0].nodeType?e.textContent.length==h?b+=e.offsetWidth:(g=0,h=e.textContent.substring(0,h),""!=h&&(g=f.get(e,"padding-left"),b+=Math.floor(g),g=q.measureTextSize(e,h).width),b+=g):0!=h&&(b+=k.w));b+=this.scrollerDiv.scrollLeft;return{top:c,left:b,height:d,width:g}},getCursorPosition:function(){var a=this.getTextLayerPosition(),c=a.x,a=a.y,b=this.cursor.getCursorConfig(),c=c+b.left,a=a+(b.top+b.height);return{x:c,y:a}},getTextLayerPosition:function(){this.textLayerPosition||
(this.textLayerPosition=l.position(this.textLayer));return this.textLayerPosition}})});
//@ sourceMappingURL=MathJaxView.js.map