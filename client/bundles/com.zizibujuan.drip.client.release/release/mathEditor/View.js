//>>built
define("mathEditor/View","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/_base/event,dojo/dom,dojo/dom-style,dojo/dom-class,dojo/dom-construct,dojo/dom-geometry,dojo/on,dojo/aspect,mathEditor/Model,mathEditor/layer/Cursor,mathEditor/lang".split(","),function(o,i,l,p,h,q,j,m,k,r,s,u,t,n){return o("mathEditor.View",null,{model:null,editorDiv:null,parentNode:null,textarea:null,readOnly:!1,focused:!1,constructor:function(b){i.mixin(this,b);var b=this.editorDiv=m.create("div",{style:{"border-radius":"3px",
height:"100%",width:"100%",border:"solid 1px #CCC",position:"absolute",cursor:"text"}},this.parentNode),a=this.textLayer=m.create("div",{"class":"drip_layer drip_text"},b);this.cursor=new t({parentEl:b});r(b,"mousedown",i.hitch(this,this._onMouseDownHandler));a.innerHTML=this.model.getHTML();s.after(this.model,"onChange",i.hitch(this,this._onChange))},_onMouseDownHandler:function(b){this._focus();p.stop(b)},_focus:function(){if(!1==this.focused){this.focused=!0;var b=this.textarea,a=this.cursor;j.add(this.editorDiv,
"drip_editor_focus");setTimeout(function(){b.focus();a.show()},0)}},focus:function(){this._focus()},_onChange:function(){this.model.getHTML();this.textLayer.innerHTML=this.model.getHTML();MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.textLayer]);MathJax.Hub.Queue(i.hitch(this,this.showCursor))},blur:function(){if(!0==this.focused)this.focused=!1,j.remove(this.editorDiv,"drip_editor_focus"),this.cursor.hide()},showCursor:function(){var b=this._getCursorConfig();this.cursor.move(b);this.textarea&&q.set(this.textarea,
{top:b.top+"px",left:b.left+"px"})},moveLeft:function(){this.model.moveLeft();this.showCursor()},_getFocusInfo:function(){var b=this.textLayer,a=null,d=null;l.forEach(this.model.path,function(c){if("root"!=c.nodeName)if("line"==c.nodeName)b=b.childNodes[c.offset-1];else if("text"==c.nodeName||"math"==c.nodeName){if(b=l.filter(b.childNodes,function(a){return"span"==a.nodeName.toLowerCase()})[c.offset-1],"math"==c.nodeName)a=b.nextSibling.MathJax.elementJax.root,a=a.data[0]}else if(a){var e=h.byId("MathJax-Span-"+
a.spanID);if(j.contains(e,"mrow"))if("mrow"!=c.nodeName){var f=h.byId("MathJax-Span-"+a.data[0].spanID);j.contains(f,"mstyle")?"mstyle"!=c.nodeName&&(a=a.data[0],a=a.data[0],a=a.data[c.offset-1],e=h.byId("MathJax-Span-"+a.spanID)):(d=e,a=a.data[c.offset-1],e=h.byId("MathJax-Span-"+a.spanID))}else{debugger;d=e;a=a.data[c.offset-1]}else a=n.isMathTokenName(c.nodeName)?a.data[0]:a.data[c.offset-1];b=h.byId("MathJax-Span-"+a.spanID)}});var g=this.model.getOffset(),f=this.model.getFocusNode();if("mo"==
this.model.getFocusNode().nodeName)g=f.textContent.length;return{node:b,offset:g,mrowNode:d}},_getCursorConfig:function(){var b=0,a=0,d=0,g=0,b=this._getFocusInfo(),f=b.node,c=b.offset,a=this.getTextLayerPosition();if(b=b.mrowNode)var d=k.position(b),b=d.y-a.y,d=d.h,e=k.position(f);else e=k.position(f),b=e.y-a.y,d=e.h;a=e.x-a.x;if(1==f.nodeType&&(e=f.childNodes,1==e.length&&3==e[0].nodeType))if(f.textContent.length==c)a+=f.offsetWidth;else{g=0;c=f.textContent.substring(0,c);if(""!=c)g=n.measureTextSize(f,
c).width;a+=g}return{top:b,left:a,height:d,width:g}},getCursorPosition:function(){var b=this.getTextLayerPosition(),a=b.x,b=b.y,d=this.cursor.getCursorConfig(),a=a+d.left,b=b+(d.top+d.height);return{x:a,y:b}},getTextLayerPosition:function(){if(!this.textLayerPosition)this.textLayerPosition=k.position(this.textLayer);return this.textLayerPosition}})});