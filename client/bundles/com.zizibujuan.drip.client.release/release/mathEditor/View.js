//>>built
define("mathEditor/View",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/event","dojo/dom","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/on","dojo/aspect","mathEditor/Model","mathEditor/layer/Cursor","mathEditor/lang"],function(declare,lang,array,event,dom,domStyle,domClass,domConstruct,domGeom,on,aspect,Model,Cursor,dripLang){var ELEMENT=1,TEXT=3;return declare("mathEditor.View",null,{model:null,editorDiv:null,parentNode:null,textarea:null,readOnly:!1,focused:!1,constructor:function(options){lang.mixin(this,options);var style={"border-radius":"3px",height:"100%",width:"100%",border:"solid 1px #CCC",position:"absolute",cursor:"text"},editorDiv=this.editorDiv=domConstruct.create("div",{style:style},this.parentNode),textLayer=this.textLayer=domConstruct.create("div",{"class":"drip_layer drip_text"},editorDiv),cursor=this.cursor=new Cursor({parentEl:editorDiv});on(editorDiv,"mousedown",lang.hitch(this,this._onMouseDownHandler)),textLayer.innerHTML=this.model.getHTML(),aspect.after(this.model,"onChange",lang.hitch(this,this._onChange))},_onMouseDownHandler:function(e){0,this._focus(),event.stop(e)},_focus:function(){if(this.focused==0){this.focused=!0;var textarea=this.textarea,cursor=this.cursor;domClass.add(this.editorDiv,"drip_editor_focus"),setTimeout(function(){textarea.focus(),cursor.show()})}},_onChange:function(){this.textLayer.innerHTML=this.model.getHTML(),MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.textLayer]),MathJax.Hub.Queue(lang.hitch(this,this.showCursor))},blur:function(){this.focused==1&&(this.focused=!1,domClass.remove(this.editorDiv,"drip_editor_focus"),this.cursor.hide())},showCursor:function(){0,0;var cursorConfig=this._getCursorConfig();this.cursor.move(cursorConfig),this.textarea?domStyle.set(this.textarea,{top:cursorConfig.top+"px",left:cursorConfig.left+"px"}):0},moveLeft:function(){this.model.moveLeft(),this.showCursor()},_getFocusInfo:function(){var pathes=this.model.path,focusDomNode=this.textLayer,elementJax=null,mrowNode=null;return array.forEach(pathes,function(path,index){if(path.nodeName=="root")return;if(path.nodeName=="line")focusDomNode=focusDomNode.childNodes[path.offset-1];else if(path.nodeName=="text"||path.nodeName=="math"){var childNodes=focusDomNode.childNodes,filtered=array.filter(childNodes,function(node,i){return node.nodeName.toLowerCase()=="span"});focusDomNode=filtered[path.offset-1];if(path.nodeName=="math"){var scriptNode=focusDomNode.nextSibling;elementJax=scriptNode.MathJax.elementJax.root}}else elementJax&&(dripLang.isMathTokenName(path.nodeName)?elementJax=elementJax.data[0]:elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID),domClass.contains(focusDomNode,"mstyle")?path!="mstyle"&&(elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID)):domClass.contains(focusDomNode,"mrow")&&(mrowNode=focusDomNode,path!="mrow"&&(elementJax=elementJax.data[path.offset-1],focusDomNode=dom.byId("MathJax-Span-"+elementJax.spanID))))}),{node:focusDomNode,offset:this.model.getOffset(),mrowNode:mrowNode}},_getCursorConfig:function(){var top=0,left=0,height=0,width=0,focusInfo=this._getFocusInfo(),node=focusInfo.node,offset=focusInfo.offset,textLayerPosition=this.getTextLayerPosition(),mrowNode=focusInfo.mrowNode;if(mrowNode){var mrowPosition=domGeom.position(mrowNode);top=mrowPosition.y-textLayerPosition.y,height=mrowPosition.h;var position=domGeom.position(node);left=position.x-textLayerPosition.x}else{var position=domGeom.position(node);top=position.y-textLayerPosition.y,height=position.h,left=position.x-textLayerPosition.x}if(node.nodeType==ELEMENT){var childNodes=node.childNodes;if(childNodes.length==1&&childNodes[0].nodeType==TEXT)if(node.textContent.length==offset)left+=node.offsetWidth;else{var text=node.textContent.substring(0,offset),width=dripLang.measureTextSize(node,text).width;left+=width}}return{top:top,left:left,height:height,width:width}},getCursorPosition:function(){var textLayerPosition=this.getTextLayerPosition(),x=textLayerPosition.x,y=textLayerPosition.y,cursorConfig=this.cursor.getCursorConfig();return x+=cursorConfig.left,y+=cursorConfig.top+cursorConfig.height,{x:x,y:y}},getTextLayerPosition:function(){return this.textLayerPosition||(this.textLayerPosition=domGeom.position(this.textLayer)),this.textLayerPosition}})})