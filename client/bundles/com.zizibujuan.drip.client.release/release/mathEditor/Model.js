//>>built
define("mathEditor/Model","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/dom-construct,dojox/xml/parser,mathEditor/string,mathEditor/dataUtil,mathEditor/lang,mathEditor/xmlUtil".split(","),function(r,p,q,j,o,n,s,i,k){return r(null,{path:null,xmlString:null,doc:null,mode:"text",anchor:null,constructor:function(a){this._init();p.mixin(this,a)},_isTextMode:function(){return"text"===this.mode},_isMathMLMode:function(){return"mathml"===this.mode},_toTextMode:function(){this.mode="text"},_toMathMLMode:function(){this.mode=
"mathml"},_init:function(){this.doc=o.parse("<root><line></line></root>");this.path=[];this.anchor={};this._updateAnchor(this.doc.documentElement.firstChild,0);this._toTextMode();this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1})},clear:function(){this._init();this.onChange()},loadData:function(){},_split:function(a){return a.split(/\r\n|\r|\n/)},insertText:function(a,c){if(!c||0==c.length)return a;var b=a.node,e=a.offset,d=this._split(c),f=d.splice(0,1)[0],g=d.splice(d.length-
1,d.length)[0],h=this.doc;if(this._isLineNode(b)){var j="text",e=h.createElement(j);b.appendChild(e);b=e;e=0;this.path.push({nodeName:j,offset:0})}if(0<f.length){b.textContent=n.insertAtOffset(b.textContent,e,f);e+=f.length;f=this.path.pop();if(0==f.offset)f.offset=1;this.path.push(f)}if(null!=g){var j="line",k=this._getFocusLine();0<d.length&&q.forEach(d,function(b){var a=h.createElement(j);a.textContent=b;i.insertNodeAfter(a,k);k=a});j="line";b=h.createElement(j);i.insertNodeAfter(b,k);0==g.length?
(e=0,this.path.pop(),f=this.path.pop(),this.path.push({nodeName:j,offset:f.offset+1})):(j="text",e=h.createElement(j),e.textContent=g,b.appendChild(e),b=e,e=g.length,this.path.pop(),f=this.path.pop(),f.offset++,this.path.push(f),this.path.push({nodeName:j,offset:1}))}return{node:b,offset:e}},findTrigonometric:function(a,c){for(var b=[],e=[],d=a.node,f=d;f&&"mi"==f.nodeName&&1==f.textContent.length&&!(b.unshift(f.textContent),f=d.previousSibling,2==b.length););if(2==b.length){if(d=b.join("")+c,i.isTrigonometric(d))return{functionName:d,
preMis:b,nextMis:e}}else if(1==b.length){if((d=d.nextSibling)&&"mi"==d.nodeName&&1==d.textContent.length)if(d=b[0]+c+d.textContent,i.isTrigonometric(d))return{functionName:d,preMis:b,nextMis:e}}else if(0==b.length){d=d.nextSibling;for(e=[];d&&"mi"==d.nodeName&&1==d.textContent.length&&!(e.push(d.textContent),d=d.nextSibling,2==e.length););if(2==e.length&&(d=c+e.join(""),i.isTrigonometric(d)))return{functionName:d,preMis:b,nextMis:e}}return null},removeExistTrigonometricPart:function(a,c){var b=a.node,
e=a.offset,d=c.preMis.length;2==d?(e=b.previousSibling.previousSibling,b.parentNode.removeChild(b.previousSibling),b.parentNode.removeChild(b),b=this.path.pop(),b.offset-=2,this.path.push(b),b=e,e="mi"==b.nodeName||"mo"==b.nodeName?1:b.textContent.length):1==d?(e=b.previousSibling,b.parentNode.removeChild(b.nextSibling),b.parentNode.removeChild(b),b=this.path.pop(),b.offset--,this.path.push(b),b=e,e="mi"==b.nodeName||"mo"==b.nodeName?1:b.textContent.length):0==d&&(b.parentNode.removeChild(b.nextSibling),
b.parentNode.removeChild(b.nextSibling),e="mi"==b.nodeName||"mo"==b.nodeName?1:b.textContent.length);return{node:b,offset:e}},insertMi:function(a,c){var b=a.node,e=a.offset,d=this.doc;this._isLineNode(b)?(this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mi",offset:1}),e=d.createElement("math"),d=d.createElement("mi"),d.textContent=c,e.appendChild(d),b.appendChild(e)):(d=d.createElement("mi"),d.textContent=c,0==e?(e=this.path.pop(),this.path.push({nodeName:"mi",offset:e.offset}),
i.insertNodeBefore(d,b)):1==e&&(e=this.path.pop(),this.path.push({nodeName:"mi",offset:e.offset+1}),i.insertNodeAfter(d,b)));return{node:d,offset:1}},insertMn:function(a,c){var b=a.node,e=a.offset,d=this.doc;if(this._isLineNode(b))e=d.createElement("math"),d=d.createElement("mn"),d.textContent=c,e.appendChild(d),b.appendChild(e),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=d,e=c.length;else if(!this._isTextNode(b))b.textContent=n.insertAtOffset(b.textContent,
e,c),e+=c.length;return{node:b,offset:e}},insertMo:function(a,c){var b=a.node,e=a.offset,d=this.doc;this._isLineNode(b)?(e=d.createElement("math"),d=d.createElement("mo"),d.textContent=c,e.appendChild(d),b.appendChild(e),b=d,e=1,this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1})):this._isTextNode(b)?(e=d.createElement("math"),d=d.createElement("mo"),d.textContent=c,e.appendChild(d),i.insertNodeAfter(e,b),b=d,e=1,d=this.path.pop(),this.path.push({nodeName:"math",offset:d.offset+
1}),this.path.push({nodeName:"mo",offset:1})):"="==c&&"mo"==b.nodeName&&"="==b.textContent?b.textContent+="=":"="==c&&"mo"==b.nodeName&&"!"==b.textContent?b.textContent+="=":(d=d.createElement("mo"),d.textContent=c,i.insertNodeAfter(d,b),b=d,e=1,d=this.path.pop(),this.path.push({nodeName:"mo",offset:d.offset+1}));return{node:b,offset:e}},insertTrigonometric:function(a,c,b){var e=a.node,a=a.offset,d=this.doc;if(this._isLineNode(e)||this._isTextNode(e)){this.path.push({nodeName:"math",offset:a+1});
this.path.push({nodeName:"mrow",offset:3});this.path.push({nodeName:"mn",offset:1});var f=d.createElement("math"),b=d.createElement(b),g=d.createElement("mo"),h=d.createElement("mrow"),d=k.getPlaceHolder(d);b.textContent=c;g.textContent="&#x2061;";h.appendChild(d);f.appendChild(b);f.appendChild(g);f.appendChild(h);j.place(f,e,a)}else this.path.push({nodeName:"mrow",offset:this.path.pop().offset+3}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement(b),g=d.createElement("mo"),h=d.createElement("mrow"),
d=k.getPlaceHolder(d),b.textContent=c,g.textContent="&#x2061;",h.appendChild(d),i.insertNodeAfter(b,e),i.insertNodeAfter(g,b),i.insertNodeAfter(h,g);return{node:d,offset:0}},setData:function(a){var c=a.data,b=a.nodeName;if((a=a.removeCount)&&0<a)for(var e=0;e<a;e++)this.removeLeft();if(this._isTextMode())this.anchor=this.insertText(this.anchor,c),this.onChange(c);else{if(this._isMathMLMode()){if(i.isLetter(c)){(a=this.findTrigonometric(this.anchor,c))?(this.anchor=this.removeExistTrigonometricPart(this.anchor,
a),this.anchor=this.insertTrigonometric(this.anchor,a.functionName,b||"mi")):this.anchor=this.insertMi(this.anchor,c);this.onChange(c);return}if(i.isNumber(c)){this.anchor=this.insertMn(this.anchor,c);this.onChange(c);return}if(i.isOperator(c)){this.anchor=this.insertMo(this.anchor,c);this.onChange(c);return}if(i.isTrigonometric(c)){this.anchor=this.insertTrigonometric(this.anchor,c,b);this.onChange(c);return}if(i.isGreekLetter(c)){this.anchor=this.insertMi(this.anchor,c);this.onChange(c);return}}var d=
this.doc,a=this.anchor.node,e=this.anchor.offset;if(b&&""!=b){var f=1,g="last";this._isTextNode(a)&&(f=this.path.pop().offset+1,g="after");if("mfrac"==b)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:f}),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),e=k.createEmptyFrac(d),b.appendChild(e.rootNode),j.place(b,a,g)):(this.path.pop(),this.path.push({nodeName:"mfrac",
offset:f}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,g=f-1,e=k.createFracWithNumerator(d,a),j.place(e.rootNode,c,g)),this._updateAnchor(e.focusNode,0);else if("msup"==b)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:f}),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),e=k.createEmptyMsup(d),b.appendChild(e.rootNode),
j.place(b,a,g)):(this.path.pop(),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,e=k.createMsupWithBase(d,a),j.place(e.rootNode,c,0)),this._updateAnchor(e.focusNode,0);else if("msub"==b)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:f}),this.path.push({nodeName:"msub",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),
e=k.createEmptyMsub(d),b.appendChild(e.rootNode),j.place(b,a,g)):(this.path.pop(),this.path.push({nodeName:"msub",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,e=k.createMsubWithBase(d,a),j.place(e.rootNode,c,0)),this._updateAnchor(e.focusNode,0);else if("msqrt"==b)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:f}),this.path.push({nodeName:"msqrt",offset:1}),this.path.push({nodeName:"mrow",offset:1}),
this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),f=k.createEmptyMsqrt(d),b.appendChild(f.rootNode),j.place(b,a,g)):(this.path.pop(),this.path.push({nodeName:"msqrt",offset:e+1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,f=k.createEmptyMsqrt(d),j.place(f.rootNode,c,e)),this._updateAnchor(f.focusNode,0);else if("mroot"==b)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:f}),this.path.push({nodeName:"mroot",
offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),f=k.createEmptyMroot(d),b.appendChild(f.rootNode),j.place(b,a,g)):(this.path.pop(),this.path.push({nodeName:"mroot",offset:e+1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,f=k.createEmptyMroot(d),j.place(f.rootNode,c,e)),this._updateAnchor(f.focusNode,0);else if("mi"==b&&i.isTrigonometric(c)&&(this._isLineNode(a)||this._isTextNode(a))){this.path.push({nodeName:"math",
offset:e+1});this.path.push({nodeName:"mrow",offset:3});this.path.push({nodeName:"mn",offset:1});var b=d.createElement("math"),h=d.createElement("mi"),o=d.createElement("mo"),g=d.createElement("mrow"),f=k.getPlaceHolder(d);h.textContent=c;o.textContent="&#x2061;";g.appendChild(f);b.appendChild(h);b.appendChild(o);b.appendChild(g);j.place(b,a,e);this._updateAnchor(f,0)}this.onChange()}else if(i.isFenced(c)){if(this._isLineNode(a)||this._isTextNode(a))this.path.push({nodeName:"math",offset:e+1}),this.path.push({nodeName:"mfenced",
offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=d.createElement("math"),h=d.createElement("mfenced"),g={"{":{left:"{",right:"}"},"[":{left:"[",right:"]"},"|":{left:"|",right:"|"}},"("!=c&&(h.setAttribute("open",g[c].left),h.setAttribute("close",g[c].right)),g=d.createElement("mrow"),f=k.getPlaceHolder(d),b.appendChild(h),h.appendChild(g),g.appendChild(f),j.place(b,a,e),this.anchor.node=f,this.anchor.offset=0;this.onChange()}else a=[],p.isString(c)?
a=n.splitData(c):p.isArray(c)&&(a=c),q.forEach(a,p.hitch(this,function(b){var a=this.anchor.node;if(i.isNumber(b)){var c="mn",e=a.nodeName;if("line"==e||"text"==e){var e=this.anchor.offset,f="last",g=1;if(this._isLineNode(a))f="last",g=1;else if(this._isTextNode(a)){this._splitNodeIfNeed();var h=this.path.pop();0<e?(f="after",g=h.offset+1):f="before"}var m=d.createElement("math"),l=d.createElement(c);m.appendChild(l);j.place(m,a,f);this.anchor.node=l;this.anchor.offset=0;this._insertChar(b);this.path.push({nodeName:"math",
offset:g});this.path.push({nodeName:c,offset:1})}else if(i.isMathTokenNode(a)){a=this.anchor.node;k.isPlaceHolder(a)&&k.removePlaceHolder(a);if(a.nodeName!=c)e=d.createElement(c),i.insertNodeAfter(e,a),this.anchor.node=e,this.anchor.offset=0,h=this.path.pop(),this.path.push({nodeName:c,offset:h.offset+1});this._insertChar(b)}}else if(i.isOperator(b)){var c="mo";this._isLineNode(a)?(m=d.createElement("math"),l=d.createElement(c),m.appendChild(l),this._updateAnchor(l,0),this._insertChar(b),this.path.push({nodeName:"math",
offset:1}),this.path.push({nodeName:c,offset:1}),j.place(m,a,e)):i.isMathTokenNode(a)?"="==b&&"mo"==a.nodeName&&"="==a.textContent?a.textContent+="=":"="==b&&"mo"==a.nodeName&&"!"==a.textContent?a.textContent+="=":(l=d.createElement(c),this._updateAnchor(l,0),this._insertChar(b),h=this.path.pop(),this.path.push({nodeName:c,offset:h.offset+1}),i.insertNodeAfter(l,a)):this._isTextNode(a)&&(m=d.createElement("math"),l=d.createElement(c),m.appendChild(l),this._updateAnchor(l,0),this._insertChar(b),h=
this.path.pop(),this.path.push({nodeName:"math",offset:h.offset+1}),this.path.push({nodeName:c,offset:1}),i.insertNodeAfter(m,a))}else if(this._isLineNode(a))f=e,c="text",l=d.createElement(c),this._updateAnchor(l,0),this.path.push({nodeName:c,offset:1}),this._insertChar(b),j.place(l,a,f);else if(this._isTextNode(a))this._insertChar(b);else if(i.isMathTokenNode(a)){do h=this.path.pop();while(h&&"math"!=h.nodeName);c=d.createElement("text");for(m=a;"math"!=m.nodeName;)m=m.parentNode;i.insertNodeAfter(c,
m);this.anchor.node=c;this.anchor.offset=0;this._insertChar(b);this.path.push({nodeName:"text",offset:h.offset+1})}})),this.onChange(c)}},_updateAnchor:function(a,c){this.anchor.node=a;this.anchor.offset=c},doDelete:function(){if(""!=this.removeLeft())this.onChange()},removeLeft:function(){var a=this.anchor.offset,c=this.anchor.node,b=c.textContent;if(0==a){a=c;if("text"!=c.nodeName&&"line"!=c.nodeName){for(;"math"!=a.nodeName;)a=a.parentNode;if(a=a.previousSibling){var c=a.textContent,e=c.length,
b=n.insertAtOffset(c,e,"",1),e=e-1;""==b?(a.parentNode.removeChild(a),this.path.pop()):(a.textContent=b,this.anchor.node=a,this.anchor.offset=e);return e=c.charAt(e)}}else if("line"==c.nodeName&&1<this.getLineCount()){a=c.previousSibling;e=a.childNodes.length;if(0==e)this.anchor.node=a,this.anchor.offset=0,b=this.path.pop(),b.offset--,this.path.push(b),c.parentNode.removeChild(c);else if(a=a.lastChild,"text"==a.nodeName)this.anchor.node=a,this.anchor.offset=a.textContent.length,b=this.path.pop(),
b.offset--,this.path.push(b),this.path.push({nodeName:a.nodeName,offset:e}),c.parentNode.removeChild(c);else if("math"==a.nodeName){var d=a.childNodes.length,a=a.lastChild;this.anchor.node=a;this.anchor.offset=a.textContent.length;b=this.path.pop();b.offset--;this.path.push(b);this.path.push({nodeName:"math",offset:e});this.path.push({nodeName:a.nodeName,offset:d});c.parentNode.removeChild(c)}return"\n"}return""}"mo"==c.nodeName?(e=c.textContent,b=""):(e=b.charAt(a-1),b=n.insertAtOffset(b,a,"",1));
if(""==b)if(a=c.previousSibling)"math"==a.nodeName?(d=a.childNodes.length,a=a.lastChild,this.anchor.node=a,this.anchor.offset=a.textContent.length,b=this.path.pop(),this.path.push({nodeName:"math",offset:b.offset-1}),this.path.push({nodeName:a.nodeName,offset:d}),c.parentNode.removeChild(c)):(this.anchor.node=a,this.anchor.offset=a.textContent.length,c.parentNode.removeChild(c),this.path.push({nodeName:this.anchor.node.nodeName,offset:this.path.pop().offset-1}));else{d=b=c;if("text"!=c.nodeName&&
"line"!=c.nodeName)for(;"math"!=d.nodeName;)b=d.parentNode,b.removeChild(d),d=b,this.path.pop();a=d.previousSibling;b=d.parentNode;b.removeChild(d);c=this.path.pop().offset;a?(this.anchor.node=a,this.anchor.offset=a.textContent.length,this.path.push({nodeName:this.anchor.node.nodeName,offset:c-1})):(this.anchor.node=b,this.anchor.offset=b.childElementCount)}else this.anchor.node.textContent=b,this.anchor.offset-=1;return e},moveLeft:function(){var a=this.anchor.node,c=this.anchor.offset;if("line"==
a.nodeName){if(c=a.previousSibling){c=c.lastChild;if("math"==c.nodeName)c=c.lastChild;a=c.textContent;this.anchor.node=c;this.anchor.offset=a.length}}else if(0<c)this.anchor.offset--;else if(0==c)if(c=a.previousSibling){if("math"==c.nodeName)c=c.lastChild;a=c.textContent;this.anchor.node=c;this.anchor.offset=a.length-1}else if(c=a.parentNode.previousSibling)if("line"==c.nodeName){c=c.lastChild;if("math"==c.nodeName)c=c.lastChild;a=c.textContent;this.anchor.node=c;this.anchor.offset=a.length}else a=
c.textContent,this.anchor.node=c,this.anchor.offset=a.length-1},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},_splitNodeIfNeed:function(){var a=this.anchor.offset,c=this.anchor.node,b=c.textContent,e=b.length;if(0<a&&a<e)e=b.substring(0,a),a=b.substring(a),b=this.doc.createElement(c.nodeName),c.textContent=e,b.textContent=a,i.insertNodeAfter(b,c)},_getFocusLine:function(){for(var a=this.getFocusNode();a&&
"line"!=a.nodeName;)a=a.parentNode;return a},_isNotSameNode:function(a,c){return a==c.nodeName},_isLineNode:function(a){return"line"==a.nodeName},_isTextNode:function(a){return"text"==a.nodeName},_insertChar:function(a){var c=this.anchor.node,b=this.anchor.offset,a=n.insertAtOffset(c.textContent,b,a);c.textContent=a;this._updateAnchor(c,b+1)},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?"":o.innerXML(this.doc)},isEmpty:function(){return""==this.getXML()},getPath:function(){var a=
"";q.forEach(this.path,function(c){a+="/";a+=c.nodeName;c.offset&&(a+="["+c.offset+"]")});return a},getFocusNode:function(){return this.anchor.node},getOffset:function(){return this.anchor.offset},getLineAt:function(a){return this.getLines()[a]},getLines:function(){return this.doc.documentElement.childNodes},getHTML:function(){return s.xmlDocToHtml(this.doc)},onChange:function(){}})});