//>>built
define("mathEditor/Model","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/dom-construct,dojox/xml/parser,mathEditor/string,mathEditor/dataUtil,mathEditor/lang,mathEditor/xmlUtil".split(","),function(r,o,q,k,n,p,s,l,j){return r(null,{path:null,xmlString:null,doc:null,cursorPosition:null,constructor:function(a){this._init();o.mixin(this,a)},_init:function(){this.doc=n.parse("<root><line></line></root>");this.path=[];this.cursorPosition={};this.cursorPosition.node=this.doc.documentElement.firstChild;
this.cursorPosition.offset=0;this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1})},clear:function(){this._init();this.onChange()},loadData:function(){},setData:function(a){var b=a.data,d=a.nodeName;if((a=a.removeCount)&&0<a)for(var c=0;c<a;c++)this.removeLeft();var e=this.doc;this._splitNodeIfNeed();var a=this.cursorPosition.node,f=this.cursorPosition.offset;if(d&&""!=d){var c=1,h="last";this._isTextNode(a)&&(c=this.path.pop().offset+1,h="after");if("mfrac"==d)this._isLineNode(a)||
this._isTextNode(a)?(this.path.push({nodeName:"math",offset:c}),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=e.createElement("math"),f=j.createEmptyFrac(e),c.appendChild(f.rootNode),k.place(c,a,h)):(this.path.pop(),this.path.push({nodeName:"mfrac",offset:c}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=a.parentNode,h=c-1,f=j.createFracWithNumerator(e,a),k.place(f.rootNode,
b,h)),this.cursorPosition.node=f.focusNode,this.cursorPosition.offset=0;else if("msup"==d)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:c}),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=e.createElement("math"),f=j.createEmptyMsup(e),c.appendChild(f.rootNode),k.place(c,a,h)):(this.path.pop(),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",
offset:1}),b=a.parentNode,f=j.createMsupWithBase(e,a),k.place(f.rootNode,b,0)),this.cursorPosition.node=f.focusNode,this.cursorPosition.offset=0;else if("msub"==d)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:c}),this.path.push({nodeName:"msub",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=e.createElement("math"),f=j.createEmptyMsub(e),c.appendChild(f.rootNode),k.place(c,a,h)):(this.path.pop(),this.path.push({nodeName:"msub",
offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=a.parentNode,f=j.createMsubWithBase(e,a),k.place(f.rootNode,b,0)),this.cursorPosition.node=f.focusNode,this.cursorPosition.offset=0;else if("msqrt"==d){if(this._isLineNode(a)||this._isTextNode(a)){this.path.push({nodeName:"math",offset:c});this.path.push({nodeName:"msqrt",offset:1});this.path.push({nodeName:"mrow",offset:1});this.path.push({nodeName:"mn",offset:1});var c=e.createElement("math"),i=j.createEmptyMsqrt(e);
c.appendChild(i.rootNode);k.place(c,a,h)}else this.path.pop(),this.path.push({nodeName:"msqrt",offset:f+1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=a.parentNode,i=j.createEmptyMsqrt(e),k.place(i.rootNode,b,f);this.cursorPosition.node=i.focusNode;this.cursorPosition.offset=0}else if("mroot"==d)this._isLineNode(a)||this._isTextNode(a)?(this.path.push({nodeName:"math",offset:c}),this.path.push({nodeName:"mroot",offset:1}),this.path.push({nodeName:"mrow",
offset:2}),this.path.push({nodeName:"mn",offset:1}),c=e.createElement("math"),i=j.createEmptyMroot(e),c.appendChild(i.rootNode),k.place(c,a,h)):(this.path.pop(),this.path.push({nodeName:"mroot",offset:f+1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=a.parentNode,i=j.createEmptyMroot(e),k.place(i.rootNode,b,f)),this.cursorPosition.node=i.focusNode,this.cursorPosition.offset=0;else if("mi"==d&&/sin|cos|tan|cot/.test(b)&&(this._isLineNode(a)||this._isTextNode(a))){this.path.push({nodeName:"math",
offset:f+1});this.path.push({nodeName:"mrow",offset:3});this.path.push({nodeName:"mn",offset:1});var c=e.createElement("math"),m=e.createElement("mi"),n=e.createElement("mo"),h=e.createElement("mrow"),i=j.getPlaceHolder(e);m.textContent=b;n.textContent="&#x2061;";h.appendChild(i);c.appendChild(m);c.appendChild(n);c.appendChild(h);k.place(c,a,f);this.cursorPosition.node=i;this.cursorPosition.offset=0}this.onChange()}else if(l.isFenced(b)){if(this._isLineNode(a)||this._isTextNode(a))this.path.push({nodeName:"math",
offset:f+1}),this.path.push({nodeName:"mfenced",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=e.createElement("math"),m=e.createElement("mfenced"),h={"{":{left:"{",right:"}"},"[":{left:"[",right:"]"},"|":{left:"|",right:"|"}},"("!=b&&(m.setAttribute("open",h[b].left),m.setAttribute("close",h[b].right)),h=e.createElement("mrow"),i=j.getPlaceHolder(e),c.appendChild(m),m.appendChild(h),h.appendChild(i),k.place(c,a,f),this.cursorPosition.node=i,this.cursorPosition.offset=
0;this.onChange()}else a=[],o.isString(b)?a=p.splitData(b):o.isArray(b)&&(a=b),q.forEach(a,o.hitch(this,function(a){var b=this.cursorPosition.node;if(l.isNumber(a)){d="mn";var c=b.nodeName;if("line"==c||"text"==c){var f=this.cursorPosition.offset,c="last",h=1;if(this._isLineNode(b))c="last",h=1;else if(this._isTextNode(b)){this._splitNodeIfNeed();var g=this.path.pop();0<f?(c="after",h=g.offset+1):c="before"}f=e.createElement("math");g=e.createElement(d);f.appendChild(g);k.place(f,b,c);this.cursorPosition.node=
g;this.cursorPosition.offset=0;this._insertChar(a);this.path.push({nodeName:"math",offset:h});this.path.push({nodeName:d,offset:1})}else if(l.isMathTokenNode(b)){b=this.cursorPosition.node;j.isPlaceHolder(b)&&j.removePlaceHolder(b);if(b.nodeName!=d)g=e.createElement(d),l.insertNodeAfter(g,b),this.cursorPosition.node=g,this.cursorPosition.offset=0,g=this.path.pop(),this.path.push({nodeName:d,offset:g.offset+1});this._insertChar(a)}}else if(l.isOperator(a))if(this._isLineNode(b))f=e.createElement("math"),
b.appendChild(f),g=e.createElement("mo"),f.appendChild(g),this.cursorPosition.node=g,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1});else if(l.isMathTokenNode(b))b=this.cursorPosition.node,c=e.createElement("mo"),l.insertNodeAfter(c,b),this.cursorPosition.node=c,this.cursorPosition.offset=0,this._insertChar(a),g=this.path.pop(),this.path.push({nodeName:"mo",offset:g.offset+1});else{if(this._isTextNode(b))f=e.createElement("math"),
l.insertNodeAfter(f,b),g=e.createElement("mo"),f.appendChild(g),this.cursorPosition.node=g,this.cursorPosition.offset=0,this._insertChar(a),g=this.path.pop(),this.path.push({nodeName:"math",offset:g.offset+1}),this.path.push({nodeName:"mo",offset:1})}else if(l.isNewLine(a)){a=this._getFocusLine();b=this.doc.createElement("line");l.insertNodeAfter(b,a);this.cursorPosition.node=b;this.cursorPosition.offset=0;for(g=this.path.pop();"line"!=g.nodeName;)g=this.path.pop();this.path.push({nodeName:"line",
offset:g.offset+1})}else if(this._isLineNode(b))c=e.createElement("text"),b.appendChild(c),this.cursorPosition.node=c,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"text",offset:1});else if(this._isTextNode(b))this._insertChar(a);else if(l.isMathTokenNode(b)){do g=this.path.pop();while(g&&"math"!=g.nodeName);c=e.createElement("text");for(f=b;"math"!=f.nodeName;)f=f.parentNode;l.insertNodeAfter(c,f);this.cursorPosition.node=c;this.cursorPosition.offset=0;this._insertChar(a);
this.path.push({nodeName:"text",offset:g.offset+1})}})),this.onChange(b)},doDelete:function(){if(""!=this.removeLeft())this.onChange()},removeLeft:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,d=b.textContent;if(0==a){a=b;if("text"!=b.nodeName&&"line"!=b.nodeName){for(;"math"!=a.nodeName;)a=a.parentNode;if(a=a.previousSibling){var b=a.textContent,c=b.length,d=p.insertAtOffset(b,c,"",1),c=c-1;""==d?(a.parentNode.removeChild(a),this.path.pop()):(a.textContent=d,this.cursorPosition.node=
a,this.cursorPosition.offset=c);return c=b.charAt(c)}}else if("line"==b.nodeName&&1<this.getLineCount()){a=b.previousSibling;c=a.childNodes.length;if(0==c)this.cursorPosition.node=a,this.cursorPosition.offset=0,d=this.path.pop(),d.offset--,this.path.push(d),b.parentNode.removeChild(b);else if(a=a.lastChild,"text"==a.nodeName)this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,d=this.path.pop(),d.offset--,this.path.push(d),this.path.push({nodeName:a.nodeName,offset:c}),b.parentNode.removeChild(b);
else if("math"==a.nodeName){var e=a.childNodes.length,a=a.lastChild;this.cursorPosition.node=a;this.cursorPosition.offset=a.textContent.length;d=this.path.pop();d.offset--;this.path.push(d);this.path.push({nodeName:"math",offset:c});this.path.push({nodeName:a.nodeName,offset:e});b.parentNode.removeChild(b)}return"\n"}return""}"mo"==b.nodeName?(c=b.textContent,d=""):(c=d.charAt(a-1),d=p.insertAtOffset(d,a,"",1));if(""==d)if(a=b.previousSibling)"math"==a.nodeName?(e=a.childNodes.length,a=a.lastChild,
this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,d=this.path.pop(),this.path.push({nodeName:"math",offset:d.offset-1}),this.path.push({nodeName:a.nodeName,offset:e}),b.parentNode.removeChild(b)):(this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,b.parentNode.removeChild(b),this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:this.path.pop().offset-1}));else{e=d=b;if("text"!=b.nodeName&&"line"!=b.nodeName)for(;"math"!=e.nodeName;)d=e.parentNode,
d.removeChild(e),e=d,this.path.pop();a=e.previousSibling;d=e.parentNode;d.removeChild(e);b=this.path.pop().offset;a?(this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:b-1})):(this.cursorPosition.node=d,this.cursorPosition.offset=d.childElementCount)}else this.cursorPosition.node.textContent=d,this.cursorPosition.offset-=1;return c},moveLeft:function(){var a=this.cursorPosition.node,b=this.cursorPosition.offset;
if("line"==a.nodeName){if(b=a.previousSibling){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length}}else if(0<b)this.cursorPosition.offset--;else if(0==b)if(b=a.previousSibling){if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length-1}else if(b=a.parentNode.previousSibling)if("line"==b.nodeName){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=
b;this.cursorPosition.offset=a.length}else a=b.textContent,this.cursorPosition.node=b,this.cursorPosition.offset=a.length-1},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},_splitNodeIfNeed:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,d=b.textContent,c=d.length;if(0<a&&a<c)c=d.substring(0,a),a=d.substring(a),d=this.doc.createElement(b.nodeName),b.textContent=c,d.textContent=a,l.insertNodeAfter(d,
b)},_getFocusLine:function(){for(var a=this.getFocusNode();a&&"line"!=a.nodeName;)a=a.parentNode;return a},_isNotSameNode:function(a,b){return a==b.nodeName},_isLineNode:function(a){return"line"==a.nodeName},_isTextNode:function(a){return"text"==a.nodeName},_insertChar:function(a){this.cursorPosition.node.textContent=p.insertAtOffset(this.cursorPosition.node.textContent,this.cursorPosition.offset,a);this.cursorPosition.offset+=1},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?
"":n.innerXML(this.doc)},getPath:function(){var a="";q.forEach(this.path,function(b){a+="/";a+=b.nodeName;b.offset&&(a+="["+b.offset+"]")});return a},getFocusNode:function(){return this.cursorPosition.node},getOffset:function(){return this.cursorPosition.offset},getLineAt:function(a){return this.doc.documentElement.childNodes[a]},getHTML:function(){return s.xmlDocToHtml(this.doc)},onChange:function(){}})});