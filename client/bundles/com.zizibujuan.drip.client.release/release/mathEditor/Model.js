//>>built
define("mathEditor/Model","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-construct dojox/xml/parser mathEditor/string mathEditor/dataUtil mathEditor/lang mathEditor/xmlUtil".split(" "),function(w,x,t,y,u,m,z,e,h){var v=e.STRING_FUNCTION_APPLICATION;return w(null,{path:null,xmlString:null,doc:null,mode:"text",anchor:null,constructor:function(a){this._init();x.mixin(this,a)},_init:function(a){if(!a||""==a)a="\x3croot\x3e\x3cline\x3e\x3c/line\x3e\x3c/root\x3e";this.doc=u.parse(a);this.path=
[];this.anchor={};this.mode="text";this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1});a=this.doc.documentElement.firstChild;0==e.getChildLength(a)?this.anchor.node=a:(a=a.firstChild,this.anchor.node=a,this.path.push({nodeName:a.nodeName,offset:1}));this.anchor.offset=0},clear:function(){this._init();this.onChanged()},loadData:function(a){this._init(a);this.onChanged()},isTextMode:function(){return"text"===this.mode},isMathMLMode:function(){return"mathml"===this.mode},switchMode:function(){this.isTextMode()?
this.toMathMLMode():this.isMathMLMode()&&this.toTextMode()},toTextMode:function(){this.mode="text";var a=this.anchor.node.nodeName;"line"!=a&&"text"!=a&&(this.anchor=this.mathMLToTextMode(this.anchor))},toMathMLMode:function(){this.mode="mathml";var a=this.anchor.node.nodeName;if("line"==a||"text"==a)this.anchor=this.textToMathMLMode(this.anchor,"math")},mathMLToTextMode:function(a){var b=a.node;a=a.offset;if("math"===b.nodeName&&0==b.childNodes.length){var c=b.parentNode,d=null;if(1==c.childNodes.length)this.path.pop(),
d=c,a=0;else if(b.previousSibling){var e=b.previousSibling,d=e;a=this._isTokenNode(e.nodeName)?this._getTextLength(e):1;this._movePathToPreviousSibling(e)}else if(b.nextSibling){var e=this.path.pop(),g=b.nextSibling,d=g;a=0;e.nodeName=g.nodeName;this.path.push(e)}c.removeChild(b);return{node:d,offset:a}}for(;"math"!=b.nodeName;)b=b.parentNode,this.path.pop();return{node:b,offset:1}},textToMathMLMode:function(a,b){var c=a.node,d=a.offset,f=this.doc;if(this._isLineNode(c))f=f.createElement("math"),
c.appendChild(f),this.path.push({nodeName:"math",offset:1}),c=f,d=2;else if(this._isTextNode(c)){this._splitNodeIfNeed(b);var f=f.createElement("math"),g=0,g=this.path.pop();0<d?(g=g.offset+1,e.insertNodeAfter(f,c)):(g=g.offset,e.insertNodeBefore(f,c));this.path.push({nodeName:"math",offset:g});c=f;d=2}return{node:c,offset:d}},_split:function(a){return a.split(/\r\n|\r|\n/)},_splitNodeByNewLine:function(a,b,c,d){var f=null,g=null,h=this.doc,l=e.getText(a).length;0==b?(f=a.previousSibling,!f||"text"!=
f.nodeName?(f=h.createElement("text"),e.setText(f,c),e.insertNodeBefore(f,a)):e.appendTextEnd(f,c),g=a,d&&""!=d&&e.appendTextStart(g,d)):b==l?(b=a.nextSibling,!b||"text"!=b.nodeName?(f=a,e.appendTextEnd(f,c),0<d.length&&(g=h.createElement("text"),e.setText(g,d),e.insertNodeAfter(g,a))):(e.appendTextEnd(a,c),f=a,g=b,e.appendTextStart(g,d))):0<b&&b<l&&(l=e.getText(a),e.setText(a,l.substring(0,b)+c),f=a,g=h.createElement("text"),e.setText(g,d+l.substring(b)),e.insertNodeAfter(g,a));return{beforeNode:f,
afterNode:g}},insertText:function(a,b){if(!b||0==b.length)return a;var c=a.node,d=a.offset,f=this.doc,g=this._split(b);if(1==g.length){var h=g[0];if(this._isLineNode(c)){var l="text",k=f.createElement(l);c.appendChild(k);c=k;this.path.push({nodeName:l,offset:1})}var p=e.getText(c),p=m.insertAtOffset(p,d,h);e.setText(c,p);d+=h.length;return{node:c,offset:d}}var q=g.splice(0,1)[0],h=g.splice(g.length-1,g.length)[0],n=null,p=n=k=null,r=0;this._isLineNode(c)?p=this.path.pop():this._isTextNode(c)&&(this.path.pop(),
p=this.path.pop());0==q.length?this._isLineNode(c)?h&&""!=h&&(k=f.createElement("text"),e.setText(k,h),c.appendChild(k)):(c=this._splitNodeByNewLine(c,d,q,h),n=c.beforeNode,k=c.afterNode):0<q.length&&(this._isLineNode(c)?(l="text",k=f.createElement(l),e.setText(k,q),c.appendChild(k),n=k,k=k.nextSibling,h&&""!=h&&(k||(k=f.createElement("text"),e.insertNodeAfter(k,n)),e.appendTextStart(k,h))):(c=this._splitNodeByNewLine(c,d,q,h),n=c.beforeNode,k=c.afterNode));var r=g.length+1,l="line",s=this._getFocusLine();
0<g.length&&t.forEach(g,function(a){var b=f.createElement(l);e.setText(b,a);e.insertNodeAfter(b,s);s=b});l="line";n=f.createElement(l);e.insertNodeAfter(n,s);if(k){c=k;do n.appendChild(c);while(c=c.nextSibling)}k?(this.path.push({nodeName:"line",offset:p.offset+r}),this.path.push({nodeName:"text",offset:1}),c=k,d=h.length):(this.path.push({nodeName:"line",offset:p.offset+r}),c=n,d=0);return{node:c,offset:d}},findTrigonometric:function(a,b){for(var c=[],d=[],f=a.node,g=f;g&&("mi"==g.nodeName&&1==e.getText(g).length)&&
!(c.unshift(e.getText(g)),g=f.previousSibling,2==c.length););if(2==c.length){if(f=c.join("")+b,e.isTrigonometric(f))return{functionName:f,preMis:c,nextMis:d}}else if(1==c.length){if((f=f.nextSibling)&&"mi"==f.nodeName&&1==e.getText(f).length)if(f=e.getText(f),f=c[0]+b+f,e.isTrigonometric(f))return{functionName:f,preMis:c,nextMis:d}}else if(0==c.length){f=f.nextSibling;for(d=[];f&&("mi"==f.nodeName&&1==e.getText(f).length)&&!(d.push(e.getText(f)),f=f.nextSibling,2==d.length););if(2==d.length&&(f=b+
d.join(""),e.isTrigonometric(f)))return{functionName:f,preMis:c,nextMis:d}}return null},removeExistTrigonometricPart:function(a,b){var c=a.node,d=a.offset,f=b.preMis.length;2==f?((d=c.previousSibling.previousSibling)?(f=this.path.pop(),f.offset-=2,this.path.push(f)):(d=c.parentNode,this.path.pop()),c.parentNode.removeChild(c.previousSibling),c.parentNode.removeChild(c),c=d,d=e.isMathLayoutNode(c)?2:"mi"==c.nodeName||"mo"==c.nodeName?1:e.getText(c).length):1==f?(d=c.previousSibling,c.parentNode.removeChild(c.nextSibling),
c.parentNode.removeChild(c),f=this.path.pop(),f.offset--,this.path.push(f),c=d,d="mi"==c.nodeName||"mo"==c.nodeName?1:e.getText(c).length):0==f&&(c.parentNode.removeChild(c.nextSibling),c.parentNode.removeChild(c.nextSibling),d="mi"==c.nodeName||"mo"==c.nodeName?1:e.getText(c).length);return{node:c,offset:d}},insertMi:function(a,b,c){var d=a.node;a=a.offset;var f=this.doc;if("math"===d.nodeName||"mrow"===d.nodeName||e.isMathLayoutNode(d)){if(0===a)return this._insertNewTokenNodeBefore(c,b,d);if(1===
a)return this._insertNewTokenNodeAfter(c,b,d);if(2===a)return a=f.createElement(c),e.setText(a,b),d.appendChild(a),this.path.push({nodeName:c,offset:1}),{node:a,offset:1}}if(0==a)return this._insertNewTokenNodeBefore(c,b,d);a!=this._getTextLength(d)&&this._splitNodeIfNeed(c);return this._insertNewTokenNodeAfter(c,b,d)},insertMo:function(a,b,c){var d=a.node;a=a.offset;var f=this.doc;if("math"===d.nodeName||"msqrt"===d.nodeName)a=f.createElement(c),e.setText(a,b),d.appendChild(a),this.path.push({nodeName:c,
offset:1}),d=a,a=1;else if("\x3d"==b&&"mo"==d.nodeName&&"\x3d"==e.getText(d))e.appendTextEnd(d,"\x3d");else if("\x3d"==b&&"mo"==d.nodeName&&"!"==e.getText(d))e.appendTextEnd(d,"\x3d");else{if(0==a)return this._insertNewTokenNodeBefore(c,b,d);"mn"===d.nodeName&&(0<a&&a<this._getTextLength(d))&&this._splitNodeIfNeed(c);a=f.createElement(c);e.setText(a,b);b=d.parentNode;this._isMstyleAndHasOneChild(b)?e.insertNodeAfter(a,b):e.insertNodeAfter(a,d);d=a;a=1;b=this.path.pop();this.path.push({nodeName:c,
offset:b.offset+1})}return{node:d,offset:a}},_isMstyleAndHasOneChild:function(a){return"mstyle"===a.nodeName&&1===e.getChildLength(a)},insertMn:function(a,b,c){var d=a.node;a=a.offset;var f=this.doc;if("math"===d.nodeName||"mrow"===d.nodeName||e.isMathLayoutNode(d)){if(0===a){if((f=d.previousSibling)&&"mn"===f.nodeName)e.appendTextEnd(f,b);else return this._insertNewTokenNodeBefore(c,b,d);return{node:d,offset:a}}if(1===a){if((c=d.nextSibling)&&"mn"===c.nodeName)e.appendTextStart(c,b);else return this._insertNewTokenNodeAfter("mn",
b,d);return{node:d,offset:a}}if(2===a)return f=f.createElement(c),e.setText(f,b),d.appendChild(f),this.path.push({nodeName:c,offset:1}),a=b.length,{node:f,offset:a}}if("mn"===d.nodeName)return c=e.getText(d),e.setText(d,m.insertAtOffset(c,a,b)),a+=b.length,{node:d,offset:a};if(0==a)if((f=d.previousSibling)&&"mn"===f.nodeName)e.appendTextEnd(f,b);else return this._insertNewTokenNodeBefore(c,b,d);else if((c=d.nextSibling)&&"mn"===c.nodeName)e.appendTextStart(c,b);else return this._insertNewTokenNodeAfter("mn",
b,d);return{node:d,offset:a}},_insertNewTokenNodeAfter:function(a,b,c){var d=this.doc.createElement(a);e.setText(d,b);var f=c.parentNode;this._isMstyleAndHasOneChild(f)?e.insertNodeAfter(d,f):e.insertNodeAfter(d,c);c=this.path.pop();this.path.push({nodeName:a,offset:c.offset+1});node=d;offset="mn"===a?b.length:1;return{node:node,offset:offset}},_insertNewTokenNodeBefore:function(a,b,c){a=this.doc.createElement(a);e.setText(a,b);b=c.parentNode;this._isMstyleAndHasOneChild(b)?e.insertNodeBefore(a,b):
e.insertNodeBefore(a,c);c=this.path.pop();c.offset++;this.path.push(c);return this.anchor},insertFenced:function(a,b,c){var d=a.node,f=a.offset;a=this.doc;if("math"==d.nodeName)return this.path.push({nodeName:c,offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=h.createEmptyMfenced(a,b),d.appendChild(b.rootNode),d=b.focusNode,{node:d,offset:0};if(this._isMathMLNodeEnd(d,f))return f=this.path.pop(),f.offset++,f.nodeName=c,this.path.push(f),this.path.push({nodeName:"mrow",
offset:1}),this.path.push({nodeName:"mn",offset:1}),b=h.createEmptyMfenced(a,b),c=d.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeAfter(b.rootNode,c):e.insertNodeAfter(b.rootNode,d),d=b.focusNode,{node:d,offset:0};if(this._isMathMLNodeStart(d,f))return f=this.path.pop(),f.nodeName=c,this.path.push(f),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),b=h.createEmptyMfenced(a,b),c=d.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeBefore(b.rootNode,c):
e.insertNodeBefore(b.rootNode,d),d=b.focusNode,{node:d,offset:0}},insertTrigonometric:function(a,b,c){a=a.node;var d=this.doc;if("math"===a.nodeName){this.path.push({nodeName:"mrow",offset:3});this.path.push({nodeName:"mn",offset:1});c=d.createElement(c);var f=d.createElement("mo"),g=d.createElement("mrow"),d=h.getPlaceHolder(d);e.setText(c,b);e.setText(f,v);g.appendChild(d);a.appendChild(c);a.appendChild(f);a.appendChild(g)}else f=this.path.pop(),this.path.push({nodeName:"mrow",offset:f.offset+3}),
this.path.push({nodeName:"mn",offset:1}),c=d.createElement(c),f=d.createElement("mo"),g=d.createElement("mrow"),d=h.getPlaceHolder(d),e.setText(c,b),e.setText(f,v),g.appendChild(d),e.insertNodeAfter(c,a),e.insertNodeAfter(f,c),e.insertNodeAfter(g,f);return{node:d,offset:0}},insertInferredMfrac:function(a,b,c){a=a.node;var d=this.doc;"math"===a.nodeName?(this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),d=h.createEmptyFrac(d),
a.appendChild(d.rootNode)):(b="last",this.path.pop(),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=a.parentNode,b=0,d=h.createFracWithNumerator(d,a),y.place(d.rootNode,c,b));a=d.focusNode;return{node:a,offset:0}},insertMfrac:function(a,b,c){b=a.node;var d=a.offset;a=this.doc;c=b.nodeName;if("math"===c&&2===d)return this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",
offset:1}),c=h.createEmptyFrac(a),b.appendChild(c.rootNode),b=c.focusNode,{node:b,offset:0};if(this._isMathMLNodeEnd(b,d))return c=this.path.pop(),c.offset++,c.nodeName="mfrac",this.path.push(c),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=h.createEmptyFrac(a),a=b.parentNode,this._isMstyleAndHasOneChild(a)?e.insertNodeAfter(c.rootNode,a):e.insertNodeAfter(c.rootNode,b),b=c.focusNode,{node:b,offset:0};if(this._isMathMLNodeStart(b,d))return c=this.path.pop(),
c.nodeName="mfrac",this.path.push(c),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=h.createEmptyFrac(a),a=b.parentNode,this._isMstyleAndHasOneChild(a)?e.insertNodeBefore(c.rootNode,a):e.insertNodeBefore(c.rootNode,b),b=c.focusNode,{node:b,offset:0}},insertMsqrt:function(a,b,c){b=a.node;c=a.offset;a=this.doc;if("math"===b.nodeName||"msqrt"===b.nodeName||"mrow"===b.nodeName)return this.path.push({nodeName:"msqrt",offset:1}),this.path.push({nodeName:"mn",offset:1}),
a=h.createEmptyMsqrt(a),b.appendChild(a.rootNode),b=a.focusNode,{node:b,offset:0};if(this._isMathMLNodeEnd(b,c))return c=this.path.pop(),c.offset++,c.nodeName="msqrt",this.path.push(c),this.path.push({nodeName:"mn",offset:1}),a=h.createEmptyMsqrt(a),c=b.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeAfter(a.rootNode,c):e.insertNodeAfter(a.rootNode,b),b=a.focusNode,{node:b,offset:0};if(this._isMathMLNodeStart(b,c))return c=this.path.pop(),c.nodeName="msqrt",this.path.push(c),this.path.push({nodeName:"mn",
offset:1}),a=h.createEmptyMsqrt(a),c=b.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeBefore(a.rootNode,c):e.insertNodeBefore(a.rootNode,b),b=a.focusNode,{node:b,offset:0}},insertMroot:function(a,b,c){b=a.node;c=a.offset;a=this.doc;if("math"===b.nodeName)return this.path.push({nodeName:"mroot",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),a=h.createEmptyMroot(a),b.appendChild(a.rootNode),b=a.focusNode,{node:b,offset:0};if(this._isMathMLNodeEnd(b,
c))return c=this.path.pop(),c.offset++,c.nodeName="mroot",this.path.push(c),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),a=h.createEmptyMroot(a),c=b.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeAfter(a.rootNode,c):e.insertNodeAfter(a.rootNode,b),b=a.focusNode,{node:b,offset:0};if(this._isMathMLNodeStart(b,c))return c=this.path.pop(),c.nodeName="mroot",this.path.push(c),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),
a=h.createEmptyMroot(a),c=b.parentNode,this._isMstyleAndHasOneChild(c)?e.insertNodeBefore(a.rootNode,c):e.insertNodeBefore(a.rootNode,b),b=a.focusNode,{node:b,offset:0}},insertScripting:function(a,b,c){b=a.node;var d=a.offset;a=this.doc;if("math"===b.nodeName)return this.path.push({nodeName:c,offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=h.createEmptyScripting(a,c),b.appendChild(c.rootNode),b=c.focusNode,{node:b,offset:0};if(0==d){if(d=b.previousSibling){var f=
this.path.pop(),f=f.offset;return this._createScriptingAfter(d,f-1,c)}f=this.path.pop();f=f.offset;this.path.push({nodeName:c,offset:f});this.path.push({nodeName:"mrow",offset:2});this.path.push({nodeName:"mn",offset:1});c=h.createEmptyScripting(a,c);e.insertNodeBefore(c.rootNode,b);b=c.focusNode;return{node:b,offset:0}}f=this.path.pop();f=f.offset;return this._createScriptingAfter(b,f,c)},_createScriptingAfter:function(a,b,c){var d=this.doc;"mo"===a.nodeName?(this.path.push({nodeName:c,offset:b+
1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=h.createEmptyScripting(d,c),e.insertNodeAfter(c.rootNode,a)):(this.path.push({nodeName:c,offset:b}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),a.previousSibling?(b=a.previousSibling,c=h.createScriptingWithBase(d,a,c),e.insertNodeAfter(c.rootNode,b)):a.nextSibling?(b=a.nextSibling,c=h.createScriptingWithBase(d,a,c),e.insertNodeBefore(c.rootNode,b)):(b=a.parentNode,c=h.createScriptingWithBase(d,
a,c),b.appendChild(c.rootNode)));a=c.focusNode;return{node:a,offset:0}},_splitNodeIfNeed:function(a){var b=this.anchor.offset,c=this.anchor.node;if(this._isTokenNode(c.nodeName)&&c.nodeName!=a){var d=e.getText(c);a=d.length;0<b&&b<a&&(a=d.substring(0,b),b=d.substring(b),d=this.doc.createElement(c.nodeName),e.setText(c,a),e.setText(d,b),e.insertNodeAfter(d,c))}},onChanging:function(a){},onChanged:function(a){},setData:function(a){var b=a.data,c=a.nodeName,d=a.removeCount;if(d&&0<d)for(var f=0;f<d;f++)this.removeLeft();
if(this.isTextMode()){var d=this.anchor.node,g=this.anchor.offset;if("math"===d.nodeName)if(0===g)c=d.previousSibling,g=this.path.pop(),!c||"text"!=c.nodeName?(c=this.doc,c=c.createElement("text"),e.insertNodeBefore(c,d)):g.offset--,g.nodeName=c.nodeName,this.path.push(g),"text"===c.nodeName&&(this.anchor.node=c,this.anchor.offset=e.getText(c).length);else if(1===g){c=d.nextSibling;if(!c||"text"!=c.nodeName)c=this.doc,c=c.createElement("text"),e.insertNodeAfter(c,d);"text"===c.nodeName&&(this._movePathToNextSibling(c),
this.anchor.node=c,this.anchor.offset=0)}this.anchor=this.insertText(this.anchor,b);this.onChanged(b)}else if(this.isMathMLMode()&&!e.isNewLine(b)){d={"^":"msup",_:"msub"};d[b]&&(c=d[b],b="");var d=this.anchor.node,m=f=!1;a=a.isCommandString;c?e.isGreekLetter(b)?f=!0:e.isTrigonometric(b)&&(m=!0):e.isLetter(b)?c="mi":e.isNumber(b)?c="mn":e.isOperator(b)?c="mo":e.isFenced(b)&&(c="mfenced");if("text"==d.nodeName||"line"==d.nodeName)this.anchor=this.textToMathMLMode(this.anchor,c);d=this.anchor.node;
g=this.anchor.offset;h.isPlaceHolder(d)&&(this.path.pop(),this.anchor.node=d.parentNode,this.anchor.offset=2,h.removePlaceHolder(d));var l={};l.data=b;this.onChanging(l);l=!1;if((this._isSupBaseMrow(d.parentNode)||this._isSubBaseMrow(d.parentNode))&&!("mn"===c&&"mn"===d.nodeName))0===g?(this.path.pop(),this.path.pop(),this.anchor.node=d.parentNode.parentNode,this.anchor.offset=0):("mo"===c?(this.anchor.node=d.parentNode,this.anchor.offset=2,g=d.parentNode.parentNode,e.insertNodeBefore(d,g),d=this.doc.createElement("mo"),
e.setText(d,b),e.insertNodeBefore(d,g),l=!0,this.path.pop(),this.path.pop(),g=this.path.pop(),g.offset+=2):(this.anchor.node=d.parentNode,this.anchor.offset=2,g=d.parentNode.parentNode,e.insertNodeBefore(d,g),this.path.pop(),this.path.pop(),g=this.path.pop(),g.offset++),this.path.push(g),this.path.push({nodeName:"mrow",offset:1}));if(l)d=this.anchor.node,c=h.getPlaceHolder(this.doc),d.appendChild(c),this.path.push({nodeName:c.nodeName,offset:1}),this.anchor.node=c,this.anchor.offset=0;else if("mi"===
c)a?this.anchor=this.insertMi(this.anchor,b,c):f?this.anchor=this.insertMi(this.anchor,b,c):m?this.anchor=this.insertTrigonometric(this.anchor,b,c):(d=this.findTrigonometric(this.anchor,b,c))?(this.anchor=this.removeExistTrigonometricPart(this.anchor,d),this.anchor=this.insertTrigonometric(this.anchor,d.functionName,c)):this.anchor=this.insertMi(this.anchor,b,c);else if("mn"===c)this.anchor=this.insertMn(this.anchor,b,c);else if("mo"===c)this.anchor=this.insertMo(this.anchor,b,c);else if("mfenced"===
c)this._splitNodeIfNeed(c),this.anchor=this.insertFenced(this.anchor,b,c);else if("mfrac"===c)this._splitNodeIfNeed(c),this.anchor=this.insertMfrac(this.anchor,b,c);else if("msqrt"===c)this._splitNodeIfNeed(c),this.anchor=this.insertMsqrt(this.anchor,b,c);else if("mroot"===c)this._splitNodeIfNeed(c),this.anchor=this.insertMroot(this.anchor,b,c);else if("msub"===c||"msup"==c)this._splitNodeIfNeed(c),this.anchor=this.insertScripting(this.anchor,b,c);this.onChanged(b)}},_updateAnchor:function(a,b){this.anchor.node=
a;this.anchor.offset=b},_removeEmptyDenominator:function(a){this.path.pop();this.path.pop();var b=this.path.pop();a=a.parentNode.previousSibling;var c=a.lastChild;"mstyle"==c.nodeName&&(c=c.lastChild);b.nodeName=c.nodeName;this.path.push(b);this.anchor.node=c;this._isTokenNode(c.nodeName)?this.anchor.offset=this._getTextLength(c):this.anchor.offset=1;b=a.parentNode;this._isMstyleAndHasOneChild(b.parentNode)&&(b=b.parentNode);for(var c=a.childNodes.length,d=b.parentNode,e=0;e<c;e++)d.insertBefore(a.firstChild,
b);d.removeChild(b)},_removeEmptyNumerator:function(a){this.path.pop();this.path.pop();var b=this.path.pop();a=a.parentNode.nextSibling;var c=a.firstChild;"mstyle"==c.nodeName&&(c=c.firstChild);b.nodeName=c.nodeName;this.path.push(b);this.anchor.node=c;this.anchor.offset=0;b=a.childNodes.length;c=a.parentNode;this._isMstyleAndHasOneChild(c.parentNode)&&(c=c.parentNode);for(var d=c.parentNode,e=0;e<b;e++)d.insertBefore(a.firstChild,c);d.removeChild(c)},_removeEmptyRootBase:function(a){this.path.pop();
this.path.pop();var b=this.path.pop();a=a.parentNode.nextSibling;var c=a.lastChild;b.nodeName=c.nodeName;this.path.push(b);this.anchor.node=c;this._isTokenNode(c.nodeName)?this.anchor.offset=this._getTextLength(c):this.anchor.offset=1;for(var b=a.childNodes.length,c=a.parentNode,d=c.parentNode,e=0;e<b;e++)d.insertBefore(a.firstChild,c);d.removeChild(c)},_removeEmptyRootIndex:function(a){this.path.pop();this.path.pop();var b=this.path.pop();a=a.parentNode.previousSibling;var c=a.firstChild;b.nodeName=
c.nodeName;this.path.push(b);this.anchor.node=c;this.anchor.offset=0;for(var b=a.childNodes.length,c=a.parentNode,d=c.parentNode,e=0;e<b;e++)d.insertBefore(a.firstChild,c);d.removeChild(c)},_removeLeftMathLayoutNode:function(a){this._isMstyleAndHasOneChild(a.parentNode)&&(a=a.parentNode);if(1==a.parentNode.childNodes.length){this._moveToTopLeft(a);var b=a.parentNode;b.removeChild(a);"math"===b.nodeName&&0===e.getChildLength(b)&&(this.anchor.offset=2)}else if(a.previousSibling)b=a.previousSibling,
"mstyle"===b.nodeName&&(b=b.lastChild),this._moveToPreviousSiblingEnd(b),a.parentNode.removeChild(a);else if(a.nextSibling){b=a.nextSibling;"mstyle"===b.nodeName&&(b=b.firstChild);var c=this.path.pop();c.nodeName=b.nodeName;this.path.push(c);this.anchor.node=b;this.anchor.offset=0;a.parentNode.removeChild(a)}},_removeRightMathLayoutNode:function(a){this._isMstyleAndHasOneChild(a.parentNode)&&(a=a.parentNode);if(1==a.parentNode.childNodes.length){this._moveToTopLeft(a);var b=a.parentNode;b.removeChild(a);
"math"===b.nodeName&&0===e.getChildLength(b)&&(this.anchor.offset=2)}else if(a.nextSibling){b=a.nextSibling;"mstyle"===b.nodeName&&(b=b.firstChild);var c=this.path.pop();c.nodeName=b.nodeName;this.path.push(c);this.anchor.node=b;this.anchor.offset=0;a.parentNode.removeChild(a)}else a.previousSibling&&(b=a.previousSibling,"mstyle"===b.nodeName&&(b=b.lastChild),this._moveToPreviousSiblingEnd(b),a.parentNode.removeChild(a))},_replaceNodeWithPlaceHolder:function(a){var b=this.path.pop(),c=h.getPlaceHolder(this.doc);
b.nodeName=c.nodeName;this.path.push(b);this.anchor.node=c;this.anchor.offset=0;a.parentNode.insertBefore(c,a);a.parentNode.removeChild(a)},_canRemoveLeftNode:function(a,b){var c=!1;this._isTokenNode(a.nodeName)?1==this._getTextLength(a)&&1==b&&(c=!0):1==b&&(c=!0);return c},_canRemoveRightNode:function(a,b){var c=!1;this._isTokenNode(a.nodeName)?1==this._getTextLength(a)&&0==b&&(c=!0):0==b&&(c=!0);return c},_isSoleChildInMrow:function(a){return"mrow"===a.parentNode.nodeName&&1===e.getChildLength(a.parentNode)},
_isSoleChildInMsqrt:function(a){return"msqrt"===a.parentNode.nodeName&&1===e.getChildLength(a.parentNode)},removeRight:function(){var a=this.anchor.offset,b=this.anchor.node,c=this._isLineEnd(this.anchor);if(c)if(a=c.nextSibling)if(0==a.childNodes.length)a.parentNode.removeChild(a);else if(0==c.childNodes.length)this._moveLineStart(a),c.parentNode.removeChild(c);else{this._moveLineEnd(c);"text"===c.lastChild.nodeName&&"text"===a.firstChild.nodeName&&(e.appendTextEnd(c.lastChild,e.getText(a.firstChild)),
a.removeChild(a.firstChild));for(var b=a.childNodes.length,d=0;d<b;d++)c.appendChild(a.firstChild);a.parentNode.removeChild(a)}else this._moveLineEnd(c);else if(this._isEmptyDenominator(b))this._removeEmptyDenominator(b);else if(this._isEmptyNumerator(b))this._removeEmptyNumerator(b);else if(this._isEmptySqrtBase(b))this.path.pop(),this._removeRightMathLayoutNode(b.parentNode);else if(this._isEmptyRootBase(b))this._removeEmptyRootBase(b);else if(this._isEmptyRootIndex(b))this._removeEmptyRootIndex(b);
else if((this._isSoleChildInMrow(b)||this._isSoleChildInMsqrt(b))&&this._canRemoveRightNode(b,a))this._replaceNodeWithPlaceHolder(b);else if(this._isTokenNode(b.nodeName))if(c=this._getTextLength(b),c==a)if(h.isPlaceHolder(b))a=b.parentNode,this.anchor.node=a,this.anchor.offset=0,this.path.pop(),a.removeChild(b),"math"===a.nodeName&&0==e.getChildLength(a)&&(this.anchor.offset=2);else{if(a=b.nextSibling)b=this._getTextLength(a),1==b?a.parentNode.removeChild(a):(c=e.getText(a),e.setText(a,c.substring(1,
b)))}else if(0==a)if(1==c){if(a=b.nextSibling)return c=this.path.pop(),c.nodeName=a.nodeName,this.path.push(c),this.anchor.node=a,this.anchor.offset=0,b.parentNode.removeChild(b),e.getText(b);if(a=b.previousSibling)this._moveToPreviousSiblingEnd(a),b.parentNode.removeChild(b);else return this.path.pop(),this.anchor.node=b.parentNode,"math"===b.parentNode.nodeName&&1===e.getChildLength(b.parentNode)?this.anchor.offset=2:this.anchor.offset=0,d=null,this._isTokenNode(b.nodeName)&&(d=e.getText(b)),b.parentNode.removeChild(b),
d}else return c=e.getText(b),d=c.charAt(a),a=m.insertAtOffset(c,a+1,"",1),e.setText(b,a),d;else return c=e.getText(b),d=c.charAt(a),a=m.insertAtOffset(c,a+1,"",1),e.setText(b,a),d;else e.isMathLayoutNode(b)&&this._removeRightMathLayoutNode(b)},removeLeft:function(){var a=this.anchor.offset,b=this.anchor.node,c=this._isLineStart(this.anchor);if(c)if(a=c.previousSibling){this._movePathToPreviousSibling(a);this._moveLineEnd(a);if(0<c.childNodes.length){"text"===a.lastChild.nodeName&&"text"===c.firstChild.nodeName&&
(e.appendTextEnd(a.lastChild,e.getText(c.firstChild)),c.removeChild(c.firstChild));for(var b=c.childNodes.length,d=0;d<b;d++)a.appendChild(c.firstChild)}c.parentNode.removeChild(c)}else this._moveLineStart(c);else if(this._isEmptyDenominator(b))this._removeEmptyDenominator(b);else if(this._isEmptyNumerator(b))this._removeEmptyNumerator(b);else if(this._isEmptySqrtBase(b))this.path.pop(),this._removeLeftMathLayoutNode(b.parentNode);else if(this._isEmptyRootBase(b))this._removeEmptyRootBase(b);else if(this._isEmptyRootIndex(b))this._removeEmptyRootIndex(b);
else if((this._isSoleChildInMrow(b)||this._isSoleChildInMsqrt(b))&&this._canRemoveLeftNode(b,a))this._replaceNodeWithPlaceHolder(b);else if(this._isTokenNode(b.nodeName))if(c=this._getTextLength(b),0==a)if(h.isPlaceHolder(b))this.anchor.node=b.parentNode,this.anchor.offset=0,this.path.pop(),a=b.parentNode,a.removeChild(b),"math"===a.nodeName&&0==e.getChildLength(a)&&(this.anchor.offset=2);else{if(a=b.previousSibling)b=this._getTextLength(a),1==b?(b=this.path.pop(),b.offset--,this.path.push(b),a.parentNode.removeChild(a)):
(c=e.getText(a),e.setText(a,c.substring(0,b-1)))}else{if(1<c)return c=e.getText(b),d=c.charAt(a-1),newText=m.insertAtOffset(c,a,"",1),e.setText(b,newText),this.anchor.offset--,d;if(1==c){if(a=b.previousSibling)return this._isMstyleAndHasOneChild(a)&&(a=a.firstChild),this.anchor.node=a,this._movePathToPreviousSibling(a),this._isTokenNode(a.nodeName)?this.anchor.offset=this._getTextLength(a):this.anchor.offset=1,b.parentNode.removeChild(b),e.getText(b);this.path.pop();a=b.parentNode;this.anchor.node=
a;"math"===a.nodeName&&1===e.getChildLength(a)?this.anchor.offset=2:this.anchor.offset=0;a.removeChild(b);return e.getText(b)}}else if(e.isMathLayoutNode(b))if(0===a){if(this._isMstyleAndHasOneChild(b.parentNode)&&(b=b.parentNode),(a=b.previousSibling)&&this._isTokenNode(a.nodeName))b=this._getTextLength(a),1==b?(b=this.path.pop(),b.offset--,this.path.push(b),a.parentNode.removeChild(a)):(c=e.getText(a),e.setText(a,c.substring(0,b-1)))}else 1===a&&this._removeLeftMathLayoutNode(b)},_isTokenNode:function(a){return e.isMathTokenName(a)||
"text"===a},_isEmptyDenominator:function(a){return h.isPlaceHolder(a)&&this._isDenominatorMrow(a.parentNode)},_isEmptyNumerator:function(a){return h.isPlaceHolder(a)&&this._isNumeratorMrow(a.parentNode)},_isEmptySqrtBase:function(a){return h.isPlaceHolder(a)&&this._isSqrt(a.parentNode)},_isEmptyRootBase:function(a){return h.isPlaceHolder(a)&&this._isRootBaseMrow(a.parentNode)},_isEmptyRootIndex:function(a){return h.isPlaceHolder(a)&&this._isRootIndexMrow(a.parentNode)},_isDenominatorMrow:function(a){return a&&
"mrow"===a.nodeName&&"mfrac"===a.parentNode.nodeName&&a.previousSibling},_isNumeratorMrow:function(a){return a&&"mrow"===a.nodeName&&"mfrac"===a.parentNode.nodeName&&a.nextSibling},_isSqrt:function(a){return"msqrt"===a.nodeName},_isRootIndexMrow:function(a){return a&&"mrow"===a.nodeName&&"mroot"===a.parentNode.nodeName&&a.previousSibling},_isRootBaseMrow:function(a){return a&&"mrow"===a.nodeName&&"mroot"===a.parentNode.nodeName&&a.nextSibling},_isSupSuperscriptMrow:function(a){return a&&"mrow"===
a.nodeName&&"msup"===a.parentNode.nodeName&&a.previousSibling},_isSubSubscriptMrow:function(a){return a&&"mrow"===a.nodeName&&"msub"===a.parentNode.nodeName&&a.previousSibling},_isSupBaseMrow:function(a){return a&&"mrow"===a.nodeName&&"msup"===a.parentNode.nodeName&&a.nextSibling},_isSubBaseMrow:function(a){return a&&"mrow"===a.nodeName&&"msub"===a.parentNode.nodeName&&a.nextSibling},_isLastFenceChildMrow:function(a){return a&&"mrow"===a.nodeName&&"mfenced"===a.parentNode.nodeName&&null==a.nextSibling},
_isFirstChildFenceChildMrow:function(a){return a&&"mrow"===a.nodeName&&"mfenced"===a.parentNode.nodeName&&null==a.previousSibling},_getTextLength:function(a){var b=0;if(h.isPlaceHolder(a))return 0;var c=a.nodeName;if("mn"===c||"text"===c)b=e.getText(a).length;else if("mo"===c||"mi"===c)b=1;return b},_isLineNode:function(a){return"line"===a.nodeName},_isLineStart:function(a){var b=a.node;a=a.offset;var c=b.nodeName;return"line"===c?b:"text"===c&&0===a&&!b.previousSibling||"math"===c&&0===a&&!b.previousSibling?
(this.path.pop(),b.parentNode):!1},_isLineEnd:function(a){var b=a.node;a=a.offset;var c=b.nodeName;return"line"===c?b:"text"===c&&a===e.getText(b).length&&!b.nextSibling||"math"===c&&1===a&&!b.nextSibling?(this.path.pop(),b.parentNode):!1},_isMathMLNodeEnd:function(a,b){return e.isMathTokenNode(a)&&this._getTextLength(a)===b||e.isMathLayoutNode(a)&&1===b},_isMathMLNodeStart:function(a,b){return 0!=b?!1:e.isMathTokenNode(a)||e.isMathLayoutNode(a)},_movePathToNextSibling:function(a){var b=this.path.pop();
b.offset++;b.nodeName=a.nodeName;this.path.push(b)},_movePathToPreviousSibling:function(a){var b=this.path.pop();b.offset--;b.nodeName=a.nodeName;this.path.push(b)},_moveLineStart:function(a){if(0===a.childNodes.length)this.anchor.node=a,this.anchor.offset=0;else{a=a.firstChild;var b=a.nodeName;"text"===b?(this.anchor.node=a,this.anchor.offset=0,this.path.push({nodeName:b,offset:1})):"math"===b&&(this.anchor.node=a,this.anchor.offset=0,this.path.push({nodeName:b,offset:1}))}},_moveLineEnd:function(a){var b=
a.childNodes.length;if(0===b)this.anchor.node=a,this.anchor.offset=0;else{a=a.lastChild;var c=a.nodeName;"text"===c?(this.anchor.node=a,this.anchor.offset=e.getText(a).length,this.path.push({nodeName:c,offset:b})):"math"===c&&(this.anchor.node=a,this.anchor.offset=1,this.path.push({nodeName:c,offset:b}))}},_moveToTopRight:function(a){this.path.pop();this.anchor.node=a.parentNode;this.anchor.offset=1},_moveToTopLeft:function(a){this.path.pop();this.anchor.node=a.parentNode;this.anchor.offset=0},_moveInNodeStart:function(a){a=
a.firstChild;"mstyle"===a.nodeName&&(a=a.firstChild);this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveInNodeEnd:function(a){var b=a.lastChild;"mstyle"===b.nodeName&&(b=b.lastChild);this.path.push({nodeName:b.nodeName,offset:a.childNodes.length});this.anchor.node=b;this._isTokenNode(b.nodeName)?this.anchor.offset=this._getTextLength(b):this.anchor.offset=1},_moveToPreviousSiblingEnd:function(a){this._movePathToPreviousSibling(a);this.anchor.node=a;this._isTokenNode(a.nodeName)?
this.anchor.offset=this._getTextLength(a):this.anchor.offset=1},_moveToNextSiblingStart:function(a){this._movePathToNextSibling(a);this.anchor.node=a;this.anchor.offset=0},_moveLeftToDenominatorEnd:function(a){a=a.lastChild;this.path.push({nodeName:a.nodeName,offset:2});var b=a.lastChild,c=1;this._isTokenNode(b.nodeName)?c=this._getTextLength(b):"mstyle"===b.nodeName&&(b=b.lastChild);this.path.push({nodeName:b.nodeName,offset:e.getChildLength(a)});this.anchor.node=b;this.anchor.offset=c},_moveLeftDenominatorToNumerator:function(a){a=
a.previousSibling;this._movePathToPreviousSibling(a);var b=a.lastChild;this._isTokenNode(b.nodeName)?(this.path.push({nodeName:b.nodeName,offset:a.childNodes.length}),this.anchor.node=b,this.anchor.offset=this._getTextLength(b)):("mstyle"===b.nodeName&&(b=b.lastChild),this.path.push({nodeName:b.nodeName,offset:b.parentNode.childNodes.length}),this.anchor.node=b,this.anchor.offset=1)},_moveRightToNumeratorStart:function(a){a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});a=a.firstChild;
!this._isTokenNode(a.nodeName)&&"mstyle"===a.nodeName&&(a=a.firstChild);this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveRightNumeratorToDenominator:function(a){a=a.nextSibling;this._movePathToNextSibling(a);a=a.firstChild;!this._isTokenNode(a.nodeName)&&"mstyle"===a.nodeName&&(a=a.firstChild);this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveRightMrootIndexToBase:function(a){a=a.previousSibling;this._movePathToPreviousSibling(a);
a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveLeftMrootBaseToIndex:function(a){var b=a.nextSibling;this._movePathToNextSibling(a);a=b.lastChild;this.path.push({nodeName:a.nodeName,offset:b.childNodes.length});this.anchor.node=a;this._isTokenNode(a.nodeName)?this.anchor.offset=this._getTextLength(a):this.anchor.offset=1},_moveLeftMsupSuperscriptToBase:function(a){a=a.previousSibling;this._movePathToPreviousSibling(a);var b=a.lastChild;this.path.push({nodeName:b.nodeName,
offset:a.childNodes.length});this.anchor.node=b;this._isTokenNode(b.nodeName)?this.anchor.offset=this._getTextLength(b):this.anchor.offset=1},_moveLeftMsubSubscriptToBase:function(a){this._moveLeftMsupSuperscriptToBase(a)},_moveRightMsupBaseToSuperscript:function(a){a=a.nextSibling;this._movePathToNextSibling(a);a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveRightMsubBaseToSubscript:function(a){this._moveRightMsupBaseToSuperscript(a)},_canMoveRightWithInToken:function(a){var b=
a.node;if(h.isPlaceHolder(b))return!1;a=a.offset;return this._isTokenNode(b.nodeName)&&0<=a&&a<e.getText(b).length?!0:!1},_canMoveLeftWithInToken:function(a){var b=a.node;if(h.isPlaceHolder(b))return!1;a=a.offset;return this._isTokenNode(b.nodeName)&&0<a&&a<=e.getText(b).length?!0:!1},_moveRightToMsqrtBaseStart:function(a){a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveLeftToMsqrtBaseEnd:function(a){a=a.lastChild;this.path.push({nodeName:a.nodeName,
offset:a.childNodes.length});this.anchor.node=a;this._isTokenNode(a.nodeName)?this.anchor.offset=this._getTextLength(a):this.anchor.offset=1},_moveLeftToMrootBaseEnd:function(a){a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});var b=a.lastChild;this.path.push({nodeName:b.nodeName,offset:e.getChildLength(a)});this.anchor.node=b;this._isTokenNode(b.nodeName)?this.anchor.offset=this._getTextLength(b):this.anchor.offset=1},_moveRightToMrootIndexStart:function(a){a=a.lastChild;this.path.push({nodeName:a.nodeName,
offset:2});a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveLeftToMsupSuperscriptEnd:function(a){a=a.lastChild;this.path.push({nodeName:a.nodeName,offset:2});var b=a.lastChild;this.path.push({nodeName:b.nodeName,offset:a.childNodes.length});this.anchor.node=b;this._isTokenNode(b.nodeName)?this.anchor.offset=this._getTextLength(b):this.anchor.offset=1},_moveLeftToMsubSuperscriptEnd:function(a){this._moveLeftToMsupSuperscriptEnd(a)},_moveRightToMsupBaseStart:function(a){a=
a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveRightToMfencedInnerStart:function(a){a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});a=a.firstChild;this.path.push({nodeName:a.nodeName,offset:1});this.anchor.node=a;this.anchor.offset=0},_moveLeftToMfencedInnerEnd:function(a){a=a.lastChild;this.path.push({nodeName:a.nodeName,offset:1});var b=a.lastChild;this.path.push({nodeName:b.nodeName,
offset:a.childNodes.length});this.anchor.node=b;this._isTokenNode(b.nodeName)?this.anchor.offset=this._getTextLength(b):this.anchor.offset=1},moveLeft:function(){var a=this.anchor.node,b=this.anchor.offset,c=this._isLineStart(this.anchor);if(c){var d=c.previousSibling;d?(this._movePathToPreviousSibling(d),this._moveLineEnd(d)):this._moveLineStart(c)}else if(this._canMoveLeftWithInToken(this.anchor))this.anchor.offset--;else if(c=a.nodeName,"math"===c)if(1===b)a.lastChild?this._moveInNodeEnd(a):this.anchor.offset=
2,this.mode="mathml";else if(2===b)this.anchor.offset=0,this.mode="text";else{if(0===b&&(d=a.previousSibling)&&"text"===d.nodeName)this._movePathToPreviousSibling(d),this.anchor.node=d,this.anchor.offset=e.getText(d).length-1,this.mode="text"}else if((d=a.previousSibling)&&"text"===a.nodeName&&"math"===d.nodeName)this._movePathToPreviousSibling(d),0<e.getChildLength(d)?this._moveInNodeEnd(d):(this.anchor.node=d,this.anchor.offset=2),this.mode="mathml";else if("mfrac"===c&&1===b)b=a.lastChild,"mrow"===
b.nodeName&&(this.path.push({nodeName:b.nodeName,offset:a.childNodes.length}),b=b.lastChild,"mstyle"===b.nodeName&&(b=b.lastChild),this.path.push({nodeName:b.nodeName,offset:b.parentNode.childNodes.length})),this.anchor.node=b,this._isTokenNode(b.nodeName)&&(this.anchor.offset=this._getTextLength(b));else if("msqrt"===c&&1===b)this._moveLeftToMsqrtBaseEnd(a);else if("mroot"===c&&1===b)this._moveLeftToMrootBaseEnd(a);else if("msup"===c&&1===b)this._moveLeftToMsupSuperscriptEnd(a);else if("msub"===
c&&1===b)this._moveLeftToMsubSuperscriptEnd(a);else if("mfenced"===c&&1===b)this._moveLeftToMfencedInnerEnd(a);else if(this._isTokenNode(c)&&0===b)if(d=a.previousSibling)"mstyle"===d.nodeName&&(d=d.lastChild),this._movePathToPreviousSibling(d),"msqrt"===d.nodeName?this._moveLeftToMsqrtBaseEnd(d):"mroot"===d.nodeName?this._moveLeftToMrootBaseEnd(d):"msup"===d.nodeName?this._moveLeftToMsupSuperscriptEnd(d):"msub"===d.nodeName?this._moveLeftToMsubSuperscriptEnd(d):"mfenced"===d.nodeName?this._moveLeftToMfencedInnerEnd(d):
"mfrac"===d.nodeName?this._moveLeftToDenominatorEnd(d):(this.anchor.node=d,a=this._getTextLength(d),this.anchor.offset=0<a?a-1:0);else{this.path.pop();if((a=a.parentNode)&&"mstyle"===a.nodeName)a=a.parentNode;this._isDenominatorMrow(a)?this._moveLeftDenominatorToNumerator(a):this._isNumeratorMrow(a)?(this.path.pop(),this.anchor.node=a.parentNode):this._isSqrt(a)?(this.anchor.node=a,this.anchor.offset=0):this._isRootBaseMrow(a)?this._moveLeftMrootBaseToIndex(a):this._isRootIndexMrow(a)?this._moveToTopLeft(a):
this._isSupSuperscriptMrow(a)?this._moveLeftMsupSuperscriptToBase(a):this._isSubSubscriptMrow(a)?this._moveLeftMsubSubscriptToBase(a):this._isSupBaseMrow(a)||this._isSubBaseMrow(a)?this._moveToTopLeft(a):this._isFirstChildFenceChildMrow(a)?this._moveToTopLeft(a):a&&(this.anchor.node=a,"math"===a.nodeName&&(this.mode="text"))}else if(("mfrac"===c||"msqrt"===c||"mroot"===c||"msup"===c||"msub"===c||"mfenced"===c)&&0===b)"mstyle"===a.parentNode.nodeName&&(a=a.parentNode),(d=a.previousSibling)?("mstyle"===
d.nodeName&&(d=d.lastChild),this._movePathToPreviousSibling(d),"msqrt"===d.nodeName?this._moveLeftToMsqrtBaseEnd(d):"mroot"===d.nodeName?this._moveLeftToMrootBaseEnd(d):"msup"===d.nodeName?this._moveLeftToMsupSuperscriptEnd(d):"msub"===d.nodeName?this._moveLeftToMsubSuperscriptEnd(d):"mfenced"===d.nodeName?this._moveLeftToMfencedInnerEnd(d):"mfrac"===d.nodeName?this._moveLeftToDenominatorEnd(d):(this.anchor.node=d,a=this._getTextLength(d),this.anchor.offset=0<a?a-1:0)):(this.path.pop(),a=a.parentNode,
"mstyle"===a.nodeName&&(a=a.parentNode),this._isDenominatorMrow(a)?this._moveLeftDenominatorToNumerator(a):this._isNumeratorMrow(a)?(this.path.pop(),this.anchor.node=a.parentNode):this._isSqrt(a)?(this.anchor.node=a,this.anchor.offset=0):this._isRootBaseMrow(a)?this._moveLeftMrootBaseToIndex(a):this._isRootIndexMrow(a)?this._moveToTopLeft(a):this._isSupSuperscriptMrow(a)?this._moveLeftMsupSuperscriptToBase(a):this._isSubSubscriptMrow(a)?this._moveLeftMsubSubscriptToBase(a):this._isSupBaseMrow(a)||
this._isSubBaseMrow(a)?this._moveToTopLeft(a):this._isFirstChildFenceChildMrow(a)?this._moveToTopLeft(a):a&&(this.anchor.node=a,"math"===a.nodeName&&(this.mode="text")))},moveRight:function(){var a=this._isLineEnd(this.anchor);if(a){var b=a.nextSibling;b?(this._movePathToNextSibling(b),this._moveLineStart(b)):this._moveLineEnd(a)}else if(this._canMoveRightWithInToken(this.anchor))this.anchor.offset++;else{var a=this.anchor.node,c=this.anchor.offset,d=a.nodeName;if("math"===d)if(0==c)a.firstChild?
this._moveInNodeStart(a):this.anchor.offset=2,this.mode="mathml";else if(2==c)this.anchor.offset=1,this.mode="text";else{if(1==c&&(b=a.nextSibling)&&"text"===b.nodeName)this._movePathToNextSibling(b),this.anchor.node=b,this.anchor.offset=1,this.mode="text"}else if((b=a.nextSibling)&&"text"===a.nodeName&&"math"===b.nodeName)this._movePathToNextSibling(b),0<e.getChildLength(b)?this._moveInNodeStart(b):(this.anchor.node=b,this.anchor.offset=2),this.mode="mathml";else if("mfrac"===d&&0===c)b=a.firstChild,
"mrow"===b.nodeName&&(this.path.push({nodeName:b.nodeName,offset:1}),b=b.firstChild,"mstyle"===b.nodeName&&(b=b.firstChild),this.path.push({nodeName:b.nodeName,offset:1})),this.anchor.node=b;else if("msqrt"===d&&0===c)this._moveRightToMsqrtBaseStart(a);else if("mroot"===d&&0===c)this._moveRightToMrootIndexStart(a);else if("msup"===d&&0===c)this._moveRightToMsupBaseStart(a);else if("mfenced"===d&&0===c)this._moveRightToMfencedInnerStart(a);else if(("msqrt"===d||"mfrac"===d||"mroot"===d||"msup"===d||
"mfenced"===d)&&1===c)"mstyle"===a.parentNode.nodeName&&(a=a.parentNode),(b=a.nextSibling)?("mstyle"===b.nodeName&&(b=b.firstChild),this._movePathToNextSibling(b),"msqrt"===b.nodeName?this._moveRightToMsqrtBaseStart(b):"mroot"===b.nodeName?this._moveRightToMrootIndexStart(b):"msup"===b.nodeName?this._moveRightToMsupBaseStart(b):"mfenced"===b.nodeName?this._moveRightToMfencedInnerStart(b):"mfrac"===b.nodeName?this._moveRightToNumeratorStart(b):(this.anchor.node=b,0<this._getTextLength(b)?this.anchor.offset=
1:this.anchor.offset=0)):(this.path.pop(),b=a.parentNode,"mstyle"===b.nodeName&&(b=b.parentNode),this._isNumeratorMrow(b)?this._moveRightNumeratorToDenominator(b):this._isDenominatorMrow(b)?this._moveToTopRight(b):this._isSqrt(b)?(this.anchor.node=b,this.anchor.offset=1):this._isRootIndexMrow(b)?this._moveRightMrootIndexToBase(b):this._isRootBaseMrow(b)?this._moveToTopRight(b):this._isSupBaseMrow(b)?this._moveRightMsupBaseToSuperscript(b):this._isSubBaseMrow(b)?this._moveRightMsubBaseToSubscript(b):
this._isSupSuperscriptMrow(b)?this._moveToTopRight(b):this._isSubSubscriptMrow(b)?this._moveToTopRight(b):this._isLastFenceChildMrow(b)?this._moveToTopRight(b):b&&(this.anchor.node=b,"math"===b.nodeName&&(this.mode="text")));else if(this._isTokenNode(d)&&c===this._getTextLength(a))if(b=a.nextSibling)"mstyle"===b.nodeName&&(b=b.firstChild),this._movePathToNextSibling(b),"msqrt"===b.nodeName?this._moveRightToMsqrtBaseStart(b):"mroot"===b.nodeName?this._moveRightToMrootIndexStart(b):"msup"===b.nodeName?
this._moveRightToMsupBaseStart(b):"mfenced"===b.nodeName?this._moveRightToMfencedInnerStart(b):"mfrac"===b.nodeName?this._moveRightToNumeratorStart(b):(this.anchor.node=b,this.anchor.offset=1);else{this.path.pop();if((b=a.parentNode)&&"mstyle"===b.nodeName)b=b.parentNode;this._isNumeratorMrow(b)?this._moveRightNumeratorToDenominator(b):this._isDenominatorMrow(b)?this._moveToTopRight(b):this._isSqrt(b)?(this.anchor.node=b,this.anchor.offset=1):this._isRootIndexMrow(b)?this._moveRightMrootIndexToBase(b):
this._isRootBaseMrow(b)?this._moveToTopRight(b):this._isSupBaseMrow(b)?this._moveRightMsupBaseToSuperscript(b):this._isSubBaseMrow(b)?this._moveRightMsubBaseToSubscript(b):this._isSupSuperscriptMrow(b)?this._moveToTopRight(b):this._isSubSubscriptMrow(b)?this._moveToTopRight(b):this._isLastFenceChildMrow(b)?this._moveToTopRight(b):b&&(this.anchor.node=b,this.anchor.offset=1,"math"===b.nodeName&&(this.mode="text"))}}},moveUp:function(){},moveDown:function(){},_getFocusLine:function(){for(var a=this.getFocusNode();a&&
"line"!=a.nodeName;)a=a.parentNode;return a},_isNotSameNode:function(a,b){return a==b.nodeName},_isLineNode:function(a){return"line"==a.nodeName},_isTextNode:function(a){return"text"==a.nodeName},_insertChar:function(a){var b=this.anchor.node,c=this.anchor.offset,d=e.getText(b);a=m.insertAtOffset(d,c,a);e.setText(b,a);this._updateAnchor(b,c+1)},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?"":u.innerXML(this.doc)},isEmpty:function(){return""==this.getXML()},getPath:function(){var a=
"";t.forEach(this.path,function(b,c){a+="/";a+=b.nodeName;b.offset&&(a+="["+b.offset+"]")});return a},getFocusNode:function(){return this.anchor.node},getOffset:function(){return this.anchor.offset},getLines:function(){return this.doc.documentElement.childNodes},getLineAt:function(a){return this.getLines()[a]},getLineCount:function(){return this.getLines().length},getHTML:function(){return z.xmlDocToHtml(this.doc)}})});
//@ sourceMappingURL=Model.js.map