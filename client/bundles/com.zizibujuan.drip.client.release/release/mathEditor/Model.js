//>>built
define("mathEditor/Model","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/dom-construct,dojox/xml/parser,mathEditor/string,mathEditor/dataUtil,mathEditor/lang,mathEditor/xmlUtil".split(","),function(o,i,m,k,n,l,p,h,j){return o(null,{path:null,xmlString:null,doc:null,cursorPosition:null,constructor:function(a){this._init();i.mixin(this,a)},_init:function(){this.doc=n.parse("<root><line></line></root>");this.path=[];this.cursorPosition={};this.cursorPosition.node=this.doc.documentElement.firstChild;
this.cursorPosition.offset=0;this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1})},clear:function(){this._init();this.onChange()},loadData:function(){},setData:function(a){var b=a.data,d=a.nodeName;if((a=a.removeCount)&&0<a)for(var c=0;c<a;c++)this.removeLeft();var f=this.doc;if(d&&""!=d){if("mfrac"==d){this._splitNodeIfNeed();var b=this.cursorPosition.node,e=1,a="last";if(this._isTextNode(b))a=this.path.pop().offset,e=a+1,a="after";this._isLineNode(b)||this._isTextNode(b)?
(this.path.push({nodeName:"math",offset:e}),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=f.createElement("math"),e=j.createEmptyFrac(f),c.appendChild(e.rootNode),k.place(c,b,a)):(this.path.pop(),this.path.push({nodeName:"mfrac",offset:e}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=b.parentNode,a=e-1,e=j.createFracWithNumerator(f,b),k.place(e.rootNode,c,a));this.cursorPosition.node=
e.focusNode;this.cursorPosition.offset=0;this.onChange();return}if("msup"==d){this._splitNodeIfNeed();b=this.cursorPosition.node;e=1;a="last";if(this._isTextNode(b))a=this.path.pop().offset,e=a+1,a="after";this._isLineNode(b)||this._isTextNode(b)?(this.path.push({nodeName:"math",offset:e}),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=f.createElement("math"),e=j.createEmptyMsup(f),c.appendChild(e.rootNode),k.place(c,
b,a)):(this.path.pop(),this.path.push({nodeName:"msup",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=b.parentNode,e=j.createMsupWithBase(f,b),k.place(e.rootNode,c,0));this.cursorPosition.node=e.focusNode;this.cursorPosition.offset=0;this.onChange();return}}a=[];i.isString(b)?a=l.splitData(b):i.isArray(b)&&(a=b);m.forEach(a,i.hitch(this,function(a){var b=this.cursorPosition.node;if(h.isNumber(a)){d="mn";var c=b.nodeName;if("line"==c||"text"==c){var e=
this.cursorPosition.offset,c="last",i=1;if(this._isLineNode(b))c="last",i=1;else if(this._isTextNode(b)){this._splitNodeIfNeed();var g=this.path.pop();0<e?(c="after",i=g.offset+1):c="before"}e=f.createElement("math");g=f.createElement(d);e.appendChild(g);k.place(e,b,c);this.cursorPosition.node=g;this.cursorPosition.offset=0;this._insertChar(a);this.path.push({nodeName:"math",offset:i});this.path.push({nodeName:d,offset:1})}else if(h.isMathTokenNode(b)){b=this.cursorPosition.node;j.isPlaceHolder(b)&&
j.removePlaceHolder(b);if(b.nodeName!=d)g=f.createElement(d),h.insertNodeAfter(g,b),this.cursorPosition.node=g,this.cursorPosition.offset=0,g=this.path.pop(),this.path.push({nodeName:d,offset:g.offset+1});this._insertChar(a)}}else if(h.isOperator(a))if(this._isLineNode(b))e=f.createElement("math"),b.appendChild(e),g=f.createElement("mo"),e.appendChild(g),this.cursorPosition.node=g,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",
offset:1});else if(h.isMathTokenNode(b))b=this.cursorPosition.node,c=f.createElement("mo"),h.insertNodeAfter(c,b),this.cursorPosition.node=c,this.cursorPosition.offset=0,this._insertChar(a),g=this.path.pop(),this.path.push({nodeName:"mo",offset:g.offset+1});else{if(this._isTextNode(b))e=f.createElement("math"),h.insertNodeAfter(e,b),g=f.createElement("mo"),e.appendChild(g),this.cursorPosition.node=g,this.cursorPosition.offset=0,this._insertChar(a),g=this.path.pop(),this.path.push({nodeName:"math",
offset:g.offset+1}),this.path.push({nodeName:"mo",offset:1})}else if(h.isNewLine(a)){a=this._getFocusLine();b=this.doc.createElement("line");h.insertNodeAfter(b,a);this.cursorPosition.node=b;this.cursorPosition.offset=0;for(g=this.path.pop();"line"!=g.nodeName;)g=this.path.pop();this.path.push({nodeName:"line",offset:g.offset+1})}else if(this._isLineNode(b))c=f.createElement("text"),b.appendChild(c),this.cursorPosition.node=c,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"text",
offset:1});else if(this._isTextNode(b))this._insertChar(a);else if(h.isMathTokenNode(b)){do g=this.path.pop();while(g&&"math"!=g.nodeName);c=f.createElement("text");for(e=b;"math"!=e.nodeName;)e=e.parentNode;h.insertNodeAfter(c,e);this.cursorPosition.node=c;this.cursorPosition.offset=0;this._insertChar(a);this.path.push({nodeName:"text",offset:g.offset+1})}}));this.onChange(b)},doDelete:function(){if(""!=this.removeLeft())this.onChange()},removeLeft:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,
d=b.textContent;if(0==a){a=b;if("text"!=b.nodeName&&"line"!=b.nodeName){for(;"math"!=a.nodeName;)a=a.parentNode;if(a=a.previousSibling){var b=a.textContent,c=b.length,d=l.insertAtOffset(b,c,"",1),c=c-1;""==d?(a.parentNode.removeChild(a),this.path.pop()):(a.textContent=d,this.cursorPosition.node=a,this.cursorPosition.offset=c);return c=b.charAt(c)}}else if("line"==b.nodeName&&1<this.getLineCount()){a=b.previousSibling;c=a.childNodes.length;if(0==c)this.cursorPosition.node=a,this.cursorPosition.offset=
0,d=this.path.pop(),d.offset--,this.path.push(d),b.parentNode.removeChild(b);else if(a=a.lastChild,"text"==a.nodeName)this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,d=this.path.pop(),d.offset--,this.path.push(d),this.path.push({nodeName:a.nodeName,offset:c}),b.parentNode.removeChild(b);else if("math"==a.nodeName){var f=a.childNodes.length,a=a.lastChild;this.cursorPosition.node=a;this.cursorPosition.offset=a.textContent.length;d=this.path.pop();d.offset--;this.path.push(d);
this.path.push({nodeName:"math",offset:c});this.path.push({nodeName:a.nodeName,offset:f});b.parentNode.removeChild(b)}return"\n"}return""}"mo"==b.nodeName?(c=b.textContent,d=""):(c=d.charAt(a-1),d=l.insertAtOffset(d,a,"",1));if(""==d)if(a=b.previousSibling)"math"==a.nodeName?(f=a.childNodes.length,a=a.lastChild,this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,d=this.path.pop(),this.path.push({nodeName:"math",offset:d.offset-1}),this.path.push({nodeName:a.nodeName,offset:f}),
b.parentNode.removeChild(b)):(this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,b.parentNode.removeChild(b),this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:this.path.pop().offset-1}));else{f=d=b;if("text"!=b.nodeName&&"line"!=b.nodeName)for(;"math"!=f.nodeName;)d=f.parentNode,d.removeChild(f),f=d,this.path.pop();a=f.previousSibling;d=f.parentNode;d.removeChild(f);b=this.path.pop().offset;a?(this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,
this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:b-1})):(this.cursorPosition.node=d,this.cursorPosition.offset=d.childElementCount)}else this.cursorPosition.node.textContent=d,this.cursorPosition.offset-=1;return c},moveLeft:function(){var a=this.cursorPosition.node,b=this.cursorPosition.offset;if("line"==a.nodeName){if(b=a.previousSibling){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length}}else if(0<b)this.cursorPosition.offset--;
else if(0==b)if(b=a.previousSibling){if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length-1}else if(b=a.parentNode.previousSibling)if("line"==b.nodeName){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length}else a=b.textContent,this.cursorPosition.node=b,this.cursorPosition.offset=a.length-1},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},
_splitNodeIfNeed:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,d=b.textContent,c=d.length;if(0<a&&a<c)c=d.substring(0,a),a=d.substring(a),d=this.doc.createElement(b.nodeName),b.textContent=c,d.textContent=a,h.insertNodeAfter(d,b)},_getFocusLine:function(){for(var a=this.getFocusNode();a&&"line"!=a.nodeName;)a=a.parentNode;return a},_isNotSameNode:function(a,b){return a==b.nodeName},_isLineNode:function(a){return"line"==a.nodeName},_isTextNode:function(a){return"text"==a.nodeName},
_insertChar:function(a){this.cursorPosition.node.textContent=l.insertAtOffset(this.cursorPosition.node.textContent,this.cursorPosition.offset,a);this.cursorPosition.offset+=1},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?"":n.innerXML(this.doc)},getPath:function(){var a="";m.forEach(this.path,function(b){a+="/";a+=b.nodeName;b.offset&&(a+="["+b.offset+"]")});return a},getFocusNode:function(){return this.cursorPosition.node},getOffset:function(){return this.cursorPosition.offset},
getLineAt:function(a){return this.doc.documentElement.childNodes[a]},getHTML:function(){return p.xmlDocToHtml(this.doc)},onChange:function(){}})});