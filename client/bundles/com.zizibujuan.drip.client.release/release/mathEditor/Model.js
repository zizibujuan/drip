//>>built
define("mathEditor/Model","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/dom-construct,dojox/xml/parser,mathEditor/string,mathEditor/dataUtil,mathEditor/lang,mathEditor/xmlUtil".split(","),function(t,p,q,k,s,n,u,g,i){return t(null,{path:null,xmlString:null,doc:null,mode:"text",anchor:null,constructor:function(c){this._init();p.mixin(this,c)},_isTextMode:function(){return"text"===this.mode},_isMathMLMode:function(){return"mathml"===this.mode},_toTextMode:function(){this.mode="text"},_toMathMLMode:function(){this.mode=
"mathml"},_init:function(){this.doc=s.parse("<root><line></line></root>");this.path=[];this.anchor={};this._updateAnchor(this.doc.documentElement.firstChild,0);this._toTextMode();this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1})},clear:function(){this._init();this.onChange()},loadData:function(){},_split:function(c){return c.split(/\r\n|\r|\n/)},insertText:function(c,b){if(!b||0==b.length)return c;var a=c.node,e=c.offset,d=this._split(b),f=d.splice(0,1)[0],j=d.splice(d.length-
1,d.length)[0],h=this.doc;if(this._isLineNode(a)){var i="text",e=h.createElement(i);a.appendChild(e);a=e;e=0;this.path.push({nodeName:i,offset:0})}if(0<f.length){a.textContent=n.insertAtOffset(a.textContent,e,f);e+=f.length;f=this.path.pop();if(0==f.offset)f.offset=1;this.path.push(f)}if(null!=j){var i="line",r=this._getFocusLine();0<d.length&&q.forEach(d,function(a){var b=h.createElement(i);b.textContent=a;g.insertNodeAfter(b,r);r=b});i="line";a=h.createElement(i);g.insertNodeAfter(a,r);0==j.length?
(e=0,this.path.pop(),f=this.path.pop(),this.path.push({nodeName:i,offset:f.offset+1})):(i="text",e=h.createElement(i),e.textContent=j,a.appendChild(e),a=e,e=j.length,this.path.pop(),f=this.path.pop(),f.offset++,this.path.push(f),this.path.push({nodeName:i,offset:1}))}return{node:a,offset:e}},findTrigonometric:function(c,b){for(var a=[],e=[],d=c.node,f=d;f&&"mi"==f.nodeName&&1==f.textContent.length&&!(a.unshift(f.textContent),f=d.previousSibling,2==a.length););if(2==a.length){if(d=a.join("")+b,g.isTrigonometric(d))return{functionName:d,
preMis:a,nextMis:e}}else if(1==a.length){if((d=d.nextSibling)&&"mi"==d.nodeName&&1==d.textContent.length)if(d=a[0]+b+d.textContent,g.isTrigonometric(d))return{functionName:d,preMis:a,nextMis:e}}else if(0==a.length){d=d.nextSibling;for(e=[];d&&"mi"==d.nodeName&&1==d.textContent.length&&!(e.push(d.textContent),d=d.nextSibling,2==e.length););if(2==e.length&&(d=b+e.join(""),g.isTrigonometric(d)))return{functionName:d,preMis:a,nextMis:e}}return null},removeExistTrigonometricPart:function(c,b){var a=c.node,
e=c.offset,d=b.preMis.length;2==d?(e=a.previousSibling.previousSibling,a.parentNode.removeChild(a.previousSibling),a.parentNode.removeChild(a),a=this.path.pop(),a.offset-=2,this.path.push(a),a=e,e="mi"==a.nodeName||"mo"==a.nodeName?1:a.textContent.length):1==d?(e=a.previousSibling,a.parentNode.removeChild(a.nextSibling),a.parentNode.removeChild(a),a=this.path.pop(),a.offset--,this.path.push(a),a=e,e="mi"==a.nodeName||"mo"==a.nodeName?1:a.textContent.length):0==d&&(a.parentNode.removeChild(a.nextSibling),
a.parentNode.removeChild(a.nextSibling),e="mi"==a.nodeName||"mo"==a.nodeName?1:a.textContent.length);return{node:a,offset:e}},insertMi:function(c,b){var a=c.node,e=c.offset,d=this.doc;this._isLineNode(a)?(this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mi",offset:1}),e=d.createElement("math"),d=d.createElement("mi"),d.textContent=b,e.appendChild(d),a.appendChild(e)):(d=d.createElement("mi"),d.textContent=b,0==e?(e=this.path.pop(),this.path.push({nodeName:"mi",offset:e.offset}),
g.insertNodeBefore(d,a)):1==e&&(e=this.path.pop(),this.path.push({nodeName:"mi",offset:e.offset+1}),g.insertNodeAfter(d,a)));return{node:d,offset:1}},insertMn:function(c,b){var a=c.node,e=c.offset,d=this.doc;if(this._isLineNode(a))e=d.createElement("math"),d=d.createElement("mn"),d.textContent=b,e.appendChild(d),a.appendChild(e),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mn",offset:1}),a=d,e=b.length;else if(!this._isTextNode(a))a.textContent=n.insertAtOffset(a.textContent,
e,b),e+=b.length;return{node:a,offset:e}},insertMo:function(c,b){var a=c.node,e=c.offset,d=this.doc;this._isLineNode(a)?(e=d.createElement("math"),d=d.createElement("mo"),d.textContent=b,e.appendChild(d),a.appendChild(e),a=d,e=1,this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1})):this._isTextNode(a)?(e=d.createElement("math"),d=d.createElement("mo"),d.textContent=b,e.appendChild(d),g.insertNodeAfter(e,a),a=d,e=1,d=this.path.pop(),this.path.push({nodeName:"math",offset:d.offset+
1}),this.path.push({nodeName:"mo",offset:1})):"="==b&&"mo"==a.nodeName&&"="==a.textContent?a.textContent+="=":"="==b&&"mo"==a.nodeName&&"!"==a.textContent?a.textContent+="=":(d=d.createElement("mo"),d.textContent=b,g.insertNodeAfter(d,a),a=d,e=1,d=this.path.pop(),this.path.push({nodeName:"mo",offset:d.offset+1}));return{node:a,offset:e}},insertFenced:function(c,b){var a=c.node,e=c.offset,d=this.doc;if(this._isLineNode(a)||this._isTextNode(a)){this.path.push({nodeName:"math",offset:e+1});this.path.push({nodeName:"mfenced",
offset:1});this.path.push({nodeName:"mrow",offset:1});this.path.push({nodeName:"mn",offset:1});var f=d.createElement("math"),g=d.createElement("mfenced"),h={"{":{left:"{",right:"}"},"[":{left:"[",right:"]"},"|":{left:"|",right:"|"}};"("!=b&&(g.setAttribute("open",h[b].left),g.setAttribute("close",h[b].right));h=d.createElement("mrow");d=i.getPlaceHolder(d);f.appendChild(g);g.appendChild(h);h.appendChild(d);k.place(f,a,e);a=d;e=0}return{node:a,offset:e}},insertTrigonometric:function(c,b,a){var e=c.node,
c=c.offset,d=this.doc;if(this._isLineNode(e)||this._isTextNode(e)){this.path.push({nodeName:"math",offset:c+1});this.path.push({nodeName:"mrow",offset:3});this.path.push({nodeName:"mn",offset:1});var f=d.createElement("math"),a=d.createElement(a),j=d.createElement("mo"),h=d.createElement("mrow"),d=i.getPlaceHolder(d);a.textContent=b;j.textContent="&#x2061;";h.appendChild(d);f.appendChild(a);f.appendChild(j);f.appendChild(h);k.place(f,e,c)}else this.path.push({nodeName:"mrow",offset:this.path.pop().offset+
3}),this.path.push({nodeName:"mn",offset:1}),a=d.createElement(a),j=d.createElement("mo"),h=d.createElement("mrow"),d=i.getPlaceHolder(d),a.textContent=b,j.textContent="&#x2061;",h.appendChild(d),g.insertNodeAfter(a,e),g.insertNodeAfter(j,a),g.insertNodeAfter(h,j);return{node:d,offset:0}},insertMfrac:function(c){var b=c.node,c=c.offset,a=this.doc,e=1,c="last";this._isTextNode(b)&&(e=this.path.pop().offset+1,c="after");if(this._isLineNode(b)||this._isTextNode(b)){this.path.push({nodeName:"math",offset:e});
this.path.push({nodeName:"mfrac",offset:1});this.path.push({nodeName:"mrow",offset:1});this.path.push({nodeName:"mn",offset:1});var d=a.createElement("math"),a=i.createEmptyFrac(a);d.appendChild(a.rootNode);k.place(d,b,c)}else this.path.pop(),this.path.push({nodeName:"mfrac",offset:e}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),d=b.parentNode,c=e-1,a=i.createFracWithNumerator(a,b),k.place(a.rootNode,d,c);b=a.focusNode;return{node:b,offset:0}},insertMsqrt:function(c){var b=
c.node,c=c.offset,a=this.doc,e=1,d="last";this._isTextNode(b)&&(e=this.path.pop().offset+1,d="after");this._isLineNode(b)||this._isTextNode(b)?(this.path.push({nodeName:"math",offset:e}),this.path.push({nodeName:"msqrt",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1}),c=a.createElement("math"),a=i.createEmptyMsqrt(a),c.appendChild(a.rootNode),k.place(c,b,d)):(this.path.pop(),this.path.push({nodeName:"msqrt",offset:c+1}),this.path.push({nodeName:"mrow",
offset:1}),this.path.push({nodeName:"mn",offset:1}),b=b.parentNode,a=i.createEmptyMsqrt(a),k.place(a.rootNode,b,c));b=a.focusNode;return{node:b,offset:0}},insertMroot:function(c){var b=c.node,c=c.offset,a=this.doc,e=1,d="last";this._isTextNode(b)&&(e=this.path.pop().offset+1,d="after");this._isLineNode(b)||this._isTextNode(b)?(this.path.push({nodeName:"math",offset:e}),this.path.push({nodeName:"mroot",offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),c=
a.createElement("math"),a=i.createEmptyMroot(a),c.appendChild(a.rootNode),k.place(c,b,d)):(this.path.pop(),this.path.push({nodeName:"mroot",offset:c+1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),b=b.parentNode,a=i.createEmptyMroot(a),k.place(a.rootNode,b,c));b=a.focusNode;return{node:b,offset:0}},insertScripting:function(c,b,a){var b=c.node,c=c.offset,c=this.doc,e=1,d="last";this._isTextNode(b)&&(e=this.path.pop().offset+1,d="after");this._isLineNode(b)||
this._isTextNode(b)?(this.path.push({nodeName:"math",offset:e}),this.path.push({nodeName:a,offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),e=c.createElement("math"),a=i.createEmptyScripting(c,a),e.appendChild(a.rootNode),k.place(e,b,d)):(this.path.pop(),this.path.push({nodeName:a,offset:1}),this.path.push({nodeName:"mrow",offset:2}),this.path.push({nodeName:"mn",offset:1}),d=b.parentNode,a=i.createScriptingWithBase(c,b,a),k.place(a.rootNode,d,0));b=a.focusNode;
return{node:b,offset:0}},_splitNodeIfNeed:function(c){var b=this.anchor.offset,a=this.anchor.node;if(a.nodeName!=c){var e=a.textContent,c=e.length;if(0<b&&b<c)c=e.substring(0,b),b=e.substring(b),e=this.doc.createElement(a.nodeName),a.textContent=c,e.textContent=b,g.insertNodeAfter(e,a)}},setData:function(c){var b=c.data,a=c.nodeName;if((c=c.removeCount)&&0<c)for(var e=0;e<c;e++)this.removeLeft();if(this._isTextMode())this.anchor=this.insertText(this.anchor,b),this.onChange(b);else{if(this._isMathMLMode()){if(g.isLetter(b)){(c=
this.findTrigonometric(this.anchor,b))?(this.anchor=this.removeExistTrigonometricPart(this.anchor,c),this.anchor=this.insertTrigonometric(this.anchor,c.functionName,a||"mi")):this.anchor=this.insertMi(this.anchor,b);this.onChange(b);return}if(g.isNumber(b)){c=this.anchor.node;i.isPlaceHolder(c)&&i.removePlaceHolder(c);this.anchor=this.insertMn(this.anchor,b);this.onChange(b);return}if(g.isOperator(b)){this.anchor=this.insertMo(this.anchor,b);this.onChange(b);return}if(g.isTrigonometric(b)){this.anchor=
this.insertTrigonometric(this.anchor,b,a);this.onChange(b);return}if(g.isGreekLetter(b)){this.anchor=this.insertMi(this.anchor,b);this.onChange(b);return}if(g.isFenced(b)){this.anchor=this.insertFenced(this.anchor,b);this.onChange(b);return}if("mfrac"===a){this._splitNodeIfNeed(a);this.anchor=this.insertMfrac(this.anchor,b,a);this.onChange(b);return}if("msqrt"===a){this._splitNodeIfNeed(a);this.anchor=this.insertMsqrt(this.anchor,b,a);this.onChange(b);return}if("mroot"===a){this._splitNodeIfNeed(a);
this.anchor=this.insertMroot(this.anchor,b,a);this.onChange(b);return}if("msub"===a||"msup"==a){this._splitNodeIfNeed(a);this.anchor=this.insertScripting(this.anchor,b,a);this.onChange(b);return}}var d=this.doc,c=this.anchor.node,e=this.anchor.offset;if(a&&""!=a){this._isTextNode(c)&&this.path.pop();if("mfrac"!=a&&"msup"!=a&&"msub"!=a&&"msqrt"!=a&&"mroot"!=a&&"mi"==a&&g.isTrigonometric(b)&&(this._isLineNode(c)||this._isTextNode(c))){this.path.push({nodeName:"math",offset:e+1});this.path.push({nodeName:"mrow",
offset:3});this.path.push({nodeName:"mn",offset:1});var a=d.createElement("math"),f=d.createElement("mi"),j=d.createElement("mo"),h=d.createElement("mrow"),o=i.getPlaceHolder(d);f.textContent=b;j.textContent="&#x2061;";h.appendChild(o);a.appendChild(f);a.appendChild(j);a.appendChild(h);k.place(a,c,e);this._updateAnchor(o,0)}this.onChange()}else if(g.isFenced(b)){if(this._isLineNode(c)||this._isTextNode(c))this.path.push({nodeName:"math",offset:e+1}),this.path.push({nodeName:"mfenced",offset:1}),this.path.push({nodeName:"mrow",
offset:1}),this.path.push({nodeName:"mn",offset:1}),a=d.createElement("math"),f=d.createElement("mfenced"),h={"{":{left:"{",right:"}"},"[":{left:"[",right:"]"},"|":{left:"|",right:"|"}},"("!=b&&(f.setAttribute("open",h[b].left),f.setAttribute("close",h[b].right)),h=d.createElement("mrow"),o=i.getPlaceHolder(d),a.appendChild(f),f.appendChild(h),h.appendChild(o),k.place(a,c,e),this.anchor.node=o,this.anchor.offset=0;this.onChange()}else c=[],p.isString(b)?c=n.splitData(b):p.isArray(b)&&(c=b),q.forEach(c,
p.hitch(this,function(a){var b=this.anchor.node;if(g.isNumber(a)){var c="mn",e=b.nodeName;if("line"==e||"text"==e){var e=this.anchor.offset,f="last",h=1;if(this._isLineNode(b))f="last",h=1;else if(this._isTextNode(b)){this._splitNodeIfNeed();var j=this.path.pop();0<e?(f="after",h=j.offset+1):f="before"}var m=d.createElement("math"),l=d.createElement(c);m.appendChild(l);k.place(m,b,f);this.anchor.node=l;this.anchor.offset=0;this._insertChar(a);this.path.push({nodeName:"math",offset:h});this.path.push({nodeName:c,
offset:1})}else if(g.isMathTokenNode(b)){b=this.anchor.node;i.isPlaceHolder(b)&&i.removePlaceHolder(b);if(b.nodeName!=c)e=d.createElement(c),g.insertNodeAfter(e,b),this.anchor.node=e,this.anchor.offset=0,j=this.path.pop(),this.path.push({nodeName:c,offset:j.offset+1});this._insertChar(a)}}else if(g.isOperator(a)){var c="mo";this._isLineNode(b)?(m=d.createElement("math"),l=d.createElement(c),m.appendChild(l),this._updateAnchor(l,0),this._insertChar(a),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:c,
offset:1}),k.place(m,b,e)):g.isMathTokenNode(b)?"="==a&&"mo"==b.nodeName&&"="==b.textContent?b.textContent+="=":"="==a&&"mo"==b.nodeName&&"!"==b.textContent?b.textContent+="=":(l=d.createElement(c),this._updateAnchor(l,0),this._insertChar(a),j=this.path.pop(),this.path.push({nodeName:c,offset:j.offset+1}),g.insertNodeAfter(l,b)):this._isTextNode(b)&&(m=d.createElement("math"),l=d.createElement(c),m.appendChild(l),this._updateAnchor(l,0),this._insertChar(a),j=this.path.pop(),this.path.push({nodeName:"math",
offset:j.offset+1}),this.path.push({nodeName:c,offset:1}),g.insertNodeAfter(m,b))}else if(this._isLineNode(b))f=e,c="text",l=d.createElement(c),this._updateAnchor(l,0),this.path.push({nodeName:c,offset:1}),this._insertChar(a),k.place(l,b,f);else if(this._isTextNode(b))this._insertChar(a);else if(g.isMathTokenNode(b)){do j=this.path.pop();while(j&&"math"!=j.nodeName);c=d.createElement("text");for(m=b;"math"!=m.nodeName;)m=m.parentNode;g.insertNodeAfter(c,m);this.anchor.node=c;this.anchor.offset=0;
this._insertChar(a);this.path.push({nodeName:"text",offset:j.offset+1})}})),this.onChange(b)}},_updateAnchor:function(c,b){this.anchor.node=c;this.anchor.offset=b},doDelete:function(){if(""!=this.removeLeft())this.onChange()},removeLeft:function(){var c=this.anchor.offset,b=this.anchor.node,a=b.textContent;if(0==c){c=b;if("text"!=b.nodeName&&"line"!=b.nodeName){for(;"math"!=c.nodeName;)c=c.parentNode;if(c=c.previousSibling){var b=c.textContent,e=b.length,a=n.insertAtOffset(b,e,"",1),e=e-1;""==a?(c.parentNode.removeChild(c),
this.path.pop()):(c.textContent=a,this.anchor.node=c,this.anchor.offset=e);return e=b.charAt(e)}}else if("line"==b.nodeName&&1<this.getLineCount()){c=b.previousSibling;e=c.childNodes.length;if(0==e)this.anchor.node=c,this.anchor.offset=0,a=this.path.pop(),a.offset--,this.path.push(a),b.parentNode.removeChild(b);else if(c=c.lastChild,"text"==c.nodeName)this.anchor.node=c,this.anchor.offset=c.textContent.length,a=this.path.pop(),a.offset--,this.path.push(a),this.path.push({nodeName:c.nodeName,offset:e}),
b.parentNode.removeChild(b);else if("math"==c.nodeName){var d=c.childNodes.length,c=c.lastChild;this.anchor.node=c;this.anchor.offset=c.textContent.length;a=this.path.pop();a.offset--;this.path.push(a);this.path.push({nodeName:"math",offset:e});this.path.push({nodeName:c.nodeName,offset:d});b.parentNode.removeChild(b)}return"\n"}return""}"mo"==b.nodeName?(e=b.textContent,a=""):(e=a.charAt(c-1),a=n.insertAtOffset(a,c,"",1));if(""==a)if(c=b.previousSibling)"math"==c.nodeName?(d=c.childNodes.length,
c=c.lastChild,this.anchor.node=c,this.anchor.offset=c.textContent.length,a=this.path.pop(),this.path.push({nodeName:"math",offset:a.offset-1}),this.path.push({nodeName:c.nodeName,offset:d}),b.parentNode.removeChild(b)):(this.anchor.node=c,this.anchor.offset=c.textContent.length,b.parentNode.removeChild(b),this.path.push({nodeName:this.anchor.node.nodeName,offset:this.path.pop().offset-1}));else{d=a=b;if("text"!=b.nodeName&&"line"!=b.nodeName)for(;"math"!=d.nodeName;)a=d.parentNode,a.removeChild(d),
d=a,this.path.pop();c=d.previousSibling;a=d.parentNode;a.removeChild(d);b=this.path.pop().offset;c?(this.anchor.node=c,this.anchor.offset=c.textContent.length,this.path.push({nodeName:this.anchor.node.nodeName,offset:b-1})):(this.anchor.node=a,this.anchor.offset=a.childElementCount)}else this.anchor.node.textContent=a,this.anchor.offset-=1;return e},moveLeft:function(){var c=this.anchor.node,b=this.anchor.offset;if("line"==c.nodeName){if(b=c.previousSibling){b=b.lastChild;if("math"==b.nodeName)b=
b.lastChild;c=b.textContent;this.anchor.node=b;this.anchor.offset=c.length}}else if(0<b)this.anchor.offset--;else if(0==b)if(b=c.previousSibling){if("math"==b.nodeName)b=b.lastChild;c=b.textContent;this.anchor.node=b;this.anchor.offset=c.length-1}else if(b=c.parentNode.previousSibling)if("line"==b.nodeName){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;c=b.textContent;this.anchor.node=b;this.anchor.offset=c.length}else c=b.textContent,this.anchor.node=b,this.anchor.offset=c.length-1},moveRight:function(){},
moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},_getFocusLine:function(){for(var c=this.getFocusNode();c&&"line"!=c.nodeName;)c=c.parentNode;return c},_isNotSameNode:function(c,b){return c==b.nodeName},_isLineNode:function(c){return"line"==c.nodeName},_isTextNode:function(c){return"text"==c.nodeName},_insertChar:function(c){var b=this.anchor.node,a=this.anchor.offset,c=n.insertAtOffset(b.textContent,a,c);b.textContent=c;this._updateAnchor(b,
a+1)},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?"":s.innerXML(this.doc)},isEmpty:function(){return""==this.getXML()},getPath:function(){var c="";q.forEach(this.path,function(b){c+="/";c+=b.nodeName;b.offset&&(c+="["+b.offset+"]")});return c},getFocusNode:function(){return this.anchor.node},getOffset:function(){return this.anchor.offset},getLineAt:function(c){return this.getLines()[c]},getLines:function(){return this.doc.documentElement.childNodes},getHTML:function(){return u.xmlDocToHtml(this.doc)},
onChange:function(){}})});