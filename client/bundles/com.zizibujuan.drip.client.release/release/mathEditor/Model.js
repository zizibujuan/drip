//>>built
define("mathEditor/Model",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojox/xml/parser","mathEditor/string","mathEditor/dataUtil","mathEditor/lang","mathEditor/xmlUtil"],function(declare,lang,array,domConstruct,xmlParser,dripString,dataUtil,dripLang,xmlUtil){var EMPTY_XML="<root><line></line></root>";return declare(null,{path:null,xmlString:null,doc:null,cursorPosition:null,constructor:function(options){this._init(),lang.mixin(this,options)},_init:function(){this.doc=xmlParser.parse(EMPTY_XML),this.path=[],this.cursorPosition={},this.cursorPosition.node=this.doc.documentElement.firstChild,this.cursorPosition.offset=0,this.path.push({nodeName:"root"}),this.path.push({nodeName:"line",offset:1})},clear:function(){this._init(),this.onChange()},loadData:function(xmlString){},setData:function(insertInfo){var data=insertInfo.data,nodeName=insertInfo.nodeName,removeCount=insertInfo.removeCount;if(removeCount&&removeCount>0)for(var i=0;i<removeCount;i++)this.removeLeft();var xmlDoc=this.doc;if(nodeName!=""&&nodeName=="mfrac"){this._splitNodeIfNeed();var node=this.cursorPosition.node,offset=this.cursorPosition.offset,newOffset=1,position="last";if(!this._isLineNode(node)&&this._isTextNode(node)){var _offset=this.path.pop().offset;newOffset=_offset+1,position="after"}this.path.push({nodeName:"math",offset:newOffset}),this.path.push({nodeName:"mfrac",offset:1}),this.path.push({nodeName:"mrow",offset:1}),this.path.push({nodeName:"mn",offset:1});var math=xmlDoc.createElement("math"),fracData=xmlUtil.createEmptyFrac(xmlDoc);math.appendChild(fracData.rootNode),domConstruct.place(math,node,position),this.cursorPosition.node=fracData.focusNode,this.cursorPosition.offset=0,this.onChange();return}var dataArray=[];lang.isString(data)?dataArray=dripString.splitData(data):lang.isArray(data)&&(dataArray=data),array.forEach(dataArray,lang.hitch(this,function(eachData,index){var c=eachData,node=this.cursorPosition.node;if(dripLang.isNumber(c)){nodeName="mn";function isLineOrText(node){var nodeName=node.nodeName;return nodeName=="line"||nodeName=="text"}if(isLineOrText(node)){var offset=this.cursorPosition.offset,position="last",pathOffset=1;if(this._isLineNode(node))position="last",pathOffset=1;else if(this._isTextNode(node)){this._splitNodeIfNeed();var pos=this.path.pop();offset>0?(position="after",pathOffset=pos.offset+1):position="before"}var mathNode=xmlDoc.createElement("math"),mnNode=xmlDoc.createElement(nodeName);mathNode.appendChild(mnNode),domConstruct.place(mathNode,node,position),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"math",offset:pathOffset}),this.path.push({nodeName:nodeName,offset:1})}else if(dripLang.isMathTokenNode(node)){var node=this.cursorPosition.node;if(node.nodeName!=nodeName){var mnNode=xmlDoc.createElement(nodeName);dripLang.insertNodeAfter(mnNode,node),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0;var pos=this.path.pop();this.path.push({nodeName:nodeName,offset:pos.offset+1})}this._insertChar(c)}}else if(dripLang.isOperator(c)){if(this._isLineNode(node)){var mathNode=xmlDoc.createElement("math");node.appendChild(mathNode);var mnNode=xmlDoc.createElement("mo");mathNode.appendChild(mnNode),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1})}else if(dripLang.isMathTokenNode(node)){var node=this.cursorPosition.node,moNode=xmlDoc.createElement("mo");dripLang.insertNodeAfter(moNode,node),this.cursorPosition.node=moNode,this.cursorPosition.offset=0,this._insertChar(c);var pos=this.path.pop();this.path.push({nodeName:"mo",offset:pos.offset+1})}else if(this._isTextNode(node)){var mathNode=xmlDoc.createElement("math");dripLang.insertNodeAfter(mathNode,node);var mnNode=xmlDoc.createElement("mo");mathNode.appendChild(mnNode),this.cursorPosition.node=mnNode,this.cursorPosition.offset=0,this._insertChar(c);var pos=this.path.pop();this.path.push({nodeName:"math",offset:pos.offset+1}),this.path.push({nodeName:"mo",offset:1})}}else if(dripLang.isNewLine(c)){var focusedLine=this._getFocusLine(),newLineNode=this.doc.createElement("line");dripLang.insertNodeAfter(newLineNode,focusedLine),this.cursorPosition.node=newLineNode,this.cursorPosition.offset=0;var pos=this.path.pop();while(pos.nodeName!="line")pos=this.path.pop();this.path.push({nodeName:"line",offset:pos.offset+1})}else if(this._isLineNode(node)){var textSpanNode=xmlDoc.createElement("text");node.appendChild(textSpanNode),this.cursorPosition.node=textSpanNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"text",offset:1})}else if(this._isTextNode(node))this._insertChar(c);else if(dripLang.isMathTokenNode(node)){var pos=null;do pos=this.path.pop();while(pos&&pos.nodeName!="math");var textSpanNode=xmlDoc.createElement("text"),mathNode=node;while(mathNode.nodeName!="math")mathNode=mathNode.parentNode;dripLang.insertNodeAfter(textSpanNode,mathNode),this.cursorPosition.node=textSpanNode,this.cursorPosition.offset=0,this._insertChar(c),this.path.push({nodeName:"text",offset:pos.offset+1})}})),this.onChange(data)},doDelete:function(){var removed=this.removeLeft();removed!=""&&this.onChange()},removeLeft:function(){var offset=this.cursorPosition.offset,node=this.cursorPosition.node,oldText=node.textContent;0;if(offset==0){var _node=node;if(node.nodeName!="text"&&node.nodeName!="line"){while(_node.nodeName!="math")_node=_node.parentNode;var previousNode=_node.previousSibling;if(previousNode){var textContent=previousNode.textContent,oldLength=textContent.length,newText=dripString.insertAtOffset(textContent,oldLength,"",1),newLength=oldLength-1;newText==""?(previousNode.parentNode.removeChild(previousNode),this.path.pop()):(previousNode.textContent=newText,this.cursorPosition.node=previousNode,this.cursorPosition.offset=newLength);var removed=textContent.charAt(newLength);return removed}}else if(node.nodeName=="line"){if(this.getLineCount()>1){var previousNode=node.previousSibling,childCount=previousNode.childNodes.length;if(childCount==0){this.cursorPosition.node=previousNode,this.cursorPosition.offset=0;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),node.parentNode.removeChild(node)}else{previousNode=previousNode.lastChild;if(previousNode.nodeName=="text"){this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),this.path.push({nodeName:previousNode.nodeName,offset:childCount}),node.parentNode.removeChild(node)}else if(previousNode.nodeName=="math"){var mathChildCount=previousNode.childNodes.length;previousNode=previousNode.lastChild,this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop();lastPath.offset--,this.path.push(lastPath),this.path.push({nodeName:"math",offset:childCount}),this.path.push({nodeName:previousNode.nodeName,offset:mathChildCount}),node.parentNode.removeChild(node)}}return"\n"}return""}return""}var removed="",newText="";node.nodeName=="mo"?(removed=node.textContent,newText=""):(removed=oldText.charAt(offset-1),newText=dripString.insertAtOffset(oldText,offset,"",1));if(newText==""){var previousNode=node.previousSibling,_offset=0;if(previousNode)if(previousNode.nodeName=="math"){var mathChildCount=previousNode.childNodes.length;previousNode=previousNode.lastChild,this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length;var lastPath=this.path.pop(),lastOffset=lastPath.offset-1;this.path.push({nodeName:"math",offset:lastOffset}),this.path.push({nodeName:previousNode.nodeName,offset:mathChildCount}),node.parentNode.removeChild(node)}else{this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length,node.parentNode.removeChild(node);var old=this.path.pop();this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:old.offset-1})}else{var p=node,c=node;if(node.nodeName!="text"&&node.nodeName!="line")while(c.nodeName!="math")p=c.parentNode,p.removeChild(c),c=p,this.path.pop();previousNode=c.previousSibling,p=c.parentNode,p.removeChild(c);var oldOffset=this.path.pop().offset;previousNode?(this.cursorPosition.node=previousNode,this.cursorPosition.offset=previousNode.textContent.length,this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:oldOffset-1})):(this.cursorPosition.node=p,this.cursorPosition.offset=p.childElementCount)}}else this.cursorPosition.node.textContent=newText,this.cursorPosition.offset-=1;return removed},moveLeft:function(){var node=this.cursorPosition.node,offset=this.cursorPosition.offset,nodeName=node.nodeName;if(nodeName=="line"){var previousNode=node.previousSibling;if(!previousNode)return;previousNode=previousNode.lastChild,previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length;return}if(offset>0){this.cursorPosition.offset--;return}if(offset==0){var previousNode=node.previousSibling;if(previousNode){previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length-1;return}var parentNode=node.parentNode,previousNode=parentNode.previousSibling;if(previousNode)if(previousNode.nodeName=="line"){previousNode=previousNode.lastChild,previousNode.nodeName=="math"&&(previousNode=previousNode.lastChild);var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length}else{var textContent=previousNode.textContent;this.cursorPosition.node=previousNode,this.cursorPosition.offset=textContent.length-1}}},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},_splitNodeIfNeed:function(){var offset=this.cursorPosition.offset,node=this.cursorPosition.node,textContent=node.textContent,textLength=textContent.length;if(0<offset&&offset<textLength){var part1=textContent.substring(0,offset),part2=textContent.substring(offset),node2=this.doc.createElement(node.nodeName);node.textContent=part1,node2.textContent=part2,dripLang.insertNodeAfter(node2,node)}},_getFocusLine:function(){var focusNode=this.getFocusNode(),lineNode=focusNode;while(lineNode&&lineNode.nodeName!="line")lineNode=lineNode.parentNode;return lineNode},_isNotSameNode:function(newNodeName,node){var nodeName=node.nodeName;return newNodeName==nodeName},_isLineNode:function(node){return node.nodeName=="line"},_isTextNode:function(node){return node.nodeName=="text"},_insertChar:function(charData){var offset=this.cursorPosition.offset,oldText=this.cursorPosition.node.textContent,newText=dripString.insertAtOffset(oldText,offset,charData);this.cursorPosition.node.textContent=newText,this.cursorPosition.offset+=1},getXML:function(){var doc=this.doc;return doc.firstChild.firstChild.childNodes.length==0?"":xmlParser.innerXML(this.doc)},getPath:function(){var xpath="";return array.forEach(this.path,function(path,index){xpath+="/",xpath+=path.nodeName,path.offset&&(xpath+="["+path.offset+"]")}),xpath},getFocusNode:function(){return this.cursorPosition.node},getOffset:function(){return this.cursorPosition.offset},getLineAt:function(lineIndex){return this.doc.documentElement.childNodes[lineIndex]},getHTML:function(){return dataUtil.xmlDocToHtml(this.doc)},onChange:function(data){}})})