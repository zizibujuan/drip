//>>built
define("mathEditor/Model","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/dom-construct,dojox/xml/parser,mathEditor/string,mathEditor/dataUtil,mathEditor/lang,mathEditor/xmlUtil".split(","),function(n,j,l,m,i,k,o,h,p){return n(null,{path:null,xmlString:null,doc:null,cursorPosition:null,constructor:function(a){this._init();j.mixin(this,a)},_init:function(){this.doc=i.parse("<root><line></line></root>");this.path=[];this.cursorPosition={};this.cursorPosition.node=this.doc.documentElement.firstChild;
this.cursorPosition.offset=0;this.path.push({nodeName:"root"});this.path.push({nodeName:"line",offset:1})},clear:function(){this._init();this.onChange()},loadData:function(){},setData:function(a){var b=a.data,c=a.nodeName;if((a=a.removeCount)&&0<a)for(var d=0;d<a;d++)this.removeLeft();var f=this.doc;if(""!=c&&"mfrac"==c){this._splitNodeIfNeed();b=this.cursorPosition.node;d=1;a="last";!this._isLineNode(b)&&this._isTextNode(b)&&(d=this.path.pop().offset+1,a="after");this.path.push({nodeName:"math",
offset:d});this.path.push({nodeName:"mfrac",offset:1});this.path.push({nodeName:"mrow",offset:1});this.path.push({nodeName:"mn",offset:1});var d=f.createElement("math"),i=p.createEmptyFrac(f);d.appendChild(i.rootNode);m.place(d,b,a);this.cursorPosition.node=i.focusNode;this.cursorPosition.offset=0;this.onChange()}else a=[],j.isString(b)?a=k.splitData(b):j.isArray(b)&&(a=b),l.forEach(a,j.hitch(this,function(a){var b=this.cursorPosition.node;if(h.isNumber(a)){c="mn";var d=b.nodeName;if("line"==d||"text"==
d){var g=this.cursorPosition.offset,d="last",i=1;if(this._isLineNode(b))d="last",i=1;else if(this._isTextNode(b)){this._splitNodeIfNeed();var e=this.path.pop();0<g?(d="after",i=e.offset+1):d="before"}g=f.createElement("math");e=f.createElement(c);g.appendChild(e);m.place(g,b,d);this.cursorPosition.node=e;this.cursorPosition.offset=0;this._insertChar(a);this.path.push({nodeName:"math",offset:i});this.path.push({nodeName:c,offset:1})}else if(h.isMathTokenNode(b)){b=this.cursorPosition.node;if(b.nodeName!=
c)e=f.createElement(c),h.insertNodeAfter(e,b),this.cursorPosition.node=e,this.cursorPosition.offset=0,e=this.path.pop(),this.path.push({nodeName:c,offset:e.offset+1});this._insertChar(a)}}else if(h.isOperator(a))if(this._isLineNode(b))g=f.createElement("math"),b.appendChild(g),e=f.createElement("mo"),g.appendChild(e),this.cursorPosition.node=e,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"math",offset:1}),this.path.push({nodeName:"mo",offset:1});else if(h.isMathTokenNode(b))b=
this.cursorPosition.node,d=f.createElement("mo"),h.insertNodeAfter(d,b),this.cursorPosition.node=d,this.cursorPosition.offset=0,this._insertChar(a),e=this.path.pop(),this.path.push({nodeName:"mo",offset:e.offset+1});else{if(this._isTextNode(b))g=f.createElement("math"),h.insertNodeAfter(g,b),e=f.createElement("mo"),g.appendChild(e),this.cursorPosition.node=e,this.cursorPosition.offset=0,this._insertChar(a),e=this.path.pop(),this.path.push({nodeName:"math",offset:e.offset+1}),this.path.push({nodeName:"mo",
offset:1})}else if(h.isNewLine(a)){a=this._getFocusLine();b=this.doc.createElement("line");h.insertNodeAfter(b,a);this.cursorPosition.node=b;this.cursorPosition.offset=0;for(e=this.path.pop();"line"!=e.nodeName;)e=this.path.pop();this.path.push({nodeName:"line",offset:e.offset+1})}else if(this._isLineNode(b))d=f.createElement("text"),b.appendChild(d),this.cursorPosition.node=d,this.cursorPosition.offset=0,this._insertChar(a),this.path.push({nodeName:"text",offset:1});else if(this._isTextNode(b))this._insertChar(a);
else if(h.isMathTokenNode(b)){do e=this.path.pop();while(e&&"math"!=e.nodeName);d=f.createElement("text");for(g=b;"math"!=g.nodeName;)g=g.parentNode;h.insertNodeAfter(d,g);this.cursorPosition.node=d;this.cursorPosition.offset=0;this._insertChar(a);this.path.push({nodeName:"text",offset:e.offset+1})}})),this.onChange(b)},doDelete:function(){if(""!=this.removeLeft())this.onChange()},removeLeft:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,c=b.textContent;if(0==a){a=b;if("text"!=
b.nodeName&&"line"!=b.nodeName){for(;"math"!=a.nodeName;)a=a.parentNode;if(a=a.previousSibling){var b=a.textContent,d=b.length,c=k.insertAtOffset(b,d,"",1),d=d-1;""==c?(a.parentNode.removeChild(a),this.path.pop()):(a.textContent=c,this.cursorPosition.node=a,this.cursorPosition.offset=d);return d=b.charAt(d)}}else if("line"==b.nodeName&&1<this.getLineCount()){a=b.previousSibling;d=a.childNodes.length;if(0==d)this.cursorPosition.node=a,this.cursorPosition.offset=0,c=this.path.pop(),c.offset--,this.path.push(c),
b.parentNode.removeChild(b);else if(a=a.lastChild,"text"==a.nodeName)this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,c=this.path.pop(),c.offset--,this.path.push(c),this.path.push({nodeName:a.nodeName,offset:d}),b.parentNode.removeChild(b);else if("math"==a.nodeName){var f=a.childNodes.length,a=a.lastChild;this.cursorPosition.node=a;this.cursorPosition.offset=a.textContent.length;c=this.path.pop();c.offset--;this.path.push(c);this.path.push({nodeName:"math",offset:d});this.path.push({nodeName:a.nodeName,
offset:f});b.parentNode.removeChild(b)}return"\n"}return""}"mo"==b.nodeName?(d=b.textContent,c=""):(d=c.charAt(a-1),c=k.insertAtOffset(c,a,"",1));if(""==c)if(a=b.previousSibling)"math"==a.nodeName?(f=a.childNodes.length,a=a.lastChild,this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,c=this.path.pop(),this.path.push({nodeName:"math",offset:c.offset-1}),this.path.push({nodeName:a.nodeName,offset:f}),b.parentNode.removeChild(b)):(this.cursorPosition.node=a,this.cursorPosition.offset=
a.textContent.length,b.parentNode.removeChild(b),this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:this.path.pop().offset-1}));else{f=c=b;if("text"!=b.nodeName&&"line"!=b.nodeName)for(;"math"!=f.nodeName;)c=f.parentNode,c.removeChild(f),f=c,this.path.pop();a=f.previousSibling;c=f.parentNode;c.removeChild(f);b=this.path.pop().offset;a?(this.cursorPosition.node=a,this.cursorPosition.offset=a.textContent.length,this.path.push({nodeName:this.cursorPosition.node.nodeName,offset:b-1})):
(this.cursorPosition.node=c,this.cursorPosition.offset=c.childElementCount)}else this.cursorPosition.node.textContent=c,this.cursorPosition.offset-=1;return d},moveLeft:function(){var a=this.cursorPosition.node,b=this.cursorPosition.offset;if("line"==a.nodeName){if(b=a.previousSibling){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length}}else if(0<b)this.cursorPosition.offset--;else if(0==b)if(b=a.previousSibling){if("math"==
b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length-1}else if(b=a.parentNode.previousSibling)if("line"==b.nodeName){b=b.lastChild;if("math"==b.nodeName)b=b.lastChild;a=b.textContent;this.cursorPosition.node=b;this.cursorPosition.offset=a.length}else a=b.textContent,this.cursorPosition.node=b,this.cursorPosition.offset=a.length-1},moveRight:function(){},moveUp:function(){},moveDown:function(){},getLineCount:function(){return this.doc.documentElement.childNodes.length},
_splitNodeIfNeed:function(){var a=this.cursorPosition.offset,b=this.cursorPosition.node,c=b.textContent,d=c.length;if(0<a&&a<d)d=c.substring(0,a),a=c.substring(a),c=this.doc.createElement(b.nodeName),b.textContent=d,c.textContent=a,h.insertNodeAfter(c,b)},_getFocusLine:function(){for(var a=this.getFocusNode();a&&"line"!=a.nodeName;)a=a.parentNode;return a},_isNotSameNode:function(a,b){return a==b.nodeName},_isLineNode:function(a){return"line"==a.nodeName},_isTextNode:function(a){return"text"==a.nodeName},
_insertChar:function(a){this.cursorPosition.node.textContent=k.insertAtOffset(this.cursorPosition.node.textContent,this.cursorPosition.offset,a);this.cursorPosition.offset+=1},getXML:function(){return 0==this.doc.firstChild.firstChild.childNodes.length?"":i.innerXML(this.doc)},getPath:function(){var a="";l.forEach(this.path,function(b){a+="/";a+=b.nodeName;b.offset&&(a+="["+b.offset+"]")});return a},getFocusNode:function(){return this.cursorPosition.node},getOffset:function(){return this.cursorPosition.offset},
getLineAt:function(a){return this.doc.documentElement.childNodes[a]},getHTML:function(){return o.xmlDocToHtml(this.doc)},onChange:function(){}})});