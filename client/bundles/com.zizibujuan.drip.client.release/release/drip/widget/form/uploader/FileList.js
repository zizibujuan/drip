//>>built
define("drip/widget/form/uploader/FileList",["dojo/_base/fx","dojo/dom-style","dojo/dom-class","dojo/dom-prop","dojo/dom-construct","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dijit/_base/manager","dojox/form/uploader/_Base"],function(fx,domStyle,domClass,domProp,domConstruct,declare,lang,array,on,manager,formUploaderBase){return declare("drip.widget.form.uploader.FileList",[formUploaderBase],{uploaderId:"",uploader:null,_upCheckCnt:0,fileId:"",fileInfo:null,templateString:"<div></div>",rowAmt:0,postCreate:function(){this.setUploader()},getData:function(){return fileId},reset:function(){0,this.fileId=""},setUploader:function(){if(!this.uploaderId&&!this.uploader)0;else if(this.uploaderId&&!this.uploader)this.uploader=manager.byId(this.uploaderId);else if(this._upCheckCnt>4){0;return}this.uploader?(this.connect(this.uploader,"onChange","_onUploaderChange"),this.connect(this.uploader,"reset","reset"),this.connect(this.uploader,"onBegin",function(){0,this.showProgressBar(),this.showProgress(!0)}),this.connect(this.uploader,"onProgress","_progress"),this.connect(this.uploader,"onComplete",function(customEvent){0;var fileInfo=this.fileInfo=customEvent[0];this.fileId=fileInfo.fileId,this.thumbImageNode.src=fileInfo.url,domProp.set(this.thumbImageNode.parentNode,{href:fileInfo.url,target:"_blank"}),this._addSuccessBar()}),this._fileSizeAvail={html5:1,flash:1}[this.uploader.uploadType]):(this._upCheckCnt++,setTimeout(lang.hitch(this,"setUploader"),250))},showProgressBar:function(){},hideProgress:function(animate){var o=animate?{ani:!0,endDisp:"none",beg:15,end:0}:{endDisp:"none",ani:!1};this._hideShowProgress(o)},showProgress:function(animate){var o=animate?{ani:!0,endDisp:"inline",beg:0,end:15}:{endDisp:"inline",ani:!1};this._hideShowProgress(o)},_progress:function(customEvent){0,domStyle.set(this.percentBarNode,"width",customEvent.percent)},_hideShowProgress:function(o){},_onUploaderChange:function(fileArray){0,domConstruct.empty(this.domNode),this.rowAmt=0;var f=fileArray[0];this._addRow(1,this.getFileType(f.name),f.name,f.size)},_addSuccessBar:function(){var fileInfo=this.fileInfo,containerNode=this.uploadItemNode;domConstruct.empty(containerNode);var _href=fileInfo.url,labelContainer=domConstruct.create("a",{"class":"drip_upload_label_success",target:"_blank",href:_href},containerNode);this._addImageLabel(labelContainer,fileInfo.name,fileInfo.size),this._addDeleteNode(containerNode)},_addFailureBar:function(){var fileInfo=this.fileInfo,containerNode=this.uploadItemNode;domConstruct.empty(containerNode);var labelContainer=domConstruct.create("span",{"class":"drip_upload_label_fail"},containerNode);this._addImageLabel(labelContainer,fileInfo.name,fileInfo.size);var failInfoNode=domConstruct.create("span",{style:"float:right"},containerNode);domConstruct.create("span",{innerHTML:"附件上传失败",style:"color:#C00, font-weight:bold"},failInfoNode),domConstruct.create("span",{innerHTML:"重试",style:"margin-left: 5px;color: #222;text-decoration: underline;cursor: pointer;"},failInfoNode),this._addDeleteNode(failInfoNode)},_addRow:function(index,type,name,size){var uploadItemContainer=domConstruct.place("<div></div>",this.domNode),uploadItem=this.uploadItemNode=domConstruct.place("<div class='drip_upload_item'></div>",uploadItemContainer),a=domConstruct.create("a",null,uploadItemContainer),thumbNode=this.thumbImageNode=domConstruct.place("<img class='drip_upload_thumb_image'/>",a),table=domConstruct.place("<table></table>",uploadItem),tr=table.insertRow(),td1=tr.insertCell(0);domStyle.set(td1,"padding","0px");var labelNode=domConstruct.place("<div></div>",td1);this._addImageLabel(labelNode,name,size);var td2=tr.insertCell(1),div1=domConstruct.place("<div></div>",td2),div2=domConstruct.place("<div></div>",div1),div3=domConstruct.place("<div class='drip_upload_progress'></div>",div2),percentBarNode=this.percentBarNode=domConstruct.place("<div class='drip_upload_percent_bar'></div>",div3),td3=tr.insertCell(2);this._addDeleteNode(td3),this.rowAmt++},_addImageLabel:function(parentNode,name,size){var imageNameNode=domConstruct.place("<div class='drip_upload_image_name'></div>",parentNode);imageNameNode.innerHTML=name;if(this._fileSizeAvail){var imageSizeNode=domConstruct.place("<div class='drip_upload_image_size'></div>",parentNode);imageSizeNode.innerHTML="("+this.convertBytes(size).value+")"}},_addDeleteNode:function(parentNode){var deleteNode=domConstruct.place("<div class='drip_upload_delete_icon'></div>",parentNode);on.once(deleteNode,"click",lang.hitch(this,function(e){domConstruct.empty(this.domNode),this.fileInfo=null,this.fileId=null}))}})})