<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link type="text/css" rel="stylesheet" href="/drip/resources/app.css" />

<title>我的首页 孜孜不倦 · 一起交流学习心得，共同优化教育资源。</title>
<script type="text/javascript" 
	data-dojo-config="
		async:true,
		parseOnLoad:false,
		isDebug:true" 
	src="/dojo/dojo.js"></script>
<script type="text/javascript"
   src="/mathJax/MathJax.js?config=MML_HTMLorMML">
</script>
<script type="text/javascript" src="drip/renren.js"></script>
<script type="text/javascript">
require(["dojo/ready",
         "dojo/_base/event",
		 "dojo/on",
         "dojo/dom",
         "dojo/dom-class",
         "dojo/request/xhr",
         "dojo/store/JsonRest",
         "dijit/registry",
         "drip/user",
         "drip/Activity",
         "dojo/domReady!"],function(
        		 ready,
        		 event,
        		 on,
        		 dom,
        		 domClass,
        		 xhr,
        		 JsonRest,
        		 registry,
        		 user){
	// 加载左侧栏目中的数据，因为左侧没有用dijit部件，所无需放在ready方法中
	user.getLoggedUserInfo().then(function(userInfo){
		console.log("登录用户信息:", userInfo);
		// 在右侧用户信息区域显示
		var profileImg = dom.byId("profileImage");
		var displayName = userInfo.nickName;
		profileImg.alt = displayName;
		profileImg.src = userInfo.largeImageUrl || "/drip/resources/images/profile_180_180.gif";
		dom.byId("userName").innerHTML = displayName;
		
		// 在顶部用户信息区域显示
		var topProfileImage = dom.byId("topProfileImage");
		topProfileImage.src = userInfo.smallImageUrl || "/drip/resources/images/profile_50_50.gif";
		topProfileImage.alt = displayName;
		dom.byId("topUserName").innerHTML = displayName;
		dom.byId("largeImageLink").href = dom.byId("top_user_link").href = "/users/" + userInfo.digitalId;
		
		// 在关注和粉丝的链接上加上登录者的用户标识
		// 切记：出现在rest链接中的，只能是本地用户标识，而不是第三方网站或映射用户标识
		dom.byId("following_link").href = "/following/" + userInfo.digitalId;
		dom.byId("follower_link").href = "/followers/" + userInfo.digitalId;
	});
	
	user.getLoggedUserStatistics().then(function(statistics){
		dom.byId("follow_count").innerHTML = statistics.followCount;
		dom.byId("fan_count").innerHTML = statistics.fanCount;
		// 在页面顶级tab中显示
		dom.byId("my_answer_count").innerHTML = statistics.answerCount;
		dom.byId("my_exer_count").innerHTML = statistics.exerciseCount;
	});
	
	on(dom.byId("logout"),"click",user.logout);
	
	var store = new JsonRest({
		 target:"/activities/"
	 });
	
	var followingNoDataMessage = "没有活动，快去录入新题目，或到题库中解答习题";
	var myAnswerNoDataMessage = "还没有回答问题，快到题库中解答习题";
	var myExerciseNoDataMessage = "您还没有录入过习题，快去录入新题目";
	
	var activities = new Activity({
		store: store,
		query: {type:"following"},
		loadingMessage:"加载中...", 
		noDataMessage:followingNoDataMessage
	});
	activities.placeAt("activitiesContainer");
	
	var following = dom.byId("following");
	var myAnswer = dom.byId("myAnswer");
	var myExercise = dom.byId("myExercise");
	
	// 两个动作，一个是刷新，一个是切换。
	// 都使用一个store，然后传入不同的条件刷新
	on(following, "click", function(e){
		event.stop(e);
		if(!domClass.contains(following,"selected")){
			domClass.add(following,"selected");
			// TODO:如何刷新tab上的统计数据呢？
			// 或者在这个界面上有一个增加统计值的操作，就触发一个时间，从后台刷新一下，或者在前台更新一下
			// 而不在切换时刷新。
			activities.noDataMessage = followingNoDataMessage;
			activities.setQuery({type:"following"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(myAnswer, "selected");
		domClass.remove(myExercise, "selected");
		
		
	});
	
	on(myAnswer, "click", function(e){
		event.stop(e);
		if(!domClass.contains(myAnswer,"selected")){
			domClass.add(myAnswer,"selected");
			
			activities.noDataMessage = myAnswerNoDataMessage;
			activities.setQuery({type:"myAnswer"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(following, "selected");
		domClass.remove(myExercise, "selected");
	});
	
	on(myExercise, "click", function(e){
		event.stop(e);
		if(!domClass.contains(myExercise,"selected")){
			domClass.add(myExercise,"selected");
			
			activities.noDataMessage = myExerciseNoDataMessage;
			activities.setQuery({type:"myExercise"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(following, "selected");
		domClass.remove(myAnswer, "selected");
	});
	
	
	ready(function(){
		/*
		var btnNewExercise = registry.byId("btnNewExercise");
		btnNewExercise.on("click",function(e){
			window.location.href = "/exercises/new";
		});
		
		// 进入题库页面
		registry.byId("btnExercises").on("click", function(e){
			window.location.href = "/exercises";
		});
		*/
	});
});
</script>

<script type="text/javascript">
function sendRenrenRequest(){
	var uiOptions = {
		url: "request",
		display: "popup",
		params: { // TODO：这里的文本需要反复优化
			"accept_url":"http://www.zizibujuan.com/login/renren",// 接受邀请按钮url
			"accept_label":"好的,一起学习",//接受文本
			"redirect_uri":"http://www.zizibujuan.com/drip/closeRenrenInviteWindow.html",// 点击确定或取消后跳转的url,需要在这个url中在drip中保存数据。 TODO
			"actiontext":"邀请好友一起学习",// 好友喊你来学习
			"selector_mode":"1",//2,3
			"app_msg":"孜孜不倦诚邀您与大家一起学习",
			"send_btn_label":"邀请"
		},
		//access_token	
		onSuccess: function(a,b,c){
			console.log(a,b,c);
		},
		onFailure: function(a,b,c){
			console.log(a,b,c);
		}
	};
	Renren.ui(uiOptions);
}
</script>
 
</head>
<body  class="claro">
<script type="text/javascript">
	/* TODO：appId不能在这里硬编码*/
	Renren.init({appId:220706});
</script>

<div id="wrapper" class="drip_body">
	<div class="drip_header drip_header_logged_in" style="position: fixed; width: 100%">
		<div class="container clearfix">
			<a href="/" class="drip_header_logo" style="height:25px;">
			 	<!-- 设置文本的高度 -->
				<img alt="孜孜不倦" style="height:25px;" src="drip/resources/images/home_logo.png">
			</a>
			<span class="drip_version">测试版</span>
			
			<div class="divider-vertical"></div>
			<ul class="drip_top_nav">
				<li><a href="/" class="current">首页</a></li>
				<li><a href="/exercises">题库</a></li>
			</ul>
			<ul class="drip_user_links">
				<li>
					<a href="#" id="top_user_link" class="drip_name">
						<img width="20px" height="20px" id="topProfileImage">
						<span id="topUserName"></span>
					</a>
				</li>
				<li><a href="/exercises/new" title="录入新习题" class="drip_new_exercise">+习题</a></li>
				<li><input type="button" title="退出" id="logout" value="退出" class="logout"></input></li>
			</ul>
		</div>
	</div>

	<div class="container" style="padding-top: 60px;">
		<div>
			<div class="drip_main">
				<div class="clearfix">
						<div class="drip_main_center">
							<!-- 个人首页的链接tab -->
							<div class="drip_tab_nav">
								<ul class="drip_tab_nav_tabs">
									<li>
										<a href="#" id="following" class="selected drip_tab_nav_tab">好友动态</a>
									</li>
									<li>
										<a href="#" id="myAnswer" class="drip_tab_nav_tab">我答的习题 <span class="counter" id="my_answer_count">0</span></a>
									</li>
									<li>
										<a href="#" id="myExercise" class="drip_tab_nav_tab">我录的习题 <span class="counter" id="my_exer_count">0</span></a>
									</li>
									<!-- 添加一个我的作业 -->
								</ul>
							</div>
							<div id="activitiesContainer" class="drip_activity_list" style="padding-top:20px">
								
							</div>
						</div>
						<div class="drip_main_right">
							<div style="padding-left:20px">
								<div class="profile" style="margin-top: 10px;">
							 		<div class="clearfix">
							 			<div style="float:left">
							 				<a id="largeImageLink" href="#">
							 					<img id="profileImage" width="80px" height="80px">
							 				</a>
							 			</div>
							 			<div style="padding-left: 10px; padding-top: 5px;float:left">
							 				<a style="font-size: 14px; font-weight: bold;text-decoration: none;color: #333" id="userName"></a>
							 				<div>
							 					
							 				</div>
							 			</div>
							 		</div>
							 		<div class="clearfix">
							 			<ul style="list-style: none;padding-left: 0px; margin-top: 20px">
											<li style="float:left">
												<a href="#" id="following_link" style="text-decoration: none;color:#333">
												<strong id="follow_count" style="display:block;font-size: 20px"></strong>
												<span style="display: block;text-align: center;">关注</span>
												</a>
											</li>
											<li style="float:left; margin-left: 10px;">
												<a href="#" id="follower_link" style="text-decoration: none;color:#333">
													<strong id="fan_count" style="display:block;font-size: 20px"></strong>
													<span style="display: block;text-align: center;">粉丝</span>
												</a>
											</li>
										</ul>
							 		</div>
								 </div>
							 	<div style="margin-top: 20px;">
							 		<input value="邀请人人好友一起学习" style="width:100%; color:#00a300; padding-top: 8px; padding-bottom: 8px;
							 		margin-top:10px; font-weight:bold;
							 		font-size: 17px;cursor: pointer;" type="button" onclick="sendRenrenRequest();"></input>
							 	</div>
							</div>
						</div>
					
				</div>
				
			</div>
		</div>
	</div>
	
	<div class="footer">footer</div>
</div>
</body>
</html>










<!-- 在弹出的个人介绍中，加“来自人人”标识 -->





