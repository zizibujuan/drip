//>>built
define("drip/exercises/ExerciseForm","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/event dojo/request/xhr dijit/_WidgetBase dijit/registry dojo/dom dojo/dom-attr dojo/dom-style dojo/dom-class dojo/dom-construct dojo/on dojo/query dojo/json dojo/string mathEditor/Editor drip/classCode drip/tip dojox/form/Uploader drip/widget/form/uploader/FileList".split(" "),function(v,k,w,m,x,y,n,B,h,r,C,c,l,s,t,p,z,g,A,D,E){var u=[{id:"essayQuestion",label:"\u95ee\u7b54\u9898",type:g.ExerciseType.ESSAY_QUESTION},
{id:"single",label:"\u5355\u9879\u9009\u62e9\u9898",type:g.ExerciseType.SINGLE_OPTION},{id:"multiple",label:"\u591a\u9879\u9009\u62e9\u9898",type:g.ExerciseType.MULTI_OPTION}];return v("drip.exercises.ExerciseForm",[y],{data:{exercise:{}},optionLength:4,_optionName:"exercise-option",_editors:[],_fieldErrors:{},postCreate:function(){this.inherited(arguments);this.leftDiv=c.place('\x3cdiv style\x3d"width: 600px; float: left;"\x3e\x3c/div\x3e',this.domNode);this.rightDiv=c.place('\x3cdiv style\x3d"width: 350px; float: right;"\x3e\x3c/div\x3e',
this.domNode);this._createForm(g.ExerciseType.ESSAY_QUESTION);var a=c.create("div",{"class":"drip_form_actions"},this.leftDiv),a=this.btnSave=c.place('\x3cbutton class\x3d"button primary"\x3e\x3ci class\x3d"icon-save icon-large"\x3e\x3c/i\x3e \u4fdd\u5b58\x3c/button\x3e',a);l(a,"click",k.hitch(this,this.doSave))},_createForm:function(a){this._exerciseType=a;this._createExerciseTypeOptions(a);this._createContentInput();var b=null;a===g.ExerciseType.SINGLE_OPTION?b="radio":a===g.ExerciseType.MULTI_OPTION&&
(b="checkbox");this._showOptionPane(b);this._createAnswerInput();this._createGuideInput();this._createImageInput();this._createMathEditorHelper()},_createExerciseTypeOptions:function(a){if(!this.exerciseTypePane){var b=c.create("div",{"class":"form clearfix"},this.leftDiv);c.place('\x3cdiv class\x3d"drip-title"\x3e\u9898\u578b\x3c/div\x3e',b);for(var e=this._exerciseTypeOptionName="exerciseType",d=c.place('\x3cul class\x3d"radio-group"\x3e\x3c/ul\x3e',b),f=0;f<u.length;f++){var q=u[f],g=q.type==a,
h=c.create("li",null,d),g=c.create("input",{type:"radio",name:e,id:q.type,checked:g},h);c.create("label",{"for":q.type,innerHTML:q.label},h);l(g,"click",k.hitch(this,function(a){a=a.target;a.id!=this.data.exerType&&(this._createForm(a.id),this.clearErrors())}))}this.exerciseTypePane=b}},_createContentInput:function(){this.exerContentEditor||(this.contentPane=(this.exerContentEditor=this._createMathInput("\u5185\u5bb9",10,"\u5fc5\u586b")).domNode.parentNode)},_createAnswerInput:function(){this._exerciseType===
g.ExerciseType.ESSAY_QUESTION?this.answerEditor?"none"==r.get(this.answerEditor.domNode.parentNode,"display")&&r.set(this.answerEditor.domNode.parentNode,"display",""):this.answerEditor=this._createMathInput("\u7b54\u6848",5):this.answerEditor&&r.set(this.answerEditor.domNode.parentNode,"display","none")},_createGuideInput:function(){this.guideEditor||(this.guideEditor=this._createMathInput("\u89e3\u6790",5))},_createMathInput:function(a,b,e){e=e?"\x3cspan\x3e("+e+")\x3c/span\x3e":"";var d=c.create("div",
{"class":"form"},this.leftDiv);c.place('\x3cdiv\x3e\x3cspan class\x3d"drip-title"\x3e'+a+"\x3c/span\x3e"+e+"\x3c/div\x3e",d);return this._createEditor(d,b,550)},_createEditor:function(a,b,c){var d={};d.rows=b;c&&(d.width=c);b=new z(d);b.placeAt(a);b.startup();this._editors.push(b);return b},_createImageInput:function(){if(!this._imageInput){var a=c.create("div",{"class":"form"},this.rightDiv),a=c.place('\x3cdiv class\x3d"drip-title" style\x3d"margin-bottom: 5px;"\x3e\x3c/div\x3e',a),b=new dojox.form.Uploader({label:"\u4e0a\u4f20\u56fe\u7247",
multiple:!0,type:"file",uploadOnSelect:!0,url:"/uploads/exerciseImage"});b.placeAt(a);b.startup();(this.image=new drip.widget.form.uploader.FileList({uploader:b})).placeAt(a);this._imageInput=!0}},_createMathEditorHelper:function(){this._editorHelper||(c.create("iframe",{"class":"helper",style:"border:none; height:700px; width:100%",src:"/drip/exercises/mathEditorHelp.html"},this.rightDiv),this._editorHelper=!0)},_showOptionPane:function(a){this.optionPane?null==a?""==this.optionPane.style.display&&
(this.optionPane.style.display="none"):("none"==this.optionPane.style.display&&(this.optionPane.style.display=""),a!=this._optionType&&s("input",this.optionPane).forEach(function(b,c){b.type=a})):null!=a&&this._createOptionPane(a);this._optionType=a},_getFormData:function(){var a=this.data;a.exercise.exerciseType=this._exerciseType;a.exercise.imageName=this.image.fileId;a.exercise.content=this.exerContentEditor.get("value");this.tblOption&&(a.exercise.options=[],n.findWidgets(this.tblOption).forEach(function(b,
c){var d=b.get("value");""!=p.trim(d)&&a.exercise.options.push({content:d})}));var b={};if(this._exerciseType===g.ExerciseType.SINGLE_OPTION||this.exerciseType===g.ExerciseType.MULTI_OPTION){var c=[];s("[name\x3d"+this._optionName+"]:checked",this.tblOption).forEach(function(a,b){c.push({seq:a.value})});0<c.length&&(b.detail=c)}else if(this._exerciseType==g.ExerciseType.ESSAY_QUESTION){var d=this.answerEditor.get("value");""!=p.trim(d)&&(b.detail=[{content:d}])}d=this.guideEditor.get("value");null!=
d&&0<d.length&&(b.guide=d);if(b.detail||b.guide)a.answer=b;return a},doSave:function(a){a=this._getFormData();this.clearErrors();this.validate(a);this.hasError()?this.showErrors():(h.set(this.btnSave,"disabled",!0),x("/exercises/",{method:"POST",data:t.stringify(a)}).then(k.hitch(this,function(a){A.ok("\u4fdd\u5b58\u6210\u529f\uff01",this.btnSave,"before");this._reset();h.set(this.btnSave,"disabled",!1)}),k.hitch(this,function(a){h.set(this.btnSave,"disabled",!1);this.data={};a.response.data&&(this._fieldErrors=
t.parse(a.response.data),this.hasError()&&this.showErrors())})))},validate:function(a){var b=a.exercise;a=b.exerciseType;var c=b.content,b=b.options||[];a==g.ExerciseType.SINGLE_OPTION||a==g.ExerciseType.MULTI_OPTION?(""==p.trim(c)&&(this._fieldErrors.content=["\u8bf7\u8f93\u5165\u4e60\u9898\u5185\u5bb9"]),2>b.length&&(this._fieldErrors.exerOption=["\u8bf7\u8f93\u5165\u81f3\u5c11\u4e24\u4e2a\u9009\u9879"])):a==g.ExerciseType.ESSAY_QUESTION&&""==p.trim(c)&&(this._fieldErrors.content=["\u8bf7\u8f93\u5165\u4e60\u9898\u5185\u5bb9"])},
hasError:function(){var a=this._fieldErrors,b;for(b in a)return!0;return!1},showErrors:function(){var a=this._fieldErrors,b=a.content;if(b){var e=this.exerContentEditor.domNode.previousSibling;c.create("span",{style:{color:"red"},innerHTML:b[0]},e)}if(a=a.exerOption)e=this.tblOption.parentNode.previousSibling,c.create("span",{style:{color:"red"},innerHTML:a[0]},e)},clearErrors:function(){var a=this._fieldErrors;a.content&&c.destroy(this.exerContentEditor.domNode.previousSibling.lastChild);a.exerOption&&
c.destroy(this.tblOption.parentNode.previousSibling.lastChild);this._fieldErrors={}},_reset:function(){this.data={exercise:{}};this.clearErrors();this.exerContentEditor.set("value","");this.answerEditor.set("value","");this.guideEditor.set("value","");s("[name\x3d"+this._optionName+"]:checked",this.tblOption).forEach(function(a,b){h.set(a,"checked",!1)});this.tblOption&&n.findWidgets(this.tblOption).forEach(function(a,b){a.set("value","")});this.image.reset()},empty:function(){},_createOptionPane:function(a){var b=
this.optionPane=c.create("div",null,this.contentPane,"after");c.place('\x3cdiv class\x3d"drip-title"\x3e\u9009\u9879\u548c\u7b54\u6848\x3c/div\x3e',b);for(var b=c.place("\x3cdiv\x3e\x3c/div\x3e",b),e=this.tblOption=c.place('\x3ctable class\x3d"drip-exercise-option"\x3e\x3c/table\x3e',b),d=this.optionLength,f=0;f<d;f++)this._createOption(e,f,a);this._refreshOption();b=c.place("\x3cdiv\x3e\x3c/div\x3e",b);b=c.place('\x3ca href\x3d"#"\x3e\x3ci class\x3d"icon-plus"\x3e\x3c/i\x3e \u6dfb\u52a0\u9009\u9879\x3c/a\x3e',
b);l(b,"click",k.hitch(this,function(b){this._createOption(e,this.optionLength++,a);m.stop(b)}))},_getOptionId:function(){this.optionId||(this.optionId=0);return this.optionId++},_createOption:function(a,b,e){var d=c.place("\x3ctr\x3e\x3c/tr\x3e",a),f=c.place("\x3ctd\x3e\x3c/td\x3e",d);this._getOptionId();c.place('\x3cinput type\x3d"'+e+'" name\x3d"'+this._optionName+'"/\x3e',f);e=c.place("\x3ctd\x3e\x3c/td\x3e",d);c.place("\x3clabel\x3e"+"ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(b)+"\x3c/label\x3e",e);
b=c.place("\x3ctd\x3e\x3c/td\x3e",d);this._createEditor(b,2,490);f=c.place("\x3ctd\x3e\x3c/td\x3e",d);b=c.place('\x3ca href\x3d"#" class\x3d"iconbutton" title\x3d"\u5220\u9664"\x3e\x3ci class\x3d"icon-trash"\x3e\x3c/i\x3e\x3c/a\x3e',f);e=c.place('\x3ca href\x3d"#" class\x3d"iconbutton" title\x3d"\u4e0b\u79fb"\x3e\x3ci class\x3d"icon-arrow-down"\x3e\x3c/i\x3e\x3c/a\x3e',f);f=c.place('\x3ca href\x3d"#" class\x3d"iconbutton" title\x3d"\u4e0a\u79fb"\x3e\x3ci class\x3d"icon-arrow-up"\x3e\x3c/i\x3e\x3c/a\x3e',
f);l(b,"click",k.hitch(this,function(a){this.optionLength--;n.findWidgets(d).forEach(function(a,b){a.destroyRecursive()});c.destroy(d);this._refreshOption();m.stop(a)}));l(e,"click",k.hitch(this,function(b){d.nextSibling?c.place(d,d.nextSibling,"after"):c.place(d,a,"first");this._refreshOption();m.stop(b)}));l(f,"click",k.hitch(this,function(b){d.previousSibling?c.place(d,d.previousSibling,"before"):c.place(d,a,"last");this._refreshOption();m.stop(b)}))},_refreshOption:function(){w.forEach(this.tblOption.childNodes,
function(a,b){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(b),d=a.cells[0].firstChild,f="option"+(b+1);h.set(d,"id",f);d.value=b;d=a.cells[1].firstChild;h.set(d,"for",f);d.innerHTML=c})},_destroyForm:function(){var a=this.domNode;n.findWidgets(a).forEach(function(a,c){a.destroyRecursive()});c.empty(a)},startup:function(){this.inherited(arguments);for(var a=this._editors,b=0;b<a.length;b++)a[b].startup()}})});
//@ sourceMappingURL=ExerciseForm.js.map