//>>built
require({cache:{"url:drip/templates/ActivityNode.html":'<div class="item">\n	<div>\n		<div class="drip_face">\n			<!-- TODO：放置用户头像 -->\n			<a href="#" data-dojo-attach-point="userLinkNode"><img data-dojo-attach-point="userImageNode" src="" width="50px" height="50px"/></a>\n		</div>\n		<div class="drip_detail">\n			<div>\n				<a href="#" data-dojo-attach-point="userInfo"></a>\n				<span data-dojo-attach-point="action"></span>\n				<span class="time" style="margin-left: 20px;"><time title="" data-dojo-attach-point="time">三分钟前</time></span>\n			</div>\n			<div>\n				<div>\n					<div class="exercise" data-dojo-attach-point="exerciseNode">\n						\n					</div>\n					<div style="float: right">\n					<!-- \n						<a href="#">关注(100)</a>\n						<i style="margin-left:6px;margin-right:8px; color:#AEAEAE">|</i>\n						<a href="#">收藏(100)</a>\n						<i style="margin-left:6px;margin-right:8px; color:#AEAEAE">|</i>\n					 -->\n						<!-- 解答是一个按钮，数字用一个框括住。点击按钮后，隐藏；点击取消之后，再显示 -->\n						<span data-dojo-attach-point="answerAreaNode">\n							<!-- 解答 -->\n							<input type="button" value="解答" class="drip_to_answer" data-dojo-attach-point="btnAnswer"></input>\n							<a href="#" class="drip_answer_count">0</a>\n						</span>\n					</div>\n				</div>\n			</div>\n		</div>\n	</div>\n</div>	',"url:drip/templates/ActivityList.html":'<div class="activities">\n<!-- 分页 -->\n</div>'}}),define("drip/Activity",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/request/xhr","dojo/dom-construct","dojo/dom-prop","dojo/dom-style","dojo/query","dojo/on","dojo/json","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/Button","dojo/store/JsonRest","drip/classCode","drip/prettyDate","mathEditor/Editor","dojo/text!./templates/ActivityNode.html","dojo/text!./templates/ActivityList.html","drip/MiniCard"],function(declare,array,lang,event,xhr,domConstruct,domProp,domStyle,query,on,JSON,_WidgetBase,_TemplatedMixin,Button,JsonRest,classCode,prettyDate,Editor,nodeTemplate,listTemplate,MiniCard){var optionLabel="ABCDEFGHIJKLMNOPQRSTUVWXYZ",ActivityNode=declare("drip.ActivityNode",[_WidgetBase,_TemplatedMixin],{templateString:nodeTemplate,data:{},postCreate:function(){this.inherited(arguments),this._showActionLabel(),this.miniCard=new MiniCard;var exerciseInfo=this.data.exercise,exerciseId=exerciseInfo.id;0,this._createExercise(exerciseInfo);var exerType=exerciseInfo.exerType,answerInfo=this.data.answer;if(answerInfo){if(this._isOptionExercise(exerType)){this._optionLabels=[],array.forEach(answerInfo.detail,lang.hitch(this,this._setOptionAnswer));var answerDiv=this.answerDiv=domConstruct.create("div",{"class":"answer"},this.exerciseNode,"after");this._optionLabels.length>0?answerDiv.innerHTML="答案是：<span>"+this._optionLabels.join(",")+"</span>":answerDiv.innerHTML="答案是：<span>您还没有作答。	</span>"}var guide=answerInfo.guide;if(guide&&guide!="")var guideContainerDiv=this.guideContainerDiv=domConstruct.create("div",{"class":"guide"},this.exerciseNode),guideLabel=domConstruct.create("div",{innerHTML:"习题解析"},guideContainerDiv),guideContentDiv=domConstruct.create("div",{innerHTML:guide},guideContainerDiv)}on(this.btnAnswer,"click",lang.hitch(this,function(e){this.answerDiv&&domStyle.set(this.answerDiv,"display","none"),this.guideContainerDiv&&domStyle.set(this.guideContainerDiv,"display","none"),this._isOptionExercise(exerType)&&this._getOptionEls().forEach(function(optEl,index){domProp.set(optEl,"disabled",!1),domProp.get(optEl,"checked")==1&&domProp.set(optEl,"checked",!1)});var doAnswerPane=this.doAnswerPane=domConstruct.create("div",null,this.exerciseNode,"after"),guideDiv=domConstruct.create("div",{"class":"guide"},doAnswerPane),guideLabel=domConstruct.create("div",{innerHTML:"习题解析"},guideDiv),editor=new Editor({style:"height:50px;width:98%"});editor.placeAt(guideDiv);var btnContainer=domConstruct.create("div",{style:"width:98%;margin-top:5px;text-align:right"},doAnswerPane),aCancel=domConstruct.create("a",{"class":"drip_op_cancel",innerHTML:"取消",href:"#"},btnContainer),btnSave=domConstruct.create("input",{type:"button",value:"保存"},btnContainer);on(btnSave,"click",lang.hitch(this,function(e){var answerData={};answerData.exerId=exerciseInfo.id,answerData.detail=[],this._isOptionExercise(exerType)&&this._getOptionEls().forEach(lang.hitch(this,function(optionEl,index){if(domProp.get(optionEl,"checked")===!0){var optionData={optionId:domProp.get(optionEl,"optionId")};answerData.detail.push(optionData)}}));var guide=editor.get("value");guide!=""&&(0,answerData.guide=guide),xhr.post("/answers/",{handleAs:"json",data:JSON.stringify(answerData)}).then(lang.hitch(this,function(response){this._destroyAnswerPane(),this._showAnswerArea(!0)}),lang.hitch(this,function(error){}))})),on(aCancel,"click",lang.hitch(this,function(e){event.stop(e),this._destroyAnswerPane(),this.answerDiv&&domStyle.set(this.answerDiv,"display",""),this.guideContainerDiv&&domStyle.set(this.guideContainerDiv,"display","");var answerInfo=this.data.answer;answerInfo&&this._isOptionExercise(exerType)&&array.forEach(answerInfo.detail,lang.hitch(this,this._setOptionAnswer)),this._showAnswerArea(!0)}));var answerWidget=this._answerWidget=[];answerWidget.push(editor),xhr.get("/answers/",{query:{exerId:exerciseId},handleAs:"json"}).then(lang.hitch(this,function(data){this._currentUserAnswer=data,0,data.guide&&(editor.set("value",data.guide),0),data.detail&&data.detail.length>0&&array.forEach(data.detail,lang.hitch(this,this._setOptionAnswer))})),this._showAnswerArea(!1)})),0;var localUserId=this.data.localUserId,mapUserId=this.data.mapUserId;debugger;on(this.userLinkNode,"mouseover",lang.hitch(this,function(e){this.miniCard.show(e.target,localUserId,mapUserId)})),on(this.userInfo,"mouseover",lang.hitch(this,function(e){this.miniCard.show(e.target,localUserId,mapUserId)})),on(this.userLinkNode,"mouseout",lang.hitch(this,function(e){this.miniCard.hide()})),on(this.userInfo,"mouseout",lang.hitch(this,function(e){this.miniCard.hide()}))},_showAnswerArea:function(show){var display="";show==0&&(display="none"),domStyle.set(this.answerAreaNode,"display",display)},_destroyAnswerPane:function(){this._answerWidget&&(array.forEach(this._answerWidget,function(widget,index){widget.destroyRecursive()}),delete this._answerWidget),domConstruct.destroy(this.doAnswerPane)},_isOptionExercise:function(exerType){return exerType==classCode.ExerciseType.SINGLE_OPTION||exerType==classCode.ExerciseType.MULTI_OPTION},_setOptionAnswer:function(answer,index){var optionId=answer.optionId;this._getOptionEls().some(lang.hitch(this,function(node,index){return domProp.get(node,"optionId")==optionId?(domProp.set(node,"checked",!0),this._optionLabels&&this._optionLabels.push(node.parentNode.nextSibling.firstChild.firstChild.innerHTML),!0):!1}))},_getOptionEls:function(){return this._optionEls||(this._optionEls=query("input[type=radio]",this.table)),this._optionEls},_showActionLabel:function(){var data=this.data;0;var userName=data.userInfo.displayName;this.userInfo.innerHTML=userName,this.action.innerHTML=classCode.ActionTypeMap[data.actionType],this.time.innerHTML=prettyDate.pretty(data.createTime),this.time.title=data.createTime.replace("T"," "),this.time.datetime=data.createTime,this.userImageNode.src=data.userInfo.smallImageUrl},_createExercise:function(exerciseInfo){var _contentDiv=domConstruct.create("div",{innerHTML:exerciseInfo.content.replace(/&amp;/g,"&"),"class":"content"},this.exerciseNode),options=exerciseInfo.options;if(options&&options.length>0){var inputType="radio";exerciseInfo.exerType==classCode.ExerciseType.SINGLE_OPTION?inputType="radio":exerciseInfo.exerType==classCode.ExerciseType.MULTI_OPTION&&(inputType="checkbox");var _optionsDiv=domConstruct.create("div",{"class":"option"},this.exerciseNode),table=this.table=domConstruct.create("table",null,_optionsDiv);array.forEach(options,lang.hitch(this,this._createOption,table,inputType))}},_createOption:function(parentNode,inputType,data,index){0;var inputId=this.id+"_"+data.id,inputGroupName="opt_"+this.id,tr=domConstruct.place("<tr></tr>",parentNode),td1=domConstruct.place("<td></td>",tr),input=domConstruct.create("input",{type:inputType,name:inputGroupName,id:inputId},td1);domProp.set(input,{disabled:!0,optionId:data.id});var td2=domConstruct.place("<td></td>",tr),label=domConstruct.place("<label></label>",td2);domProp.set(label,"for",inputId),domConstruct.place('<span style="padding-right:5px">'+optionLabel.charAt(index)+"</span>",label);var divOptionContent=domConstruct.place("<span></span>",label);divOptionContent.innerHTML=data.content}}),Activity=declare("Activity",[_WidgetBase,_TemplatedMixin],{templateString:listTemplate,store:new JsonRest({target:"/activities/"}),postCreate:function(){this.inherited(arguments),this.store.query().then(lang.hitch(this,this._load))},_load:function(items){items.length==0?this.domNode.innerHTML="没有活动，快去录入新题目，或到题库中解答习题":(0,array.forEach(items,lang.hitch(this,function(item,index){var node=new ActivityNode({data:item});this.domNode.appendChild(node.domNode)})),prettyDate.setInterval(this.domNode,6e4),MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.domNode]))}});return Activity})