//>>built
require({cache:{"url:drip/templates/ActivityNode.html":'\x3cdiv class\x3d"item"\x3e\n\t\x3cdiv\x3e\n\t\t\x3cdiv class\x3d"drip_face"\x3e\n\t\t\t\x3c!-- TODO\uff1a\u653e\u7f6e\u7528\u6237\u5934\u50cf --\x3e\n\t\t\t\x3ca href\x3d"#" data-dojo-attach-point\x3d"userLinkNode"\x3e\x3cimg data-dojo-attach-point\x3d"userImageNode" src\x3d"" width\x3d"50px" height\x3d"50px"/\x3e\x3c/a\x3e\n\t\t\x3c/div\x3e\n\t\t\x3cdiv class\x3d"drip_detail"\x3e\n\t\t\t\x3cdiv class\x3d"drip_action"\x3e\n\t\t\t\t\x3ca href\x3d"#" data-dojo-attach-point\x3d"userInfo"\x3e\x3c/a\x3e\n\t\t\t\t\x3cspan data-dojo-attach-point\x3d"action"\x3e\x3c/span\x3e\n\t\t\t\t\x3cspan class\x3d"time" style\x3d"margin-left: 20px;"\x3e\x3ctime title\x3d"" data-dojo-attach-point\x3d"time"\x3e\x3c/time\x3e\x3c/span\x3e\n\t\t\t\x3c/div\x3e\n\t\t\t\x3cdiv\x3e\n\t\t\t\t\x3cdiv\x3e\n\t\t\t\t\t\x3cdiv class\x3d"exercise" data-dojo-attach-point\x3d"exerciseNode"\x3e\x3c/div\x3e\n\t\t\t\t\t\x3cdiv class\x3d"answerContainer" data-dojo-attach-point\x3d"answerNode"\x3e\x3c/div\x3e\n\t\t\t\t\t\x3cdiv style\x3d"float: right"\x3e\n\t\t\t\t\t\x3c!-- \n\t\t\t\t\t\t\x3ca href\x3d"#"\x3e\u5173\u6ce8(100)\x3c/a\x3e\n\t\t\t\t\t\t\x3ci style\x3d"margin-left:6px;margin-right:8px; color:#AEAEAE"\x3e|\x3c/i\x3e\n\t\t\t\t\t\t\x3ca href\x3d"#"\x3e\u6536\u85cf(100)\x3c/a\x3e\n\t\t\t\t\t\t\x3ci style\x3d"margin-left:6px;margin-right:8px; color:#AEAEAE"\x3e|\x3c/i\x3e\n\t\t\t\t\t --\x3e\n\t\t\t\t\t\t\x3c!-- \u89e3\u7b54\u662f\u4e00\u4e2a\u6309\u94ae\uff0c\u6570\u5b57\u7528\u4e00\u4e2a\u6846\u62ec\u4f4f\u3002\u70b9\u51fb\u6309\u94ae\u540e\uff0c\u9690\u85cf\uff1b\u70b9\u51fb\u53d6\u6d88\u4e4b\u540e\uff0c\u518d\u663e\u793a --\x3e\n\t\t\t\t\t\t\x3cspan data-dojo-attach-point\x3d"answerAreaNode"\x3e\n\t\t\t\t\t\t\t\x3c!-- \u89e3\u7b54 --\x3e\n\t\t\t\t\t\t\t\x3cbutton data-dojo-attach-point\x3d"btnAnswer"\n\t\t\t\t\t\t\t class\x3d"minibutton"\x3e\x3ci class\x3d"icon-comment-alt"\x3e\x3c/i\x3e \u89e3\u7b54\x3c/button\x3e\n\t\t\t\t\t\t\t\x3ca href\x3d"#" data-dojo-attach-point\x3d"drip_answer_count" class\x3d"drip_answer_count"\x3e0\x3c/a\x3e\n\t\t\t\t\t\t\x3c/span\x3e\n\t\t\t\t\t\x3c/div\x3e\n\t\t\t\t\x3c/div\x3e\n\t\t\t\x3c/div\x3e\n\t\t\x3c/div\x3e\n\t\x3c/div\x3e\n\x3c/div\x3e\t',
"url:drip/templates/ActivityList.html":'\x3cdiv class\x3d"activities"\x3e\n\x3c!-- \u5206\u9875 --\x3e\n\x3c/div\x3e'}});
define("drip/Activity","dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/_base/event dojo/request/xhr dojo/dom-construct dojo/dom-prop dojo/dom-style dojo/query dojo/on dojo/fx dojo/json dojo/string dojo/date/locale dijit/_WidgetBase dijit/_TemplatedMixin dijit/form/Button drip/classCode drip/prettyDate drip/_StoreMixin mathEditor/Editor mathEditor/dataUtil dojo/text!./templates/ActivityNode.html dojo/text!./templates/ActivityList.html drip/MiniCard drip/tip".split(" "),function(r,l,d,w,s,
e,g,m,x,k,p,y,z,A,t,u,H,h,q,B,v,n,C,D,E,F){var G=r("drip.ActivityNode",[t,u],{templateString:C,data:{},postCreate:function(){this.inherited(arguments);this._showActionLabel();this.miniCard=new E;this._createExercise();this._createAnswer();this.drip_answer_count.innerHTML=this.data.exerAnswerCount;k(this.btnAnswer,"click",d.hitch(this,this._loadAnswerHandler));var a=this.data.userInfo.userId;k(this.userLinkNode,"mouseover",d.hitch(this,function(b){this.miniCard.show(b.target,a)}));k(this.userInfo,
"mouseover",d.hitch(this,function(b){this.miniCard.show(b.target,a)}));k(this.userLinkNode,"mouseout",d.hitch(this,function(a){this.miniCard.hide()}));k(this.userInfo,"mouseout",d.hitch(this,function(a){this.miniCard.hide()}))},_showActionLabel:function(){var a=this.data;this.userInfo.innerHTML=a.userInfo.nickName||a.userInfo.loginName;this.action.innerHTML=h.ActionTypeMap[a.actionType];this.time.innerHTML=q.prettyForNumber(a.createTime);this.time.title=A.format(new Date(a.createTime),{selector:"date",
formatLength:"full"});this.time.datetime=a.createTime;this.userImageNode.src=a.userInfo.smallImageUrl||h.avatar.smallImageUrl},_createExercise:function(){var a=this.data.exercise,b=this.data.userInfo,c=n.xmlStringToHtml(a.content);e.create("div",{innerHTML:c,"class":"content"},this.exerciseNode);a.imageName&&e.create("img",{src:"/userImages/"+b.userId+"/"+a.imageName},this.exerciseNode);if((b=a.options)&&0<b.length)c="radio",a.exerType==h.ExerciseType.SINGLE_OPTION?c="radio":a.exerType==h.ExerciseType.MULTI_OPTION&&
(c="checkbox"),a=e.create("div",{"class":"option"},this.exerciseNode),a=this.table=e.create("table",null,a),l.forEach(b,d.hitch(this,this._createOption,a,c))},_createOption:function(a,b,c,f){var d=this.id+"_"+c.id,h="opt_"+this.id;a=e.place("\x3ctr\x3e\x3c/tr\x3e",a);var k=e.place("\x3ctd\x3e\x3c/td\x3e",a);b=e.create("input",{type:b,name:h,id:d},k);g.set(b,{disabled:!0,optionId:c.id});b=e.place("\x3ctd\x3e\x3c/td\x3e",a);f=e.place('\x3clabel style\x3d"padding-right:5px"\x3e'+"ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(f)+
"\x3c/label\x3e",b);g.set(f,"for",d);d=e.place("\x3ctd\x3e\x3c/td\x3e",a);c=n.xmlStringToHtml(c.content);d.innerHTML=c},_createAnswer:function(){var a=this.data.answer;if(a){var b=this.data.exercise.exerciseType;this._isOptionExercise(b)?(this._optionLabels=[],l.forEach(a.detail,d.hitch(this,this._setOptionAnswer)),b=this.answerDiv=e.create("div",{"class":"answer"},this.answerNode),b.innerHTML=0<this._optionLabels.length?"\u7b54\u6848\uff1a\x3cspan\x3e"+this._optionLabels.join(",")+"\x3c/span\x3e":
"\u7b54\u6848\uff1a\x3cspan\x3e\u60a8\u8fd8\u6ca1\u6709\u4f5c\u7b54\u3002\x3c/span\x3e"):b==h.ExerciseType.ESSAY_QUESTION&&1==a.detail.length&&(b=this.answerDiv=e.create("div",{"class":"answer"},this.answerNode),b.innerHTML="\u7b54\u6848:"+n.xmlStringToHtml(a.detail[0].content));if((a=a.guide)&&""!=a)a=n.xmlStringToHtml(a),b=this.guideContainerDiv=e.create("div",{"class":"guide"},this.answerNode),e.create("div",{innerHTML:"\u89e3\u6790"},b),e.create("div",{innerHTML:a},b)}},_loadAnswerHandler:function(){this.answerNode&&
m.set(this.answerNode,"display","none");var a=this._answerWidgets=[],b=this.editAnswerPane=e.create("div",null,this.exerciseNode,"after"),c=this.data.exercise.exerciseType;if(this._isOptionExercise(c))this._getOptionEls().forEach(function(a,b){g.set(a,"disabled",!1);!0==g.get(a,"checked")&&g.set(a,"checked",!1)}),this._getOptionEls().on("click",d.hitch(this,this._onAnswerChangedHandler));else if(c==h.ExerciseType.ESSAY_QUESTION){c=e.create("div",{"class":"answer"},b);e.create("div",{innerHTML:"\u7b54\u6848"},
c);var f=this.answerEditor=new v({rows:5,width:650});f.placeAt(c);f.startup();f.on("change",d.hitch(this,this._onAnswerChangedHandler));a.push(f)}f=e.create("div",{"class":"guide"},b);e.create("div",{innerHTML:"\u89e3\u6790"},f);c=this.guideEditor=new v({rows:5,width:650});c.placeAt(f);c.startup();c.on("change",d.hitch(this,this._onGuideChangedHandler));f=e.create("div",{style:"width:98%;margin-top:5px;text-align:right"},b);b=this._aCancel=e.create("a",{"class":"drip_op_cancel",innerHTML:"\u53d6\u6d88",
href:"#"},f);f=this._btnSave=e.place('\x3cbutton class\x3d"minibutton"\x3e\x3ci class\x3d"icon-save"\x3e\x3c/i\x3e \u4fdd\u5b58\x3c/button\x3e',f);g.set(f,"disabled",!0);k(f,"click",d.hitch(this,this._saveOrUpdateAnswer));k(b,"click",d.hitch(this,this._cancelAnswer));a.push(c);s.get("/answers/",{query:{exerId:this.data.exercise.id},handleAs:"json"}).then(d.hitch(this,this._loadLatestAnswer));this._showAnswerArea(!1)},_onAnswerChangedHandler:function(a){var b=this.data.exercise.exerciseType;if(a=this._oldAnswer){if(this._isOptionExercise(b)){var c=
a.detail,f=this._getSelectExerciseAnswer();if(0==f.length){this._disableBtnSave(!0);return}if(!this._selectedAnswerOptionsEquals(c,f)){this._disableBtnSave(!1);return}c=this.guideEditor;c=c.get("value");if(c!=a.guide){this._disableBtnSave(!1);return}}if(b==h.ExerciseType.ESSAY_QUESTION){b=this.answerEditor;if(b.isEmpty()){this._disableBtnSave(!0);return}b=b.get("value");if(a.detail[0].content!=b){this._disableBtnSave(!1);return}c=this.guideEditor;c=c.get("value");if(c!=a.guide){this._disableBtnSave(!1);
return}}this._disableBtnSave(!0)}else this._isOptionExercise(b)?(f=this._getSelectExerciseAnswer(),0==f.length?this._disableBtnSave(!0):this._disableBtnSave(!1)):b==h.ExerciseType.ESSAY_QUESTION&&(b=this.answerEditor,b.isEmpty()?this._disableBtnSave(!0):this._disableBtnSave(!1))},_selectedAnswerOptionsEquals:function(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c].optionId!=b[c].optionId)return!1;return!0},_onGuideChangedHandler:function(a){a=this.data.exercise.exerciseType;
var b=this._oldAnswer;b&&(b.guide!=this.guideEditor.get("value")?this._disableBtnSave(!1):this._isOptionExercise(a)||a==h.ExerciseType.ESSAY_QUESTION&&(b.detail[0].content==this.answerEditor.get("value")?this._disableBtnSave(!0):this._disableBtnSave(!1)))},_disableBtnSave:function(a){var b=this._btnSave;g.get(b,"disabled")!=a&&g.set(b,"disabled",a)},_getSelectExerciseAnswer:function(){var a=[];this._getOptionEls().forEach(d.hitch(this,function(b,c){if(!0===g.get(b,"checked")){var f={optionId:g.get(b,
"optionId")};a.push(f)}}));return a},_saveOrUpdateAnswer:function(a){a={detail:[]};var b=this.data.exercise.exerciseType;this._isOptionExercise(b)?a.detail=this._getSelectExerciseAnswer():b==h.ExerciseType.ESSAY_QUESTION&&(b=this.answerEditor.get("value"),""!=z.trim(b)&&a.detail.push({content:b}));b=this.guideEditor.get("value");""!=b&&(a.guide=b);var b=null,c="/answers/";this._oldAnswer?(b="PUT",c+=this._oldAnswer.id,a.id=this._oldAnswer.id,a.answerVersion=this._oldAnswer.answerVersion,a.exerciseId=
this._oldAnswer.exerciseId):(b="POST",a.exerciseId=this.data.exercise.histId);s(c,{method:b,handleAs:"json",data:y.stringify(a)}).then(d.hitch(this,function(a){F.ok("\u4fdd\u5b58\u6210\u529f",this._aCancel,"before");a=p.wipeOut({node:this.editAnswerPane,duration:2E3,onEnd:d.hitch(this,function(){this._destroyAnswerPane();this._resetSelectOldAnswerPanel()})});var b=p.wipeIn({node:this.answerNode,onEnd:d.hitch(this,function(){this._showAnswerArea(!0)})});p.chain([a,b]).play()}),d.hitch(this,function(a){}))},
_cancelAnswer:function(a){w.stop(a);this._destroyAnswerPane();this.answerDiv&&m.set(this.answerDiv,"display","");this.guideContainerDiv&&m.set(this.guideContainerDiv,"display","");this._resetSelectOldAnswerPanel();this._showAnswerArea(!0)},_resetSelectOldAnswerPanel:function(){var a=this.data.answer;if(a){var b=this.data.exercise.exerciseType;this._isOptionExercise(b)&&(l.forEach(a.detail,d.hitch(this,this._setOptionAnswer)),this._getOptionEls().forEach(function(a){g.set(a,"disabled",!0)}))}else b=
this.data.exercise.exerciseType,this._isOptionExercise(b)&&this._getOptionEls().forEach(function(a){g.set(a,"checked",!1);g.set(a,"disabled",!0)})},_loadLatestAnswer:function(a){a=this.data.answer;if(!(null==a||"null"==a)){this._oldAnswer=a;a.guide&&this.guideEditor.set("value",a.guide);var b=this.data.exercise.exerciseType;this._isOptionExercise(b)?a.detail&&0<a.detail.length&&l.forEach(a.detail,d.hitch(this,this._setOptionAnswer)):b==h.ExerciseType.ESSAY_QUESTION&&a.detail&&1==a.detail.length&&
this.answerEditor.set("value",a.detail[0].content);b=e.create("div",{style:{color:"gray","font-style":"italic"}},this.editAnswerPane);e.create("span",{innerHTML:"\u60a8\u4e0a\u6b21\u4e8e"},b);e.create("time",{innerHTML:q.prettyForNumber(a.createTime)},b).datetime=a.createTime;e.create("span",{innerHTML:"\u7f16\u8f91\u8be5\u7b54\u6848"},b)}},_showAnswerArea:function(a){var b="";!1==a&&(b="none");m.set(this.answerAreaNode,"display",b);m.set(this.answerNode,"display",b)},_destroyAnswerPane:function(){this._answerWidgets&&
(l.forEach(this._answerWidgets,function(a,b){a.destroyRecursive()}),this._answerWidgets=[]);e.destroy(this.editAnswerPane);this.guideEditor=this.answerEditor=null},_isOptionExercise:function(a){return a==h.ExerciseType.SINGLE_OPTION||a==h.ExerciseType.MULTI_OPTION},_setOptionAnswer:function(a,b){var c=a.optionId;this._getOptionEls().some(d.hitch(this,function(a,b){return g.get(a,"optionId")==c?(g.set(a,"checked",!0),this._optionLabels&&this._optionLabels.push(a.parentNode.nextSibling.firstChild.innerHTML),
!0):!1}))},_getOptionEls:function(){this._optionEls||(this._optionEls=x("input[type\x3dradio]",this.table));return this._optionEls}});return r("Activity",[t,u,B],{templateString:D,postCreate:function(){this.inherited(arguments);m.set(this.domNode,{"padding-top":"10px","padding-left":"10px","padding-right":"10px"});this.refresh()},_load:function(a){0==a.length?this.domNode.innerHTML=this.noDataMessage:(this.domNode.innerHTML="",l.forEach(a,d.hitch(this,function(a,c){var d=new G({data:a});this.domNode.appendChild(d.domNode)})),
q.setInterval(this.domNode,6E4),MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.domNode]))},refresh:function(){this.domNode.innerHTML=this.loadingMessage;this.store&&this.store.query(this.query).then(d.hitch(this,this._load))}})});
//@ sourceMappingURL=Activity.js.map