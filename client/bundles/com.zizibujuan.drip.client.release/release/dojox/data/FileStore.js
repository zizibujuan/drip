//>>built
define("dojox/data/FileStore",["dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/json","dojo/_base/xhr"],function(declare,lang,kernel,jsonUtil,xhr){return declare("dojox.data.FileStore",null,{constructor:function(args){args&&args.label&&(this.label=args.label),args&&args.url&&(this.url=args.url),args&&args.options&&(lang.isArray(args.options)?this.options=args.options:lang.isString(args.options)&&(this.options=args.options.split(","))),args&&args.pathAsQueryParam&&(this.pathAsQueryParam=!0),args&&"urlPreventCache"in args&&(this.urlPreventCache=args.urlPreventCache?!0:!1)},url:"",_storeRef:"_S",label:"name",_identifier:"path",_attributes:["children","directory","name","path","modified","size","parentDir"],pathSeparator:"/",options:[],failOk:!1,urlPreventCache:!0,_assertIsItem:function(item){if(!this.isItem(item))throw new Error("dojox.data.FileStore: a function was passed an item argument that was not an item")},_assertIsAttribute:function(attribute){if(typeof attribute!="string")throw new Error("dojox.data.FileStore: a function was passed an attribute argument that was not an attribute name string")},pathAsQueryParam:!1,getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0}},getValue:function(item,attribute,defaultValue){var values=this.getValues(item,attribute);return values&&values.length>0?values[0]:defaultValue},getAttributes:function(item){return this._attributes},hasAttribute:function(item,attribute){return this._assertIsItem(item),this._assertIsAttribute(attribute),attribute in item},getIdentity:function(item){return this.getValue(item,this._identifier)},getIdentityAttributes:function(item){return[this._identifier]},isItemLoaded:function(item){var loaded=this.isItem(item);return loaded&&typeof item._loaded=="boolean"&&!item._loaded&&(loaded=!1),loaded},loadItem:function(keywordArgs){var item=keywordArgs.item,self=this,scope=keywordArgs.scope||kernel.global,content={};this.options.length>0&&(content.options=jsonUtil.toJson(this.options)),this.pathAsQueryParam&&(content.path=item.parentPath+this.pathSeparator+item.name);var xhrData={url:this.pathAsQueryParam?this.url:this.url+"/"+item.parentPath+"/"+item.name,handleAs:"json-comment-optional",content:content,preventCache:this.urlPreventCache,failOk:this.failOk},deferred=xhr.get(xhrData);deferred.addErrback(function(error){keywordArgs.onError&&keywordArgs.onError.call(scope,error)}),deferred.addCallback(function(data){delete item.parentPath,delete item._loaded,lang.mixin(item,data),self._processItem(item),keywordArgs.onItem&&keywordArgs.onItem.call(scope,item)})},getLabel:function(item){return this.getValue(item,this.label)},getLabelAttributes:function(item){return[this.label]},containsValue:function(item,attribute,value){var values=this.getValues(item,attribute);for(var i=0;i<values.length;i++)if(values[i]==value)return!0;return!1},getValues:function(item,attribute){this._assertIsItem(item),this._assertIsAttribute(attribute);var value=item[attribute];return typeof value!="undefined"&&!lang.isArray(value)?value=[value]:typeof value=="undefined"&&(value=[]),value},isItem:function(item){return item&&item[this._storeRef]===this?!0:!1},close:function(request){},fetch:function(request){request=request||{},request.store||(request.store=this);var self=this,scope=request.scope||kernel.global,reqParams={};request.query&&(reqParams.query=jsonUtil.toJson(request.query)),request.sort&&(reqParams.sort=jsonUtil.toJson(request.sort)),request.queryOptions&&(reqParams.queryOptions=jsonUtil.toJson(request.queryOptions)),typeof request.start=="number"&&(reqParams.start=""+request.start),typeof request.count=="number"&&(reqParams.count=""+request.count),this.options.length>0&&(reqParams.options=jsonUtil.toJson(this.options));var getArgs={url:this.url,preventCache:this.urlPreventCache,failOk:this.failOk,handleAs:"json-comment-optional",content:reqParams},deferred=xhr.get(getArgs);deferred.addCallback(function(data){self._processResult(data,request)}),deferred.addErrback(function(error){request.onError&&request.onError.call(scope,error,request)})},fetchItemByIdentity:function(keywordArgs){var path=keywordArgs.identity,self=this,scope=keywordArgs.scope||kernel.global,content={};this.options.length>0&&(content.options=jsonUtil.toJson(this.options)),this.pathAsQueryParam&&(content.path=path);var xhrData={url:this.pathAsQueryParam?this.url:this.url+"/"+path,handleAs:"json-comment-optional",content:content,preventCache:this.urlPreventCache,failOk:this.failOk},deferred=xhr.get(xhrData);deferred.addErrback(function(error){keywordArgs.onError&&keywordArgs.onError.call(scope,error)}),deferred.addCallback(function(data){var item=self._processItem(data);keywordArgs.onItem&&keywordArgs.onItem.call(scope,item)})},_processResult:function(data,request){var scope=request.scope||kernel.global;try{data.pathSeparator&&(this.pathSeparator=data.pathSeparator),request.onBegin&&request.onBegin.call(scope,data.total,request);var items=this._processItemArray(data.items);if(request.onItem){var i;for(i=0;i<items.length;i++)request.onItem.call(scope,items[i],request);items=null}request.onComplete&&request.onComplete.call(scope,items,request)}catch(e){request.onError?request.onError.call(scope,e,request):0}},_processItemArray:function(itemArray){var i;for(i=0;i<itemArray.length;i++)this._processItem(itemArray[i]);return itemArray},_processItem:function(item){if(!item)return null;item[this._storeRef]=this;if(item.children&&item.directory)if(lang.isArray(item.children)){var children=item.children,i;for(i=0;i<children.length;i++){var name=children[i];lang.isObject(name)?children[i]=this._processItem(name):(children[i]={name:name,_loaded:!1,parentPath:item.path},children[i][this._storeRef]=this)}}else delete item.children;return item}})})