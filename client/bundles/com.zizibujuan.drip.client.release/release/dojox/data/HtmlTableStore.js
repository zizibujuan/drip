//>>built
define("dojox/data/HtmlTableStore",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/dom","dojo/_base/array","dojo/_base/xhr","dojo/_base/sniff","dojo/data/util/simpleFetch","dojo/data/util/filter","dojox/xml/parser"],function(kernel,declare,lang,dom,array,xhr,has,simpleFetch,filter,xmlParser){var HtmlTableStore=declare("dojox.data.HtmlTableStore",null,{constructor:function(args){kernel.deprecated("dojox.data.HtmlTableStore","Please use dojox.data.HtmlStore");if(args.url){if(!args.tableId)throw new Error("dojo.data.HtmlTableStore: Cannot instantiate using url without an id!");this.url=args.url,this.tableId=args.tableId}else{args.tableId?(this._rootNode=dom.byId(args.tableId),this.tableId=this._rootNode.id):this._rootNode=dom.byId(this.tableId),this._getHeadings();for(var i=0;i<this._rootNode.rows.length;i++)this._rootNode.rows[i].store=this}},url:"",tableId:"",_getHeadings:function(){this._headings=[],array.forEach(this._rootNode.tHead.rows[0].cells,lang.hitch(this,function(th){this._headings.push(xmlParser.textContent(th))}))},_getAllItems:function(){var items=[];for(var i=1;i<this._rootNode.rows.length;i++)items.push(this._rootNode.rows[i]);return items},_assertIsItem:function(item){if(!this.isItem(item))throw new Error("dojo.data.HtmlTableStore: a function was passed an item argument that was not an item")},_assertIsAttribute:function(attribute){if(typeof attribute!="string")throw new Error("dojo.data.HtmlTableStore: a function was passed an attribute argument that was not an attribute name string");return array.indexOf(this._headings,attribute)},getValue:function(item,attribute,defaultValue){var values=this.getValues(item,attribute);return values.length>0?values[0]:defaultValue},getValues:function(item,attribute){this._assertIsItem(item);var index=this._assertIsAttribute(attribute);return index>-1?[xmlParser.textContent(item.cells[index])]:[]},getAttributes:function(item){this._assertIsItem(item);var attributes=[];for(var i=0;i<this._headings.length;i++)this.hasAttribute(item,this._headings[i])&&attributes.push(this._headings[i]);return attributes},hasAttribute:function(item,attribute){return this.getValues(item,attribute).length>0},containsValue:function(item,attribute,value){var regexp=undefined;return typeof value=="string"&&(regexp=filter.patternToRegExp(value,!1)),this._containsValue(item,attribute,value,regexp)},_containsValue:function(item,attribute,value,regexp){var values=this.getValues(item,attribute);for(var i=0;i<values.length;++i){var possibleValue=values[i];if(typeof possibleValue=="string"&&regexp)return possibleValue.match(regexp)!==null;if(value===possibleValue)return!0}return!1},isItem:function(something){return something&&something.store&&something.store===this?!0:!1},isItemLoaded:function(something){return this.isItem(something)},loadItem:function(keywordArgs){this._assertIsItem(keywordArgs.item)},_fetchItems:function(request,fetchHandler,errorHandler){if(this._rootNode)this._finishFetchItems(request,fetchHandler,errorHandler);else if(!this.url){this._rootNode=dom.byId(this.tableId),this._getHeadings();for(var i=0;i<this._rootNode.rows.length;i++)this._rootNode.rows[i].store=this}else{var getArgs={url:this.url,handleAs:"text"},self=this,getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){var findNode=function(node,id){if(node.id==id)return node;if(node.childNodes)for(var i=0;i<node.childNodes.length;i++){var returnNode=findNode(node.childNodes[i],id);if(returnNode)return returnNode}return null},d=document.createElement("div");d.innerHTML=data,self._rootNode=findNode(d,self.tableId),self._getHeadings.call(self);for(var i=0;i<self._rootNode.rows.length;i++)self._rootNode.rows[i].store=self;self._finishFetchItems(request,fetchHandler,errorHandler)}),getHandler.addErrback(function(error){errorHandler(error,request)})}},_finishFetchItems:function(request,fetchHandler,errorHandler){var items=null,arrayOfAllItems=this._getAllItems();if(request.query){var ignoreCase=request.queryOptions?request.queryOptions.ignoreCase:!1;items=[];var regexpList={},value,key;for(key in request.query)value=request.query[key]+"",typeof value=="string"&&(regexpList[key]=filter.patternToRegExp(value,ignoreCase));for(var i=0;i<arrayOfAllItems.length;++i){var match=!0,candidateItem=arrayOfAllItems[i];for(key in request.query)value=request.query[key]+"",this._containsValue(candidateItem,key,value,regexpList[key])||(match=!1);match&&items.push(candidateItem)}fetchHandler(items,request)}else arrayOfAllItems.length>0&&(items=arrayOfAllItems.slice(0,arrayOfAllItems.length)),fetchHandler(items,request)},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0}},close:function(request){},getLabel:function(item){return this.isItem(item)?"Table Row #"+this.getIdentity(item):undefined},getLabelAttributes:function(item){return null},getIdentity:function(item){return this._assertIsItem(item),has("opera")?array.indexOf(this._rootNode.rows,item)-1:item.sectionRowIndex},getIdentityAttributes:function(item){return null},fetchItemByIdentity:function(keywordArgs){var identity=keywordArgs.identity,self=this,item=null,scope=null;if(!this._rootNode)if(!this.url){this._rootNode=dom.byId(this.tableId),this._getHeadings();for(var i=0;i<this._rootNode.rows.length;i++)this._rootNode.rows[i].store=this;item=this._rootNode.rows[identity+1],keywordArgs.onItem&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onItem.call(scope,item))}else{var getArgs={url:this.url,handleAs:"text"},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){var findNode=function(node,id){if(node.id==id)return node;if(node.childNodes)for(var i=0;i<node.childNodes.length;i++){var returnNode=findNode(node.childNodes[i],id);if(returnNode)return returnNode}return null},d=document.createElement("div");d.innerHTML=data,self._rootNode=findNode(d,self.tableId),self._getHeadings.call(self);for(var i=0;i<self._rootNode.rows.length;i++)self._rootNode.rows[i].store=self;item=self._rootNode.rows[identity+1],keywordArgs.onItem&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onItem.call(scope,item))}),getHandler.addErrback(function(error){keywordArgs.onError&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onError.call(scope,error))})}else this._rootNode.rows[identity+1]&&(item=this._rootNode.rows[identity+1],keywordArgs.onItem&&(scope=keywordArgs.scope?keywordArgs.scope:kernel.global,keywordArgs.onItem.call(scope,item)))}});return lang.extend(HtmlTableStore,simpleFetch),HtmlTableStore})