//>>built
define("dojox/data/CsvStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/filter","dojo/data/util/simpleFetch"],function(lang,declare,xhr,kernel,filterUtil,simpleFetch){var CsvStore=declare("dojox.data.CsvStore",null,{constructor:function(keywordParameters){this._attributes=[],this._attributeIndexes={},this._dataArray=[],this._arrayOfAllItems=[],this._loadFinished=!1,keywordParameters.url&&(this.url=keywordParameters.url),this._csvData=keywordParameters.data,keywordParameters.label?this.label=keywordParameters.label:this.label===""&&(this.label=undefined),this._storeProp="_csvStore",this._idProp="_csvId",this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._loadInProgress=!1,this._queuedFetches=[],this.identifier=keywordParameters.identifier,this.identifier===""?delete this.identifier:this._idMap={},"separator"in keywordParameters&&(this.separator=keywordParameters.separator),"urlPreventCache"in keywordParameters&&(this.urlPreventCache=keywordParameters.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(item){if(!this.isItem(item))throw new Error(this.declaredClass+": a function was passed an item argument that was not an item")},_getIndex:function(item){var idx=this.getIdentity(item);return this.identifier&&(idx=this._idMap[idx]),idx},getValue:function(item,attribute,defaultValue){this._assertIsItem(item);var itemValue=defaultValue;if(typeof attribute!="string")throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");var ai=this._attributeIndexes[attribute];if(ai!=null){var itemData=this._dataArray[this._getIndex(item)];itemValue=itemData[ai]||defaultValue}return itemValue},getValues:function(item,attribute){var value=this.getValue(item,attribute);return value?[value]:[]},getAttributes:function(item){this._assertIsItem(item);var attributes=[],itemData=this._dataArray[this._getIndex(item)];for(var i=0;i<itemData.length;i++)itemData[i]!==""&&attributes.push(this._attributes[i]);return attributes},hasAttribute:function(item,attribute){this._assertIsItem(item);if(typeof attribute=="string"){var attributeIndex=this._attributeIndexes[attribute],itemData=this._dataArray[this._getIndex(item)];return typeof attributeIndex!="undefined"&&attributeIndex<itemData.length&&itemData[attributeIndex]!==""}throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string")},containsValue:function(item,attribute,value){var regexp=undefined;return typeof value=="string"&&(regexp=filterUtil.patternToRegExp(value,!1)),this._containsValue(item,attribute,value,regexp)},_containsValue:function(item,attribute,value,regexp){var values=this.getValues(item,attribute);for(var i=0;i<values.length;++i){var possibleValue=values[i];if(typeof possibleValue=="string"&&regexp)return possibleValue.match(regexp)!==null;if(value===possibleValue)return!0}return!1},isItem:function(something){if(something&&something[this._storeProp]===this){var identity=something[this._idProp];if(this.identifier){var data=this._dataArray[this._idMap[identity]];if(data)return!0}else if(identity>=0&&identity<this._dataArray.length)return!0}return!1},isItemLoaded:function(something){return this.isItem(something)},loadItem:function(item){},getFeatures:function(){return this._features},getLabel:function(item){return this.label&&this.isItem(item)?this.getValue(item,this.label):undefined},getLabelAttributes:function(item){return this.label?[this.label]:null},_fetchItems:function(keywordArgs,findCallback,errorCallback){var self=this,filter=function(requestArgs,arrayOfAllItems){var items=null;if(requestArgs.query){var key,value;items=[];var ignoreCase=requestArgs.queryOptions?requestArgs.queryOptions.ignoreCase:!1,regexpList={};for(key in requestArgs.query)value=requestArgs.query[key],typeof value=="string"&&(regexpList[key]=filterUtil.patternToRegExp(value,ignoreCase));for(var i=0;i<arrayOfAllItems.length;++i){var match=!0,candidateItem=arrayOfAllItems[i];for(key in requestArgs.query)value=requestArgs.query[key],self._containsValue(candidateItem,key,value,regexpList[key])||(match=!1);match&&items.push(candidateItem)}}else items=arrayOfAllItems.slice(0,arrayOfAllItems.length);findCallback(items,requestArgs)};if(this._loadFinished)filter(keywordArgs,this._arrayOfAllItems);else if(this.url!=="")if(this._loadInProgress)this._queuedFetches.push({args:keywordArgs,filter:filter});else{this._loadInProgress=!0;var getArgs={url:self.url,handleAs:"text",preventCache:self.urlPreventCache},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){try{self._processData(data),filter(keywordArgs,self._arrayOfAllItems),self._handleQueuedFetches()}catch(e){errorCallback(e,keywordArgs)}}),getHandler.addErrback(function(error){self._loadInProgress=!1;if(!errorCallback)throw error;errorCallback(error,keywordArgs)});var oldAbort=null;keywordArgs.abort&&(oldAbort=keywordArgs.abort),keywordArgs.abort=function(){var df=getHandler;df&&df.fired===-1&&(df.cancel(),df=null),oldAbort&&oldAbort.call(keywordArgs)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,filter(keywordArgs,this._arrayOfAllItems)}catch(e){errorCallback(e,keywordArgs)}else{var error=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(!errorCallback)throw error;errorCallback(error,keywordArgs)}},close:function(request){},_getArrayOfArraysFromCsvFileContents:function(csvFileContents){if(lang.isString(csvFileContents)){var leadingWhiteSpaceCharacters=new RegExp("^\\s+","g"),trailingWhiteSpaceCharacters=new RegExp("\\s+$","g"),doubleQuotes=new RegExp('""',"g"),arrayOfOutputRecords=[],i,arrayOfInputLines=this._splitLines(csvFileContents);for(i=0;i<arrayOfInputLines.length;++i){var singleLine=arrayOfInputLines[i];if(singleLine.length>0){var listOfFields=singleLine.split(this.separator),j=0;while(j<listOfFields.length){var space_field_space=listOfFields[j],field_space=space_field_space.replace(leadingWhiteSpaceCharacters,""),field=field_space.replace(trailingWhiteSpaceCharacters,""),firstChar=field.charAt(0),lastChar=field.charAt(field.length-1),secondToLastChar=field.charAt(field.length-2),thirdToLastChar=field.charAt(field.length-3);if(field.length===2&&field=='""')listOfFields[j]="";else if(firstChar=='"'&&(lastChar!='"'||lastChar=='"'&&secondToLastChar=='"'&&thirdToLastChar!='"')){if(j+1===listOfFields.length)return;var nextField=listOfFields[j+1];listOfFields[j]=field_space+this.separator+nextField,listOfFields.splice(j+1,1)}else firstChar=='"'&&lastChar=='"'&&(field=field.slice(1,field.length-1),field=field.replace(doubleQuotes,'"')),listOfFields[j]=field,j+=1}arrayOfOutputRecords.push(listOfFields)}}this._attributes=arrayOfOutputRecords.shift();for(i=0;i<this._attributes.length;i++)this._attributeIndexes[this._attributes[i]]=i;this._dataArray=arrayOfOutputRecords}},_splitLines:function(csvContent){var split=[],i,line="",inQuotes=!1;for(i=0;i<csvContent.length;i++){var c=csvContent.charAt(i);switch(c){case'"':inQuotes=!inQuotes,line+=c;break;case"\r":inQuotes?line+=c:(split.push(line),line="",i<csvContent.length-1&&csvContent.charAt(i+1)=="\n"&&i++);break;case"\n":inQuotes?line+=c:(split.push(line),line="");break;default:line+=c}}return line!==""&&split.push(line),split},_processData:function(data){this._getArrayOfArraysFromCsvFileContents(data),this._arrayOfAllItems=[];if(this.identifier&&this._attributeIndexes[this.identifier]===undefined)throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(var i=0;i<this._dataArray.length;i++){var id=i;if(this.identifier){var iData=this._dataArray[i];id=iData[this._attributeIndexes[this.identifier]],this._idMap[id]=i}this._arrayOfAllItems.push(this._createItemFromIdentity(id))}this._loadFinished=!0,this._loadInProgress=!1},_createItemFromIdentity:function(identity){var item={};return item[this._storeProp]=this,item[this._idProp]=identity,item},getIdentity:function(item){return this.isItem(item)?item[this._idProp]:null},fetchItemByIdentity:function(keywordArgs){var item,scope=keywordArgs.scope?keywordArgs.scope:kernel.global;if(!this._loadFinished){var self=this;if(this.url!=="")if(this._loadInProgress)this._queuedFetches.push({args:keywordArgs});else{this._loadInProgress=!0;var getArgs={url:self.url,handleAs:"text"},getHandler=xhr.get(getArgs);getHandler.addCallback(function(data){try{self._processData(data);var item=self._createItemFromIdentity(keywordArgs.identity);self.isItem(item)||(item=null),keywordArgs.onItem&&keywordArgs.onItem.call(scope,item),self._handleQueuedFetches()}catch(error){keywordArgs.onError&&keywordArgs.onError.call(scope,error)}}),getHandler.addErrback(function(error){this._loadInProgress=!1,keywordArgs.onError&&keywordArgs.onError.call(scope,error)})}else if(this._csvData)try{self._processData(self._csvData),self._csvData=null,item=self._createItemFromIdentity(keywordArgs.identity),self.isItem(item)||(item=null),keywordArgs.onItem&&keywordArgs.onItem.call(scope,item)}catch(e){keywordArgs.onError&&keywordArgs.onError.call(scope,e)}}else item=this._createItemFromIdentity(keywordArgs.identity),this.isItem(item)||(item=null),keywordArgs.onItem&&keywordArgs.onItem.call(scope,item)},getIdentityAttributes:function(item){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var fData=this._queuedFetches[i],delayedFilter=fData.filter,delayedQuery=fData.args;delayedFilter?delayedFilter(delayedQuery,this._arrayOfAllItems):this.fetchItemByIdentity(fData.args)}this._queuedFetches=[]}}});return lang.extend(CsvStore,simpleFetch),CsvStore})