//>>built
define("dojox/data/CdfStore",["dojo","dojox","dojo/data/util/sorter"],function(dojo,dojox){return dojox.data.ASYNC_MODE=0,dojox.data.SYNC_MODE=1,dojo.declare("dojox.data.CdfStore",null,{identity:"jsxid",url:"",xmlStr:"",data:null,label:"",mode:dojox.data.ASYNC_MODE,constructor:function(args){args&&(this.url=args.url,this.xmlStr=args.xmlStr||args.str,args.data&&(this.xmlStr=this._makeXmlString(args.data)),this.identity=args.identity||this.identity,this.label=args.label||this.label,this.mode=args.mode!==undefined?args.mode:this.mode),this._modifiedItems={},this.byId=this.fetchItemByIdentity},getValue:function(item,property,defaultValue){return item.getAttribute(property)||defaultValue},getValues:function(item,property){var v=this.getValue(item,property,[]);return dojo.isArray(v)?v:[v]},getAttributes:function(item){return item.getAttributeNames()},hasAttribute:function(item,property){return this.getValue(item,property)!==undefined},hasProperty:function(item,property){return this.hasAttribute(item,property)},containsValue:function(item,property,value){var values=this.getValues(item,property);for(var i=0;i<values.length;i++){if(values[i]===null)continue;if(typeof value=="string"){if(values[i].toString&&values[i].toString()===value)return!0}else if(values[i]===value)return!0}return!1},isItem:function(something){return something.getClass&&something.getClass().equals(jsx3.xml.Entity.jsxclass)?!0:!1},isItemLoaded:function(something){return this.isItem(something)},loadItem:function(keywordArgs){},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Write":!0,"dojo.data.api.Identity":!0}},getLabel:function(item){if(this.label!==""&&this.isItem(item)){var label=this.getValue(item,this.label);if(label)return label.toString()}return undefined},getLabelAttributes:function(item){return this.label!==""?[this.label]:null},fetch:function(request){request=request||{},request.store||(request.store=this),request.mode!==undefined&&(this.mode=request.mode);var self=this,errorHandler=function(errorData){if(request.onError){var scope=request.scope||dojo.global;request.onError.call(scope,errorData,request)}else 0},fetchHandler=function(items,requestObject){requestObject=requestObject||request;var oldAbortFunction=requestObject.abort||null,aborted=!1,startIndex=requestObject.start?requestObject.start:0,endIndex=requestObject.count&&requestObject.count!==Infinity?startIndex+requestObject.count:items.length;requestObject.abort=function(){aborted=!0,oldAbortFunction&&oldAbortFunction.call(requestObject)};var scope=requestObject.scope||dojo.global;requestObject.store||(requestObject.store=self),requestObject.onBegin&&requestObject.onBegin.call(scope,items.length,requestObject),requestObject.sort&&items.sort(dojo.data.util.sorter.createSortFunction(requestObject.sort,self));if(requestObject.onItem)for(var i=startIndex;i<items.length&&i<endIndex;++i){var item=items[i];aborted||requestObject.onItem.call(scope,item,requestObject)}return requestObject.onComplete&&!aborted?(requestObject.onItem||(items=items.slice(startIndex,endIndex),requestObject.byId&&(items=items[0])),requestObject.onComplete.call(scope,items,requestObject)):(items=items.slice(startIndex,endIndex),requestObject.byId&&(items=items[0])),items};if(!this.url&&!this.data&&!this.xmlStr)return errorHandler(new Error("No URL or data specified.")),!1;var localRequest=request||"*";if(this.mode==dojox.data.SYNC_MODE){var res=this._loadCDF();if(res instanceof Error)return request.onError?request.onError.call(request.scope||dojo.global,res,request):0,res;this.cdfDoc=res;var items=this._getItems(this.cdfDoc,localRequest);return items&&items.length>0?items=fetchHandler(items,request):items=fetchHandler([],request),items}var dfd=this._loadCDF();return dfd.addCallbacks(dojo.hitch(this,function(cdfDoc){var items=this._getItems(this.cdfDoc,localRequest);items&&items.length>0?fetchHandler(items,request):fetchHandler([],request)}),dojo.hitch(this,function(err){errorHandler(err,request)})),dfd},_loadCDF:function(){var dfd=new dojo.Deferred;if(this.cdfDoc)return this.mode==dojox.data.SYNC_MODE?this.cdfDoc:(setTimeout(dojo.hitch(this,function(){dfd.callback(this.cdfDoc)}),0),dfd);this.cdfDoc=jsx3.xml.CDF.Document.newDocument(),this.cdfDoc.subscribe("response",this,function(evt){dfd.callback(this.cdfDoc)}),this.cdfDoc.subscribe("error",this,function(err){dfd.errback(err)}),this.cdfDoc.setAsync(!this.mode);if(this.url)this.cdfDoc.load(this.url);else if(this.xmlStr){this.cdfDoc.loadXML(this.xmlStr);if(this.cdfDoc.getError().code)return new Error(this.cdfDoc.getError().description)}return this.mode==dojox.data.SYNC_MODE?this.cdfDoc:dfd},_getItems:function(cdfDoc,request){var itr=cdfDoc.selectNodes(request.query,!1,1),items=[];while(itr.hasNext())items.push(itr.next());return items},close:function(request){},newItem:function(keywordArgs,parentInfo){keywordArgs=keywordArgs||{},keywordArgs.tagName&&(keywordArgs.tagName!="record"&&0,delete keywordArgs.tagName),keywordArgs.jsxid=keywordArgs.jsxid||this.cdfDoc.getKey(),this.isItem(parentInfo)&&(parentInfo=this.getIdentity(parentInfo));var item=this.cdfDoc.insertRecord(keywordArgs,parentInfo);return this._makeDirty(item),item},deleteItem:function(item){return this.cdfDoc.deleteRecord(this.getIdentity(item)),this._makeDirty(item),!0},setValue:function(item,property,value){return this._makeDirty(item),item.setAttribute(property,value),!0},setValues:function(item,property,values){return this._makeDirty(item),0,item.setAttribute(property,values)},unsetAttribute:function(item,property){return this._makeDirty(item),item.removeAttribute(property),!0},revert:function(){return delete this.cdfDoc,this._modifiedItems={},!0},isDirty:function(item){if(item)return!!this._modifiedItems[this.getIdentity(item)];var _dirty=!1;for(var nm in this._modifiedItems){_dirty=!0;break}return _dirty},_makeDirty:function(item){var id=this.getIdentity(item);this._modifiedItems[id]=item},_makeXmlString:function(obj){var parseObj=function(obj,name){var xmlStr="",nm;if(dojo.isArray(obj))for(var i=0;i<obj.length;i++)xmlStr+=parseObj(obj[i],name);else if(dojo.isObject(obj)){xmlStr+="<"+name+" ";for(nm in obj)dojo.isObject(obj[nm])||(xmlStr+=nm+'="'+obj[nm]+'" ');xmlStr+=">";for(nm in obj)dojo.isObject(obj[nm])&&(xmlStr+=parseObj(obj[nm],nm));xmlStr+="</"+name+">"}return xmlStr};return parseObj(obj,"data")},getIdentity:function(item){return this.getValue(item,this.identity)},getIdentityAttributes:function(item){return[this.identity]},fetchItemByIdentity:function(args){if(dojo.isString(args)){var id=args;args={query:"//record[@jsxid='"+id+"']",mode:dojox.data.SYNC_MODE}}else args&&(args.query="//record[@jsxid='"+args.identity+"']"),args.mode||(args.mode=this.mode);return args.byId=!0,this.fetch(args)},byId:function(args){}}),dojox.data.CdfStore})