//>>built
define("dojox/image/SlideShow",["dojo","dijit","dojox","dojo/require!dojo/string,dojo/fx,dijit/_Widget,dijit/_Templated"],function(dojo,dijit,dojox){dojo.provide("dojox.image.SlideShow"),dojo.require("dojo.string"),dojo.require("dojo.fx"),dojo.require("dijit._Widget"),dojo.require("dijit._Templated"),dojo.declare("dojox.image.SlideShow",[dijit._Widget,dijit._Templated],{imageHeight:375,imageWidth:500,title:"",titleTemplate:'${title} <span class="slideShowCounterText">(${current} of ${total})</span>',noLink:!1,loop:!0,hasNav:!0,images:[],pageSize:20,autoLoad:!0,autoStart:!1,fixedHeight:!1,imageStore:null,linkAttr:"link",imageLargeAttr:"imageUrl",titleAttr:"title",slideshowInterval:3,templateString:dojo.cache("dojox.image","resources/SlideShow.html",'<div dojoAttachPoint="outerNode" class="slideShowWrapper">\n	<div style="position:relative;" dojoAttachPoint="innerWrapper">\n		<div class="slideShowNav" dojoAttachEvent="onclick: _handleClick">\n			<div class="dijitInline slideShowTitle" dojoAttachPoint="titleNode">${title}</div>\n		</div>\n		<div dojoAttachPoint="navNode" class="slideShowCtrl" dojoAttachEvent="onclick: _handleClick">\n			<span dojoAttachPoint="navPrev" class="slideShowCtrlPrev"></span>\n			<span dojoAttachPoint="navPlay" class="slideShowCtrlPlay"></span>\n			<span dojoAttachPoint="navNext" class="slideShowCtrlNext"></span>\n		</div>\n		<div dojoAttachPoint="largeNode" class="slideShowImageWrapper"></div>		\n		<div dojoAttachPoint="hiddenNode" class="slideShowHidden"></div>\n	</div>\n</div>'),_imageCounter:0,_tmpImage:null,_request:null,postCreate:function(){this.inherited(arguments);var img=document.createElement("img");img.setAttribute("width",this.imageWidth),img.setAttribute("height",this.imageHeight),this.hasNav&&(dojo.connect(this.outerNode,"onmouseover",this,function(evt){try{this._showNav()}catch(e){}}),dojo.connect(this.outerNode,"onmouseout",this,function(evt){try{this._hideNav(evt)}catch(e){}})),this.outerNode.style.width=this.imageWidth+"px",img.setAttribute("src",this._blankGif);var _this=this;this.largeNode.appendChild(img),this._tmpImage=this._currentImage=img,this._fitSize(!0),this._loadImage(0,dojo.hitch(this,"showImage",0)),this._calcNavDimensions(),dojo.style(this.navNode,"opacity",0)},setDataStore:function(dataStore,request,paramNames){this.reset();var _this=this;this._request={query:{},start:request.start||0,count:request.count||this.pageSize,onBegin:function(count,request){_this.maxPhotos=count}},request.query&&dojo.mixin(this._request.query,request.query),paramNames&&dojo.forEach(["imageLargeAttr","linkAttr","titleAttr"],function(attrName){paramNames[attrName]&&(this[attrName]=paramNames[attrName])},this);var _complete=function(items){_this.maxPhotos=items.length,_this._request.onComplete=null,_this.autoStart?(_this.imageIndex=-1,_this.toggleSlideShow()):_this.showImage(0)};this.imageStore=dataStore,this._request.onComplete=_complete,this._request.start=0,this.imageStore.fetch(this._request)},reset:function(){dojo.query("> *",this.largeNode).orphan(),this.largeNode.appendChild(this._tmpImage),dojo.query("> *",this.hiddenNode).orphan(),dojo.forEach(this.images,function(img){img&&img.parentNode&&img.parentNode.removeChild(img)}),this.images=[],this.isInitialized=!1,this._imageCounter=0},isImageLoaded:function(index){return this.images&&this.images.length>index&&this.images[index]},moveImageLoadingPointer:function(index){this._imageCounter=index},destroy:function(){this._slideId&&this._stop(),this.inherited(arguments)},showNextImage:function(inTimer,forceLoop){if(inTimer&&this._timerCancelled)return!1;if(this.imageIndex+1>=this.maxPhotos){if(!inTimer||!this.loop&&!forceLoop)return this._slideId&&this._stop(),!1;this.imageIndex=-1}return this.showImage(this.imageIndex+1,dojo.hitch(this,function(){inTimer&&this._startTimer()})),!0},toggleSlideShow:function(){if(this._slideId)this._stop();else{dojo.toggleClass(this.domNode,"slideShowPaused"),this._timerCancelled=!1;var idx=this.imageIndex;if(idx<0||this.images[idx]&&this.images[idx]._img.complete){var success=this.showNextImage(!0,!0);success||this._stop()}else{var handle=dojo.subscribe(this.getShowTopicName(),dojo.hitch(this,function(info){setTimeout(dojo.hitch(this,function(){if(info.index==idx){var success=this.showNextImage(!0,!0);success||this._stop(),dojo.unsubscribe(handle)}}),this.slideshowInterval*1e3)}));dojo.publish(this.getShowTopicName(),[{index:idx,title:"",url:""}])}}},getShowTopicName:function(){return(this.widgetId||this.id)+"/imageShow"},getLoadTopicName:function(){return(this.widgetId?this.widgetId:this.id)+"/imageLoad"},showImage:function(index,callback){!callback&&this._slideId&&this.toggleSlideShow();var _this=this,current=this.largeNode.getElementsByTagName("div");this.imageIndex=index;var showOrLoadIt=function(){if(_this.images[index]){while(_this.largeNode.firstChild)_this.largeNode.removeChild(_this.largeNode.firstChild);dojo.style(_this.images[index],"opacity",0),_this.largeNode.appendChild(_this.images[index]),_this._currentImage=_this.images[index]._img,_this._fitSize();var onEnd=function(a,b,c){var img=_this.images[index].firstChild;img.tagName.toLowerCase()!="img"&&(img=img.firstChild);var title=img.getAttribute("title")||"";_this._navShowing&&_this._showNav(!0),dojo.publish(_this.getShowTopicName(),[{index:index,title:title,url:img.getAttribute("src")}]),callback&&callback(a,b,c),_this._setTitle(title)};dojo.fadeIn({node:_this.images[index],duration:300,onEnd:onEnd}).play()}else _this._loadImage(index,function(){_this.showImage(index,callback)})};current&&current.length>0?dojo.fadeOut({node:current[0],duration:300,onEnd:function(){_this.hiddenNode.appendChild(current[0]),showOrLoadIt()}}).play():showOrLoadIt()},_fitSize:function(force){if(!this.fixedHeight||force){var height=this._currentImage.height+(this.hasNav?20:0);dojo.style(this.innerWrapper,"height",height+"px");return}dojo.style(this.largeNode,"paddingTop",this._getTopPadding()+"px")},_getTopPadding:function(){return this.fixedHeight?(this.imageHeight-this._currentImage.height)/2:0},_loadNextImage:function(){if(!this.autoLoad)return;while(this.images.length>=this._imageCounter&&this.images[this._imageCounter])this._imageCounter++;this._loadImage(this._imageCounter)},_loadImage:function(index,callbackFn){if(this.images[index]||!this._request)return;var pageStart=index-index%(this._request.count||this.pageSize);this._request.start=pageStart,this._request.onComplete=function(items){var diff=index-pageStart;items&&items.length>diff&&loadIt(items[diff])};var _this=this,store=this.imageStore,loadIt=function(item){var url=_this.imageStore.getValue(item,_this.imageLargeAttr),img=new Image,div=dojo.create("div",{id:_this.id+"_imageDiv"+index});div._img=img;var link=_this.imageStore.getValue(item,_this.linkAttr);if(!link||_this.noLink)div.appendChild(img);else{var a=dojo.create("a",{href:link,target:"_blank"},div);a.appendChild(img)}dojo.connect(img,"onload",function(){if(store!=_this.imageStore)return;_this._fitImage(img),dojo.attr(div,{width:_this.imageWidth,height:_this.imageHeight}),dojo.publish(_this.getLoadTopicName(),[index]),setTimeout(function(){_this._loadNextImage()},1),callbackFn&&callbackFn()}),_this.hiddenNode.appendChild(div);var titleDiv=dojo.create("div",{className:"slideShowTitle"},div);_this.images[index]=div,dojo.attr(img,"src",url);var title=_this.imageStore.getValue(item,_this.titleAttr);title&&dojo.attr(img,"title",title)};this.imageStore.fetch(this._request)},_stop:function(){this._slideId&&clearTimeout(this._slideId),this._slideId=null,this._timerCancelled=!0,dojo.removeClass(this.domNode,"slideShowPaused")},_prev:function(){if(this.imageIndex<1)return;this.showImage(this.imageIndex-1)},_next:function(){this.showNextImage()},_startTimer:function(){var id=this.id;this._slideId=setTimeout(function(){dijit.byId(id).showNextImage(!0)},this.slideshowInterval*1e3)},_calcNavDimensions:function(){dojo.style(this.navNode,"position","absolute"),dojo.style(this.navNode,"top","-10000px"),dojo.style(this.navPlay,"marginLeft",0),this.navPlay._size=dojo.marginBox(this.navPlay),this.navPrev._size=dojo.marginBox(this.navPrev),this.navNext._size=dojo.marginBox(this.navNext),dojo.style(this.navNode,{position:"",top:""})},_setTitle:function(title){this.titleNode.innerHTML=dojo.string.substitute(this.titleTemplate,{title:title,current:1+this.imageIndex,total:this.maxPhotos||""})},_fitImage:function(img){var width=img.width,height=img.height;width>this.imageWidth&&(height=Math.floor(height*(this.imageWidth/width)),img.height=height,img.width=width=this.imageWidth),height>this.imageHeight&&(width=Math.floor(width*(this.imageHeight/height)),img.height=this.imageHeight,img.width=width)},_handleClick:function(e){switch(e.target){case this.navNext:this._next();break;case this.navPrev:this._prev();break;case this.navPlay:this.toggleSlideShow()}},_showNav:function(force){if(this._navShowing&&!force)return;this._calcNavDimensions(),dojo.style(this.navNode,"marginTop","0px");var navPlayPos=dojo.style(this.navNode,"width")/2-this.navPlay._size.w/2-this.navPrev._size.w;0,dojo.style(this.navPlay,"marginLeft",navPlayPos+"px");var wrapperSize=dojo.marginBox(this.outerNode),margin=this._currentImage.height-this.navPlay._size.h-10+this._getTopPadding();margin>this._currentImage.height&&(margin+=10),dojo[this.imageIndex<1?"addClass":"removeClass"](this.navPrev,"slideShowCtrlHide"),dojo[this.imageIndex+1>=this.maxPhotos?"addClass":"removeClass"](this.navNext,"slideShowCtrlHide");var _this=this;this._navAnim&&this._navAnim.stop();if(this._navShowing)return;this._navAnim=dojo.fadeIn({node:this.navNode,duration:300,onEnd:function(){_this._navAnim=null}}),this._navAnim.play(),this._navShowing=!0},_hideNav:function(e){if(!e||!this._overElement(this.outerNode,e)){var _this=this;this._navAnim&&this._navAnim.stop(),this._navAnim=dojo.fadeOut({node:this.navNode,duration:300,onEnd:function(){_this._navAnim=null}}),this._navAnim.play(),this._navShowing=!1}},_overElement:function(element,e){if(typeof dojo=="undefined")return!1;element=dojo.byId(element);var m={x:e.pageX,y:e.pageY},bb=dojo.position(element,!0);return m.x>=bb.x&&m.x<=bb.x+bb.w&&m.y>=bb.y&&m.y<=top+bb.h}})})