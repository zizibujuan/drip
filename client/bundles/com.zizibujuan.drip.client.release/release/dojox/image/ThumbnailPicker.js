//>>built
define("dojox/image/ThumbnailPicker",["dojo","dijit","dojox","dojo/require!dojox/fx/scroll,dojo/fx/easing,dojo/fx,dijit/_Widget,dijit/_Templated"],function(dojo,dijit,dojox){dojo.provide("dojox.image.ThumbnailPicker"),dojo.experimental("dojox.image.ThumbnailPicker"),dojo.require("dojox.fx.scroll"),dojo.require("dojo.fx.easing"),dojo.require("dojo.fx"),dojo.require("dijit._Widget"),dojo.require("dijit._Templated"),dojo.declare("dojox.image.ThumbnailPicker",[dijit._Widget,dijit._Templated],{imageStore:null,request:null,size:500,thumbHeight:75,thumbWidth:100,useLoadNotifier:!1,useHyperlink:!1,hyperlinkTarget:"new",isClickable:!0,isScrollable:!0,isHorizontal:!0,autoLoad:!0,linkAttr:"link",imageThumbAttr:"imageUrlThumb",imageLargeAttr:"imageUrl",pageSize:20,titleAttr:"title",templateString:dojo.cache("dojox.image","resources/ThumbnailPicker.html",'<div dojoAttachPoint="outerNode" class="thumbOuter">\n	<div dojoAttachPoint="navPrev" class="thumbNav thumbClickable">\n	  <img src="" dojoAttachPoint="navPrevImg"/>    \n	</div>\n	<div dojoAttachPoint="thumbScroller" class="thumbScroller">\n	  <div dojoAttachPoint="thumbsNode" class="thumbWrapper"></div>\n	</div>\n	<div dojoAttachPoint="navNext" class="thumbNav thumbClickable">\n	  <img src="" dojoAttachPoint="navNextImg"/>  \n	</div>\n</div>'),_thumbs:[],_thumbIndex:0,_maxPhotos:0,_loadedImages:{},baseClass:"ThumbnailPicker",cellClass:"Thumbnail",postCreate:function(){this.inherited(arguments),this.pageSize=Number(this.pageSize),this._scrollerSize=this.size-102;var sizeProp=this._sizeProperty=this.isHorizontal?"width":"height";dojo.style(this.outerNode,"textAlign","center"),dojo.style(this.outerNode,sizeProp,this.size+"px"),dojo.style(this.thumbScroller,sizeProp,this._scrollerSize+"px"),this.useHyperlink&&dojo.subscribe(this.getClickTopicName(),this,function(packet){var index=packet.index,url=this.imageStore.getValue(packet.data,this.linkAttr);if(!url)return;this.hyperlinkTarget=="new"?window.open(url):window.location=url}),this.isClickable&&dojo.addClass(this.thumbsNode,"thumbClickable"),this._totalSize=0,this.init()},init:function(){if(this.isInitialized)return!1;var classExt=this.isHorizontal?"Horiz":"Vert";return dojo.addClass(this.navPrev,"prev"+classExt),dojo.addClass(this.navNext,"next"+classExt),dojo.addClass(this.thumbsNode,"thumb"+classExt),dojo.addClass(this.outerNode,"thumb"+classExt),dojo.attr(this.navNextImg,"src",this._blankGif),dojo.attr(this.navPrevImg,"src",this._blankGif),this.connect(this.navPrev,"onclick","_prev"),this.connect(this.navNext,"onclick","_next"),this.isInitialized=!0,this.isHorizontal?(this._offsetAttr="offsetLeft",this._sizeAttr="offsetWidth",this._scrollAttr="scrollLeft"):(this._offsetAttr="offsetTop",this._sizeAttr="offsetHeight",this._scrollAttr="scrollTop"),this._updateNavControls(),this.imageStore&&this.request&&this._loadNextPage(),!0},getClickTopicName:function(){return this.id+"/select"},getShowTopicName:function(){return this.id+"/show"},setDataStore:function(dataStore,request,paramNames){this.reset(),this.request={query:{},start:request.start||0,count:request.count||10,onBegin:dojo.hitch(this,function(total){this._maxPhotos=total})},request.query&&dojo.mixin(this.request.query,request.query),paramNames&&dojo.forEach(["imageThumbAttr","imageLargeAttr","linkAttr","titleAttr"],function(attrName){paramNames[attrName]&&(this[attrName]=paramNames[attrName])},this),this.request.start=0,this.request.count=this.pageSize,this.imageStore=dataStore,this._loadInProgress=!1,this.init()||this._loadNextPage()},reset:function(){this._loadedImages={},dojo.forEach(this._thumbs,function(img){img&&img.parentNode&&dojo.destroy(img)}),this._thumbs=[],this.isInitialized=!1,this._noImages=!0},isVisible:function(index){var img=this._thumbs[index];if(!img)return!1;var pos=this.isHorizontal?"offsetLeft":"offsetTop",size=this.isHorizontal?"offsetWidth":"offsetHeight",scrollAttr=this.isHorizontal?"scrollLeft":"scrollTop",offset=img[pos]-this.thumbsNode[pos];return offset>=this.thumbScroller[scrollAttr]&&offset+img[size]<=this.thumbScroller[scrollAttr]+this._scrollerSize},resize:function(dim){var sizeParam=this.isHorizontal?"w":"h",total=0;if(this._thumbs.length>0&&dojo.marginBox(this._thumbs[0]).w==0)return;dojo.forEach(this._thumbs,dojo.hitch(this,function(imgContainer){var mb=dojo.marginBox(imgContainer.firstChild),size=mb[sizeParam];total+=Number(size)+10,this.useLoadNotifier&&mb.w>0&&dojo.style(imgContainer.lastChild,"width",mb.w-4+"px"),dojo.style(imgContainer,"width",mb.w+"px")})),dojo.style(this.thumbsNode,this._sizeProperty,total+"px"),this._updateNavControls()},_next:function(){var pos=this.isHorizontal?"offsetLeft":"offsetTop",size=this.isHorizontal?"offsetWidth":"offsetHeight",baseOffset=this.thumbsNode[pos],firstThumb=this._thumbs[this._thumbIndex],origOffset=firstThumb[pos]-baseOffset,index=-1,img;for(var i=this._thumbIndex+1;i<this._thumbs.length;i++){img=this._thumbs[i];if(img[pos]-baseOffset+img[size]-origOffset>this._scrollerSize){this._showThumbs(i);return}}},_prev:function(){if(this.thumbScroller[this.isHorizontal?"scrollLeft":"scrollTop"]==0)return;var pos=this.isHorizontal?"offsetLeft":"offsetTop",size=this.isHorizontal?"offsetWidth":"offsetHeight",firstThumb=this._thumbs[this._thumbIndex],origOffset=firstThumb[pos]-this.thumbsNode[pos],index=-1,img;for(var i=this._thumbIndex-1;i>-1;i--){img=this._thumbs[i];if(origOffset-img[pos]>this._scrollerSize){this._showThumbs(i+1);return}}this._showThumbs(0)},_checkLoad:function(img,index){dojo.publish(this.getShowTopicName(),[{index:index}]),this._updateNavControls(),this._loadingImages={},this._thumbIndex=index,this.thumbsNode.offsetWidth-img.offsetLeft<this._scrollerSize*2&&this._loadNextPage()},_showThumbs:function(index){index=Math.min(Math.max(index,0),this._maxPhotos);if(index>=this._maxPhotos)return;var img=this._thumbs[index];if(!img)return;var left=img.offsetLeft-this.thumbsNode.offsetLeft,top=img.offsetTop-this.thumbsNode.offsetTop,offset=this.isHorizontal?left:top;if(offset>=this.thumbScroller[this._scrollAttr]&&offset+img[this._sizeAttr]<=this.thumbScroller[this._scrollAttr]+this._scrollerSize)return;if(this.isScrollable){var target=this.isHorizontal?{x:left,y:0}:{x:0,y:top};dojox.fx.smoothScroll({target:target,win:this.thumbScroller,duration:300,easing:dojo.fx.easing.easeOut,onEnd:dojo.hitch(this,"_checkLoad",img,index)}).play(10)}else this.isHorizontal?this.thumbScroller.scrollLeft=left:this.thumbScroller.scrollTop=top,this._checkLoad(img,index)},markImageLoaded:function(index){var thumbNotifier=dojo.byId("loadingDiv_"+this.id+"_"+index);thumbNotifier&&this._setThumbClass(thumbNotifier,"thumbLoaded"),this._loadedImages[index]=!0},_setThumbClass:function(thumb,className){if(!this.autoLoad)return;dojo.addClass(thumb,className)},_loadNextPage:function(){if(this._loadInProgress)return;this._loadInProgress=!0;var start=this.request.start+(this._noImages?0:this.pageSize),pos=start;while(pos<this._thumbs.length&&this._thumbs[pos])pos++;var store=this.imageStore,complete=function(items,request){if(store!=this.imageStore)return;if(items&&items.length){var itemCounter=0,loadNext=dojo.hitch(this,function(){if(itemCounter>=items.length){this._loadInProgress=!1;return}var counter=itemCounter++;this._loadImage(items[counter],pos+counter,loadNext)});loadNext(),this._updateNavControls()}else this._loadInProgress=!1},error=function(){this._loadInProgress=!1,0};this.request.onComplete=dojo.hitch(this,complete),this.request.onError=dojo.hitch(this,error),this.request.start=start,this._noImages=!1,this.imageStore.fetch(this.request)},_loadImage:function(data,index,callback){var store=this.imageStore,url=store.getValue(data,this.imageThumbAttr),imgContainer=dojo.create("div",{id:"img_"+this.id+"_"+index,"class":this.cellClass}),img=dojo.create("img",{},imgContainer);img._index=index,img._data=data,this._thumbs[index]=imgContainer;var loadingDiv;this.useLoadNotifier&&(loadingDiv=dojo.create("div",{id:"loadingDiv_"+this.id+"_"+index},imgContainer),this._setThumbClass(loadingDiv,this._loadedImages[index]?"thumbLoaded":"thumbNotifier"));var size=dojo.marginBox(this.thumbsNode),defaultSize,sizeParam;this.isHorizontal?(defaultSize=this.thumbWidth,sizeParam="w"):(defaultSize=this.thumbHeight,sizeParam="h"),size=size[sizeParam];var sl=this.thumbScroller.scrollLeft,st=this.thumbScroller.scrollTop;dojo.style(this.thumbsNode,this._sizeProperty,size+defaultSize+20+"px"),this.thumbScroller.scrollLeft=sl,this.thumbScroller.scrollTop=st,this.thumbsNode.appendChild(imgContainer),dojo.connect(img,"onload",this,dojo.hitch(this,function(){return store!=this.imageStore?!1:(this.resize(),setTimeout(callback,0),!1)})),dojo.connect(img,"onclick",this,function(evt){return dojo.publish(this.getClickTopicName(),[{index:evt.target._index,data:evt.target._data,url:img.getAttribute("src"),largeUrl:this.imageStore.getValue(data,this.imageLargeAttr),title:this.imageStore.getValue(data,this.titleAttr),link:this.imageStore.getValue(data,this.linkAttr)}]),dojo.query("."+this.cellClass,this.thumbsNode).removeClass(this.cellClass+"Selected"),dojo.addClass(evt.target.parentNode,this.cellClass+"Selected"),!1}),dojo.addClass(img,"imageGalleryThumb"),img.setAttribute("src",url);var title=this.imageStore.getValue(data,this.titleAttr);title&&img.setAttribute("title",title),this._updateNavControls()},_updateNavControls:function(){var change=function(node,add){var fn=add?"addClass":"removeClass";dojo[fn](node,"enabled"),dojo[fn](node,"thumbClickable")},pos=this.isHorizontal?"scrollLeft":"scrollTop",size=this.isHorizontal?"offsetWidth":"offsetHeight";change(this.navPrev,this.thumbScroller[pos]>0);var addClass=this.thumbScroller[pos]+this._scrollerSize<this.thumbsNode[size];change(this.navNext,addClass)}})})