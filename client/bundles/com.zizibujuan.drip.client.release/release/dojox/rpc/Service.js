//>>built
define("dojox/rpc/Service",["dojo","dojox","dojo/AdapterRegistry","dojo/_base/url"],function(dojo,dojox){return dojo.declare("dojox.rpc.Service",null,{constructor:function(smd,options){function processSmd(smd){smd._baseUrl=new dojo._Url(dojo.isBrowser?location.href:dojo.config.baseUrl,url||".")+"",self._smd=smd;for(var serviceName in self._smd.services){var pieces=serviceName.split("."),current=self;for(var i=0;i<pieces.length-1;i++)current=current[pieces[i]]||(current[pieces[i]]={});current[pieces[pieces.length-1]]=self._generateService(serviceName,self._smd.services[serviceName])}}var url,self=this;if(smd)if(dojo.isString(smd)||smd instanceof dojo._Url){smd instanceof dojo._Url?url=smd+"":url=smd;var text=dojo._getText(url);if(!text)throw new Error("Unable to load SMD from "+smd);processSmd(dojo.fromJson(text))}else processSmd(smd);this._options=options?options:{},this._requestId=0},_generateService:function(serviceName,method){if(this[method])throw new Error("WARNING: "+serviceName+" already exists for service. Unable to generate function");method.name=serviceName;var func=dojo.hitch(this,"_executeMethod",method),transport=dojox.rpc.transportRegistry.match(method.transport||this._smd.transport);transport.getExecutor&&(func=transport.getExecutor(func,method,this));var schema=method.returns||(method._schema={}),servicePath="/"+serviceName+"/";return schema._service=func,func.servicePath=servicePath,func._schema=schema,func.id=dojox.rpc.Service._nextId++,func},_getRequest:function(method,args){var smd=this._smd,envDef=dojox.rpc.envelopeRegistry.match(method.envelope||smd.envelope||"NONE"),parameters=(method.parameters||[]).concat(smd.parameters||[]);if(envDef.namedParams){if(args.length==1&&dojo.isObject(args[0]))args=args[0];else{var data={};for(var i=0;i<method.parameters.length;i++)if(typeof args[i]!="undefined"||!method.parameters[i].optional)data[method.parameters[i].name]=args[i];args=data}if(method.strictParameters||smd.strictParameters)for(i in args){var found=!1;for(var j=0;j<parameters.length;j++)parameters[i].name==i&&(found=!0);found||delete args[i]}for(i=0;i<parameters.length;i++){var param=parameters[i];if(!param.optional&&param.name&&!args[param.name])if(param["default"])args[param.name]=param["default"];else if(!(param.name in args))throw new Error("Required parameter "+param.name+" was omitted")}}else parameters&&parameters[0]&&parameters[0].name&&args.length==1&&dojo.isObject(args[0])&&(envDef.namedParams===!1?args=dojox.rpc.toOrdered(parameters,args):args=args[0]);dojo.isObject(this._options)&&(args=dojo.mixin(args,this._options));var schema=method._schema||method.returns,request=envDef.serialize.apply(this,[smd,method,args]);request._envDef=envDef;var contentType=method.contentType||smd.contentType||request.contentType;return dojo.mixin(request,{sync:dojox.rpc._sync,contentType:contentType,headers:method.headers||smd.headers||request.headers||{},target:request.target||dojox.rpc.getTarget(smd,method),transport:method.transport||smd.transport||request.transport,envelope:method.envelope||smd.envelope||request.envelope,timeout:method.timeout||smd.timeout,callbackParamName:method.callbackParamName||smd.callbackParamName,rpcObjectParamName:method.rpcObjectParamName||smd.rpcObjectParamName,schema:schema,handleAs:request.handleAs||"auto",preventCache:method.preventCache||smd.preventCache,frameDoc:this._options.frameDoc||undefined})},_executeMethod:function(method){var args=[],i;for(i=1;i<arguments.length;i++)args.push(arguments[i]);var request=this._getRequest(method,args),deferred=dojox.rpc.transportRegistry.match(request.transport).fire(request);return deferred.addBoth(function(results){return request._envDef.deserialize.call(this,results)}),deferred}}),dojox.rpc.getTarget=function(smd,method){var dest=smd._baseUrl;return smd.target&&(dest=new dojo._Url(dest,smd.target)+""),method.target&&(dest=new dojo._Url(dest,method.target)+""),dest},dojox.rpc.toOrdered=function(parameters,args){if(dojo.isArray(args))return args;var data=[];for(var i=0;i<parameters.length;i++)data.push(args[parameters[i].name]);return data},dojox.rpc.transportRegistry=new dojo.AdapterRegistry(!0),dojox.rpc.envelopeRegistry=new dojo.AdapterRegistry(!0),dojox.rpc.envelopeRegistry.register("URL",function(str){return str=="URL"},{serialize:function(smd,method,data){var d=dojo.objectToQuery(data);return{data:d,transport:"POST"}},deserialize:function(results){return results},namedParams:!0}),dojox.rpc.envelopeRegistry.register("JSON",function(str){return str=="JSON"},{serialize:function(smd,method,data){var d=dojo.toJson(data);return{data:d,handleAs:"json",contentType:"application/json"}},deserialize:function(results){return results}}),dojox.rpc.envelopeRegistry.register("PATH",function(str){return str=="PATH"},{serialize:function(smd,method,data){var i,target=dojox.rpc.getTarget(smd,method);if(dojo.isArray(data))for(i=0;i<data.length;i++)target+="/"+data[i];else for(i in data)target+="/"+i+"/"+data[i];return{data:"",target:target}},deserialize:function(results){return results}}),dojox.rpc.transportRegistry.register("POST",function(str){return str=="POST"},{fire:function(r){return r.url=r.target,r.postData=r.data,dojo.rawXhrPost(r)}}),dojox.rpc.transportRegistry.register("GET",function(str){return str=="GET"},{fire:function(r){return r.url=r.target+(r.data?"?"+(r.rpcObjectParamName?r.rpcObjectParamName+"=":"")+r.data:""),dojo.xhrGet(r)}}),dojox.rpc.transportRegistry.register("JSONP",function(str){return str=="JSONP"},{fire:function(r){return r.url=r.target+(r.target.indexOf("?")==-1?"?":"&")+(r.rpcObjectParamName?r.rpcObjectParamName+"=":"")+r.data,r.callbackParamName=r.callbackParamName||"callback",dojo.io.script.get(r)}}),dojox.rpc.Service._nextId=1,dojo._contentHandlers.auto=function(xhr){var handlers=dojo._contentHandlers,retContentType=xhr.getResponseHeader("Content-Type"),results=retContentType?retContentType.match(/\/.*json/)?handlers.json(xhr):retContentType.match(/\/javascript/)?handlers.javascript(xhr):retContentType.match(/\/xml/)?handlers.xml(xhr):handlers.text(xhr):handlers.text(xhr);return results},dojox.rpc.Service})