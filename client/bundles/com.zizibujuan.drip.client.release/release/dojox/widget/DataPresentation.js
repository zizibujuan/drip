//>>built
define("dojox/widget/DataPresentation",["dojo","dijit","dojox","dojo/require!dojox/grid/DataGrid,dojox/charting/Chart2D,dojox/charting/widget/Legend,dojox/charting/action2d/Tooltip,dojox/charting/action2d/Highlight,dojo/colors,dojo/data/ItemFileWriteStore"],function(dojo,dijit,dojox){dojo.provide("dojox.widget.DataPresentation"),dojo.experimental("dojox.widget.DataPresentation"),dojo.require("dojox.grid.DataGrid"),dojo.require("dojox.charting.Chart2D"),dojo.require("dojox.charting.widget.Legend"),dojo.require("dojox.charting.action2d.Tooltip"),dojo.require("dojox.charting.action2d.Highlight"),dojo.require("dojo.colors"),dojo.require("dojo.data.ItemFileWriteStore"),function(){var getLabels=function(range,labelMod,charttype,domNode){var labels=[];labels[0]={value:0,text:""};var nlabels=range.length;if(charttype!=="ClusteredBars"&&charttype!=="StackedBars"){var cwid=domNode.offsetWidth,tmp=(""+range[0]).length*range.length*7;if(labelMod==1)for(var z=1;z<500;++z){if(tmp/z<cwid)break;++labelMod}}for(var i=0;i<nlabels;i++)labels.push({value:i+1,text:!labelMod||i%labelMod?"":range[i]});return labels.push({value:nlabels+1,text:""}),labels},getIndependentAxisArgs=function(charttype,labels){var args={vertical:!1,labels:labels,min:0,max:labels.length-1,majorTickStep:1,minorTickStep:1};if(charttype==="ClusteredBars"||charttype==="StackedBars")args.vertical=!0;if(charttype==="Lines"||charttype==="Areas"||charttype==="StackedAreas")args.min++,args.max--;return args},getDependentAxisArgs=function(charttype,axistype,minval,maxval){var args={vertical:!0,fixLower:"major",fixUpper:"major",natural:!0};axistype==="secondary"&&(args.leftBottom=!1);if(charttype==="ClusteredBars"||charttype==="StackedBars")args.vertical=!1;return minval==maxval&&(args.min=minval-1,args.max=maxval+1),args},getPlotArgs=function(charttype,axistype,animate){var args={type:charttype,hAxis:"independent",vAxis:"dependent-"+axistype,gap:4,lines:!1,areas:!1,markers:!1};if(charttype==="ClusteredBars"||charttype==="StackedBars")args.hAxis=args.vAxis,args.vAxis="independent";if(charttype==="Lines"||charttype==="Hybrid-Lines"||charttype==="Areas"||charttype==="StackedAreas")args.lines=!0;if(charttype==="Areas"||charttype==="StackedAreas")args.areas=!0;return charttype==="Lines"&&(args.markers=!0),charttype==="Hybrid-Lines"&&(args.shadows={dx:2,dy:2,dw:2},args.type="Lines"),charttype==="Hybrid-ClusteredColumns"&&(args.type="ClusteredColumns"),animate&&(args.animate=animate),args},setupChart=function(domNode,chart,type,reverse,animate,labelMod,theme,tooltip,store,query,queryOptions){var _chart=chart;_chart||(domNode.innerHTML="",_chart=new dojox.charting.Chart2D(domNode)),theme&&(theme._clone=function(){var result=new dojox.charting.Theme({chart:this.chart,plotarea:this.plotarea,axis:this.axis,series:this.series,marker:this.marker,antiAlias:this.antiAlias,assignColors:this.assignColors,assignMarkers:this.assigneMarkers,colors:dojo.delegate(this.colors)});return result.markers=this.markers,result._buildMarkerArray(),result},_chart.setTheme(theme));var range=store.series_data[0].slice(0);reverse&&range.reverse();var labels=getLabels(range,labelMod,type,domNode),plots={},maxval=null,minval=null,seriestoremove={};for(var sname in _chart.runs)seriestoremove[sname]=!0;var nseries=store.series_name.length;for(var i=0;i<nseries;i++)if(store.series_chart[i]&&store.series_data[i].length>0){var charttype=type,axistype=store.series_axis[i];charttype=="Hybrid"&&(store.series_charttype[i]=="line"?charttype="Hybrid-Lines":charttype="Hybrid-ClusteredColumns"),plots[axistype]||(plots[axistype]={});if(!plots[axistype][charttype]){var axisname=axistype+"-"+charttype;_chart.addPlot(axisname,getPlotArgs(charttype,axistype,animate));var tooltipArgs={};typeof tooltip=="string"?tooltipArgs.text=function(o){var substitutions=[o.element,o.run.name,range[o.index],charttype==="ClusteredBars"||charttype==="StackedBars"?o.x:o.y];return dojo.replace(tooltip,substitutions)}:typeof tooltip=="function"&&(tooltipArgs.text=tooltip),new dojox.charting.action2d.Tooltip(_chart,axisname,tooltipArgs),charttype!=="Lines"&&charttype!=="Hybrid-Lines"&&new dojox.charting.action2d.Highlight(_chart,axisname),plots[axistype][charttype]=!0}var xvals=[],valen=store.series_data[i].length;for(var j=0;j<valen;j++){var val=store.series_data[i][j];xvals.push(val);if(maxval===null||val>maxval)maxval=val;if(minval===null||val<minval)minval=val}reverse&&xvals.reverse();var seriesargs={plot:axistype+"-"+charttype};store.series_linestyle[i]&&(seriesargs.stroke={style:store.series_linestyle[i]}),_chart.addSeries(store.series_name[i],xvals,seriesargs),delete seriestoremove[store.series_name[i]]}for(sname in seriestoremove)_chart.removeSeries(sname);return _chart.addAxis("independent",getIndependentAxisArgs(type,labels)),_chart.addAxis("dependent-primary",getDependentAxisArgs(type,"primary",minval,maxval)),_chart.addAxis("dependent-secondary",getDependentAxisArgs(type,"secondary",minval,maxval)),_chart},setupLegend=function(domNode,legend,chart,horizontal){var _legend=legend;return _legend?_legend.refresh():_legend=new dojox.charting.widget.Legend({chart:chart,horizontal:horizontal},domNode),_legend},setupGrid=function(domNode,grid,store,query,queryOptions){var _grid=grid||new dojox.grid.DataGrid({},domNode);_grid.startup(),_grid.setStore(store,query,queryOptions);var structure=[];for(var ser=0;ser<store.series_name.length;ser++)store.series_grid[ser]&&store.series_data[ser].length>0&&structure.push({field:"data."+ser,name:store.series_name[ser],width:"auto",formatter:store.series_gridformatter[ser]});return _grid.setStructure(structure),_grid},setupTitle=function(domNode,store){store.title&&(domNode.innerHTML=store.title)},setupFooter=function(domNode,store){store.footer&&(domNode.innerHTML=store.footer)},getSubfield=function(object,field){var result=object;if(field){var fragments=field.split(/[.\[\]]+/);for(var frag=0,l=fragments.length;frag<l;frag++)result&&(result=result[fragments[frag]])}return result};dojo.declare("dojox.widget.DataPresentation",null,{type:"chart",chartType:"clusteredBars",reverse:!1,animate:null,labelMod:1,legendHorizontal:!0,constructor:function(node,args){dojo.mixin(this,args),this.domNode=dojo.byId(node),this[this.type+"Node"]=this.domNode,typeof this.theme=="string"&&(this.theme=dojo.getObject(this.theme)),this.chartNode=dojo.byId(this.chartNode),this.legendNode=dojo.byId(this.legendNode),this.gridNode=dojo.byId(this.gridNode),this.titleNode=dojo.byId(this.titleNode),this.footerNode=dojo.byId(this.footerNode),this.legendVertical&&(this.legendHorizontal=!this.legendVertical),this.url?this.setURL(null,null,this.refreshInterval):this.data?this.setData(null,this.refreshInterval):this.setStore()},setURL:function(url,urlContent,refreshInterval){refreshInterval&&this.cancelRefresh(),this.url=url||this.url,this.urlContent=urlContent||this.urlContent,this.refreshInterval=refreshInterval||this.refreshInterval;var me=this;dojo.xhrGet({url:this.url,content:this.urlContent,handleAs:"json-comment-optional",load:function(response,ioArgs){me.setData(response)},error:function(xhr,ioArgs){me.urlError&&typeof me.urlError=="function"&&me.urlError(xhr,ioArgs)}}),refreshInterval&&this.refreshInterval>0&&(this.refreshIntervalPending=setInterval(function(){me.setURL()},this.refreshInterval))},setData:function(data,refreshInterval){refreshInterval&&this.cancelRefresh(),this.data=data||this.data,this.refreshInterval=refreshInterval||this.refreshInterval;var _series=typeof this.series=="function"?this.series(this.data):this.series,datasets=[],series_data=[],series_name=[],series_chart=[],series_charttype=[],series_linestyle=[],series_axis=[],series_grid=[],series_gridformatter=[],maxlen=0;for(var ser=0;ser<_series.length;ser++)datasets[ser]=getSubfield(this.data,_series[ser].datapoints),datasets[ser]&&datasets[ser].length>maxlen&&(maxlen=datasets[ser].length),series_data[ser]=[],series_name[ser]=_series[ser].name||(_series[ser].namefield?getSubfield(this.data,_series[ser].namefield):null)||"series "+ser,series_chart[ser]=_series[ser].chart!==!1,series_charttype[ser]=_series[ser].charttype||"bar",series_linestyle[ser]=_series[ser].linestyle,series_axis[ser]=_series[ser].axis||"primary",series_grid[ser]=_series[ser].grid!==!1,series_gridformatter[ser]=_series[ser].gridformatter;var point,datapoint,datavalue,fdatavalue,datapoints=[];for(point=0;point<maxlen;point++){datapoint={index:point};for(ser=0;ser<_series.length;ser++)datasets[ser]&&datasets[ser].length>point&&(datavalue=getSubfield(datasets[ser][point],_series[ser].field),series_chart[ser]&&(fdatavalue=parseFloat(datavalue),isNaN(fdatavalue)||(datavalue=fdatavalue)),datapoint["data."+ser]=datavalue,series_data[ser].push(datavalue));datapoints.push(datapoint)}maxlen<=0&&datapoints.push({index:0});var store=new dojo.data.ItemFileWriteStore({data:{identifier:"index",items:datapoints}});this.data.title&&(store.title=this.data.title),this.data.footer&&(store.footer=this.data.footer),store.series_data=series_data,store.series_name=series_name,store.series_chart=series_chart,store.series_charttype=series_charttype,store.series_linestyle=series_linestyle,store.series_axis=series_axis,store.series_grid=series_grid,store.series_gridformatter=series_gridformatter,this.setPreparedStore(store);if(refreshInterval&&this.refreshInterval>0){var me=this;this.refreshIntervalPending=setInterval(function(){me.setData()},this.refreshInterval)}},refresh:function(){this.url?this.setURL(this.url,this.urlContent,this.refreshInterval):this.data&&this.setData(this.data,this.refreshInterval)},cancelRefresh:function(){this.refreshIntervalPending&&(clearInterval(this.refreshIntervalPending),this.refreshIntervalPending=undefined)},setStore:function(store,query,queryOptions){this.setPreparedStore(store,query,queryOptions)},setPreparedStore:function(store,query,queryOptions){this.preparedstore=store||this.store,this.query=query||this.query,this.queryOptions=queryOptions||this.queryOptions,this.preparedstore&&(this.chartNode&&(this.chartWidget=setupChart(this.chartNode,this.chartWidget,this.chartType,this.reverse,this.animate,this.labelMod,this.theme,this.tooltip,this.preparedstore,this.query,this.queryOptions),this.renderChartWidget()),this.legendNode&&(this.legendWidget=setupLegend(this.legendNode,this.legendWidget,this.chartWidget,this.legendHorizontal)),this.gridNode&&(this.gridWidget=setupGrid(this.gridNode,this.gridWidget,this.preparedstore,this.query,this.queryOptions),this.renderGridWidget()),this.titleNode&&setupTitle(this.titleNode,this.preparedstore),this.footerNode&&setupFooter(this.footerNode,this.preparedstore))},renderChartWidget:function(){this.chartWidget&&this.chartWidget.render()},renderGridWidget:function(){this.gridWidget&&this.gridWidget.render()},getChartWidget:function(){return this.chartWidget},getGridWidget:function(){return this.gridWidget},destroy:function(){this.cancelRefresh(),this.chartWidget&&(this.chartWidget.destroy(),delete this.chartWidget),this.legendWidget&&delete this.legendWidget,this.gridWidget&&delete this.gridWidget,this.chartNode&&(this.chartNode.innerHTML=""),this.legendNode&&(this.legendNode.innerHTML=""),this.gridNode&&(this.gridNode.innerHTML=""),this.titleNode&&(this.titleNode.innerHTML=""),this.footerNode&&(this.footerNode.innerHTML="")}})}()})