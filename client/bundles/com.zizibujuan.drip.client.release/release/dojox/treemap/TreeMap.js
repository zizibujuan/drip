//>>built
define("dojox/treemap/TreeMap",["dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/_base/event","dojo/_base/Color","dojo/touch","dojo/when","dojo/on","dojo/query","dojo/dom-construct","dojo/dom-geometry","dojo/dom-class","dojo/dom-style","./_utils","dijit/_WidgetBase","dojox/widget/_Invalidating","dojox/widget/Selection","dojo/_base/sniff","dojo/uacss"],function(arr,lang,declare,event,Color,touch,when,on,query,domConstruct,domGeom,domClass,domStyle,utils,_WidgetBase,_Invalidating,Selection,has){return declare("dojox.treemap.TreeMap",[_WidgetBase,_Invalidating,Selection],{baseClass:"dojoxTreeMap",store:null,query:{},queryOptions:null,itemToRenderer:null,_dataChanged:!1,rootItem:null,_rootItemChanged:!1,tooltipAttr:"",areaAttr:"",_areaChanged:!1,labelAttr:"label",labelThreshold:NaN,colorAttr:"",colorModel:null,_coloringChanged:!1,groupAttrs:[],groupFuncs:null,_groupFuncs:null,_groupingChanged:!1,constructor:function(){this.itemToRenderer={},this.invalidatingProperties=["colorModel","groupAttrs","groupFuncs","areaAttr","areaFunc","labelAttr","labelFunc","labelThreshold","tooltipAttr","tooltipFunc","colorAttr","colorFunc","rootItem"]},getIdentity:function(item){return item.__treeID?item.__treeID:this.store.getIdentity(item)},resize:function(box){box&&(domGeom.setMarginBox(this.domNode,box),this.invalidateRendering())},postCreate:function(){this.inherited(arguments),this.connect(this.domNode,"mouseover",this._onMouseOver),this.connect(this.domNode,"mouseout",this._onMouseOut),this.connect(this.domNode,touch.release,this._onMouseUp),this.domNode.setAttribute("role","presentation"),this.domNode.setAttribute("aria-label","treemap")},buildRendering:function(){this.inherited(arguments),this.refreshRendering()},refreshRendering:function(){var forceCreate=!1;this._dataChanged&&(this._dataChanged=!1,this._groupingChanged=!0,this._coloringChanged=!0),this._groupingChanged&&(this._groupingChanged=!1,this._set("rootItem",null),this._updateTreeMapHierarchy(),forceCreate=!0),this._rootItemChanged&&(this._rootItemChanged=!1,forceCreate=!0),this._coloringChanged&&(this._coloringChanged=!1,this.colorModel!=null&&this._data!=null&&this.colorModel.initialize&&this.colorModel.initialize(this._data,lang.hitch(this,function(item){return this.colorFunc(item,this.store)}))),this._areaChanged&&(this._areaChanged=!1,this._removeAreaForGroup());if(this.domNode==undefined||this._items==null)return;forceCreate&&domConstruct.empty(this.domNode);var rootItem=this.rootItem;rootItem!=null&&this._isLeaf(rootItem)&&(rootItem=this._getRenderer(rootItem).parentItem);var box=domGeom.getMarginBox(this.domNode);rootItem!=null?this._buildRenderer(this.domNode,null,rootItem,{x:box.l,y:box.t,w:box.w,h:box.h},0,forceCreate):this._buildChildrenRenderers(this.domNode,rootItem?rootItem:{__treeRoot:!0,children:this._items},0,forceCreate,box)},_setRootItemAttr:function(value){this._rootItemChanged=!0,this._set("rootItem",value)},_setStoreAttr:function(value){var r;this._observeHandler&&(this._observeHandler.remove(),this._observeHandler=null);if(value!=null){var results=value.query(this.query,this.queryOptions);results.observe&&(this._observeHandler=results.observe(lang.hitch(this,this._updateItem),!0)),r=when(results,lang.hitch(this,this._initItems))}else r=this._initItems([]);return this._set("store",value),r},_initItems:function(items){return this._dataChanged=!0,this._data=items,this.invalidateRendering(),items},_updateItem:function(item,previousIndex,newIndex){previousIndex!=-1?newIndex!=previousIndex?this._data.splice(previousIndex,1):this._data[newIndex]=item:newIndex!=-1&&this._data.splice(newIndex,0,item),this._dataChanged=!0,this.invalidateRendering()},_setGroupAttrsAttr:function(value){this._groupingChanged=!0,this.groupFuncs==null&&(value!=null?this._groupFuncs=arr.map(value,function(attr){return function(item){return item[attr]}}):this._groupFuncs=null),this._set("groupAttrs",value)},_setGroupFuncsAttr:function(value){this._groupingChanged=!0,this._set("groupFuncs",this._groupFuncs=value),value==null&&this.groupAttrs!=null&&(this._groupFuncs=arr.map(this.groupAttrs,function(attr){return function(item){return item[attr]}}))},_setAreaAttrAttr:function(value){this._areaChanged=!0,this._set("areaAttr",value)},areaFunc:function(item,store){return this.areaAttr&&this.areaAttr.length>0?parseFloat(item[this.areaAttr]):1},_setAreaFuncAttr:function(value){this._areaChanged=!0,this._set("areaFunc",value)},labelFunc:function(item,store){var label=this.labelAttr&&this.labelAttr.length>0?item[this.labelAttr]:null;return label?label.toString():null},tooltipFunc:function(item,store){var tooltip=this.tooltipAttr&&this.tooltipAttr.length>0?item[this.tooltipAttr]:null;return tooltip?tooltip.toString():null},_setColorModelAttr:function(value){this._coloringChanged=!0,this._set("colorModel",value)},_setColorAttrAttr:function(value){this._coloringChanged=!0,this._set("colorAttr",value)},colorFunc:function(item,store){var color=this.colorAttr&&this.colorAttr.length>0?item[this.colorAttr]:0;return color==null&&(color=0),parseFloat(color)},_setColorFuncAttr:function(value){this._coloringChanged=!0,this._set("colorFunc",value)},createRenderer:function(item,level,kind){var div=domConstruct.create("div");return kind!="header"&&(domStyle.set(div,"overflow","hidden"),domStyle.set(div,"position","absolute")),div},styleRenderer:function(renderer,item,level,kind){switch(kind){case"leaf":domStyle.set(renderer,"background",this.getColorForItem(item).toHex());case"header":var label=this.getLabelForItem(item);label&&(isNaN(this.labelThreshold)||level<this.labelThreshold)?renderer.innerHTML=label:domConstruct.empty(renderer);break;default:}},_updateTreeMapHierarchy:function(){if(this._data==null)return;this._groupFuncs!=null&&this._groupFuncs.length>0?this._items=utils.group(this._data,this._groupFuncs,lang.hitch(this,this._getAreaForItem)).children:this._items=this._data},_removeAreaForGroup:function(item){var children;if(item!=null){if(!item.__treeValue)return;delete item.__treeValue,children=item.children}else children=this._items;if(children)for(var i=0;i<children.length;++i)this._removeAreaForGroup(children[i])},_getAreaForItem:function(item){var area=this.areaFunc(item,this.store);return isNaN(area)?0:area},_computeAreaForItem:function(item){var value;if(item.__treeID){value=item.__treeValue;if(!value){value=0;var children=item.children;for(var i=0;i<children.length;++i)value+=this._computeAreaForItem(children[i]);item.__treeValue=value}}else value=this._getAreaForItem(item);return value},getColorForItem:function(item){var value=this.colorFunc(item,this.store);return this.colorModel!=null?this.colorModel.getColor(value):new Color(value)},getLabelForItem:function(item){return item.__treeName?item.__treeName:this.labelFunc(item,this.store)},_buildChildrenRenderers:function(domNode,item,level,forceCreate,delta,anim){var children=item.children,box=domGeom.getMarginBox(domNode),solution=utils.solve(children,box.w,box.h,lang.hitch(this,this._computeAreaForItem),!this.isLeftToRight()),rectangles=solution.rectangles;delta&&(rectangles=arr.map(rectangles,function(item){return item.x+=delta.l,item.y+=delta.t,item}));var rectangle;for(var j=0;j<children.length;++j)rectangle=rectangles[j],this._buildRenderer(domNode,item,children[j],rectangle,level,forceCreate,anim)},_isLeaf:function(item){return!item.children},_isRoot:function(item){return item.__treeRoot},_getRenderer:function(item,anim,parent){if(anim)for(var i=0;i<parent.children.length;++i)if(parent.children[i].item==item)return parent.children[i];return this.itemToRenderer[this.getIdentity(item)]},_buildRenderer:function(container,parent,child,rect,level,forceCreate,anim){var isLeaf=this._isLeaf(child),renderer=forceCreate?null:this._getRenderer(child,anim,container);renderer=isLeaf?this._updateLeafRenderer(renderer,child,level):this._updateGroupRenderer(renderer,child,level),forceCreate&&(renderer.level=level,renderer.item=child,renderer.parentItem=parent,this.itemToRenderer[this.getIdentity(child)]=renderer,this.updateRenderers(child));var x=Math.floor(rect.x),y=Math.floor(rect.y),w=Math.floor(rect.x+rect.w+1e-11)-x,h=Math.floor(rect.y+rect.h+1e-11)-y;forceCreate&&domConstruct.place(renderer,container),domGeom.setMarginBox(renderer,{l:x,t:y,w:w,h:h});if(!isLeaf){var box=domGeom.getContentBox(renderer);this._layoutGroupContent(renderer,box.w,box.h,level+1,forceCreate,anim)}this.onRendererUpdated({renderer:renderer,item:child,kind:isLeaf?"leaf":"group",level:level})},_layoutGroupContent:function(renderer,width,height,level,forceCreate,anim){var header=query(".dojoxTreeMapHeader",renderer)[0],content=query(".dojoxTreeMapGroupContent",renderer)[0];if(header==null||content==null)return;var box=domGeom.getMarginBox(header);box.h>height?(box.h=height,domStyle.set(content,"display","none")):(domStyle.set(content,"display","block"),domGeom.setMarginBox(content,{l:0,t:box.h,w:width,h:height-box.h}),this._buildChildrenRenderers(content,renderer.item,level,forceCreate,null,anim)),domGeom.setMarginBox(header,{l:0,t:0,w:width,h:box.h})},_updateGroupRenderer:function(renderer,item,level){var forceCreate=renderer==null;renderer==null&&(renderer=this.createRenderer("div",level,"group"),domClass.add(renderer,"dojoxTreeMapGroup")),this.styleRenderer(renderer,item,level,"group");var header=query(".dojoxTreeMapHeader",renderer)[0];header=this._updateHeaderRenderer(header,item,level),forceCreate&&domConstruct.place(header,renderer);var content=query(".dojoxTreeMapGroupContent",renderer)[0];return content=this._updateGroupContentRenderer(content,item,level),forceCreate&&domConstruct.place(content,renderer),renderer},_updateHeaderRenderer:function(renderer,item,level){return renderer==null&&(renderer=this.createRenderer(item,level,"header"),domClass.add(renderer,"dojoxTreeMapHeader"),domClass.add(renderer,"dojoxTreeMapHeader_"+level)),this.styleRenderer(renderer,item,level,"header"),renderer},_updateLeafRenderer:function(renderer,item,level){renderer==null&&(renderer=this.createRenderer(item,level,"leaf"),domClass.add(renderer,"dojoxTreeMapLeaf"),domClass.add(renderer,"dojoxTreeMapLeaf_"+level)),this.styleRenderer(renderer,item,level,"leaf");var tooltip=this.tooltipFunc(item,this.store);return tooltip&&(renderer.title=tooltip),renderer},_updateGroupContentRenderer:function(renderer,item,level){return renderer==null&&(renderer=this.createRenderer(item,level,"content"),domClass.add(renderer,"dojoxTreeMapGroupContent"),domClass.add(renderer,"dojoxTreeMapGroupContent_"+level)),this.styleRenderer(renderer,item,level,"content"),renderer},_getRendererFromTarget:function(target){var renderer=target;while(renderer!=this.domNode&&!renderer.item)renderer=renderer.parentNode;return renderer},_onMouseOver:function(e){var renderer=this._getRendererFromTarget(e.target);if(renderer.item){var item=renderer.item;this._hoveredItem=item,this.updateRenderers(item),this.onItemRollOver({renderer:renderer,item:item,triggerEvent:e})}},_onMouseOut:function(e){var renderer=this._getRendererFromTarget(e.target);if(renderer.item){var item=renderer.item;this._hoveredItem=null,this.updateRenderers(item),this.onItemRollOut({renderer:renderer,item:item,triggerEvent:e})}},_onMouseUp:function(e){var renderer=this._getRendererFromTarget(e.target);renderer.item&&this.selectFromEvent(e,renderer.item,e.currentTarget,!0)},onRendererUpdated:function(){},onItemRollOver:function(){},onItemRollOut:function(){},updateRenderers:function(items){if(!items)return;lang.isArray(items)||(items=[items]);for(var i=0;i<items.length;i++){var item=items[i],renderer=this._getRenderer(item);if(!renderer)continue;var selected=this.isItemSelected(item),ie=has("ie"),div;if(selected){domClass.add(renderer,"dojoxTreeMapSelected");if(ie&&(has("quirks")||ie<9)){div=renderer.previousSibling;var rStyle=domStyle.get(renderer);if(!div||!domClass.contains(div,"dojoxTreeMapIEHack"))div=this.createRenderer(item,-10,"group"),domClass.add(div,"dojoxTreeMapIEHack"),domClass.add(div,"dojoxTreeMapSelected"),domStyle.set(div,{position:"absolute",overflow:"hidden"}),domConstruct.place(div,renderer,"before");var bWidth=2*parseInt(domStyle.get(div,"border-width"));this._isLeaf(item)?bWidth-=1:bWidth+=1,rStyle["left"]!="auto"&&domStyle.set(div,{left:parseInt(rStyle.left)+1+"px",top:parseInt(rStyle.top)+1+"px",width:parseInt(rStyle.width)-bWidth+"px",height:parseInt(rStyle.height)-bWidth+"px"})}}else ie&&(has("quirks")||ie<9)&&(div=renderer.previousSibling,div&&domClass.contains(div,"dojoxTreeMapIEHack")&&div.parentNode.removeChild(div)),domClass.remove(renderer,"dojoxTreeMapSelected");this._hoveredItem==item?domClass.add(renderer,"dojoxTreeMapHovered"):domClass.remove(renderer,"dojoxTreeMapHovered"),selected||this._hoveredItem==item?domStyle.set(renderer,"zIndex",20):domStyle.set(renderer,"zIndex",has("ie")<=7?0:"auto")}}})})