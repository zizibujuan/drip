//>>built
define("dojox/grid/enhanced/_FocusManager",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/sniff","dojo/_base/html","dojo/keys","dijit/a11y","dijit/focus","../_FocusManager"],function(dojo,lang,declare,array,connect,event,has,html,keys,dijitA11y,dijitFocus,_FocusManager){var _FocusArea=declare("dojox.grid.enhanced._FocusArea",null,{constructor:function(area,focusManager){this._fm=focusManager,this._evtStack=[area.name];var dummy=function(){return!0};area.onFocus=area.onFocus||dummy,area.onBlur=area.onBlur||dummy,area.onMove=area.onMove||dummy,area.onKeyUp=area.onKeyUp||dummy,area.onKeyDown=area.onKeyDown||dummy,lang.mixin(this,area)},move:function(rowStep,colStep,evt){if(this.name){var i,len=this._evtStack.length;for(i=len-1;i>=0;--i)if(this._fm._areas[this._evtStack[i]].onMove(rowStep,colStep,evt)===!1)return!1}return!0},_onKeyEvent:function(evt,funcName){if(this.name){var i,len=this._evtStack.length;for(i=len-1;i>=0;--i)if(this._fm._areas[this._evtStack[i]][funcName](evt,!1)===!1)return!1;for(i=0;i<len;++i)if(this._fm._areas[this._evtStack[i]][funcName](evt,!0)===!1)return!1}return!0},keydown:function(evt){return this._onKeyEvent(evt,"onKeyDown")},keyup:function(evt){return this._onKeyEvent(evt,"onKeyUp")},contentMouseEventPlanner:function(){return 0},headerMouseEventPlanner:function(){return 0}});return declare("dojox.grid.enhanced._FocusManager",_FocusManager,{_stopEvent:function(evt){try{evt&&evt.preventDefault&&event.stop(evt)}catch(e){}},constructor:function(grid){this.grid=grid,this._areas={},this._areaQueue=[],this._contentMouseEventHandlers=[],this._headerMouseEventHandlers=[],this._currentAreaIdx=-1,this._gridBlured=!0,this._connects.push(connect.connect(grid,"onBlur",this,"_doBlur")),this._connects.push(connect.connect(grid.scroller,"renderPage",this,"_delayedCellFocus")),this.addArea({name:"header",onFocus:lang.hitch(this,this.focusHeader),onBlur:lang.hitch(this,this._blurHeader),onMove:lang.hitch(this,this._navHeader),getRegions:lang.hitch(this,this._findHeaderCells),onRegionFocus:lang.hitch(this,this.doColHeaderFocus),onRegionBlur:lang.hitch(this,this.doColHeaderBlur),onKeyDown:lang.hitch(this,this._onHeaderKeyDown)}),this.addArea({name:"content",onFocus:lang.hitch(this,this._focusContent),onBlur:lang.hitch(this,this._blurContent),onMove:lang.hitch(this,this._navContent),onKeyDown:lang.hitch(this,this._onContentKeyDown)}),this.addArea({name:"editableCell",onFocus:lang.hitch(this,this._focusEditableCell),onBlur:lang.hitch(this,this._blurEditableCell),onKeyDown:lang.hitch(this,this._onEditableCellKeyDown),onContentMouseEvent:lang.hitch(this,this._onEditableCellMouseEvent),contentMouseEventPlanner:function(evt,areas){return-1}}),this.placeArea("header"),this.placeArea("content"),this.placeArea("editableCell"),this.placeArea("editableCell","above","content")},destroy:function(){for(var name in this._areas){var area=this._areas[name];array.forEach(area._connects,connect.disconnect),area._connects=null,area.uninitialize&&area.uninitialize()}this.inherited(arguments)},addArea:function(area){area.name&&lang.isString(area.name)&&(this._areas[area.name]&&array.forEach(area._connects,connect.disconnect),this._areas[area.name]=new _FocusArea(area,this),area.onHeaderMouseEvent&&this._headerMouseEventHandlers.push(area.name),area.onContentMouseEvent&&this._contentMouseEventHandlers.push(area.name))},getArea:function(areaName){return this._areas[areaName]},_bindAreaEvents:function(){var area,hdl,areas=this._areas;array.forEach(this._areaQueue,function(name){area=areas[name],!area._initialized&&lang.isFunction(area.initialize)&&(area.initialize(),area._initialized=!0),area.getRegions&&(area._regions=area.getRegions()||[],array.forEach(area._connects||[],connect.disconnect),area._connects=[],array.forEach(area._regions,function(r){area.onRegionFocus&&(hdl=connect.connect(r,"onfocus",area.onRegionFocus),area._connects.push(hdl)),area.onRegionBlur&&(hdl=connect.connect(r,"onblur",area.onRegionBlur),area._connects.push(hdl))}))})},removeArea:function(areaName){var area=this._areas[areaName];if(area){this.ignoreArea(areaName);var i=array.indexOf(this._contentMouseEventHandlers,areaName);i>=0&&this._contentMouseEventHandlers.splice(i,1),i=array.indexOf(this._headerMouseEventHandlers,areaName),i>=0&&this._headerMouseEventHandlers.splice(i,1),array.forEach(area._connects,connect.disconnect),area.uninitialize&&area.uninitialize(),delete this._areas[areaName]}},currentArea:function(areaName,toBlurOld){var idx,cai=this._currentAreaIdx;return lang.isString(areaName)&&(idx=array.indexOf(this._areaQueue,areaName))>=0?(cai!=idx&&(this.tabbingOut=!1,toBlurOld&&cai>=0&&cai<this._areaQueue.length&&this._areas[this._areaQueue[cai]].onBlur(),this._currentAreaIdx=idx),null):cai<0||cai>=this._areaQueue.length?new _FocusArea({},this):this._areas[this._areaQueue[this._currentAreaIdx]]},placeArea:function(name,pos,otherAreaName){if(!this._areas[name])return;var idx=array.indexOf(this._areaQueue,otherAreaName);switch(pos){case"after":idx>=0&&++idx;case"before":if(idx>=0){this._areaQueue.splice(idx,0,name);break};default:this._areaQueue.push(name);break;case"above":var isAbove=!0;case"below":var otherArea=this._areas[otherAreaName];otherArea&&(isAbove?otherArea._evtStack.push(name):otherArea._evtStack.splice(0,0,name))}},ignoreArea:function(name){this._areaQueue=array.filter(this._areaQueue,function(areaName){return areaName!=name})},focusArea:function(areaId,evt){var idx;typeof areaId=="number"?idx=areaId<0?this._areaQueue.length+areaId:areaId:idx=array.indexOf(this._areaQueue,lang.isString(areaId)?areaId:areaId&&areaId.name),idx<0&&(idx=0);var step=idx-this._currentAreaIdx;this._gridBlured=!1,step?this.tab(step,evt):this.currentArea().onFocus(evt,step)},tab:function(step,evt){this._gridBlured=!1,this.tabbingOut=!1;if(step===0)return;var cai=this._currentAreaIdx,dir=step>0?1:-1;if(cai<0||cai>=this._areaQueue.length)cai=this._currentAreaIdx+=step;else{var nextArea=this._areas[this._areaQueue[cai]].onBlur(evt,step);nextArea===!0?cai=this._currentAreaIdx+=step:lang.isString(nextArea)&&this._areas[nextArea]&&(cai=this._currentAreaIdx=array.indexOf(this._areaQueue,nextArea))}for(;cai>=0&&cai<this._areaQueue.length;cai+=dir){this._currentAreaIdx=cai;if(this._areaQueue[cai]&&this._areas[this._areaQueue[cai]].onFocus(evt,step))return}this.tabbingOut=!0,step<0?(this._currentAreaIdx=-1,dijitFocus.focus(this.grid.domNode)):(this._currentAreaIdx=this._areaQueue.length,dijitFocus.focus(this.grid.lastFocusNode))},_onMouseEvent:function(type,evt){var lowercase=type.toLowerCase(),handlers=this["_"+lowercase+"MouseEventHandlers"],res=array.map(handlers,function(areaName){return{area:areaName,idx:this._areas[areaName][lowercase+"MouseEventPlanner"](evt,handlers)}},this).sort(function(a,b){return b.idx-a.idx}),resHandlers=array.map(res,function(handler){return res.area}),i=res.length;while(--i>=0)if(this._areas[res[i].area]["on"+type+"MouseEvent"](evt,resHandlers)===!1)return},contentMouseEvent:function(evt){this._onMouseEvent("Content",evt)},headerMouseEvent:function(evt){this._onMouseEvent("Header",evt)},initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView||this.grid.views.views[0],this._bindAreaEvents()},isNavHeader:function(){return this._areaQueue[this._currentAreaIdx]=="header"},previousKey:function(e){this.tab(-1,e)},nextKey:function(e){this.tab(1,e)},setFocusCell:function(inCell,inRowIndex){inCell&&(this.currentArea(this.grid.edit.isEditing()?"editableCell":"content",!0),this._focusifyCellNode(!1),this.cell=inCell,this.rowIndex=inRowIndex,this._focusifyCellNode(!0)),this.grid.onCellFocus(this.cell,this.rowIndex)},doFocus:function(e){e&&e.target==e.currentTarget&&!this.tabbingOut?this._gridBlured&&(this._gridBlured=!1,this._currentAreaIdx<0||this._currentAreaIdx>=this._areaQueue.length?this.focusArea(0,e):this.focusArea(this._currentAreaIdx,e)):this.tabbingOut=!1,event.stop(e)},_doBlur:function(){this._gridBlured=!0},doLastNodeFocus:function(e){this.tabbingOut?this.tabbingOut=!1:this.focusArea(-1,e)},_delayedHeaderFocus:function(){this.isNavHeader()&&!has("ie")&&this.focusHeader()},_delayedCellFocus:function(){},_changeMenuBindNode:function(oldBindNode,newBindNode){var hm=this.grid.headerMenu;hm&&this._contextMenuBindNode==oldBindNode&&(hm.unBindDomNode(oldBindNode),hm.bindDomNode(newBindNode),this._contextMenuBindNode=newBindNode)},focusHeader:function(evt,step){var didFocus=!1;return this.inherited(arguments),this._colHeadNode&&html.style(this._colHeadNode,"display")!="none"&&(dijitFocus.focus(this._colHeadNode),this._stopEvent(evt),didFocus=!0),didFocus},_blurHeader:function(evt,step){return this._colHeadNode&&html.removeClass(this._colHeadNode,this.focusClass),html.removeAttr(this.grid.domNode,"aria-activedescendant"),this._changeMenuBindNode(this.grid.domNode,this.grid.viewsHeaderNode),this._colHeadNode=this._colHeadFocusIdx=null,!0},_navHeader:function(rowStep,colStep,evt){var colDir=colStep<0?-1:1,savedIdx=array.indexOf(this._findHeaderCells(),this._colHeadNode);if(savedIdx>=0&&evt.shiftKey&&evt.ctrlKey){this.colSizeAdjust(evt,savedIdx,colDir*5);return}this.move(rowStep,colStep)},_onHeaderKeyDown:function(e,isBubble){if(isBubble){var dk=keys;switch(e.keyCode){case dk.ENTER:case dk.SPACE:var colIdx=this.getHeaderIndex();colIdx>=0&&!this.grid.pluginMgr.isFixedCell(e.cell)&&(this.grid.setSortIndex(colIdx,null,e),event.stop(e))}}return!0},_setActiveColHeader:function(){this.inherited(arguments),dijitFocus.focus(this._colHeadNode)},findAndFocusGridCell:function(){this._focusContent()},_focusContent:function(evt,step){var didFocus=!0,isEmpty=this.grid.rowCount===0;if(this.isNoFocusCell()&&!isEmpty){for(var i=0,cell=this.grid.getCell(0);cell&&cell.hidden;cell=this.grid.getCell(++i));this.setFocusIndex(0,cell?i:0)}else this.cell&&!isEmpty?this.focusView&&!this.focusView.rowNodes[this.rowIndex]?(this.grid.scrollToRow(this.rowIndex),this.focusGrid()):this.setFocusIndex(this.rowIndex,this.cell.index):didFocus=!1;return didFocus&&this._stopEvent(evt),didFocus},_blurContent:function(evt,step){return this._focusifyCellNode(!1),!0},_navContent:function(rowStep,colStep,evt){if(this.rowIndex===0&&rowStep<0||this.rowIndex===this.grid.rowCount-1&&rowStep>0)return;this._colHeadNode=null,this.move(rowStep,colStep,evt),evt&&event.stop(evt)},_onContentKeyDown:function(e,isBubble){if(isBubble){var dk=keys,s=this.grid.scroller;switch(e.keyCode){case dk.ENTER:case dk.SPACE:var g=this.grid;if(g.indirectSelection)break;g.selection.clickSelect(this.rowIndex,connect.isCopyKey(e),e.shiftKey),g.onRowClick(e),event.stop(e);break;case dk.PAGE_UP:this.rowIndex!==0&&(this.rowIndex!=s.firstVisibleRow+1?this._navContent(s.firstVisibleRow-this.rowIndex,0):(this.grid.setScrollTop(s.findScrollTop(this.rowIndex-1)),this._navContent(s.firstVisibleRow-s.lastVisibleRow+1,0)),event.stop(e));break;case dk.PAGE_DOWN:this.rowIndex+1!=this.grid.rowCount&&(event.stop(e),this.rowIndex!=s.lastVisibleRow-1?this._navContent(s.lastVisibleRow-this.rowIndex-1,0):(this.grid.setScrollTop(s.findScrollTop(this.rowIndex+1)),this._navContent(s.lastVisibleRow-s.firstVisibleRow-1,0)),event.stop(e))}}return!0},_blurFromEditableCell:!1,_isNavigating:!1,_navElems:null,_focusEditableCell:function(evt,step){var didFocus=!1;if(this._isNavigating)didFocus=!0;else if(this.grid.edit.isEditing()&&this.cell){if(this._blurFromEditableCell||!this._blurEditableCell(evt,step))this.setFocusIndex(this.rowIndex,this.cell.index),didFocus=!0;this._stopEvent(evt)}return didFocus},_applyEditableCell:function(){try{this.grid.edit.apply()}catch(e){0}},_blurEditableCell:function(evt,step){this._blurFromEditableCell=!1;if(this._isNavigating){var toBlur=!0;if(evt){var elems=this._navElems,firstElem=elems.lowest||elems.first,lastElem=elems.last||elems.highest||firstElem,target=has("ie")?evt.srcElement:evt.target;toBlur=target==(step>0?lastElem:firstElem)}return toBlur?(this._isNavigating=!1,html.setSelectable(this.cell.getNode(this.rowIndex),!1),"content"):!1}if(this.grid.edit.isEditing()&&this.cell){if(!step||typeof step!="number")return!1;var dir=step>0?1:-1,cc=this.grid.layout.cellCount;for(var cell,col=this.cell.index+dir;col>=0&&col<cc;col+=dir){cell=this.grid.getCell(col);if(cell.editable)return this.cell=cell,this._blurFromEditableCell=!0,!1}if((this.rowIndex>0||dir==1)&&(this.rowIndex<this.grid.rowCount||dir==-1)){this.rowIndex+=dir;for(col=dir>0?0:cc-1;col>=0&&col<cc;col+=dir){cell=this.grid.getCell(col);if(cell.editable){this.cell=cell;break}}return this._applyEditableCell(),"content"}}return!0},_initNavigatableElems:function(){this._navElems=dijitA11y._getTabNavigable(this.cell.getNode(this.rowIndex))},_onEditableCellKeyDown:function(e,isBubble){var dk=keys,g=this.grid,edit=g.edit,editApplied=!1,toPropagate=!0;switch(e.keyCode){case dk.ENTER:isBubble&&edit.isEditing()&&(this._applyEditableCell(),editApplied=!0,event.stop(e));case dk.SPACE:if(!isBubble&&this._isNavigating){toPropagate=!1;break}if(isBubble){if(!this.cell.editable&&this.cell.navigatable){this._initNavigatableElems();var toFocus=this._navElems.lowest||this._navElems.first;if(toFocus){this._isNavigating=!0,html.setSelectable(this.cell.getNode(this.rowIndex),!0),dijitFocus.focus(toFocus),event.stop(e),this.currentArea("editableCell",!0);break}}!editApplied&&!edit.isEditing()&&!g.pluginMgr.isFixedCell(this.cell)&&edit.setEditCell(this.cell,this.rowIndex),editApplied?this.currentArea("content",!0):this.cell.editable&&g.canEdit()&&this.currentArea("editableCell",!0)}break;case dk.PAGE_UP:case dk.PAGE_DOWN:!isBubble&&edit.isEditing()&&(toPropagate=!1);break;case dk.ESCAPE:isBubble||(edit.cancel(),this.currentArea("content",!0))}return toPropagate},_onEditableCellMouseEvent:function(evt){if(evt.type=="click"){var cell=this.cell||evt.cell;if(cell&&!cell.editable&&cell.navigatable){this._initNavigatableElems();if(this._navElems.lowest||this._navElems.first){var target=has("ie")?evt.srcElement:evt.target;if(target!=cell.getNode(evt.rowIndex))return this._isNavigating=!0,this.focusArea("editableCell",evt),html.setSelectable(cell.getNode(evt.rowIndex),!0),dijitFocus.focus(target),!1}}else if(this.grid.singleClickEdit)return this.currentArea("editableCell"),!1}return!0}})})