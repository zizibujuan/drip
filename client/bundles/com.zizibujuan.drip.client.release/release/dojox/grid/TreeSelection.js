//>>built
define("dojox/grid/TreeSelection",["../main","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/dom-attr","dojo/query","./DataSelection"],function(dojox,declare,array,lang,domAttr,query,DataSelection){return declare("dojox.grid.TreeSelection",DataSelection,{setMode:function(mode){this.selected={},this.sorted_sel=[],this.sorted_ltos={},this.sorted_stol={},DataSelection.prototype.setMode.call(this,mode)},addToSelection:function(inItemOrIndex){if(this.mode=="none")return;var idx=null;typeof inItemOrIndex=="number"||typeof inItemOrIndex=="string"?idx=inItemOrIndex:idx=this.grid.getItemIndex(inItemOrIndex);if(this.selected[idx])this.selectedIndex=idx;else if(this.onCanSelect(idx)!==!1){this.selectedIndex=idx;var rowNodes=query("tr[dojoxTreeGridPath='"+idx+"']",this.grid.domNode);rowNodes.length&&domAttr.set(rowNodes[0],"aria-selected","true"),this._beginUpdate(),this.selected[idx]=!0,this._insertSortedSelection(idx),this.onSelected(idx),this._endUpdate()}},deselect:function(inItemOrIndex){if(this.mode=="none")return;var idx=null;typeof inItemOrIndex=="number"||typeof inItemOrIndex=="string"?idx=inItemOrIndex:idx=this.grid.getItemIndex(inItemOrIndex),this.selectedIndex==idx&&(this.selectedIndex=-1);if(this.selected[idx]){if(this.onCanDeselect(idx)===!1)return;var rowNodes=query("tr[dojoxTreeGridPath='"+idx+"']",this.grid.domNode);rowNodes.length&&domAttr.set(rowNodes[0],"aria-selected","false"),this._beginUpdate(),delete this.selected[idx],this._removeSortedSelection(idx),this.onDeselected(idx),this._endUpdate()}},getSelected:function(){var result=[];for(var i in this.selected)this.selected[i]&&result.push(this.grid.getItem(i));return result},getSelectedCount:function(){var c=0;for(var i in this.selected)this.selected[i]&&c++;return c},_bsearch:function(v){var o=this.sorted_sel,h=o.length-1,l=0,m;while(l<=h){var cmp=this._comparePaths(o[m=l+h>>1],v);if(cmp<0){l=m+1;continue}if(cmp>0){h=m-1;continue}return m}return cmp<0?m-cmp:m},_comparePaths:function(a,b){for(var i=0,l=a.length<b.length?a.length:b.length;i<l;i++){if(a[i]<b[i])return-1;if(a[i]>b[i])return 1}return a.length<b.length?-1:a.length>b.length?1:0},_insertSortedSelection:function(index){index=String(index);var s=this.sorted_sel,sl=this.sorted_ltos,ss=this.sorted_stol,lpath=index.split("/");lpath=array.map(lpath,function(item){return parseInt(item,10)}),sl[lpath]=index,ss[index]=lpath;if(s.length===0){s.push(lpath);return}if(s.length==1){var cmp=this._comparePaths(s[0],lpath);cmp==1?s.unshift(lpath):s.push(lpath);return}var idx=this._bsearch(lpath);this.sorted_sel.splice(idx,0,lpath)},_removeSortedSelection:function(index){index=String(index);var s=this.sorted_sel,sl=this.sorted_ltos,ss=this.sorted_stol;if(s.length===0)return;var lpath=ss[index];if(!lpath)return;var idx=this._bsearch(lpath);idx>-1&&(delete sl[lpath],delete ss[index],s.splice(idx,1))},getFirstSelected:function(){if(!this.sorted_sel.length||this.mode=="none")return-1;var fpath=this.sorted_sel[0];return fpath?(fpath=this.sorted_ltos[fpath],fpath?fpath:-1):-1},getNextSelected:function(inPrev){if(!this.sorted_sel.length||this.mode=="none")return-1;inPrev=String(inPrev);var prevPath=this.sorted_stol[inPrev];if(!prevPath)return-1;var idx=this._bsearch(prevPath),lpath=this.sorted_sel[idx+1];return lpath?this.sorted_ltos[lpath]:-1},_range:function(inFrom,inTo,func){!lang.isString(inFrom)&&inFrom<0&&(inFrom=inTo);var cells=this.grid.layout.cells,store=this.grid.store,grid=this.grid;inFrom=new dojox.grid.TreePath(String(inFrom),grid),inTo=new dojox.grid.TreePath(String(inTo),grid);if(inFrom.compare(inTo)>0){var tmp=inFrom;inFrom=inTo,inTo=tmp}var inFromStr=inFrom._str,inToStr=inTo._str;func(inFromStr);var p=inFrom;while(p=p.next()){if(p._str==inToStr)break;func(p._str)}func(inToStr)}})})