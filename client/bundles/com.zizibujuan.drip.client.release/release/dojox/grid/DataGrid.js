//>>built
define("dojox/grid/DataGrid",["../main","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/sniff","dojo/_base/declare","./_Grid","./DataSelection","dojo/_base/html"],function(dojox,array,lang,json,has,declare,_Grid,DataSelection,html){var DataGrid=declare("dojox.grid.DataGrid",_Grid,{store:null,query:null,queryOptions:null,fetchText:"...",sortFields:null,updateDelay:1,items:null,_store_connects:null,_by_idty:null,_by_idx:null,_cache:null,_pages:null,_pending_requests:null,_bop:-1,_eop:-1,_requests:0,rowCount:0,_isLoaded:!1,_isLoading:!1,keepSelection:!1,postCreate:function(){this._pages=[],this._store_connects=[],this._by_idty={},this._by_idx=[],this._cache=[],this._pending_requests={},this._setStore(this.store),this.inherited(arguments)},destroy:function(){this.selection.destroy(),this.inherited(arguments)},createSelection:function(){this.selection=new DataSelection(this)},get:function(inRowIndex,inItem){if(inItem&&this.field=="_item"&&!this.fields)return inItem;if(inItem&&this.fields){var ret=[],s=this.grid.store;return array.forEach(this.fields,function(f){ret=ret.concat(s.getValues(inItem,f))}),ret}return!inItem&&typeof inRowIndex=="string"?this.inherited(arguments):inItem?this.field?this.field=="_item"?inItem:this.grid.store.getValue(inItem,this.field):this.value:this.defaultValue},_checkUpdateStatus:function(){if(this.updateDelay>0){var iStarted=!1;this._endUpdateDelay&&(clearTimeout(this._endUpdateDelay),delete this._endUpdateDelay,iStarted=!0),this.updating||(this.beginUpdate(),iStarted=!0);if(iStarted){var _this=this;this._endUpdateDelay=setTimeout(function(){delete _this._endUpdateDelay,_this.endUpdate()},this.updateDelay)}}},_onSet:function(item,attribute,oldValue,newValue){this._checkUpdateStatus();var idx=this.getItemIndex(item);idx>-1&&this.updateRow(idx)},_createItem:function(item,index){var idty=this._hasIdentity?this.store.getIdentity(item):json.toJson(this.query)+":idx:"+index+":sort:"+json.toJson(this.getSortProps()),o=this._by_idty[idty]={idty:idty,item:item};return o},_addItem:function(item,index,noUpdate){this._by_idx[index]=this._createItem(item,index),noUpdate||this.updateRow(index)},_onNew:function(item,parentInfo){this._checkUpdateStatus();var rowCount=this.get("rowCount");this._addingItem=!0,this.updateRowCount(rowCount+1),this._addingItem=!1,this._addItem(item,rowCount),this.showMessage()},_onDelete:function(item){this._checkUpdateStatus();var idx=this._getItemIndex(item,!0);if(idx>=0){this._pages=[],this._bop=-1,this._eop=-1;var o=this._by_idx[idx];this._by_idx.splice(idx,1),delete this._by_idty[o.idty],this.updateRowCount(this.get("rowCount")-1),this.get("rowCount")===0&&this.showMessage(this.noDataMessage)}this.selection.isSelected(idx)&&(this.selection.deselect(idx),this.selection.selected.splice(idx,1))},_onRevert:function(){this._refresh()},setStore:function(store,query,queryOptions){if(this._requestsPending(0))return;this._setQuery(query,queryOptions),this._setStore(store),this._refresh(!0)},setQuery:function(query,queryOptions){if(this._requestsPending(0))return;this._setQuery(query,queryOptions),this._refresh(!0)},setItems:function(items){this.items=items,this._setStore(this.store),this._refresh(!0)},_setQuery:function(query,queryOptions){this.query=query,this.queryOptions=queryOptions||this.queryOptions},_setStore:function(store){this.store&&this._store_connects&&array.forEach(this._store_connects,this.disconnect,this),this.store=store;if(this.store){var f=this.store.getFeatures(),h=[];this._canEdit=!!f["dojo.data.api.Write"]&&!!f["dojo.data.api.Identity"],this._hasIdentity=!!f["dojo.data.api.Identity"],!!f["dojo.data.api.Notification"]&&!this.items&&(h.push(this.connect(this.store,"onSet","_onSet")),h.push(this.connect(this.store,"onNew","_onNew")),h.push(this.connect(this.store,"onDelete","_onDelete"))),this._canEdit&&h.push(this.connect(this.store,"revert","_onRevert")),this._store_connects=h}},_onFetchBegin:function(size,req){if(!this.scroller)return;this.rowCount!=size&&(req.isRender?(this.scroller.init(size,this.keepRows,this.rowsPerPage),this.rowCount=size,this._setAutoHeightAttr(this.autoHeight,!0),this._skipRowRenormalize=!0,this.prerender(),this._skipRowRenormalize=!1):this.updateRowCount(size)),size?this.showMessage():(this.views.render(),this._resize(),this.showMessage(this.noDataMessage),this.focus.initFocusView())},_onFetchComplete:function(items,req){if(!this.scroller)return;items&&items.length>0&&(array.forEach(items,function(item,idx){this._addItem(item,req.start+idx,!0)},this),this.updateRows(req.start,items.length),req.isRender?(this.setScrollTop(0),this.postrender()):this._lastScrollTop&&this.setScrollTop(this._lastScrollTop),has("ie")&&html.setSelectable(this.domNode,this.selectable)),delete this._lastScrollTop,this._isLoaded||(this._isLoading=!1,this._isLoaded=!0),this._pending_requests[req.start]=!1},_onFetchError:function(err,req){0,delete this._lastScrollTop,this._isLoaded||(this._isLoading=!1,this._isLoaded=!0,this.showMessage(this.errorMessage)),this._pending_requests[req.start]=!1,this.onFetchError(err,req)},onFetchError:function(err,req){},_fetch:function(start,isRender){start=start||0;if(this.store&&!this._pending_requests[start]){!this._isLoaded&&!this._isLoading&&(this._isLoading=!0,this.showMessage(this.loadingMessage)),this._pending_requests[start]=!0;try{if(this.items){var items=this.items,store=this.store;this.rowsPerPage=items.length;var req={start:start,count:this.rowsPerPage,isRender:isRender};this._onFetchBegin(items.length,req);var waitCount=0;array.forEach(items,function(i){store.isItemLoaded(i)||waitCount++});if(waitCount===0)this._onFetchComplete(items,req);else{var onItem=function(item){waitCount--,waitCount===0&&this._onFetchComplete(items,req)};array.forEach(items,function(i){store.isItemLoaded(i)||store.loadItem({item:i,onItem:onItem,scope:this})},this)}}else this.store.fetch({start:start,count:this.rowsPerPage,query:this.query,sort:this.getSortProps(),queryOptions:this.queryOptions,isRender:isRender,onBegin:lang.hitch(this,"_onFetchBegin"),onComplete:lang.hitch(this,"_onFetchComplete"),onError:lang.hitch(this,"_onFetchError")})}catch(e){this._onFetchError(e,{start:start,count:this.rowsPerPage})}}},_clearData:function(){this.updateRowCount(0),this._by_idty={},this._by_idx=[],this._pages=[],this._bop=this._eop=-1,this._isLoaded=!1,this._isLoading=!1},getItem:function(idx){var data=this._by_idx[idx];return!data||data&&!data.item?(this._preparePage(idx),null):data.item},getItemIndex:function(item){return this._getItemIndex(item,!1)},_getItemIndex:function(item,isDeleted){if(!isDeleted&&!this.store.isItem(item))return-1;var idty=this._hasIdentity?this.store.getIdentity(item):null;for(var i=0,l=this._by_idx.length;i<l;i++){var d=this._by_idx[i];if(d&&(idty&&d.idty==idty||d.item===item))return i}return-1},filter:function(query,reRender){this.query=query,reRender&&this._clearData(),this._fetch()},_getItemAttr:function(idx,attr){var item=this.getItem(idx);return item?this.store.getValue(item,attr):this.fetchText},_render:function(){this.domNode.parentNode&&(this.scroller.init(this.get("rowCount"),this.keepRows,this.rowsPerPage),this.prerender(),this._fetch(0,!0))},_requestsPending:function(inRowIndex){return this._pending_requests[inRowIndex]},_rowToPage:function(inRowIndex){return this.rowsPerPage?Math.floor(inRowIndex/this.rowsPerPage):inRowIndex},_pageToRow:function(inPageIndex){return this.rowsPerPage?this.rowsPerPage*inPageIndex:inPageIndex},_preparePage:function(inRowIndex){if((inRowIndex<this._bop||inRowIndex>=this._eop)&&!this._addingItem){var pageIndex=this._rowToPage(inRowIndex);this._needPage(pageIndex),this._bop=pageIndex*this.rowsPerPage,this._eop=this._bop+(this.rowsPerPage||this.get("rowCount"))}},_needPage:function(inPageIndex){this._pages[inPageIndex]||(this._pages[inPageIndex]=!0,this._requestPage(inPageIndex))},_requestPage:function(inPageIndex){var row=this._pageToRow(inPageIndex),count=Math.min(this.rowsPerPage,this.get("rowCount")-row);count>0&&(this._requests++,this._requestsPending(row)||setTimeout(lang.hitch(this,"_fetch",row,!1),1))},getCellName:function(inCell){return inCell.field},_refresh:function(isRender){this._clearData(),this._fetch(0,isRender)},sort:function(){this.edit.apply(),this._lastScrollTop=this.scrollTop,this._refresh()},canSort:function(){return!this._isLoading},getSortProps:function(){var c=this.getCell(this.getSortIndex());if(!c)return this.sortFields?this.sortFields:null;var desc=c.sortDesc,si=!(this.sortInfo>0);return typeof desc=="undefined"?desc=si:desc=si?!desc:desc,[{attribute:c.field,descending:desc}]},styleRowState:function(inRow){if(this.store&&this.store.getState){var states=this.store.getState(inRow.index),c="";for(var i=0,ss=["inflight","error","inserting"],s;s=ss[i];i++)if(states[s]){c=" dojoxGridRow-"+s;break}inRow.customClasses+=c}},onStyleRow:function(inRow){this.styleRowState(inRow),this.inherited(arguments)},canEdit:function(inCell,inRowIndex){return this._canEdit},_copyAttr:function(idx,attr){var row={},backstop={},src=this.getItem(idx);return this.store.getValue(src,attr)},doStartEdit:function(inCell,inRowIndex){this._cache[inRowIndex]||(this._cache[inRowIndex]=this._copyAttr(inRowIndex,inCell.field)),this.onStartEdit(inCell,inRowIndex)},doApplyCellEdit:function(inValue,inRowIndex,inAttrName){this.store.fetchItemByIdentity({identity:this._by_idx[inRowIndex].idty,onItem:lang.hitch(this,function(item){var oldValue=this.store.getValue(item,inAttrName);if(typeof oldValue=="number")inValue=isNaN(inValue)?inValue:parseFloat(inValue);else if(typeof oldValue=="boolean")inValue=inValue=="true"?!0:inValue=="false"?!1:inValue;else if(oldValue instanceof Date){var asDate=new Date(inValue);inValue=isNaN(asDate.getTime())?inValue:asDate}this.store.setValue(item,inAttrName,inValue),this.onApplyCellEdit(inValue,inRowIndex,inAttrName)})})},doCancelEdit:function(inRowIndex){var cache=this._cache[inRowIndex];cache&&(this.updateRow(inRowIndex),delete this._cache[inRowIndex]),this.onCancelEdit.apply(this,arguments)},doApplyEdit:function(inRowIndex,inDataAttr){var cache=this._cache[inRowIndex];this.onApplyEdit(inRowIndex)},removeSelectedRows:function(){if(this._canEdit){this.edit.apply();var fx=lang.hitch(this,function(items){items.length&&(array.forEach(items,this.store.deleteItem,this.store),this.selection.clear())});this.allItemsSelected?this.store.fetch({query:this.query,queryOptions:this.queryOptions,onComplete:fx}):fx(this.selection.getSelected())}}});return DataGrid.cell_markupFactory=function(cellFunc,node,cellDef){var field=lang.trim(html.attr(node,"field")||"");field&&(cellDef.field=field),cellDef.field=cellDef.field||cellDef.name;var fields=lang.trim(html.attr(node,"fields")||"");fields&&(cellDef.fields=fields.split(",")),cellFunc&&cellFunc(node,cellDef)},DataGrid.markupFactory=function(props,node,ctor,cellFunc){return _Grid.markupFactory(props,node,ctor,lang.partial(DataGrid.cell_markupFactory,cellFunc))},DataGrid})