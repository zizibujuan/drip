//>>built
define("dojox/grid/TreeGrid",["dojo/_base/kernel","../main","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/dom-attr","dojo/dom-class","dojo/query","dojo/keys","dijit/tree/ForestStoreModel","./DataGrid","./_Layout","./_FocusManager","./_RowManager","./_EditManager","./TreeSelection","./cells/tree","./_TreeView"],function(dojo,dojox,declare,array,lang,event,domAttr,domClass,query,keys,ForestStoreModel,DataGrid,_Layout,_FocusManager,_RowManager,_EditManager,TreeSelection,TreeCell){dojo.experimental("dojox.grid.TreeGrid");var _TreeAggregator=declare("dojox.grid._TreeAggregator",null,{cells:[],grid:null,childFields:[],constructor:function(kwArgs){this.cells=kwArgs.cells||[],this.childFields=kwArgs.childFields||[],this.grid=kwArgs.grid,this.store=this.grid.store},_cacheValue:function(cache,id,value){return cache[id]=value,value},clearSubtotalCache:function(){this.store&&delete this.store._cachedAggregates},cnt:function(cell,level,item){var total=0,store=this.store,childFields=this.childFields;if(childFields[level]){var children=store.getValues(item,childFields[level]);cell.index<=level+1?total=children.length:array.forEach(children,function(c){total+=this.getForCell(cell,level+1,c,"cnt")},this)}else total=1;return total},sum:function(cell,level,item){var total=0,store=this.store,childFields=this.childFields;return childFields[level]?array.forEach(store.getValues(item,childFields[level]),function(c){total+=this.getForCell(cell,level+1,c,"sum")},this):total+=store.getValue(item,cell.field),total},value:function(cell,level,item){},getForCell:function(cell,level,item,type){var store=this.store;if(!store||!item||!store.isItem(item))return"";var storeCache=store._cachedAggregates=store._cachedAggregates||{},id=store.getIdentity(item),itemCache=storeCache[id]=storeCache[id]||[];cell.getOpenState||(cell=this.grid.getCell(cell.layoutIndex+level+1));var idx=cell.index,idxCache=itemCache[idx]=itemCache[idx]||{};type=type||(cell.parentCell?cell.parentCell.aggregate:"sum")||"sum";var attr=cell.field;attr==store.getLabelAttributes()[0]&&(type="cnt");var typeCache=idxCache[type]=idxCache[type]||[];if(typeCache[level]!=undefined)return typeCache[level];var field=(cell.parentCell&&cell.parentCell.itemAggregates?cell.parentCell.itemAggregates[cell.idxInParent]:"")||"";return field&&store.hasAttribute(item,field)?this._cacheValue(typeCache,level,store.getValue(item,field)):field?this._cacheValue(typeCache,level,0):this._cacheValue(typeCache,level,this[type](cell,level,item))}}),_TreeLayout=declare("dojox.grid._TreeLayout",_Layout,{_isCollapsable:!1,_getInternalStructure:function(inStructure){var g=this.grid,s=inStructure,cells=s[0].cells[0],tree={type:"dojox.grid._TreeView",cells:[[]]},cFields=[],maxLevels=0,getTreeCells=function(parentCell,level){var children=parentCell.children,cloneTreeCell=function(originalCell,idx){var k,n={};for(k in originalCell)n[k]=originalCell[k];return n=lang.mixin(n,{level:level,idxInParent:level>0?idx:-1,parentCell:level>0?parentCell:null}),n},ret=[];return array.forEach(children,function(c,idx){if("children"in c){cFields.push(c.field);var last=ret[ret.length-1];last.isCollapsable=!0,c.level=level,ret=ret.concat(getTreeCells(c,level+1))}else ret.push(cloneTreeCell(c,idx))}),maxLevels=Math.max(maxLevels,level),ret},tCell={children:cells,itemAggregates:[]};return tree.cells[0]=getTreeCells(tCell,0),g.aggregator=new _TreeAggregator({cells:tree.cells[0],grid:g,childFields:cFields}),g.scroller&&g.defaultOpen&&(g.scroller.defaultRowHeight=g.scroller._origDefaultRowHeight*(2*maxLevels+1)),[tree]},setStructure:function(inStructure){var s=inStructure,g=this.grid;g&&g.treeModel&&!array.every(s,function(i){return"cells"in i})&&(s=arguments[0]=[{cells:[s]}]);if(s.length==1&&s[0].cells.length==1)if(g&&g.treeModel)s[0].type="dojox.grid._TreeView",this._isCollapsable=!0,s[0].cells[0][this.grid.treeModel?this.grid.expandoCell:0].isCollapsable=!0;else{var childCells=array.filter(s[0].cells[0],function(c){return"children"in c});childCells.length===1&&(this._isCollapsable=!0)}this._isCollapsable&&(!g||!g.treeModel)&&(arguments[0]=this._getInternalStructure(s)),this.inherited(arguments)},addCellDef:function(inRowIndex,inCellIndex,inDef){var obj=this.inherited(arguments);return lang.mixin(obj,TreeCell)}}),TreePath=declare("dojox.grid.TreePath",null,{level:0,_str:"",_arr:null,grid:null,store:null,cell:null,item:null,constructor:function(path,grid){lang.isString(path)?(this._str=path,this._arr=array.map(path.split("/"),function(item){return parseInt(item,10)})):lang.isArray(path)?(this._str=path.join("/"),this._arr=path.slice(0)):typeof path=="number"?(this._str=String(path),this._arr=[path]):(this._str=path._str,this._arr=path._arr.slice(0)),this.level=this._arr.length-1,this.grid=grid,this.store=this.grid.store,grid.treeModel?this.cell=grid.layout.cells[grid.expandoCell]:this.cell=grid.layout.cells[this.level]},item:function(){return this._item||(this._item=this.grid.getItem(this._arr)),this._item},compare:function(path){if(lang.isString(path)||lang.isArray(path)){if(this._str==path)return 0;if(path.join&&this._str==path.join("/"))return 0;path=new TreePath(path,this.grid)}else if(path instanceof TreePath&&this._str==path._str)return 0;for(var i=0,l=this._arr.length<path._arr.length?this._arr.length:path._arr.length;i<l;i++){if(this._arr[i]<path._arr[i])return-1;if(this._arr[i]>path._arr[i])return 1}return this._arr.length<path._arr.length?-1:this._arr.length>path._arr.length?1:0},isOpen:function(){return this.cell.openStates&&this.cell.getOpenState(this.item())},previous:function(){var new_path=this._arr.slice(0);if(this._str=="0")return null;var last=new_path.length-1;if(new_path[last]===0)return new_path.pop(),new TreePath(new_path,this.grid);new_path[last]--;var path=new TreePath(new_path,this.grid);return path.lastChild(!0)},next:function(){var new_path=this._arr.slice(0);if(this.isOpen())new_path.push(0);else{new_path[new_path.length-1]++;for(var i=this.level;i>=0;i--){var item=this.grid.getItem(new_path.slice(0,i+1));if(i>0)item||(new_path.pop(),new_path[i-1]++);else if(!item)return null}}return new TreePath(new_path,this.grid)},children:function(alwaysReturn){if(!this.isOpen()&&!alwaysReturn)return null;var items=[],model=this.grid.treeModel;if(model){var item=this.item(),store=model.store;if(!model.mayHaveChildren(item))return null;array.forEach(model.childrenAttrs,function(attr){items=items.concat(store.getValues(item,attr))})}else{items=this.store.getValues(this.item(),this.grid.layout.cells[this.cell.level+1].parentCell.field);if(items.length>1&&this.grid.sortChildItems){var sortProps=this.grid.getSortProps();if(sortProps&&sortProps.length){var attr=sortProps[0].attribute,grid=this.grid;if(attr&&items[0][attr]){var desc=!!sortProps[0].descending;items=items.slice(0),items.sort(function(a,b){return grid._childItemSorter(a,b,attr,desc)})}}}}return items},childPaths:function(){var childItems=this.children();return childItems?array.map(childItems,function(item,index){return new TreePath(this._str+"/"+index,this.grid)},this):[]},parent:function(){return this.level===0?null:new TreePath(this._arr.slice(0,this.level),this.grid)},lastChild:function(traverse){var children=this.children();if(!children||!children.length)return this;var path=new TreePath(this._str+"/"+String(children.length-1),this.grid);return traverse?path.lastChild(!0):path},toString:function(){return this._str}}),_TreeFocusManager=declare("dojox.grid._TreeFocusManager",_FocusManager,{setFocusCell:function(inCell,inRowIndex){inCell&&inCell.getNode(inRowIndex)&&this.inherited(arguments)},isLastFocusCell:function(){if(this.cell&&this.cell.index==this.grid.layout.cellCount-1){var path=new TreePath(this.grid.rowCount-1,this.grid);return path=path.lastChild(!0),this.rowIndex==path._str}return!1},next:function(){if(this.cell){var row=this.rowIndex,col=this.cell.index+1,cc=this.grid.layout.cellCount-1,path=new TreePath(this.rowIndex,this.grid);if(col>cc){var new_path=path.next();new_path?(col=0,path=new_path):col--}if(this.grid.edit.isEditing()){var nextCell=this.grid.getCell(col);if(!this.isLastFocusCell()&&!nextCell.editable){this._focusifyCellNode(!1),this.cell=nextCell,this.rowIndex=path._str,this.next();return}}this.setFocusIndex(path._str,col)}},previous:function(){if(this.cell){var row=this.rowIndex||0,col=(this.cell.index||0)-1,path=new TreePath(row,this.grid);if(col<0){var new_path=path.previous();new_path?(col=this.grid.layout.cellCount-1,path=new_path):col=0}if(this.grid.edit.isEditing()){var prevCell=this.grid.getCell(col);if(!this.isFirstFocusCell()&&!prevCell.editable){this._focusifyCellNode(!1),this.cell=prevCell,this.rowIndex=path._str,this.previous();return}}this.setFocusIndex(path._str,col)}},move:function(inRowDelta,inColDelta){if(this.isNavHeader()){this.inherited(arguments);return}if(!this.cell)return;var sc=this.grid.scroller,r=this.rowIndex,rc=this.grid.rowCount-1,path=new TreePath(this.rowIndex,this.grid);if(inRowDelta){var row;inRowDelta>0?(path=path.next(),row=path._arr[0],row>sc.getLastPageRow(sc.page)&&this.grid.setScrollTop(this.grid.scrollTop+sc.findScrollTop(row)-sc.findScrollTop(r))):inRowDelta<0&&(path=path.previous(),row=path._arr[0],row<=sc.getPageRow(sc.page)&&this.grid.setScrollTop(this.grid.scrollTop-sc.findScrollTop(r)-sc.findScrollTop(row)))}var cc=this.grid.layout.cellCount-1,i=this.cell.index,col=Math.min(cc,Math.max(0,i+inColDelta)),cell=this.grid.getCell(col),colDir=inColDelta<0?-1:1;while(col>=0&&col<cc&&cell&&cell.hidden===!0)col+=colDir,cell=this.grid.getCell(col);if(!cell||cell.hidden===!0)col=i;inRowDelta&&this.grid.updateRow(r),this.setFocusIndex(path._str,col)}}),TreeGrid=declare("dojox.grid.TreeGrid",DataGrid,{defaultOpen:!0,sortChildItems:!1,openAtLevels:[],treeModel:null,expandoCell:0,aggregator:null,_layoutClass:_TreeLayout,createSelection:function(){this.selection=new TreeSelection(this)},_childItemSorter:function(a,b,attribute,descending){var av=this.store.getValue(a,attribute),bv=this.store.getValue(b,attribute);return av!=bv?av<bv==descending?1:-1:0},_onNew:function(item,parentInfo){if(!parentInfo||!parentInfo.item)this.inherited(arguments);else{var idx=this.getItemIndex(parentInfo.item);typeof idx=="string"?this.updateRow(idx.split("/")[0]):idx>-1&&this.updateRow(idx)}},_onSet:function(item,attribute,oldValue,newValue){this._checkUpdateStatus(),this.aggregator&&this.aggregator.clearSubtotalCache();var idx=this.getItemIndex(item);typeof idx=="string"?this.updateRow(idx.split("/")[0]):idx>-1&&this.updateRow(idx)},_onDelete:function(item){this._cleanupExpandoCache(this._getItemIndex(item,!0),this.store.getIdentity(item),item),this.inherited(arguments)},_clearData:function(){this.inherited(arguments),this._by_idty_paths={}},_cleanupExpandoCache:function(index,identity,item){},_addItem:function(item,index,noUpdate,dontUpdateRoot){!dontUpdateRoot&&this.model&&array.indexOf(this.model.root.children,item)==-1&&(this.model.root.children[index]=item),this.inherited(arguments)},getItem:function(idx){var isArray=lang.isArray(idx);lang.isString(idx)&&idx.indexOf("/")&&(idx=idx.split("/"),isArray=!0),isArray&&idx.length==1&&(idx=idx[0],isArray=!1);if(!isArray)return DataGrid.prototype.getItem.call(this,idx);var s=this.store,itm=DataGrid.prototype.getItem.call(this,idx[0]),cf,i,j;if(this.aggregator){cf=this.aggregator.childFields||[];if(cf)for(i=0;i<idx.length-1&&itm;i++)cf[i]?itm=(s.getValues(itm,cf[i])||[])[idx[i+1]]:itm=null}else if(this.treeModel){cf=this.treeModel.childrenAttrs||[];if(cf&&itm)for(i=1,il=idx.length;i<il&&itm;i++)for(j=0,jl=cf.length;j<jl;j++){cf[j]?itm=(s.getValues(itm,cf[j])||[])[idx[i]]:itm=null;if(itm)break}}return itm||null},_getItemIndex:function(item,isDeleted){if(!isDeleted&&!this.store.isItem(item))return-1;var idx=this.inherited(arguments);if(idx==-1){var idty=this.store.getIdentity(item);return this._by_idty_paths[idty]||-1}return idx},postMixInProperties:function(){this.treeModel&&!("defaultOpen"in this.params)&&(this.defaultOpen=!1);var def=this.defaultOpen;this.openAtLevels=array.map(this.openAtLevels,function(l){if(typeof l=="string")switch(l.toLowerCase()){case"true":return!0;case"false":return!1;default:var r=parseInt(l,10);if(isNaN(r))return def;return r}return l}),this._by_idty_paths={},this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this.treeModel&&this._setModel(this.treeModel)},setModel:function(treeModel){this._setModel(treeModel),this._refresh(!0)},_setModel:function(treeModel){if(!(!treeModel||!!ForestStoreModel&&treeModel instanceof ForestStoreModel))throw new Error("dojox.grid.TreeGrid: treeModel must be an instance of dijit.tree.ForestStoreModel");this.treeModel=treeModel,domClass.toggle(this.domNode,"dojoxGridTreeModel",this.treeModel?!0:!1),this._setQuery(treeModel?treeModel.query:null),this._setStore(treeModel?treeModel.store:null)},createScroller:function(){this.inherited(arguments),this.scroller._origDefaultRowHeight=this.scroller.defaultRowHeight},createManagers:function(){this.rows=new _RowManager(this),this.focus=new _TreeFocusManager(this),this.edit=new _EditManager(this)},_setStore:function(store){this.inherited(arguments),this.treeModel&&!this.treeModel.root.children&&(this.treeModel.root.children=[]),this.aggregator&&(this.aggregator.store=store)},getDefaultOpenState:function(cellDef,item){var cf,store=this.store;if(this.treeModel)return this.defaultOpen;if(!cellDef||!store||!store.isItem(item)||!(cf=this.aggregator.childFields[cellDef.level]))return this.defaultOpen;if(this.openAtLevels.length>cellDef.level){var dVal=this.openAtLevels[cellDef.level];if(typeof dVal=="boolean")return dVal;if(typeof dVal=="number")return store.getValues(item,cf).length<=dVal}return this.defaultOpen},onStyleRow:function(row){if(!this.layout._isCollapsable){this.inherited(arguments);return}var base=domAttr.get(row.node,"dojoxTreeGridBaseClasses");base&&(row.customClasses=base);var i=row,tagName=i.node.tagName.toLowerCase();i.customClasses+=(i.odd?" dojoxGridRowOdd":"")+(i.selected&&tagName=="tr"?" dojoxGridRowSelected":"")+(i.over&&tagName=="tr"?" dojoxGridRowOver":""),this.focus.styleRow(i),this.edit.styleRow(i)},styleRowNode:function(inRowIndex,inRowNode){inRowNode&&(inRowNode.tagName.toLowerCase()=="div"&&this.aggregator&&query("tr[dojoxTreeGridPath]",inRowNode).forEach(function(rowNode){this.rows.styleRowNode(domAttr.get(rowNode,"dojoxTreeGridPath"),rowNode)},this),this.rows.styleRowNode(inRowIndex,inRowNode))},onCanSelect:function(inRowIndex){var nodes=query("tr[dojoxTreeGridPath='"+inRowIndex+"']",this.domNode);return nodes.length&&domClass.contains(nodes[0],"dojoxGridSummaryRow")?!1:this.inherited(arguments)},onKeyDown:function(e){if(e.altKey||e.metaKey)return;switch(e.keyCode){case keys.UP_ARROW:!this.edit.isEditing()&&this.focus.rowIndex!="0"&&(event.stop(e),this.focus.move(-1,0));break;case keys.DOWN_ARROW:var currPath=new TreePath(this.focus.rowIndex,this),lastPath=new TreePath(this.rowCount-1,this);lastPath=lastPath.lastChild(!0),!this.edit.isEditing()&&currPath.toString()!=lastPath.toString()&&(event.stop(e),this.focus.move(1,0));break;default:this.inherited(arguments)}},canEdit:function(inCell,inRowIndex){var node=inCell.getNode(inRowIndex);return node&&this._canEdit},doApplyCellEdit:function(inValue,inRowIndex,inAttrName){var item=this.getItem(inRowIndex),oldValue=this.store.getValue(item,inAttrName);if(typeof oldValue=="number")inValue=isNaN(inValue)?inValue:parseFloat(inValue);else if(typeof oldValue=="boolean")inValue=inValue=="true"?!0:inValue=="false"?!1:inValue;else if(oldValue instanceof Date){var asDate=new Date(inValue);inValue=isNaN(asDate.getTime())?inValue:asDate}this.store.setValue(item,inAttrName,inValue),this.onApplyCellEdit(inValue,inRowIndex,inAttrName)}});return TreeGrid.markupFactory=function(props,node,ctor,cellFunc){var widthFromAttr=function(n){var w=domAttr.get(n,"width")||"auto";return w!="auto"&&w.slice(-2)!="em"&&w.slice(-1)!="%"&&(w=parseInt(w,10)+"px"),w},cellsFromMarkup=function(table){var rows;if(table.nodeName.toLowerCase()=="table"&&query("> colgroup",table).length===0&&(rows=query("> thead > tr",table)).length==1){var tr=rows[0];return query("> th",rows[0]).map(function(th){var cell={type:lang.trim(domAttr.get(th,"cellType")||""),field:lang.trim(domAttr.get(th,"field")||"")};cell.type&&(cell.type=lang.getObject(cell.type));var subTable=query("> table",th)[0];return subTable?(cell.name="",cell.children=cellsFromMarkup(subTable),domAttr.has(th,"itemAggregates")?cell.itemAggregates=array.map(domAttr.get(th,"itemAggregates").split(","),function(v){return lang.trim(v)}):cell.itemAggregates=[],domAttr.has(th,"aggregate")&&(cell.aggregate=domAttr.get(th,"aggregate")),cell.type=cell.type||dojox.grid.cells.SubtableCell):(cell.name=lang.trim(domAttr.get(th,"name")||th.innerHTML),domAttr.has(th,"width")&&(cell.width=widthFromAttr(th)),domAttr.has(th,"relWidth")&&(cell.relWidth=window.parseInt(domAttr.get(th,"relWidth"),10)),domAttr.has(th,"hidden")&&(cell.hidden=domAttr.get(th,"hidden")=="true"),cell.field=cell.field||cell.name,DataGrid.cell_markupFactory(cellFunc,th,cell),cell.type=cell.type||dojox.grid.cells.Cell),cell.type&&cell.type.markupFactory&&cell.type.markupFactory(th,cell),cell})}return[]},rows;if(!props.structure){var row=cellsFromMarkup(node);row.length&&(props.structure=[{__span:Infinity,cells:[row]}])}return DataGrid.markupFactory(props,node,ctor,cellFunc)},TreeGrid})