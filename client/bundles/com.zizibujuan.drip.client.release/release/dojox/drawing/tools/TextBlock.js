//>>built
define("dojox/drawing/tools/TextBlock",["dojo","dijit/registry","../util/oo","../manager/_registry","../stencil/Text"],function(dojo,dijit,oo,registry,StencilText){var conEdit;dojo.addOnLoad(function(){conEdit=dojo.byId("conEdit"),conEdit?conEdit.parentNode.removeChild(conEdit):0});var TextBlock=oo.declare(StencilText,function(options){if(options.data){var d=options.data,text=d.text?this.typesetter(d.text):d.text,w=d.width?d.width=="auto"?"auto":Math.max(d.width,this.style.text.minWidth):this.style.text.minWidth,h=this._lineHeight;if(text&&w=="auto"){var o=this.measureText(this.cleanText(text,!1),w);w=o.w,h=o.h}else this._text="";this.points=[{x:d.x,y:d.y},{x:d.x+w,y:d.y},{x:d.x+w,y:d.y+h},{x:d.x,y:d.y+h}],d.showEmpty||text?(this.editMode=!0,dojo.disconnect(this._postRenderCon),this._postRenderCon=null,this.connect(this,"render",this,"onRender",!0),d.showEmpty?(this._text=text||"",this.edit()):text&&d.editMode?(this._text="",this.edit()):text&&this.render(text),setTimeout(dojo.hitch(this,function(){this.editMode=!1}),100)):this.render()}else this.connectMouse(),this._postRenderCon=dojo.connect(this,"render",this,"_onPostRender")},{draws:!0,baseRender:!1,type:"dojox.drawing.tools.TextBlock",_caretStart:0,_caretEnd:0,_blockExec:!1,selectOnExec:!0,showEmpty:!1,onDrag:function(obj){this.parentNode||this.showParent(obj);var s=this._startdrag,e=obj.page;this._box.left=s.x<e.x?s.x:e.x,this._box.top=s.y,this._box.width=(s.x<e.x?e.x-s.x:s.x-e.x)+this.style.text.pad,dojo.style(this.parentNode,this._box.toPx())},onUp:function(obj){if(!this._downOnCanvas)return;this._downOnCanvas=!1;var c=dojo.connect(this,"render",this,function(){dojo.disconnect(c),this.onRender(this)});this.editMode=!0,this.showParent(obj),this.created=!0,this.createTextField(),this.connectTextField()},showParent:function(obj){if(this.parentNode)return;var x=obj.pageX||10,y=obj.pageY||10;this.parentNode=dojo.doc.createElement("div"),this.parentNode.id=this.id;var d=this.style.textMode.create;this._box={left:x,top:y,width:obj.width||1,height:obj.height&&obj.height>8?obj.height:this._lineHeight,border:d.width+"px "+d.style+" "+d.color,position:"absolute",zIndex:500,toPx:function(){var o={};for(var nm in this)o[nm]=typeof this[nm]=="number"&&nm!="zIndex"?this[nm]+"px":this[nm];return o}},dojo.style(this.parentNode,this._box),document.body.appendChild(this.parentNode)},createTextField:function(txt){var d=this.style.textMode.edit;return this._box.border=d.width+"px "+d.style+" "+d.color,this._box.height="auto",this._box.width=Math.max(this._box.width,this.style.text.minWidth*this.mouse.zoom),dojo.style(this.parentNode,this._box.toPx()),this.parentNode.appendChild(conEdit),dojo.style(conEdit,{height:txt?"auto":this._lineHeight+"px",fontSize:this.textSize/this.mouse.zoom+"px",fontFamily:this.style.text.family}),conEdit.innerHTML=txt||"",conEdit},connectTextField:function(){if(this._textConnected)return;var greekPalette=dijit.byId("greekPalette"),greekHelp=greekPalette==undefined?!1:!0;greekHelp&&dojo.mixin(greekPalette,{_pushChangeTo:conEdit,_textBlock:this}),this._textConnected=!0,this._dropMode=!1,this.mouse.setEventMode("TEXT"),this.keys.editMode(!0);var kc1,kc2,kc3,kc4,self=this,_autoSet=!1,exec=function(){if(self._dropMode)return;dojo.forEach([kc1,kc2,kc3,kc4],function(c){dojo.disconnect(c)}),self._textConnected=!1,self.keys.editMode(!1),self.mouse.setEventMode(),self.execText()};kc1=dojo.connect(conEdit,"keyup",this,function(evt){dojo.trim(conEdit.innerHTML)&&!_autoSet?(dojo.style(conEdit,"height","auto"),_autoSet=!0):dojo.trim(conEdit.innerHTML).length<2&&_autoSet&&(dojo.style(conEdit,"height",this._lineHeight+"px"),_autoSet=!1);if(!this._blockExec){if(evt.keyCode==13||evt.keyCode==27)dojo.stopEvent(evt),exec()}else evt.keyCode==dojo.keys.SPACE&&(dojo.stopEvent(evt),greekHelp&&greekPalette.onCancel())}),kc2=dojo.connect(conEdit,"keydown",this,function(evt){(evt.keyCode==13||evt.keyCode==27)&&dojo.stopEvent(evt);if(evt.keyCode==220){if(!greekHelp){0;return}dojo.stopEvent(evt),this.getSelection(conEdit),this.insertText(conEdit,"\\"),this._dropMode=!0,this._blockExec=!0,greekPalette.show({around:this.parentNode,orient:{BL:"TL"}})}if(!this._dropMode)this._blockExec=!1;else switch(evt.keyCode){case dojo.keys.UP_ARROW:case dojo.keys.DOWN_ARROW:case dojo.keys.LEFT_ARROW:case dojo.keys.RIGHT_ARROW:dojo.stopEvent(evt),greekPalette._navigateByArrow(evt);break;case dojo.keys.ENTER:dojo.stopEvent(evt),greekPalette._onCellClick(evt);break;case dojo.keys.BACKSPACE:case dojo.keys.DELETE:dojo.stopEvent(evt),greekPalette.onCancel()}}),kc3=dojo.connect(document,"mouseup",this,function(evt){!this._onAnchor&&evt.target.id!="conEdit"?(dojo.stopEvent(evt),exec()):evt.target.id=="conEdit"&&conEdit.innerHTML==""&&(conEdit.blur(),setTimeout(function(){conEdit.focus()},200))}),this.createAnchors(),kc4=dojo.connect(this.mouse,"setZoom",this,function(evt){exec()}),conEdit.focus(),this.onDown=function(){},this.onDrag=function(){},setTimeout(dojo.hitch(this,function(){conEdit.focus(),this.onUp=function(){!self._onAnchor&&this.parentNode&&(self.disconnectMouse(),exec(),self.onUp=function(){})}}),500)},execText:function(){var d=dojo.marginBox(this.parentNode),w=Math.max(d.w,this.style.text.minWidth),txt=this.cleanText(conEdit.innerHTML,!0);conEdit.innerHTML="",conEdit.blur(),this.destroyAnchors(),txt=this.typesetter(txt);var o=this.measureText(txt,w),sc=this.mouse.scrollOffset(),org=this.mouse.origin,x=this._box.left+sc.left-org.x,y=this._box.top+sc.top-org.y;x*=this.mouse.zoom,y*=this.mouse.zoom,w*=this.mouse.zoom,o.h*=this.mouse.zoom,this.points=[{x:x,y:y},{x:x+w,y:y},{x:x+w,y:y+o.h},{x:x,y:y+o.h}],this.editMode=!1,0,o.text||(this._text="",this._textArray=[]),this.render(o.text),this.onChangeText(this.getText())},edit:function(){this.editMode=!0;var text=this.getText()||"";0;if(this.parentNode||!this.points)return;var d=this.pointsToData(),sc=this.mouse.scrollOffset(),org=this.mouse.origin,obj={pageX:d.x/this.mouse.zoom-sc.left+org.x,pageY:d.y/this.mouse.zoom-sc.top+org.y,width:d.width/this.mouse.zoom,height:d.height/this.mouse.zoom};this.remove(this.shape,this.hit),this.showParent(obj),this.createTextField(text.replace("/n"," ")),this.connectTextField(),text&&this.setSelection(conEdit,"end")},cleanText:function(txt,removeBreaks){var replaceHtmlCodes=function(str){var chars={"&lt;":"<","&gt;":">","&amp;":"&"};for(var nm in chars)str=str.replace(new RegExp(nm,"gi"),chars[nm]);return str};return removeBreaks&&dojo.forEach(["<br>","<br/>","<br />","\\n","\\r"],function(br){txt=txt.replace(new RegExp(br,"gi")," ")}),txt=txt.replace(/&nbsp;/g," "),txt=replaceHtmlCodes(txt),txt=dojo.trim(txt),txt=txt.replace(/\s{2,}/g," "),txt},measureText:function(str,width){var r="(<br\\s*/*>)|(\\n)|(\\r)";this.showParent({width:width||"auto",height:"auto"}),this.createTextField(str);var txt="",el=conEdit;el.innerHTML="X";var h=dojo.marginBox(el).h;el.innerHTML=str;if(!width||(new RegExp(r,"gi")).test(str))txt=str.replace(new RegExp(r,"gi"),"\n"),el.innerHTML=str.replace(new RegExp(r,"gi"),"<br/>");else if(dojo.marginBox(el).h==h)txt=str;else{var ar=str.split(" "),strAr=[[]],line=0;el.innerHTML="";while(ar.length){var word=ar.shift();el.innerHTML+=word+" ",dojo.marginBox(el).h>h&&(line++,strAr[line]=[],el.innerHTML=word+" "),strAr[line].push(word)}dojo.forEach(strAr,function(ar,i){strAr[i]=ar.join(" ")}),txt=strAr.join("\n"),el.innerHTML=txt.replace("\n","<br/>")}var dim=dojo.marginBox(el);return conEdit.parentNode.removeChild(conEdit),dojo.destroy(this.parentNode),this.parentNode=null,{h:dim.h,w:dim.w,text:txt}},_downOnCanvas:!1,onDown:function(obj){this._startdrag={x:obj.pageX,y:obj.pageY},dojo.disconnect(this._postRenderCon),this._postRenderCon=null,this._downOnCanvas=!0},createAnchors:function(){this._anchors={};var self=this,d=this.style.anchors,b=d.width,w=d.size-b*2,h=d.size-b*2,p=d.size/2*-1+"px",s={position:"absolute",width:w+"px",height:h+"px",backgroundColor:d.fill,border:b+"px "+d.style+" "+d.color};dojo.isIE&&(s.paddingLeft=w+"px",s.fontSize=w+"px");var ss=[{top:p,left:p},{top:p,right:p},{bottom:p,right:p},{bottom:p,left:p}];for(var i=0;i<4;i++){var isLeft=i==0||i==3,id=this.util.uid(isLeft?"left_anchor":"right_anchor"),a=dojo.create("div",{id:id},this.parentNode);dojo.style(a,dojo.mixin(dojo.clone(s),ss[i]));var md,mm,mu,md=dojo.connect(a,"mousedown",this,function(evt){isLeft=evt.target.id.indexOf("left")>-1,self._onAnchor=!0;var orgX=evt.pageX,orgW=this._box.width;dojo.stopEvent(evt),mm=dojo.connect(document,"mousemove",this,function(evt){var x=evt.pageX;isLeft?(this._box.left=x,this._box.width=orgW+orgX-x):this._box.width=x+orgW-orgX,dojo.style(this.parentNode,this._box.toPx())}),mu=dojo.connect(document,"mouseup",this,function(evt){orgX=this._box.left,orgW=this._box.width,dojo.disconnect(mm),dojo.disconnect(mu),self._onAnchor=!1,conEdit.focus(),dojo.stopEvent(evt)})});this._anchors[id]={a:a,cons:[md]}}},destroyAnchors:function(){for(var n in this._anchors)dojo.forEach(this._anchors[n].con,dojo.disconnect,dojo),dojo.destroy(this._anchors[n].a)},setSavedCaret:function(val){this._caretStart=this._caretEnd=val},getSavedCaret:function(){return{start:this._caretStart,end:this._caretEnd}},insertText:function(node,val){var t,text=node.innerHTML,caret=this.getSavedCaret();text=text.replace(/&nbsp;/g," "),t=text.substr(0,caret.start)+val+text.substr(caret.end),t=this.cleanText(t,!0),this.setSavedCaret(Math.min(t.length,caret.end+val.length)),node.innerHTML=t,this.setSelection(node,"stored")},getSelection:function(node){var start,end;if(dojo.doc.selection){var r=dojo.doc.selection.createRange(),rs=dojo.body().createTextRange();rs.moveToElementText(node);var re=rs.duplicate();rs.moveToBookmark(r.getBookmark()),re.setEndPoint("EndToStart",rs),start=this._caretStart=re.text.length,end=this._caretEnd=re.text.length+r.text.length,0}else this._caretStart=dojo.global.getSelection().getRangeAt(node).startOffset,this._caretEnd=dojo.global.getSelection().getRangeAt(node).endOffset,0},setSelection:function(node,what){0;if(dojo.doc.selection){var rs=dojo.body().createTextRange();rs.moveToElementText(node);switch(what){case"end":rs.collapse(!1);break;case"beg":rs.collapse();break;case"all":rs.collapse(),rs.moveStart("character",0),rs.moveEnd("character",node.text.length);break;case"stored":rs.collapse();var dif=this._caretStart-this._caretEnd;rs.moveStart("character",this._caretStart),rs.moveEnd("character",dif)}rs.select()}else{var getAllChildren=function(node,children){children=children||[];for(var i=0;i<node.childNodes.length;i++){var n=node.childNodes[i];n.nodeType==3?children.push(n):n.tagName&&n.tagName.toLowerCase()=="img"&&children.push(n),n.childNodes&&n.childNodes.length&&getAllChildren(n,children)}return children};0,node.focus();var selection=dojo.global.getSelection();selection.removeAllRanges();var r=dojo.doc.createRange(),nodes=getAllChildren(node);switch(what){case"end":0,r.setStart(nodes[nodes.length-1],nodes[nodes.length-1].textContent.length),r.setEnd(nodes[nodes.length-1],nodes[nodes.length-1].textContent.length);break;case"beg":r.setStart(nodes[0],0),r.setEnd(nodes[0],0);break;case"all":r.setStart(nodes[0],0),r.setEnd(nodes[nodes.length-1],nodes[nodes.length-1].textContent.length);break;case"stored":0,r.setStart(nodes[0],this._caretStart),r.setEnd(nodes[0],this._caretEnd)}selection.addRange(r),0}}});return dojo.setObject("dojox.drawing.tools.TextBlock",TextBlock),TextBlock.setup={name:"dojox.drawing.tools.TextBlock",tooltip:"Text Tool",iconClass:"iconText"},registry.register(TextBlock.setup,"tool"),TextBlock})