//>>built
define("dojox/xmpp/ChatService",["dojo","dijit","dojox"],function(dojo,dijit,dojox){dojo.provide("dojox.xmpp.ChatService"),dojox.xmpp.chat={CHAT_STATE_NS:"http://jabber.org/protocol/chatstates",ACTIVE_STATE:"active",COMPOSING_STATE:"composing",INACTIVE_STATE:"inactive",PAUSED_STATE:"paused",GONE_STATE:"gone"},dojo.declare("dojox.xmpp.ChatService",null,{state:"",constructor:function(){this.state="",this.chatid=Math.round(Math.random()*1e15)},recieveMessage:function(msg,initial){msg&&!initial&&this.onNewMessage(msg)},setSession:function(session){this.session=session},setState:function(state){this.state!=state&&(this.state=state)},invite:function(contact){if(this.uid)return;if(!contact||contact=="")throw new Error("ChatService::invite() contact is NULL");this.uid=contact;var req={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},request=new dojox.string.Builder(dojox.xmpp.util.createElement("message",req,!1));request.append(dojox.xmpp.util.createElement("thread",{},!1)),request.append(this.chatid),request.append("</thread>"),request.append(dojox.xmpp.util.createElement("active",{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0)),request.append("</message>"),this.session.dispatchPacket(request.toString()),this.onInvite(contact),this.setState(dojox.xmpp.chat.CHAT_STATE_NS)},sendMessage:function(msg){if(!this.uid)return;if((!msg.body||msg.body=="")&&!msg.xhtml)return;var req={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},message=new dojox.string.Builder(dojox.xmpp.util.createElement("message",req,!1)),html=dojox.xmpp.util.createElement("html",{xmlns:dojox.xmpp.xmpp.XHTML_IM_NS},!1),bodyTag=dojox.xmpp.util.createElement("body",{"xml:lang":this.session.lang,xmlns:dojox.xmpp.xmpp.XHTML_BODY_NS},!1)+msg.body+"</body>",bodyPlainTag=dojox.xmpp.util.createElement("body",{},!1)+dojox.xmpp.util.stripHtml(msg.body)+"</body>";message.subject&&message.subject!=""&&(message.append(dojox.xmpp.util.createElement("subject",{},!1)),message.append(message.subject),message.append("</subject>")),message.append(bodyPlainTag),message.append(html),message.append(bodyTag),message.append("</html>"),message.append(dojox.xmpp.util.createElement("thread",{},!1)),message.append(this.chatid),message.append("</thread>"),this.useChatStates&&message.append(dojox.xmpp.util.createElement("active",{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0)),message.append("</message>"),this.session.dispatchPacket(message.toString())},sendChatState:function(state){if(!this.useChatState||this.firstMessage)return;if(state==this._currentState)return;var req={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},request=new dojox.string.Builder(dojox.xmpp.util.createElement("message",req,!1));request.append(dojox.xmpp.util.createElement(state,{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0)),this._currentState=state,request.append("<thread>"),request.append(this.chatid),request.append("</thread></message>"),this.session.dispatchPacket(request.toString())},onNewMessage:function(msg){},onInvite:function(contact){}})})