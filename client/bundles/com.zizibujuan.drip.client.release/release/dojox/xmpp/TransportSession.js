//>>built
define("dojox/xmpp/TransportSession",["dojo","dijit","dojox","dojo/require!dojox/xmpp/bosh,dojox/xmpp/util,dojox/data/dom"],function(dojo,dijit,dojox){dojo.provide("dojox.xmpp.TransportSession"),dojo.require("dojox.xmpp.bosh"),dojo.require("dojox.xmpp.util"),dojo.require("dojox.data.dom"),dojox.xmpp.TransportSession=function(props){this.sendTimeout=(this.wait+20)*1e3,props&&dojo.isObject(props)&&(dojo.mixin(this,props),this.useScriptSrcTransport&&(this.transportIframes=[]))},dojo.extend(dojox.xmpp.TransportSession,{rid:0,hold:1,polling:1e3,secure:!1,wait:60,lang:"en",submitContentType:"text/xml; charset=utf=8",serviceUrl:"/httpbind",defaultResource:"dojoIm",domain:"imserver.com",sendTimeout:0,useScriptSrcTransport:!1,keepAliveTimer:null,state:"NotReady",transmitState:"Idle",protocolPacketQueue:[],outboundQueue:[],outboundRequests:{},inboundQueue:[],deferredRequests:{},matchTypeIdAttribute:{},open:function(){this.status="notReady",this.rid=Math.round(Math.random()*1e9),this.protocolPacketQueue=[],this.outboundQueue=[],this.outboundRequests={},this.inboundQueue=[],this.deferredRequests={},this.matchTypeIdAttribute={},this.keepAliveTimer=setTimeout(dojo.hitch(this,"_keepAlive"),1e4),this.useScriptSrcTransport?dojox.xmpp.bosh.initialize({iframes:this.hold+1,load:dojo.hitch(this,function(){this._sendLogin()})}):this._sendLogin()},_sendLogin:function(){var rid=this.rid++,req={content:this.submitContentType,hold:this.hold,rid:rid,to:this.domain,secure:this.secure,wait:this.wait,"xml:lang":this.lang,"xmpp:version":"1.0",xmlns:dojox.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},msg=dojox.xmpp.util.createElement("body",req,!0);this.addToOutboundQueue(msg,rid)},_sendRestart:function(){var rid=this.rid++,req={rid:rid,sid:this.sid,to:this.domain,"xmpp:restart":"true","xml:lang":this.lang,xmlns:dojox.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},msg=dojox.xmpp.util.createElement("body",req,!0);this.addToOutboundQueue(msg,rid)},processScriptSrc:function(msg,rid){var msgDom=dojox.xml.parser.parse(msg,"text/xml");msgDom&&this.processDocument(msgDom,rid)},_keepAlive:function(){if(this.state=="wait"||this.isTerminated())return;this._dispatchPacket(),this.keepAliveTimer=setTimeout(dojo.hitch(this,"_keepAlive"),1e4)},close:function(protocolMsg){var rid=this.rid++,req={sid:this.sid,rid:rid,type:"terminate"},envelope=null;protocolMsg?(envelope=new dojox.string.Builder(dojox.xmpp.util.createElement("body",req,!1)),envelope.append(protocolMsg),envelope.append("</body>")):envelope=new dojox.string.Builder(dojox.xmpp.util.createElement("body",req,!1)),this.addToOutboundQueue(envelope.toString(),rid),this.state=="Terminate"},dispatchPacket:function(msg,protocolMatchType,matchId,matchProperty){msg&&this.protocolPacketQueue.push(msg);var def=new dojo.Deferred;return protocolMatchType&&matchId&&(def.protocolMatchType=protocolMatchType,def.matchId=matchId,def.matchProperty=matchProperty||"id",def.matchProperty!="id"&&(this.matchTypeIdAttribute[protocolMatchType]=def.matchProperty)),this.deferredRequests[def.protocolMatchType+"-"+def.matchId]=def,this.dispatchTimer||(this.dispatchTimer=setTimeout(dojo.hitch(this,"_dispatchPacket"),600)),def},_dispatchPacket:function(){clearTimeout(this.dispatchTimer),delete this.dispatchTimer;if(!this.sid){0;return}if(!this.authId){0;return}if(this.transmitState!="error"&&this.protocolPacketQueue.length==0&&this.outboundQueue.length>0)return;if(this.state=="wait"||this.isTerminated())return;var req={sid:this.sid,xmlns:dojox.xmpp.xmpp.BODY_NS},envelope;if(this.protocolPacketQueue.length>0)req.rid=this.rid++,envelope=new dojox.string.Builder(dojox.xmpp.util.createElement("body",req,!1)),envelope.append(this.processProtocolPacketQueue()),envelope.append("</body>"),delete this.lastPollTime;else{if(this.lastPollTime){var now=(new Date).getTime();if(now-this.lastPollTime<this.polling){this.dispatchTimer=setTimeout(dojo.hitch(this,"_dispatchPacket"),this.polling-(now-this.lastPollTime)+10);return}}req.rid=this.rid++,this.lastPollTime=(new Date).getTime(),envelope=new dojox.string.Builder(dojox.xmpp.util.createElement("body",req,!0))}this.addToOutboundQueue(envelope.toString(),req.rid)},redispatchPacket:function(rid){var env=this.outboundRequests[rid];this.sendXml(env,rid)},addToOutboundQueue:function(msg,rid){this.outboundQueue.push({msg:msg,rid:rid}),this.outboundRequests[rid]=msg,this.sendXml(msg,rid)},removeFromOutboundQueue:function(rid){for(var i=0;i<this.outboundQueue.length;i++)if(rid==this.outboundQueue[i]["rid"]){this.outboundQueue.splice(i,1);break}delete this.outboundRequests[rid]},processProtocolPacketQueue:function(){var packets=new dojox.string.Builder;for(var i=0;i<this.protocolPacketQueue.length;i++)packets.append(this.protocolPacketQueue[i]);return this.protocolPacketQueue=[],packets.toString()},sendXml:function(message,rid){if(this.isTerminated())return!1;this.transmitState="transmitting";var def=null;return this.useScriptSrcTransport?def=dojox.xmpp.bosh.get({rid:rid,url:this.serviceUrl+"?"+encodeURIComponent(message),error:dojo.hitch(this,function(res,io){return this.setState("Terminate","error"),!1}),timeout:this.sendTimeout}):def=dojo.rawXhrPost({contentType:"text/xml",url:this.serviceUrl,postData:message,handleAs:"xml",error:dojo.hitch(this,function(res,io){return this.processError(io.xhr.responseXML,io.xhr.status,rid)}),timeout:this.sendTimeout}),def.addCallback(this,function(res){return this.processDocument(res,rid)}),def},processDocument:function(doc,rid){if(this.isTerminated()||!doc.firstChild)return!1;this.transmitState="idle";var body=doc.firstChild;body.nodeName=="body";if(this.outboundQueue.length<1)return!1;var expectedId=this.outboundQueue[0].rid;if(rid==expectedId)this.removeFromOutboundQueue(rid),this.processResponse(body,rid),this.processInboundQueue();else{var gap=rid-expectedId;gap<this.hold+2&&this.addToInboundQueue(doc,rid)}return doc},processInboundQueue:function(){while(this.inboundQueue.length>0){var item=this.inboundQueue.shift();this.processDocument(item.doc,item.rid)}},addToInboundQueue:function(doc,rid){for(var i=0;i<this.inboundQueue.length;i++){if(rid<this.inboundQueue[i].rid)continue;this.inboundQueue.splice(i,0,{doc:doc,rid:rid})}},processResponse:function(body,rid){if(body.getAttribute("type")=="terminate"){var reasonNode=body.firstChild.firstChild,errorMessage="";reasonNode.nodeName=="conflict"&&(errorMessage="conflict"),this.setState("Terminate",errorMessage);return}if(this.state!="Ready"&&this.state!="Terminate"){var sid=body.getAttribute("sid");if(!sid)throw new Error("No sid returned during xmpp session startup");this.sid=sid,this.authId=body.getAttribute("authid"),this.authId==""&&this.authRetries--<1&&(0,this.terminateSession()),this.wait=body.getAttribute("wait"),body.getAttribute("polling")&&(this.polling=parseInt(body.getAttribute("polling"))*1e3),this.inactivity=body.getAttribute("inactivity"),this.setState("Ready")}dojo.forEach(body.childNodes,function(node){this.processProtocolResponse(node,rid)},this),this.transmitState=="idle"&&this.dispatchPacket()},processProtocolResponse:function(msg,rid){this.onProcessProtocolResponse(msg);var key=msg.nodeName+"-"+msg.getAttribute("id"),def=this.deferredRequests[key];def&&(def.callback(msg),delete this.deferredRequests[key])},setState:function(state,message){this.state!=state&&(this["on"+state]&&this["on"+state](state,this.state,message),this.state=state)},isTerminated:function(){return this.state=="Terminate"},processError:function(err,httpStatusCode,rid){if(this.isTerminated())return!1;if(httpStatusCode!=200)return httpStatusCode>=400&&httpStatusCode<500?(this.setState("Terminate",errorMessage),!1):(this.removeFromOutboundQueue(rid),setTimeout(dojo.hitch(this,function(){this.dispatchPacket()}),200),!0);!err||!err.dojoType||err.dojoType!="timeout",this.removeFromOutboundQueue(rid);if(err&&err.firstChild&&err.firstChild.getAttribute("type")=="terminate"){var reasonNode=err.firstChild.firstChild,errorMessage="";return reasonNode&&reasonNode.nodeName=="conflict"&&(errorMessage="conflict"),this.setState("Terminate",errorMessage),!1}return this.transmitState="error",setTimeout(dojo.hitch(this,function(){this.dispatchPacket()}),200),!0},onTerminate:function(newState,oldState,message){},onProcessProtocolResponse:function(msg){},onReady:function(newState,oldState){}})})