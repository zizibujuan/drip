//>>built
define("dojox/xmpp/PresenceService",["dojo","dijit","dojox"],function(dojo,dijit,dojox){dojo.provide("dojox.xmpp.PresenceService"),dojox.xmpp.presence={UPDATE:201,SUBSCRIPTION_REQUEST:202,SUBSCRIPTION_SUBSTATUS_NONE:204,SUBSCRIPTION_NONE:"none",SUBSCRIPTION_FROM:"from",SUBSCRIPTION_TO:"to",SUBSCRIPTION_BOTH:"both",SUBSCRIPTION_REQUEST_PENDING:"pending",STATUS_ONLINE:"online",STATUS_AWAY:"away",STATUS_CHAT:"chat",STATUS_DND:"dnd",STATUS_EXTENDED_AWAY:"xa",STATUS_OFFLINE:"offline",STATUS_INVISIBLE:"invisible"},dojo.declare("dojox.xmpp.PresenceService",null,{constructor:function(xmppService){this.session=xmppService,this.isInvisible=!1,this.avatarHash=null,this.presence=null,this.restrictedContactjids={}},publish:function(presence){this.presence=presence,this._setPresence()},sendAvatarHash:function(avatarHash){this.avatarHash=avatarHash,this._setPresence()},_setPresence:function(){var presence=this.presence,p={xmlns:"jabber:client"};presence&&presence.to&&(p.to=presence.to),presence.show&&presence.show==dojox.xmpp.presence.STATUS_OFFLINE&&(p.type="unavailable");if(presence.show&&presence.show==dojox.xmpp.presence.STATUS_INVISIBLE){this._setInvisible(),this.isInvisible=!0;return}this.isInvisible&&this._setVisible();var req=new dojox.string.Builder(dojox.xmpp.util.createElement("presence",p,!1));presence.show&&presence.show!=dojox.xmpp.presence.STATUS_OFFLINE&&(req.append(dojox.xmpp.util.createElement("show",{},!1)),req.append(presence.show),req.append("</show>")),presence.status&&(req.append(dojox.xmpp.util.createElement("status",{},!1)),req.append(presence.status),req.append("</status>")),this.avatarHash&&(req.append(dojox.xmpp.util.createElement("x",{xmlns:"vcard-temp:x:update"},!1)),req.append(dojox.xmpp.util.createElement("photo",{},!1)),req.append(this.avatarHash),req.append("</photo>"),req.append("</x>"));if(presence.priority&&presence.show!=dojox.xmpp.presence.STATUS_OFFLINE){if(presence.priority>127||presence.priority<-128)presence.priority=5;req.append(dojox.xmpp.util.createElement("priority",{},!1)),req.append(presence.priority),req.append("</priority>")}req.append("</presence>"),this.session.dispatchPacket(req.toString())},toggleBlockContact:function(jid){return this.restrictedContactjids[jid]||(this.restrictedContactjids[jid]=this._createRestrictedJid()),this.restrictedContactjids[jid].blocked=!this.restrictedContactjids[jid].blocked,this._updateRestricted(),this.restrictedContactjids},toggleContactInvisiblity:function(jid){return this.restrictedContactjids[jid]||(this.restrictedContactjids[jid]=this._createRestrictedJid()),this.restrictedContactjids[jid].invisible=!this.restrictedContactjids[jid].invisible,this._updateRestricted(),this.restrictedContactjids},_createRestrictedJid:function(){return{invisible:!1,blocked:!1}},_updateRestricted:function(){var props={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"},req=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",props,!1));req.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1)),req.append(dojox.xmpp.util.createElement("list",{name:"iwcRestrictedContacts"},!1));var count=1;for(var jid in this.restrictedContactjids){var item=this.restrictedContactjids[jid];item.blocked||item.invisible?(req.append(dojox.xmpp.util.createElement("item",{value:dojox.xmpp.util.encodeJid(jid),action:"deny",order:count++},!1)),item.blocked&&req.append(dojox.xmpp.util.createElement("message",{},!0)),item.invisible&&req.append(dojox.xmpp.util.createElement("presence-out",{},!0)),req.append("</item>")):delete this.restrictedContactjids[jid]}req.append("</list>"),req.append("</query>"),req.append("</iq>");var req2=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",props,!1));req2.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1)),req2.append(dojox.xmpp.util.createElement("active",{name:"iwcRestrictedContacts"},!0)),req2.append("</query>"),req2.append("</iq>"),this.session.dispatchPacket(req.toString()),this.session.dispatchPacket(req2.toString())},_setVisible:function(){var props={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"},req=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",props,!1));req.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1)),req.append(dojox.xmpp.util.createElement("active",{},!0)),req.append("</query>"),req.append("</iq>"),this.session.dispatchPacket(req.toString())},_setInvisible:function(){var props={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"},req=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",props,!1));req.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1)),req.append(dojox.xmpp.util.createElement("list",{name:"invisible"},!1)),req.append(dojox.xmpp.util.createElement("item",{action:"deny",order:"1"},!1)),req.append(dojox.xmpp.util.createElement("presence-out",{},!0)),req.append("</item>"),req.append("</list>"),req.append("</query>"),req.append("</iq>"),props={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"};var req2=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",props,!1));req2.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1)),req2.append(dojox.xmpp.util.createElement("active",{name:"invisible"},!0)),req2.append("</query>"),req2.append("</iq>"),this.session.dispatchPacket(req.toString()),this.session.dispatchPacket(req2.toString())},_manageSubscriptions:function(contact,type){if(!contact)return;contact.indexOf("@")==-1&&(contact+="@"+this.session.domain);var req=dojox.xmpp.util.createElement("presence",{to:contact,type:type},!0);this.session.dispatchPacket(req)},subscribe:function(contact){this._manageSubscriptions(contact,"subscribe")},approveSubscription:function(contact){this._manageSubscriptions(contact,"subscribed")},unsubscribe:function(contact){this._manageSubscriptions(contact,"unsubscribe")},declineSubscription:function(contact){this._manageSubscriptions(contact,"unsubscribed")},cancelSubscription:function(contact){this._manageSubscriptions(contact,"unsubscribed")}})})