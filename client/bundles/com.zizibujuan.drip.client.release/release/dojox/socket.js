//>>built
define("dojox/socket",["dojo","dojo/on","dojo/Evented","dojo/cookie","dojo/_base/url"],function(dojo,on,Evented){function Socket(argsOrUrl){return typeof argsOrUrl=="string"&&(argsOrUrl={url:argsOrUrl}),WebSocket?dojox.socket.WebSocket(argsOrUrl,!0):dojox.socket.LongPoll(argsOrUrl)}var WebSocket=window.WebSocket;return dojox.socket=Socket,Socket.WebSocket=function(args,fallback){var ws=new WebSocket(new dojo._Url(document.baseURI.replace(/^http/i,"ws"),args.url));ws.on=function(type,listener){ws.addEventListener(type,listener,!0)};var opened;return dojo.connect(ws,"onopen",function(event){opened=!0}),dojo.connect(ws,"onclose",function(event){if(opened)return;fallback&&Socket.replace(ws,dojox.socket.LongPoll(args),!0)}),ws},Socket.replace=function(socket,newSocket,listenForOpen){function proxyEvent(type){(newSocket.addEventListener||newSocket.on).call(newSocket,type,function(event){on.emit(socket,event.type,event)},!0)}socket.send=dojo.hitch(newSocket,"send"),socket.close=dojo.hitch(newSocket,"close"),listenForOpen&&proxyEvent("open"),dojo.forEach(["message","close","error"],proxyEvent)},Socket.LongPoll=function(args){function connect(){socket.readyState==0&&fire("open",{}),connections.length||socket.send()}function fire(type,object,deferred){socket["on"+type]&&(object.ioArgs=deferred&&deferred.ioArgs,object.type=type,on.emit(socket,type,object))}var cancelled=!1,first=!0,timeoutId,connections=[],socket={send:function(data){var sendArgs=dojo.delegate(args);sendArgs.rawBody=data,clearTimeout(timeoutId);var deferred=first?(first=!1)||socket.firstRequest(sendArgs):socket.transport(sendArgs);return connections.push(deferred),deferred.then(function(response){socket.readyState=1,connections.splice(dojo.indexOf(connections,deferred),1),connections.length||(timeoutId=setTimeout(connect,args.interval)),response&&fire("message",{data:response},deferred)},function(error){connections.splice(dojo.indexOf(connections,deferred),1),cancelled||(fire("error",{error:error},deferred),connections.length||(socket.readyState=3,fire("close",{wasClean:!1},deferred)))}),deferred},close:function(){socket.readyState=2,cancelled=!0;for(var i=0;i<connections.length;i++)connections[i].cancel();socket.readyState=3,fire("close",{wasClean:!0})},transport:args.transport||dojo.xhrPost,args:args,url:args.url,readyState:0,CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,on:Evented.prototype.on,firstRequest:function(args){var headers=args.headers||(args.headers={});headers.Pragma="start-long-poll";try{return this.transport(args)}finally{delete headers.Pragma}}};return socket.connect=socket.on,setTimeout(connect),socket},Socket})