//>>built
define("dojox/gfx/canvasWithEvents",["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/Color","dojo/dom","dojo/dom-geometry","./_base","./canvas","./shape","./matrix"],function(lang,declare,hub,Color,dom,domGeom,g,canvas,shapeLib,m){var canvasWithEvents=g.canvasWithEvents={};canvasWithEvents.Shape=declare("dojox.gfx.canvasWithEvents.Shape",canvas.Shape,{_testInputs:function(ctx,pos){if(this.clip||!this.canvasFill&&this.strokeStyle)this._hitTestPixel(ctx,pos);else{this._renderShape(ctx);var cnt=pos.length,t=this.getTransform();for(var i=0;i<pos.length;++i){var input=pos[i];if(input.target)continue;var x=input.x,y=input.y,p=t?m.multiplyPoint(m.invert(t),x,y):{x:x,y:y};input.target=this._hitTestGeometry(ctx,p.x,p.y)}}},_hitTestPixel:function(ctx,pos){for(var i=0;i<pos.length;++i){var input=pos[i];if(input.target)continue;var x=input.x,y=input.y;ctx.clearRect(0,0,1,1),ctx.save(),ctx.translate(-x,-y),this._render(ctx,!0),input.target=ctx.getImageData(0,0,1,1).data[0]?this:null,ctx.restore()}},_hitTestGeometry:function(ctx,x,y){return ctx.isPointInPath(x,y)?this:null},_renderFill:function(ctx,apply){if(ctx.pickingMode){"canvasFill"in this&&apply&&ctx.fill();return}this.inherited(arguments)},_renderStroke:function(ctx,apply){if(this.strokeStyle&&ctx.pickingMode){var c=this.strokeStyle.color;try{this.strokeStyle.color=new Color(ctx.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=c}}else this.inherited(arguments)},getEventSource:function(){return this.surface.getEventSource()},connect:function(name,object,method){return name.indexOf("mouse")===0?name="on"+name:name.indexOf("ontouch")===0&&(name=name.slice(2)),this.surface._setupEvents(name),arguments.length>2?hub.connect(this,name,object,method):hub.connect(this,name,object)},disconnect:function(token){hub.disconnect(token)},oncontextmenu:function(){},onclick:function(){},ondblclick:function(){},onmouseenter:function(){},onmouseleave:function(){},onmouseout:function(){},onmousedown:function(){},ontouchstart:function(){},touchstart:function(){},onmouseup:function(){},ontouchend:function(){},touchend:function(){},onmouseover:function(){},onmousemove:function(){},ontouchmove:function(){},touchmove:function(){},onkeydown:function(){},onkeyup:function(){}}),canvasWithEvents.Group=declare("dojox.gfx.canvasWithEvents.Group",[canvasWithEvents.Shape,canvas.Group],{_testInputs:function(ctx,pos){var children=this.children,t=this.getTransform(),i,j,input;if(children.length===0)return;var posbk=[];for(i=0;i<pos.length;++i){input=pos[i],posbk[i]={x:input.x,y:input.y};if(input.target)continue;var x=input.x,y=input.y,p=t?m.multiplyPoint(m.invert(t),x,y):{x:x,y:y};input.x=p.x,input.y=p.y}for(i=children.length-1;i>=0;--i){children[i]._testInputs(ctx,pos);var allFound=!0;for(j=0;j<pos.length;++j)if(pos[j].target==null){allFound=!1;break}if(allFound)break}if(this.clip)for(i=0;i<pos.length;++i)input=pos[i],input.x=posbk[i].x,input.y=posbk[i].y,input.target&&(ctx.clearRect(0,0,1,1),ctx.save(),ctx.translate(-input.x,-input.y),this._render(ctx,!0),ctx.getImageData(0,0,1,1).data[0]||(input.target=null),ctx.restore());else for(i=0;i<pos.length;++i)pos[i].x=posbk[i].x,pos[i].y=posbk[i].y}}),canvasWithEvents.Image=declare("dojox.gfx.canvasWithEvents.Image",[canvasWithEvents.Shape,canvas.Image],{_renderShape:function(ctx){var s=this.shape;ctx.pickingMode?ctx.fillRect(s.x,s.y,s.width,s.height):this.inherited(arguments)},_hitTestGeometry:function(ctx,x,y){var s=this.shape;return x>=s.x&&x<=s.x+s.width&&y>=s.y&&y<=s.y+s.height?this:null}}),canvasWithEvents.Text=declare("dojox.gfx.canvasWithEvents.Text",[canvasWithEvents.Shape,canvas.Text],{_testInputs:function(ctx,pos){return this._hitTestPixel(ctx,pos)}}),canvasWithEvents.Rect=declare("dojox.gfx.canvasWithEvents.Rect",[canvasWithEvents.Shape,canvas.Rect],{}),canvasWithEvents.Circle=declare("dojox.gfx.canvasWithEvents.Circle",[canvasWithEvents.Shape,canvas.Circle],{}),canvasWithEvents.Ellipse=declare("dojox.gfx.canvasWithEvents.Ellipse",[canvasWithEvents.Shape,canvas.Ellipse],{}),canvasWithEvents.Line=declare("dojox.gfx.canvasWithEvents.Line",[canvasWithEvents.Shape,canvas.Line],{}),canvasWithEvents.Polyline=declare("dojox.gfx.canvasWithEvents.Polyline",[canvasWithEvents.Shape,canvas.Polyline],{}),canvasWithEvents.Path=declare("dojox.gfx.canvasWithEvents.Path",[canvasWithEvents.Shape,canvas.Path],{}),canvasWithEvents.TextPath=declare("dojox.gfx.canvasWithEvents.TextPath",[canvasWithEvents.Shape,canvas.TextPath],{});var _eventsRedirectMap={onmouseenter:"onmousemove",onmouseleave:"onmousemove",onmouseout:"onmousemove",onmouseover:"onmousemove",touchstart:"ontouchstart",touchend:"ontouchend",touchmove:"ontouchmove"},_eventsShortNameMap={ontouchstart:"touchstart",ontouchend:"touchend",ontouchmove:"touchmove"},uagent=navigator.userAgent.toLowerCase(),isiOS=uagent.search("iphone")>-1||uagent.search("ipad")>-1||uagent.search("ipod")>-1;canvasWithEvents.Surface=declare("dojox.gfx.canvasWithEvents.Surface",canvas.Surface,{constructor:function(){this._pick={curr:null,last:null},this._pickOfMouseDown=null,this._pickOfMouseUp=null},connect:function(name,object,method){return name.indexOf("touch")!==-1?(this._setupEvents(name),name="_on"+name+"Impl_",hub.connect(this,name,object,method)):(this._initMirrorCanvas(),hub.connect(this.getEventSource(),name,null,shapeLib.fixCallback(this,g.fixTarget,object,method)))},_ontouchstartImpl_:function(){},_ontouchendImpl_:function(){},_ontouchmoveImpl_:function(){},_initMirrorCanvas:function(){if(!this.mirrorCanvas){var p=this._parent,mirror=p.ownerDocument.createElement("canvas");mirror.width=1,mirror.height=1,mirror.style.position="absolute",mirror.style.left="-99999px",mirror.style.top="-99999px",p.appendChild(mirror),this.mirrorCanvas=mirror}},_setupEvents:function(eventName){eventName in _eventsRedirectMap&&(eventName=_eventsRedirectMap[eventName]);if(this._eventsH&&this._eventsH[eventName])return;this._initMirrorCanvas(),this._eventsH||(this._eventsH={}),this._eventsH[eventName]=hub.connect(this.getEventSource(),eventName,shapeLib.fixCallback(this,g.fixTarget,this,"_"+eventName));if(eventName==="onclick"||eventName==="ondblclick")this._eventsH.onmousedown||(this._eventsH.onmousedown=hub.connect(this.getEventSource(),"onmousedown",shapeLib.fixCallback(this,g.fixTarget,this,"_onmousedown"))),this._eventsH.onmouseup||(this._eventsH.onmouseup=hub.connect(this.getEventSource(),"onmouseup",shapeLib.fixCallback(this,g.fixTarget,this,"_onmouseup")))},destroy:function(){this.inherited(arguments);for(var i in this._eventsH)hub.disconnect(this._eventsH[i]);this._eventsH=this.mirrorCanvas=null},getEventSource:function(){return this.rawNode},_invokeHandler:function(base,method,event){var handler=base[method];handler&&handler.after?handler.apply(base,[event]):method in _eventsShortNameMap&&(handler=base[_eventsShortNameMap[method]],handler&&handler.after&&handler.apply(base,[event])),!handler&&method.indexOf("touch")!==-1&&(method="_"+method+"Impl_",handler=base[method],handler&&handler.apply(base,[event])),!isEventStopped(event)&&base.parent&&this._invokeHandler(base.parent,method,event)},_oncontextmenu:function(e){this._pick.curr&&this._invokeHandler(this._pick.curr,"oncontextmenu",e)},_ondblclick:function(e){this._pickOfMouseUp&&this._invokeHandler(this._pickOfMouseUp,"ondblclick",e)},_onclick:function(e){this._pickOfMouseUp&&this._pickOfMouseUp==this._pickOfMouseDown&&this._invokeHandler(this._pickOfMouseUp,"onclick",e)},_onmousedown:function(e){this._pickOfMouseDown=this._pick.curr,this._pick.curr&&this._invokeHandler(this._pick.curr,"onmousedown",e)},_ontouchstart:function(e){this._pick.curr&&this._fireTouchEvent(e)},_onmouseup:function(e){this._pickOfMouseUp=this._pick.curr,this._pick.curr&&this._invokeHandler(this._pick.curr,"onmouseup",e)},_ontouchend:function(e){if(this._pick.curr)for(var i=0;i<this._pick.curr.length;++i)this._pick.curr[i].target&&(e.gfxTarget=this._pick.curr[i].target,this._invokeHandler(this._pick.curr[i].target,"ontouchend",e))},_onmousemove:function(e){this._pick.last&&this._pick.last!=this._pick.curr&&(this._invokeHandler(this._pick.last,"onmouseleave",e),this._invokeHandler(this._pick.last,"onmouseout",e)),this._pick.curr&&(this._pick.last==this._pick.curr?this._invokeHandler(this._pick.curr,"onmousemove",e):(this._invokeHandler(this._pick.curr,"onmouseenter",e),this._invokeHandler(this._pick.curr,"onmouseover",e)))},_ontouchmove:function(e){this._pick.curr&&this._fireTouchEvent(e)},_fireTouchEvent:function(e){var toFire=[];for(var i=0;i<this._pick.curr.length;++i){var pick=this._pick.curr[i];if(pick.target){var gfxtt=pick.target.__gfxtt;gfxtt||(gfxtt=[],pick.target.__gfxtt=gfxtt),gfxtt.push(pick.t),pick.target.__inToFire||(toFire.push(pick.target),pick.target.__inToFire=!0)}}if(toFire.length===0)this._invokeHandler(this,"on"+e.type,e);else for(i=0;i<toFire.length;++i)(function(){var targetTouches=toFire[i].__gfxtt,evt=lang.delegate(e,{gfxTarget:toFire[i]});isiOS&&(evt.preventDefault=function(){e.preventDefault()},evt.stopPropagation=function(){e.stopPropagation()}),evt.__defineGetter__("targetTouches",function(){return targetTouches}),delete toFire[i].__gfxtt,delete toFire[i].__inToFire,this._invokeHandler(toFire[i],"on"+e.type,evt)}).call(this)},_onkeydown:function(){},_onkeyup:function(){},_whatsUnderEvent:function(evt){var surface=this,i,pos=domGeom.position(surface.rawNode,!0),inputs=[],changedTouches=evt.changedTouches,touches=evt.touches;if(changedTouches)for(i=0;i<changedTouches.length;++i)inputs.push({t:changedTouches[i],x:changedTouches[i].pageX-pos.x,y:changedTouches[i].pageY-pos.y});else if(touches)for(i=0;i<touches.length;++i)inputs.push({t:touches[i],x:touches[i].pageX-pos.x,y:touches[i].pageY-pos.y});else inputs.push({x:evt.pageX-pos.x,y:evt.pageY-pos.y});var mirror=surface.mirrorCanvas,ctx=mirror.getContext("2d"),children=surface.children;ctx.clearRect(0,0,mirror.width,mirror.height),ctx.save(),ctx.strokeStyle="rgba(127,127,127,1.0)",ctx.fillStyle="rgba(127,127,127,1.0)",ctx.pickingMode=!0;var pick=null;for(i=children.length-1;i>=0;i--){children[i]._testInputs(ctx,inputs);var allFound=!0;for(j=0;j<inputs.length;++j)if(inputs[j].target==null){allFound=!1;break}if(allFound)break}return ctx.restore(),touches||changedTouches?inputs:inputs[0].target}}),canvasWithEvents.createSurface=function(parentNode,width,height){if(!width&&!height){var pos=domGeom.position(parentNode);width=width||pos.w,height=height||pos.h}typeof width=="number"&&(width+="px"),typeof height=="number"&&(height+="px");var s=new canvasWithEvents.Surface,p=dom.byId(parentNode),c=p.ownerDocument.createElement("canvas");return c.width=g.normalizedLength(width),c.height=g.normalizedLength(height),p.appendChild(c),s.rawNode=c,s._parent=p,s.surface=s,s};var isEventStopped=function(evt){return evt.cancelBubble!==undefined?evt.cancelBubble:!1};return canvasWithEvents.fixTarget=function(event,gfxElement){return isEventStopped(event)?!1:(event.gfxTarget||(gfxElement._pick.last=gfxElement._pick.curr,gfxElement._pick.curr=gfxElement._whatsUnderEvent(event),lang.isArray(gfxElement._pick.curr)||(event.gfxTarget=gfxElement._pick.curr)),!0)},canvasWithEvents})