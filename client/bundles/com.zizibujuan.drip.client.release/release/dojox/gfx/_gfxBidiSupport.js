//>>built
define("dojox/gfx/_gfxBidiSupport",["./_base","dojo/_base/lang","dojo/_base/sniff","dojo/dom","dojo/_base/html","dojo/_base/array","./utils","./shape","dojox/string/BidiEngine"],function(g,lang,has,dom,html,arr,utils,shapeLib,BidiEngine){function setTextDir(obj,newTextDir){var tDir=validateTextDir(newTextDir);return tDir&&g.utils.forEach(obj,function(e){if(e instanceof g.Surface||e instanceof g.Group)e.textDir=tDir;e instanceof g.Text&&e.setShape({textDir:tDir}),e instanceof g.TextPath&&e.setText({textDir:tDir})},obj),obj}function validateTextDir(textDir){var validValues=["ltr","rtl","auto"];if(textDir){textDir=textDir.toLowerCase();if(arr.indexOf(validValues,textDir)<0)return null}return textDir}lang.getObject("dojox.gfx._gfxBidiSupport",!0);switch(g.renderer){case"vml":g.isVml=!0;break;case"svg":g.isSvg=!0,g.svg.useSvgWeb&&(g.isSvgWeb=!0);break;case"silverlight":g.isSilverlight=!0;break;case"canvas":g.isCanvas=!0}var bidi_const={LRM:"‎",LRE:"‪",PDF:"‬",RLM:"‏",RLE:"‫"},bidiEngine=new BidiEngine;lang.extend(g.shape.Surface,{textDir:"",setTextDir:function(newTextDir){setTextDir(this,newTextDir)},getTextDir:function(){return this.textDir}}),lang.extend(g.Group,{textDir:"",setTextDir:function(newTextDir){setTextDir(this,newTextDir)},getTextDir:function(){return this.textDir}}),lang.extend(g.Text,{textDir:"",formatText:function(text,textDir){if(textDir&&text&&text.length>1){var sourceDir="ltr",targetDir=textDir;if(targetDir=="auto"){if(g.isVml)return text;targetDir=bidiEngine.checkContextual(text)}if(g.isVml)return sourceDir=bidiEngine.checkContextual(text),targetDir!=sourceDir?targetDir=="rtl"?bidiEngine.hasBidiChar(text)?bidi_const.RLM+bidi_const.RLM+text:bidiEngine.bidiTransform(text,"IRNNN","ILNNN"):bidi_const.LRM+text:text;if(g.isSvgWeb)return targetDir=="rtl"?bidiEngine.bidiTransform(text,"IRNNN","ILNNN"):text;if(g.isSilverlight)return targetDir=="rtl"?bidiEngine.bidiTransform(text,"IRNNN","VLYNN"):bidiEngine.bidiTransform(text,"ILNNN","VLYNN");if(g.isCanvas)return targetDir=="rtl"?bidi_const.RLE+text+bidi_const.PDF:bidi_const.LRE+text+bidi_const.PDF;if(g.isSvg)return has("ff")<4?targetDir=="rtl"?bidiEngine.bidiTransform(text,"IRYNN","VLNNN"):bidiEngine.bidiTransform(text,"ILYNN","VLNNN"):bidi_const.LRM+(targetDir=="rtl"?bidi_const.RLE:bidi_const.LRE)+text+bidi_const.PDF}return text},bidiPreprocess:function(newShape){return newShape}}),lang.extend(g.TextPath,{textDir:"",formatText:function(text,textDir){if(textDir&&text&&text.length>1){var sourceDir="ltr",targetDir=textDir;if(targetDir=="auto"){if(g.isVml)return text;targetDir=bidiEngine.checkContextual(text)}if(g.isVml)return sourceDir=bidiEngine.checkContextual(text),targetDir!=sourceDir?targetDir=="rtl"?bidiEngine.hasBidiChar(text)?bidi_const.RLM+bidi_const.RLM+text:bidiEngine.bidiTransform(text,"IRNNN","ILNNN"):bidi_const.LRM+text:text;if(g.isSvgWeb)return targetDir=="rtl"?bidiEngine.bidiTransform(text,"IRNNN","ILNNN"):text;g.isSvg&&(has("opera")||has("ff")>=4?text=bidi_const.LRM+(targetDir=="rtl"?bidi_const.RLE:bidi_const.LRE)+text+bidi_const.PDF:text=targetDir=="rtl"?bidiEngine.bidiTransform(text,"IRYNN","VLNNN"):bidiEngine.bidiTransform(text,"ILYNN","VLNNN"))}return text},bidiPreprocess:function(newText){return newText&&typeof newText=="string"&&(this.origText=newText,newText=this.formatText(newText,this.textDir)),newText}});var extendMethod=function(shape,method,before,after){var old=shape.prototype[method];shape.prototype[method]=function(){var rBefore;before&&(rBefore=before.apply(this,arguments));var r=old.call(this,rBefore);return after&&(r=after.call(this,r,arguments)),r}},bidiPreprocess=function(newText){return newText&&(newText.textDir&&(newText.textDir=validateTextDir(newText.textDir)),newText.text&&newText.text instanceof Array&&(newText.text=newText.text.join(","))),newText&&(newText.text!=undefined||newText.textDir)&&(this.textDir!=newText.textDir||newText.text!=this.origText)&&(this.origText=newText.text!=undefined?newText.text:this.origText,newText.textDir&&(this.textDir=newText.textDir),newText.text=this.formatText(this.origText,this.textDir)),this.bidiPreprocess(newText)};extendMethod(g.Text,"setShape",bidiPreprocess,null),extendMethod(g.TextPath,"setText",bidiPreprocess,null);var restoreText=function(origObj){var obj=lang.clone(origObj);return obj&&this.origText&&(obj.text=this.origText),obj};extendMethod(g.Text,"getShape",null,restoreText),extendMethod(g.TextPath,"getText",null,restoreText);var groupTextDir=function(group,args){var textDir;return args&&args[0]&&(textDir=validateTextDir(args[0])),group.setTextDir(textDir?textDir:this.textDir),group};extendMethod(g.Surface,"createGroup",null,groupTextDir),extendMethod(g.Group,"createGroup",null,groupTextDir);var textDirPreprocess=function(text){if(text){var textDir=text.textDir?validateTextDir(text.textDir):this.textDir;textDir&&(text.textDir=textDir)}return text};return extendMethod(g.Surface,"createText",textDirPreprocess,null),extendMethod(g.Surface,"createTextPath",textDirPreprocess,null),extendMethod(g.Group,"createText",textDirPreprocess,null),extendMethod(g.Group,"createTextPath",textDirPreprocess,null),g.createSurface=function(parentNode,width,height,textDir){var s=g[g.renderer].createSurface(parentNode,width,height),tDir=validateTextDir(textDir);if(g.isSvgWeb)return s.textDir=tDir?tDir:html.style(dom.byId(parentNode),"direction"),s;if(g.isVml||g.isSvg||g.isCanvas)s.textDir=tDir?tDir:html.style(s.rawNode,"direction");return g.isSilverlight&&(s.textDir=tDir?tDir:html.style(s._nodes[1],"direction")),s},g})