//>>built
define("dojox/dtl/dom",["dojo/_base/lang","./_base","dojox/string/tokenize","./Context","dojo/dom","dojo/dom-construct","dojo/_base/html","dojo/_base/array","dojo/_base/connect","dojo/_base/sniff"],function(lang,dd,Tokenize,context,dom,domconstruct,html,array,connect,has){dd.BOOLS={checked:1,disabled:1,readonly:1},dd.TOKEN_CHANGE=-11,dd.TOKEN_ATTR=-12,dd.TOKEN_CUSTOM=-13,dd.TOKEN_NODE=1;var ddt=dd.text,ddh=dd.dom={_attributes:{},_uppers:{},_re4:/^function anonymous\(\)\s*{\s*(.*)\s*}$/,_reTrim:/(?:^[\n\s]*(\{%)?\s*|\s*(%\})?[\n\s]*$)/g,_reSplit:/\s*%\}[\n\s]*\{%\s*/g,getTemplate:function(text){if(typeof this._commentable=="undefined"){this._commentable=!1;var div=document.createElement("div"),comment="Test comment handling, and long comments, using comments whenever possible.";div.innerHTML="<!--"+comment+"-->",div.childNodes.length&&div.firstChild.nodeType==8&&div.firstChild.data==comment&&(this._commentable=!0)}this._commentable||(text=text.replace(/<!--({({|%).*?(%|})})-->/g,"$1")),has("ie")&&(text=text.replace(/\b(checked|disabled|readonly|style)="/g,'t$1="')),text=text.replace(/\bstyle="/g,'tstyle="');var match,table=has("webkit"),pairs=[[!0,"select","option"],[table,"tr","td|th"],[table,"thead","tr","th"],[table,"tbody","tr","td"],[table,"table","tbody|thead|tr","tr","td"]],replacements=[];for(var i=0,pair;pair=pairs[i];i++){if(!pair[0])continue;if(text.indexOf("<"+pair[1])!=-1){var selectRe=new RegExp("<"+pair[1]+"(?:.|\n)*?>((?:.|\n)+?)</"+pair[1]+">","ig");while(match=selectRe.exec(text)){var inners=pair[2].split("|"),innerRe=[];for(var j=0,inner;inner=inners[j];j++)innerRe.push("<"+inner+"(?:.|\n)*?>(?:.|\n)*?</"+inner+">");var tags=[],tokens=Tokenize(match[1],new RegExp("("+innerRe.join("|")+")","ig"),function(data){var tag=/<(\w+)/.exec(data)[1];return tags[tag]||(tags[tag]=!0,tags.push(tag)),{data:data}});if(tags.length){var tag=tags.length==1?tags[0]:pair[2].split("|")[0],replace=[];for(var j=0,jl=tokens.length;j<jl;j++){var token=tokens[j];if(lang.isObject(token))replace.push(token.data);else{var stripped=token.replace(this._reTrim,"");if(!stripped)continue;token=stripped.split(this._reSplit);for(var k=0,kl=token.length;k<kl;k++){var replacement="";for(var p=2,pl=pair.length;p<pl;p++)if(p==2)replacement+="<"+tag+' dtlinstruction="{% '+token[k].replace('"','\\"')+' %}">';else{if(tag==pair[p])continue;replacement+="<"+pair[p]+">"}replacement+="DTL";for(var p=pair.length-1;p>1;p--)if(p==2)replacement+="</"+tag+">";else{if(tag==pair[p])continue;replacement+="</"+pair[p]+">"}replace.push("ÿ"+replacements.length),replacements.push(replacement)}}}text=text.replace(match[1],replace.join(""))}}}}for(var i=replacements.length;i--;)text=text.replace("ÿ"+i,replacements[i]);var re=/\b([a-zA-Z_:][a-zA-Z0-9_\-\.:]*)=['"]/g;while(match=re.exec(text)){var lower=match[1].toLowerCase();if(lower=="dtlinstruction")continue;lower!=match[1]&&(this._uppers[lower]=match[1]),this._attributes[lower]=!0}var div=document.createElement("div");div.innerHTML=text;var output={nodes:[]};while(div.childNodes.length)output.nodes.push(div.removeChild(div.childNodes[0]));return output},tokenize:function(nodes){var tokens=[];for(var i=0,node;node=nodes[i++];)node.nodeType!=1?this.__tokenize(node,tokens):this._tokenize(node,tokens);return tokens},_swallowed:[],_tokenize:function(node,tokens){var first=!1,swallowed=this._swallowed,i,j,tag,child;if(!tokens.first){first=tokens.first=!0;var tags=dd.register.getAttributeTags();for(i=0;tag=tags[i];i++)try{tag[2]({swallowNode:function(){throw 1}},new dd.Token(dd.TOKEN_ATTR,""))}catch(e){swallowed.push(tag)}}for(i=0;tag=swallowed[i];i++){var text=node.getAttribute(tag[0]);if(text){var swallowed=!1,custom=tag[2]({swallowNode:function(){return swallowed=!0,node}},new dd.Token(dd.TOKEN_ATTR,tag[0]+" "+text));if(swallowed){node.parentNode&&node.parentNode.removeChild&&node.parentNode.removeChild(node),tokens.push([dd.TOKEN_CUSTOM,custom]);return}}}var children=[];if(has("ie")&&node.tagName=="SCRIPT")children.push({nodeType:3,data:node.text}),node.text="";else for(i=0;child=node.childNodes[i];i++)children.push(child);tokens.push([dd.TOKEN_NODE,node]);var change=!1;children.length&&(tokens.push([dd.TOKEN_CHANGE,node]),change=!0);for(var key in this._attributes){var clear=!1,value="";if(key=="class")value=node.className||value;else if(key=="for")value=node.htmlFor||value;else{if(key=="value"&&node.value==node.innerHTML)continue;if(node.getAttribute){value=node.getAttribute(key,2)||value;if(key=="href"||key=="src"){if(has("ie")){var hash=location.href.lastIndexOf(location.hash),href=location.href.substring(0,hash).split("/");href.pop(),href=href.join("/")+"/",value.indexOf(href)==0&&(value=value.replace(href,"")),value=decodeURIComponent(value)}}else key=="tstyle"?(clear=key,key="style"):dd.BOOLS[key.slice(1)]&&lang.trim(value)?key=key.slice(1):this._uppers[key]&&lang.trim(value)&&(clear=this._uppers[key])}}clear&&(node.setAttribute(clear,""),node.removeAttribute(clear)),typeof value=="function"&&(value=value.toString().replace(this._re4,"$1")),change||(tokens.push([dd.TOKEN_CHANGE,node]),change=!0),tokens.push([dd.TOKEN_ATTR,node,key,value])}for(i=0,child;child=children[i];i++){if(child.nodeType==1){var instruction=child.getAttribute("dtlinstruction");instruction&&(child.parentNode.removeChild(child),child={nodeType:8,data:instruction})}this.__tokenize(child,tokens)}!first&&node.parentNode&&node.parentNode.tagName?(change&&tokens.push([dd.TOKEN_CHANGE,node,!0]),tokens.push([dd.TOKEN_CHANGE,node.parentNode]),node.parentNode.removeChild(node)):tokens.push([dd.TOKEN_CHANGE,node,!0,!0])},__tokenize:function(child,tokens){var data=child.data;switch(child.nodeType){case 1:this._tokenize(child,tokens);return;case 3:if(!data.match(/[^\s\n]/)||data.indexOf("{{")==-1&&data.indexOf("{%")==-1)tokens.push([child.nodeType,child]);else{var texts=ddt.tokenize(data);for(var j=0,text;text=texts[j];j++)typeof text=="string"?tokens.push([dd.TOKEN_TEXT,text]):tokens.push(text)}child.parentNode&&child.parentNode.removeChild(child);return;case 8:if(data.indexOf("{%")==0){var text=lang.trim(data.slice(2,-2));if(text.substr(0,5)=="load "){var parts=lang.trim(text).split(/\s+/g);for(var i=1,part;part=parts[i];i++)/\./.test(part)&&(part=part.replace(/\./g,"/")),require([part])}tokens.push([dd.TOKEN_BLOCK,text])}data.indexOf("{{")==0&&tokens.push([dd.TOKEN_VAR,lang.trim(data.slice(2,-2))]),child.parentNode&&child.parentNode.removeChild(child);return}}};return dd.DomTemplate=lang.extend(function(obj){if(!obj.nodes){var node=dom.byId(obj);node&&node.nodeType==1?(array.forEach(["class","src","href","name","value"],function(item){ddh._attributes[item]=!0}),obj={nodes:[node]}):(typeof obj=="object"&&(obj=ddt.getTemplateString(obj)),obj=ddh.getTemplate(obj))}var tokens=ddh.tokenize(obj.nodes);dd.tests&&(this.tokens=tokens.slice(0));var parser=new dd._DomParser(tokens);this.nodelist=parser.parse()},{_count:0,_re:/\bdojo:([a-zA-Z0-9_]+)\b/g,setClass:function(str){this.getRootNode().className=str},getRootNode:function(){return this.buffer.rootNode},getBuffer:function(){return new dd.DomBuffer},render:function(context,buffer){buffer=this.buffer=buffer||this.getBuffer(),this.rootNode=null;var output=this.nodelist.render(context||new dd.Context({}),buffer);for(var i=0,node;node=buffer._cache[i];i++)node._cache&&(node._cache.length=0);return output},unrender:function(context,buffer){return this.nodelist.unrender(context,buffer)}}),dd.DomBuffer=lang.extend(function(parent){this._parent=parent,this._cache=[]},{concat:function(node){var parent=this._parent;if(parent&&node.parentNode&&node.parentNode===parent&&!parent._dirty)return this;if(node.nodeType==1&&!this.rootNode)return this.rootNode=node||!0,this;if(!parent){if(node.nodeType==3&&lang.trim(node.data))throw new Error("Text should not exist outside of the root node in template");return this}if(this._closed){if(node.nodeType==3&&!lang.trim(node.data))return this;throw new Error("Content should not exist outside of the root node in template")}if(parent._dirty){if(node._drawn&&node.parentNode==parent){var caches=parent._cache;if(caches){for(var i=0,cache;cache=caches[i];i++)this.onAddNode&&this.onAddNode(cache),parent.insertBefore(cache,node),this.onAddNodeComplete&&this.onAddNodeComplete(cache);caches.length=0}}parent._dirty=!1}return parent._cache||(parent._cache=[],this._cache.push(parent)),parent._dirty=!0,parent._cache.push(node),this},remove:function(obj){if(typeof obj=="string")this._parent&&this._parent.removeAttribute(obj);else{if(obj.nodeType==1&&!this.getRootNode()&&!this._removed)return this._removed=!0,this;obj.parentNode&&(this.onRemoveNode&&this.onRemoveNode(obj),obj.parentNode&&obj.parentNode.removeChild(obj))}return this},setAttribute:function(key,value){var old=html.attr(this._parent,key);return this.onChangeAttribute&&old!=value&&this.onChangeAttribute(this._parent,key,old,value),key=="style"?this._parent.style.cssText=value:(html.attr(this._parent,key,value),key=="value"&&this._parent.setAttribute(key,value)),this},addEvent:function(context,type,fn,args){if(!context.getThis())throw new Error("You must use Context.setObject(instance)");this.onAddEvent&&this.onAddEvent(this.getParent(),type,fn);var resolved=fn;return lang.isArray(args)&&(resolved=function(e){this[fn].apply(this,[e].concat(args))}),connect.connect(this.getParent(),type,context.getThis(),resolved)},setParent:function(node,up,root){this._parent||(this._parent=this._first=node),up&&root&&node===this._first&&(this._closed=!0);if(up){var parent=this._parent,script="",ie=has("ie")&&parent.tagName=="SCRIPT";ie&&(parent.text="");if(parent._dirty){var caches=parent._cache,select=parent.tagName=="SELECT"&&!parent.options.length;for(var i=0,cache;cache=caches[i];i++)cache!==parent&&(this.onAddNode&&this.onAddNode(cache),ie?script+=cache.data:(parent.appendChild(cache),select&&cache.defaultSelected&&i&&(select=i)),this.onAddNodeComplete&&this.onAddNodeComplete(cache));select&&(parent.options.selectedIndex=typeof select=="number"?select:0),caches.length=0,parent._dirty=!1}ie&&(parent.text=script)}return this._parent=node,this.onSetParent&&this.onSetParent(node,up,root),this},getParent:function(){return this._parent},getRootNode:function(){return this.rootNode}}),dd._DomNode=lang.extend(function(node){this.contents=node},{render:function(context,buffer){return this._rendered=!0,buffer.concat(this.contents)},unrender:function(context,buffer){return this._rendered?(this._rendered=!1,buffer.remove(this.contents)):buffer},clone:function(buffer){return new this.constructor(this.contents)}}),dd._DomNodeList=lang.extend(function(nodes){this.contents=nodes||[]},{push:function(node){this.contents.push(node)},unshift:function(node){this.contents.unshift(node)},render:function(context,buffer,instance){buffer=buffer||dd.DomTemplate.prototype.getBuffer();if(instance)var parent=buffer.getParent();for(var i=0;i<this.contents.length;i++){buffer=this.contents[i].render(context,buffer);if(!buffer)throw new Error("Template node render functions must return their buffer")}return parent&&buffer.setParent(parent),buffer},dummyRender:function(context,buffer,asNode){var div=document.createElement("div"),parent=buffer.getParent(),old=parent._clone;parent._clone=div;var nodelist=this.clone(buffer,div);old?parent._clone=old:parent._clone=null,buffer=dd.DomTemplate.prototype.getBuffer(),nodelist.unshift(new dd.ChangeNode(div)),nodelist.unshift(new dd._DomNode(div)),nodelist.push(new dd.ChangeNode(div,!0)),nodelist.render(context,buffer);if(asNode)return buffer.getRootNode();var html=div.innerHTML;return has("ie")?domconstruct.replace(/\s*_(dirty|clone)="[^"]*"/g,""):html},unrender:function(context,buffer,instance){if(instance)var parent=buffer.getParent();for(var i=0;i<this.contents.length;i++){buffer=this.contents[i].unrender(context,buffer);if(!buffer)throw new Error("Template node render functions must return their buffer")}return parent&&buffer.setParent(parent),buffer},clone:function(buffer){var parent=buffer.getParent(),contents=this.contents,nodelist=new dd._DomNodeList,cloned=[];for(var i=0;i<contents.length;i++){var clone=contents[i].clone(buffer);if(clone instanceof dd.ChangeNode||clone instanceof dd._DomNode){var item=clone.contents._clone;if(item)clone.contents=item;else if(parent!=clone.contents&&clone instanceof dd._DomNode){var node=clone.contents;clone.contents=clone.contents.cloneNode(!1),buffer.onClone&&buffer.onClone(node,clone.contents),cloned.push(node),node._clone=clone.contents}}nodelist.push(clone)}for(var i=0,clone;clone=cloned[i];i++)clone._clone=null;return nodelist},rtrim:function(){for(;;){var i=this.contents.length-1;if(!(this.contents[i]instanceof dd._DomTextNode&&this.contents[i].isEmpty()))break;this.contents.pop()}return this}}),dd._DomVarNode=lang.extend(function(str){this.contents=new dd._Filter(str)},{render:function(context,buffer){var str=this.contents.resolve(context),type="text";str&&(str.render&&str.getRootNode?type="injection":str.safe&&(str.nodeType?type="node":str.toString&&(str=str.toString(),type="html"))),this._type&&type!=this._type&&this.unrender(context,buffer),this._type=type;switch(type){case"text":this._rendered=!0,this._txt=this._txt||document.createTextNode(str);if(this._txt.data!=str){var old=this._txt.data;this._txt.data=str,buffer.onChangeData&&buffer.onChangeData(this._txt,old,this._txt.data)}return buffer.concat(this._txt);case"injection":var root=str.getRootNode();this._rendered&&root!=this._root&&(buffer=this.unrender(context,buffer)),this._root=root;var injected=this._injected=new dd._DomNodeList;return injected.push(new dd.ChangeNode(buffer.getParent())),injected.push(new dd._DomNode(root)),injected.push(str),injected.push(new dd.ChangeNode(buffer.getParent())),this._rendered=!0,injected.render(context,buffer);case"node":return this._rendered=!0,this._node&&this._node!=str&&this._node.parentNode&&this._node.parentNode===buffer.getParent()&&this._node.parentNode.removeChild(this._node),this._node=str,buffer.concat(str);case"html":this._rendered&&this._src!=str&&(buffer=this.unrender(context,buffer)),this._src=str;if(!this._rendered){this._rendered=!0,this._html=this._html||[];var div=this._div=this._div||document.createElement("div");div.innerHTML=str;var children=div.childNodes;while(children.length){var removed=div.removeChild(children[0]);this._html.push(removed),buffer=buffer.concat(removed)}}return buffer;default:return buffer}},unrender:function(context,buffer){if(!this._rendered)return buffer;this._rendered=!1;switch(this._type){case"text":return buffer.remove(this._txt);case"injection":return this._injection.unrender(context,buffer);case"node":if(this._node.parentNode===buffer.getParent())return buffer.remove(this._node);return buffer;case"html":for(var i=0,l=this._html.length;i<l;i++)buffer=buffer.remove(this._html[i]);return buffer;default:return buffer}},clone:function(){return new this.constructor(this.contents.getExpression())}}),dd.ChangeNode=lang.extend(function(node,up,root){this.contents=node,this.up=up,this.root=root},{render:function(context,buffer){return buffer.setParent(this.contents,this.up,this.root)},unrender:function(context,buffer){return buffer.getParent()?buffer.setParent(this.contents):buffer},clone:function(){return new this.constructor(this.contents,this.up,this.root)}}),dd.AttributeNode=lang.extend(function(key,value){this.key=key,this.value=value,this.contents=value,this._pool[value]?this.nodelist=this._pool[value]:((this.nodelist=dd.quickFilter(value))||(this.nodelist=(new dd.Template(value,!0)).nodelist),this._pool[value]=this.nodelist),this.contents=""},{_pool:{},render:function(context,buffer){var key=this.key,value=this.nodelist.dummyRender(context);return dd.BOOLS[key]&&(value=value!="false"&&value!="undefined"&&!!value),value!==this.contents?(this.contents=value,buffer.setAttribute(key,value)):buffer},unrender:function(context,buffer){return this.contents="",buffer.remove(this.key)},clone:function(buffer){return new this.constructor(this.key,this.value)}}),dd._DomTextNode=lang.extend(function(str){this.contents=document.createTextNode(str),this.upcoming=str},{set:function(data){return this.upcoming=data,this},render:function(context,buffer){if(this.contents.data!=this.upcoming){var old=this.contents.data;this.contents.data=this.upcoming,buffer.onChangeData&&buffer.onChangeData(this.contents,old,this.upcoming)}return buffer.concat(this.contents)},unrender:function(context,buffer){return buffer.remove(this.contents)},isEmpty:function(){return!lang.trim(this.contents.data)},clone:function(){return new this.constructor(this.contents.data)}}),dd._DomParser=lang.extend(function(tokens){this.contents=tokens},{i:0,parse:function(stop_at){var terminators={},tokens=this.contents;stop_at||(stop_at=[]);for(var i=0;i<stop_at.length;i++)terminators[stop_at[i]]=!0;var nodelist=new dd._DomNodeList;while(this.i<tokens.length){var token=tokens[this.i++],type=token[0],value=token[1];if(type==dd.TOKEN_CUSTOM)nodelist.push(value);else if(type==dd.TOKEN_CHANGE){var changeNode=new dd.ChangeNode(value,token[2],token[3]);value[changeNode.attr]=changeNode,nodelist.push(changeNode)}else if(type==dd.TOKEN_ATTR){var fn=ddt.getTag("attr:"+token[2],!0);if(fn&&token[3])(token[3].indexOf("{%")!=-1||token[3].indexOf("{{")!=-1)&&value.setAttribute(token[2],""),nodelist.push(fn(null,new dd.Token(type,token[2]+" "+token[3])));else if(lang.isString(token[3]))if(token[2]=="style"||token[3].indexOf("{%")!=-1||token[3].indexOf("{{")!=-1)nodelist.push(new dd.AttributeNode(token[2],token[3]));else if(lang.trim(token[3]))try{html.attr(value,token[2],token[3])}catch(e){}}else if(type==dd.TOKEN_NODE){var fn=ddt.getTag("node:"+value.tagName.toLowerCase(),!0);fn&&nodelist.push(fn(null,new dd.Token(type,value),value.tagName.toLowerCase())),nodelist.push(new dd._DomNode(value))}else if(type==dd.TOKEN_VAR)nodelist.push(new dd._DomVarNode(value));else if(type==dd.TOKEN_TEXT)nodelist.push(new dd._DomTextNode(value.data||value));else if(type==dd.TOKEN_BLOCK){if(terminators[value])return--this.i,nodelist;var cmd=value.split(/\s+/g);if(cmd.length){cmd=cmd[0];var fn=ddt.getTag(cmd);if(typeof fn!="function")throw new Error("Function not found for "+cmd);var tpl=fn(this,new dd.Token(type,value));tpl&&nodelist.push(tpl)}}}if(stop_at.length)throw new Error("Could not find closing tag(s): "+stop_at.toString());return nodelist},next_token:function(){var token=this.contents[this.i++];return new dd.Token(token[0],token[1])},delete_first_token:function(){this.i++},skip_past:function(endtag){return dd._Parser.prototype.skip_past.call(this,endtag)},create_variable_node:function(expr){return new dd._DomVarNode(expr)},create_text_node:function(expr){return new dd._DomTextNode(expr||"")},getTemplate:function(loc){return new dd.DomTemplate(ddh.getTemplate(loc))}}),dojox.dtl.dom})