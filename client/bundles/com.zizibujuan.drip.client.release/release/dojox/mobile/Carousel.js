//>>built
define("dojox/mobile/Carousel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/event","dojo/_base/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dijit/registry","dijit/_Contained","dijit/_Container","dijit/_WidgetBase","./lazyLoadUtils","./CarouselItem","./PageIndicator","./SwapView","require","dojo/has!dojo-bidi?dojox/mobile/bidi/Carousel"],function(array,connect,declare,event,has,domClass,domConstruct,domStyle,registry,Contained,Container,WidgetBase,lazyLoadUtils,CarouselItem,PageIndicator,SwapView,require,BidiCarousel){var Carousel=declare(has("dojo-bidi")?"dojox.mobile.NonBidiCarousel":"dojox.mobile.Carousel",[WidgetBase,Container,Contained],{numVisible:2,itemWidth:0,title:"",pageIndicator:!0,navButton:!1,height:"",selectable:!0,baseClass:"mblCarousel",buildRendering:function(){this.containerNode=domConstruct.create("div",{className:"mblCarouselPages"}),this.inherited(arguments);if(this.srcNodeRef)for(var i=0,len=this.srcNodeRef.childNodes.length;i<len;i++)this.containerNode.appendChild(this.srcNodeRef.firstChild);this.headerNode=domConstruct.create("div",{className:"mblCarouselHeaderBar"},this.domNode),this.navButton&&(this.btnContainerNode=domConstruct.create("div",{className:"mblCarouselBtnContainer"},this.headerNode),domStyle.set(this.btnContainerNode,"float","right"),this.prevBtnNode=domConstruct.create("button",{className:"mblCarouselBtn",title:"Previous",innerHTML:"&lt;"},this.btnContainerNode),this.nextBtnNode=domConstruct.create("button",{className:"mblCarouselBtn",title:"Next",innerHTML:"&gt;"},this.btnContainerNode),this._prevHandle=this.connect(this.prevBtnNode,"onclick","onPrevBtnClick"),this._nextHandle=this.connect(this.nextBtnNode,"onclick","onNextBtnClick")),this.pageIndicator&&(this.title||(this.title="&nbsp;"),this.piw=new PageIndicator,domStyle.set(this.piw,"float","right"),this.headerNode.appendChild(this.piw.domNode)),this.titleNode=domConstruct.create("div",{className:"mblCarouselTitle"},this.headerNode),this.domNode.appendChild(this.containerNode),this.subscribe("/dojox/mobile/viewChanged","handleViewChanged"),this._clickHandle=this.connect(this.domNode,"onclick","_onClick"),this._keydownHandle=this.connect(this.domNode,"onkeydown","_onClick"),this._dragstartHandle=this.connect(this.domNode,"ondragstart",event.stop),this.selectedItemIndex=-1,this.items=[]},startup:function(){if(this._started)return;var h;this.height==="inherit"?this.domNode.offsetParent&&(h=this.domNode.offsetParent.offsetHeight+"px"):this.height&&(h=this.height),h&&(this.domNode.style.height=h);if(this.store){if(!this.setStore)throw new Error("Use StoreCarousel or DataCarousel instead of Carousel.");var store=this.store;this.store=null,this.setStore(store,this.query,this.queryOptions)}else this.resizeItems();this.inherited(arguments),this.currentView=array.filter(this.getChildren(),function(view){return view.isVisible()})[0]},resizeItems:function(){var idx=0,h=this.domNode.offsetHeight-(this.headerNode?this.headerNode.offsetHeight:0),m=has("ie")?5/this.numVisible-1:5/this.numVisible;array.forEach(this.getChildren(),function(view){if(!(view instanceof SwapView))return;!view.lazy&&!view.domNode.getAttribute("lazy")&&(view._instantiated=!0);var ch=view.containerNode.childNodes;for(var i=0,len=ch.length;i<len;i++){var node=ch[i];if(node.nodeType!==1)continue;var item=this.items[idx]||{};domStyle.set(node,{width:item.width||90/this.numVisible+"%",height:item.height||h+"px",margin:"0 "+(item.margin||m+"%")}),domClass.add(node,"mblCarouselSlot"),idx++}},this),this.piw&&(this.piw.refId=this.containerNode.firstChild,this.piw.reset())},resize:function(){if(!this.itemWidth)return;var num=Math.floor(this.domNode.offsetWidth/this.itemWidth);if(num===this.numVisible)return;this.selectedItemIndex=this.getIndexByItemWidget(this.selectedItem),this.numVisible=num,this.items.length>0&&(this.onComplete(this.items),this.select(this.selectedItemIndex))},fillPages:function(){array.forEach(this.getChildren(),function(child,i){var s="";for(var j=0;j<this.numVisible;j++){var type,props="",mixins,idx=i*this.numVisible+j,item={};idx<this.items.length?(item=this.items[idx],type=this.store.getValue(item,"type"),type?(props=this.store.getValue(item,"props"),mixins=this.store.getValue(item,"mixins")):(type="dojox.mobile.CarouselItem",array.forEach(["alt","src","headerText","footerText"],function(p){var v=this.store.getValue(item,p);v!==undefined&&(props&&(props+=","),props+=p+':"'+v+'"')},this))):(type="dojox.mobile.CarouselItem",props='src:"'+require.toUrl("dojo/resources/blank.gif")+'"'+', className:"mblCarouselItemBlank"'),s+='<div data-dojo-type="'+type+'"',props&&(s+=" data-dojo-props='"+props+"'"),mixins&&(s+=" data-dojo-mixins='"+mixins+"'"),s+="></div>"}child.containerNode.innerHTML=s},this)},onComplete:function(items){array.forEach(this.getChildren(),function(child){child instanceof SwapView&&child.destroyRecursive()}),this.selectedItem=null,this.items=items;var nPages=Math.ceil(items.length/this.numVisible),i,h=this.domNode.offsetHeight-this.headerNode.offsetHeight,idx=this.selectedItemIndex===-1?0:this.selectedItemIndex;pg=Math.floor(idx/this.numVisible);for(i=0;i<nPages;i++){var w=new SwapView({height:h+"px",lazy:!0});this.addChild(w),i===pg?(w.show(),this.currentView=w):w.hide()}this.fillPages(),this.resizeItems();var children=this.getChildren(),from=pg-1<0?0:pg-1,to=pg+1>nPages-1?nPages-1:pg+1;for(i=from;i<=to;i++)this.instantiateView(children[i])},onError:function(){},onUpdate:function(){},onDelete:function(){},onSet:function(item,attribute,oldValue,newValue){},onNew:function(newItem,parentInfo){},onStoreClose:function(request){},getParentView:function(node){for(var w=registry.getEnclosingWidget(node);w;w=w.getParent())if(w.getParent()instanceof SwapView)return w;return null},getIndexByItemWidget:function(w){if(!w)return-1;var view=w.getParent();return array.indexOf(this.getChildren(),view)*this.numVisible+array.indexOf(view.getChildren(),w)},getItemWidgetByIndex:function(index){if(index===-1)return null;var view=this.getChildren()[Math.floor(index/this.numVisible)];return view.getChildren()[index%this.numVisible]},onPrevBtnClick:function(){this.currentView&&this.currentView.goTo(-1)},onNextBtnClick:function(){this.currentView&&this.currentView.goTo(1)},_onClick:function(e){if(this.onClick(e)===!1)return;if(e&&e.type==="keydown")if(e.keyCode===39)this.onNextBtnClick();else if(e.keyCode===37)this.onPrevBtnClick();else if(e.keyCode!==13)return;var w;for(w=registry.getEnclosingWidget(e.target);;w=w.getParent()){if(!w)return;if(w.getParent()instanceof SwapView)break}this.select(w);var idx=this.getIndexByItemWidget(w);connect.publish("/dojox/mobile/carouselSelect",[this,w,this.items[idx],idx])},select:function(itemWidget){typeof itemWidget=="number"&&(itemWidget=this.getItemWidgetByIndex(itemWidget)),this.selectable&&(this.selectedItem&&(this.selectedItem.set("selected",!1),domClass.remove(this.selectedItem.domNode,"mblCarouselSlotSelected")),itemWidget&&(itemWidget.set("selected",!0),domClass.add(itemWidget.domNode,"mblCarouselSlotSelected")),this.selectedItem=itemWidget)},onClick:function(){},instantiateView:function(view){if(view&&!view._instantiated){var isHidden=domStyle.get(view.domNode,"display")==="none";isHidden&&domStyle.set(view.domNode,{visibility:"hidden",display:""}),lazyLoadUtils.instantiateLazyWidgets(view.containerNode,null,function(root){isHidden&&domStyle.set(view.domNode,{visibility:"visible",display:"none"})}),view._instantiated=!0}},handleViewChanged:function(view){if(view.getParent()!==this)return;this.currentView.nextView(this.currentView.domNode)===view?this.instantiateView(view.nextView(view.domNode)):this.instantiateView(view.previousView(view.domNode)),this.currentView=view},_setTitleAttr:function(title){this.titleNode.innerHTML=this._cv?this._cv(title):title,this._set("title",title)}});return has("dojo-bidi")?declare("dojox.mobile.Carousel",[Carousel,BidiCarousel]):Carousel})