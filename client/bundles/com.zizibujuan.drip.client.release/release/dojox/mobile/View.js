//>>built
define("dojox/mobile/View",["dojo/_base/array","dojo/_base/config","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/_base/sniff","dojo/_base/window","dojo/_base/Deferred","dojo/dom","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/registry","dijit/_Contained","dijit/_Container","dijit/_WidgetBase","./ViewController","./common","./transition","./viewRegistry","./_css3"],function(array,config,connect,declare,lang,has,win,Deferred,dom,domClass,domConstruct,domGeometry,domStyle,registry,Contained,Container,WidgetBase,ViewController,common,transitDeferred,viewRegistry,css3){var dm=lang.getObject("dojox.mobile",!0);return declare("dojox.mobile.View",[WidgetBase,Container,Contained],{selected:!1,keepScrollPos:!0,tag:"div",baseClass:"mblView",constructor:function(params,node){node&&(dom.byId(node).style.visibility="hidden")},destroy:function(){viewRegistry.remove(this.id),this.inherited(arguments)},buildRendering:function(){this.domNode=this.containerNode=this.srcNodeRef||domConstruct.create(this.tag),this._animEndHandle=this.connect(this.domNode,css3.name("animationEnd"),"onAnimationEnd"),this._animStartHandle=this.connect(this.domNode,css3.name("animationStart"),"onAnimationStart"),config.mblCSS3Transition||(this._transEndHandle=this.connect(this.domNode,css3.name("transitionEnd"),"onAnimationEnd")),has("mblAndroid3Workaround")&&domStyle.set(this.domNode,css3.name("transformStyle"),"preserve-3d"),viewRegistry.add(this),this.inherited(arguments)},startup:function(){if(this._started)return;if(this._visible===undefined){var views=this.getSiblingViews(),ids=location.hash&&location.hash.substring(1).split(/,/),fragView,selectedView,firstView;array.forEach(views,function(v,i){array.indexOf(ids,v.id)!==-1&&(fragView=v),i==0&&(firstView=v),v.selected&&(selectedView=v),v._visible=!1},this),(fragView||selectedView||firstView)._visible=!0}this._visible&&(this.show(!0,!0),this.defer(function(){this.onStartView(),connect.publish("/dojox/mobile/startView",[this])})),this.domNode.style.visibility!="visible"&&(this.domNode.style.visibility="visible"),this.inherited(arguments);var parent=this.getParent();(!parent||!parent.resize)&&this.resize(),this._visible||this.hide()},resize:function(){array.forEach(this.getChildren(),function(child){child.resize&&child.resize()})},onStartView:function(){},onBeforeTransitionIn:function(moveTo,dir,transition,context,method){},onAfterTransitionIn:function(moveTo,dir,transition,context,method){},onBeforeTransitionOut:function(moveTo,dir,transition,context,method){},onAfterTransitionOut:function(moveTo,dir,transition,context,method){},_clearClasses:function(node){if(!node)return;var classes=[];array.forEach(lang.trim(node.className||"").split(/\s+/),function(c){(c.match(/^mbl\w*View$/)||c.indexOf("mbl")===-1)&&classes.push(c)},this),node.className=classes.join(" ")},_fixViewState:function(toNode){var nodes=this.domNode.parentNode.childNodes;for(var i=0;i<nodes.length;i++){var n=nodes[i];n.nodeType===1&&domClass.contains(n,"mblView")&&this._clearClasses(n)}this._clearClasses(toNode);var toWidget=registry.byNode(toNode);toWidget&&(toWidget._inProgress=!1)},convertToId:function(moveTo){return typeof moveTo=="string"?moveTo.replace(/^#?([^&?]+).*/,"$1"):moveTo},_isBookmarkable:function(detail){return detail.moveTo&&(config.mblForceBookmarkable||detail.moveTo.charAt(0)==="#")&&!detail.hashchange},performTransition:function(moveTo,transitionDir,transition,context,method){if(this._inProgress)return;this._inProgress=!0;var detail,optArgs;if(moveTo&&typeof moveTo=="object")detail=moveTo,optArgs=transitionDir;else{detail={moveTo:moveTo,transitionDir:transitionDir,transition:transition,context:context,method:method},optArgs=[];for(var i=5;i<arguments.length;i++)optArgs.push(arguments[i])}this._detail=detail,this._optArgs=optArgs,this._arguments=[detail.moveTo,detail.transitionDir,detail.transition,detail.context,detail.method];if(detail.moveTo==="#")return;var toNode;detail.moveTo?toNode=this.convertToId(detail.moveTo):(this._dummyNode||(this._dummyNode=win.doc.createElement("div"),win.body().appendChild(this._dummyNode)),toNode=this._dummyNode),this.addTransitionInfo&&typeof detail.moveTo=="string"&&this._isBookmarkable(detail)&&this.addTransitionInfo(this.id,detail.moveTo,{transitionDir:detail.transitionDir,transition:detail.transition});var fromNode=this.domNode,fromTop=fromNode.offsetTop;toNode=this.toNode=dom.byId(toNode);if(!toNode){0;return}toNode.style.visibility="hidden",toNode.style.display="",this._fixViewState(toNode);var toWidget=registry.byNode(toNode);if(toWidget){if(config.mblAlwaysResizeOnTransition||!toWidget._resized)common.resizeAll(null,toWidget),toWidget._resized=!0;detail.transition&&detail.transition!="none"&&(toWidget.containerNode.style.paddingTop=fromTop+"px"),toWidget.load&&toWidget.load(),toWidget.movedFrom=fromNode.id}has("mblAndroidWorkaround")&&!config.mblCSS3Transition&&detail.transition&&detail.transition!="none"&&(domStyle.set(toNode,css3.name("transformStyle"),"preserve-3d"),domStyle.set(fromNode,css3.name("transformStyle"),"preserve-3d"),domClass.add(toNode,"mblAndroidWorkaround")),this.onBeforeTransitionOut.apply(this,this._arguments),connect.publish("/dojox/mobile/beforeTransitionOut",[this].concat(lang._toArray(this._arguments)));if(toWidget){if(this.keepScrollPos&&!this.getParent()){var scrollTop=win.body().scrollTop||win.doc.documentElement.scrollTop||win.global.pageYOffset||0;fromNode._scrollTop=scrollTop;var toTop=detail.transitionDir==1?0:toNode._scrollTop||0;toNode.style.top="0px";if(scrollTop>1||toTop!==0)fromNode.style.top=toTop-scrollTop+"px",config.mblHideAddressBar!==!1&&setTimeout(function(){win.global.scrollTo(0,toTop||1)},0)}else toNode.style.top="0px";toWidget.onBeforeTransitionIn.apply(toWidget,this._arguments),connect.publish("/dojox/mobile/beforeTransitionIn",[toWidget].concat(lang._toArray(this._arguments)))}toNode.style.display="none",toNode.style.visibility="visible",common.fromView=this,common.toView=toWidget,this._doTransition(fromNode,toNode,detail.transition,detail.transitionDir)},_toCls:function(s){return"mbl"+s.charAt(0).toUpperCase()+s.substring(1)},_doTransition:function(fromNode,toNode,transition,transitionDir){var rev=transitionDir==-1?" mblReverse":"";toNode.style.display="";if(!transition||transition=="none")this.domNode.style.display="none",this.invokeCallback();else if(config.mblCSS3Transition)Deferred.when(transitDeferred,lang.hitch(this,function(transit){var toPosition=domStyle.get(toNode,"position");domStyle.set(toNode,"position","absolute"),Deferred.when(transit(fromNode,toNode,{transition:transition,reverse:transitionDir===-1?!0:!1}),lang.hitch(this,function(){domStyle.set(toNode,"position",toPosition),toNode.style.paddingTop="",this.invokeCallback()}))}));else{transition.indexOf("cube")!=-1&&(has("ipad")?domStyle.set(toNode.parentNode,{webkitPerspective:1600}):has("iphone")&&domStyle.set(toNode.parentNode,{webkitPerspective:800}));var s=this._toCls(transition);has("mblAndroidWorkaround")?setTimeout(function(){domClass.add(fromNode,s+" mblOut"+rev),domClass.add(toNode,s+" mblIn"+rev),domClass.remove(toNode,"mblAndroidWorkaround"),setTimeout(function(){domClass.add(fromNode,"mblTransition"),domClass.add(toNode,"mblTransition")},30)},70):(domClass.add(fromNode,s+" mblOut"+rev),domClass.add(toNode,s+" mblIn"+rev),setTimeout(function(){domClass.add(fromNode,"mblTransition"),domClass.add(toNode,"mblTransition")},100));var fromOrigin="50% 50%",toOrigin="50% 50%",scrollTop,posX,posY;if(transition.indexOf("swirl")!=-1||transition.indexOf("zoom")!=-1)this.keepScrollPos&&!this.getParent()?scrollTop=win.body().scrollTop||win.doc.documentElement.scrollTop||win.global.pageYOffset||0:scrollTop=-domGeometry.position(fromNode,!0).y,posY=win.global.innerHeight/2+scrollTop,fromOrigin="50% "+posY+"px",toOrigin="50% "+posY+"px";else if(transition.indexOf("scale")!=-1){var viewPos=domGeometry.position(fromNode,!0);posX=(this.clickedPosX!==undefined?this.clickedPosX:win.global.innerWidth/2)-viewPos.x,this.keepScrollPos&&!this.getParent()?scrollTop=win.body().scrollTop||win.doc.documentElement.scrollTop||win.global.pageYOffset||0:scrollTop=-viewPos.y,posY=(this.clickedPosY!==undefined?this.clickedPosY:win.global.innerHeight/2)+scrollTop,fromOrigin=posX+"px "+posY+"px",toOrigin=posX+"px "+posY+"px"}domStyle.set(fromNode,css3.add({},{transformOrigin:fromOrigin})),domStyle.set(toNode,css3.add({},{transformOrigin:toOrigin}))}},onAnimationStart:function(e){},onAnimationEnd:function(e){var name=e.animationName||e.target.className;if(name.indexOf("Out")===-1&&name.indexOf("In")===-1&&name.indexOf("Shrink")===-1)return;var isOut=!1;domClass.contains(this.domNode,"mblOut")?(isOut=!0,this.domNode.style.display="none",domClass.remove(this.domNode,[this._toCls(this._detail.transition),"mblIn","mblOut","mblReverse"])):this.containerNode.style.paddingTop="",domStyle.set(this.domNode,css3.add({},{transformOrigin:""}));if(name.indexOf("Shrink")!==-1){var li=e.target;li.style.display="none",domClass.remove(li,"mblCloseContent");var p=viewRegistry.getEnclosingScrollable(this.domNode);p&&p.onTouchEnd()}isOut&&this.invokeCallback(),this._clearClasses(this.domNode),this.clickedPosX=this.clickedPosY=undefined,name.indexOf("Cube")!==-1&&name.indexOf("In")!==-1&&has("iphone")&&(this.domNode.parentNode.style[css3.name("perspective")]="")},invokeCallback:function(){this.onAfterTransitionOut.apply(this,this._arguments),connect.publish("/dojox/mobile/afterTransitionOut",[this].concat(this._arguments));var toWidget=registry.byNode(this.toNode);toWidget&&(toWidget.onAfterTransitionIn.apply(toWidget,this._arguments),connect.publish("/dojox/mobile/afterTransitionIn",[toWidget].concat(this._arguments)),toWidget.movedFrom=undefined,this.setFragIds&&this._isBookmarkable(this._detail)&&this.setFragIds(toWidget)),has("mblAndroidWorkaround")&&setTimeout(lang.hitch(this,function(){toWidget&&domStyle.set(this.toNode,css3.name("transformStyle"),""),domStyle.set(this.domNode,css3.name("transformStyle"),"")}),0);var c=this._detail.context,m=this._detail.method;if(c||m)m||(m=c,c=null),c=c||win.global,typeof m=="string"?c[m].apply(c,this._optArgs):typeof m=="function"&&m.apply(c,this._optArgs);this._detail=this._optArgs=this._arguments=undefined,this._inProgress=!1},isVisible:function(checkAncestors){var visible=function(node){return domStyle.get(node,"display")!=="none"};if(checkAncestors){for(var n=this.domNode;n.tagName!=="BODY";n=n.parentNode)if(!visible(n))return!1;return!0}return visible(this.domNode)},getShowingView:function(){var nodes=this.domNode.parentNode.childNodes;for(var i=0;i<nodes.length;i++){var n=nodes[i];if(n.nodeType===1&&domClass.contains(n,"mblView")&&n.style.display!=="none")return registry.byNode(n)}return null},getSiblingViews:function(){return this.domNode.parentNode?array.map(array.filter(this.domNode.parentNode.childNodes,function(n){return n.nodeType===1&&domClass.contains(n,"mblView")}),function(n){return registry.byNode(n)}):[this]},show:function(noEvent,doNotHideOthers){var out=this.getShowingView();noEvent||(out&&(out.onBeforeTransitionOut(out.id),connect.publish("/dojox/mobile/beforeTransitionOut",[out,out.id])),this.onBeforeTransitionIn(this.id),connect.publish("/dojox/mobile/beforeTransitionIn",[this,this.id])),doNotHideOthers?this.domNode.style.display="":array.forEach(this.getSiblingViews(),function(v){v.domNode.style.display=v===this?"":"none"},this),this.load&&this.load(),noEvent||(out&&(out.onAfterTransitionOut(out.id),connect.publish("/dojox/mobile/afterTransitionOut",[out,out.id])),this.onAfterTransitionIn(this.id),connect.publish("/dojox/mobile/afterTransitionIn",[this,this.id]))},hide:function(){this.domNode.style.display="none"}})})