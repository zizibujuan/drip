//>>built
define("dojox/mobile/app/ImageView",["dojo","dijit","dojox","dojo/require!dojox/mobile/app/_Widget,dojo/fx/easing"],function(dojo,dijit,dojox){dojo.provide("dojox.mobile.app.ImageView"),dojo.experimental("dojox.mobile.app.ImageView"),dojo.require("dojox.mobile.app._Widget"),dojo.require("dojo.fx.easing"),dojo.declare("dojox.mobile.app.ImageView",dojox.mobile.app._Widget,{zoom:1,zoomCenterX:0,zoomCenterY:0,maxZoom:5,autoZoomLevel:3,disableAutoZoom:!1,disableSwipe:!1,autoZoomEvent:null,_leftImg:null,_centerImg:null,_rightImg:null,_leftSmallImg:null,_centerSmallImg:null,_rightSmallImg:null,constructor:function(){this.panX=0,this.panY=0,this.handleLoad=dojo.hitch(this,this.handleLoad),this._updateAnimatedZoom=dojo.hitch(this,this._updateAnimatedZoom),this._updateAnimatedPan=dojo.hitch(this,this._updateAnimatedPan),this._onAnimPanEnd=dojo.hitch(this,this._onAnimPanEnd)},buildRendering:function(){this.inherited(arguments),this.canvas=dojo.create("canvas",{},this.domNode),dojo.addClass(this.domNode,"mblImageView")},postCreate:function(){this.inherited(arguments),this.size=dojo.marginBox(this.domNode),dojo.style(this.canvas,{width:this.size.w+"px",height:this.size.h+"px"}),this.canvas.height=this.size.h,this.canvas.width=this.size.w;var _this=this;this.connect(this.domNode,"onmousedown",function(event){if(_this.isAnimating())return;_this.panX&&_this.handleDragEnd(),_this.downX=event.targetTouches?event.targetTouches[0].clientX:event.clientX,_this.downY=event.targetTouches?event.targetTouches[0].clientY:event.clientY}),this.connect(this.domNode,"onmousemove",function(event){if(_this.isAnimating())return;if(!_this.downX&&_this.downX!==0||!_this.downY&&_this.downY!==0)return;if(!_this.disableSwipe&&_this.zoom==1||!_this.disableAutoZoom&&_this.zoom!=1){var x=event.targetTouches?event.targetTouches[0].clientX:event.pageX,y=event.targetTouches?event.targetTouches[0].clientY:event.pageY;_this.panX=x-_this.downX,_this.panY=y-_this.downY,_this.zoom==1?Math.abs(_this.panX)>10&&_this.render():(Math.abs(_this.panX)>10||Math.abs(_this.panY)>10)&&_this.render()}}),this.connect(this.domNode,"onmouseout",function(event){!_this.isAnimating()&&_this.panX&&_this.handleDragEnd()}),this.connect(this.domNode,"onmouseover",function(event){_this.downX=_this.downY=null}),this.connect(this.domNode,"onclick",function(event){if(_this.isAnimating())return;if(_this.downX==null||_this.downY==null)return;var x=event.targetTouches?event.targetTouches[0].clientX:event.pageX,y=event.targetTouches?event.targetTouches[0].clientY:event.pageY;if(Math.abs(_this.panX)>14||Math.abs(_this.panY)>14){_this.downX=_this.downY=null,_this.handleDragEnd();return}_this.downX=_this.downY=null;if(!_this.disableAutoZoom){if(!_this._centerImg||!_this._centerImg._loaded)return;if(_this.zoom!=1){_this.set("animatedZoom",1);return}var pos=dojo._abs(_this.domNode),xRatio=_this.size.w/_this._centerImg.width,yRatio=_this.size.h/_this._centerImg.height;_this.zoomTo((x-pos.x)/xRatio-_this.panX,(y-pos.y)/yRatio-_this.panY,_this.autoZoomLevel)}}),dojo.connect(this.domNode,"flick",this,"handleFlick")},isAnimating:function(){return this._anim&&this._anim.status()=="playing"},handleDragEnd:function(){this.downX=this.downY=null,0;if(this.zoom==1){if(!this.panX)return;var leftLoaded=this._leftImg&&this._leftImg._loaded||this._leftSmallImg&&this._leftSmallImg._loaded,rightLoaded=this._rightImg&&this._rightImg._loaded||this._rightSmallImg&&this._rightSmallImg._loaded,doMove=!(Math.abs(this.panX)<this._centerImg._baseWidth/2)&&((this.panX>0&&leftLoaded?1:0)||(this.panX<0&&rightLoaded?1:0));doMove?this.moveTo(this.panX):this._animPanTo(0,dojo.fx.easing.expoOut,700)}else{if(!this.panX&&!this.panY)return;this.zoomCenterX-=this.panX/this.zoom,this.zoomCenterY-=this.panY/this.zoom,this.panX=this.panY=0}},handleFlick:function(event){this.zoom==1&&event.duration<500&&(event.direction=="ltr"?this.moveTo(1):event.direction=="rtl"&&this.moveTo(-1),this.downX=this.downY=null)},moveTo:function(direction){direction=direction>0?1:-1;var toImg;direction<1?this._rightImg&&this._rightImg._loaded?toImg=this._rightImg:this._rightSmallImg&&this._rightSmallImg._loaded&&(toImg=this._rightSmallImg):this._leftImg&&this._leftImg._loaded?toImg=this._leftImg:this._leftSmallImg&&this._leftSmallImg._loaded&&(toImg=this._leftSmallImg),this._moveDir=direction;var _this=this;toImg&&toImg._loaded?this._animPanTo(this.size.w*direction,null,500,function(){_this.panX=0,_this.panY=0,direction<0?_this._switchImage("left","right"):_this._switchImage("right","left"),_this.render(),_this.onChange(direction*-1)}):(0,this._animPanTo(0,dojo.fx.easing.expoOut,700))},_switchImage:function(toImg,fromImg){var toSmallImgName="_"+toImg+"SmallImg",toImgName="_"+toImg+"Img",fromSmallImgName="_"+fromImg+"SmallImg",fromImgName="_"+fromImg+"Img";this[toImgName]=this._centerImg,this[toSmallImgName]=this._centerSmallImg,this[toImgName]._type=toImg,this[toSmallImgName]&&(this[toSmallImgName]._type=toImg),this._centerImg=this[fromImgName],this._centerSmallImg=this[fromSmallImgName],this._centerImg._type="center",this._centerSmallImg&&(this._centerSmallImg._type="center"),this[fromImgName]=this[fromSmallImgName]=null},_animPanTo:function(to,easing,duration,callback){return this._animCallback=callback,this._anim=new dojo.Animation({curve:[this.panX,to],onAnimate:this._updateAnimatedPan,duration:duration||500,easing:easing,onEnd:this._onAnimPanEnd}),this._anim.play(),this._anim},onChange:function(direction){},_updateAnimatedPan:function(amount){this.panX=amount,this.render()},_onAnimPanEnd:function(){this.panX=this.panY=0,this._animCallback&&this._animCallback()},zoomTo:function(centerX,centerY,zoom){this.set("zoomCenterX",centerX),this.set("zoomCenterY",centerY),this.set("animatedZoom",zoom)},render:function(){var cxt=this.canvas.getContext("2d");cxt.clearRect(0,0,this.canvas.width,this.canvas.height),this._renderImg(this._centerSmallImg,this._centerImg,this.zoom==1?this.panX<0?1:this.panX>0?-1:0:0),this.zoom==1&&this.panX!=0&&(this.panX>0?this._renderImg(this._leftSmallImg,this._leftImg,1):this._renderImg(this._rightSmallImg,this._rightImg,-1))},_renderImg:function(smallImg,largeImg,panDir){var img=largeImg&&largeImg._loaded?largeImg:smallImg;if(!img||!img._loaded)return;var cxt=this.canvas.getContext("2d"),baseWidth=img._baseWidth,baseHeight=img._baseHeight,desiredWidth=baseWidth*this.zoom,desiredHeight=baseHeight*this.zoom,destWidth=Math.min(this.size.w,desiredWidth),destHeight=Math.min(this.size.h,desiredHeight),sourceWidth=this.dispWidth=img.width*(destWidth/desiredWidth),sourceHeight=this.dispHeight=img.height*(destHeight/desiredHeight),zoomCenterX=this.zoomCenterX-this.panX/this.zoom,zoomCenterY=this.zoomCenterY-this.panY/this.zoom,centerX=Math.floor(Math.max(sourceWidth/2,Math.min(img.width-sourceWidth/2,zoomCenterX))),centerY=Math.floor(Math.max(sourceHeight/2,Math.min(img.height-sourceHeight/2,zoomCenterY))),sourceX=Math.max(0,Math.round((img.width-sourceWidth)/2+(centerX-img._centerX))),sourceY=Math.max(0,Math.round((img.height-sourceHeight)/2+(centerY-img._centerY))),destX=Math.round(Math.max(0,this.canvas.width-destWidth)/2),destY=Math.round(Math.max(0,this.canvas.height-destHeight)/2),oldDestWidth=destWidth,oldSourceWidth=sourceWidth;this.zoom==1&&panDir&&this.panX&&(this.panX<0?panDir>0?(destWidth-=Math.abs(this.panX),destX=0):panDir<0&&(destWidth=Math.max(1,Math.abs(this.panX)-5),destX=this.size.w-destWidth):panDir>0?(destWidth=Math.max(1,Math.abs(this.panX)-5),destX=0):panDir<0&&(destWidth-=Math.abs(this.panX),destX=this.size.w-destWidth),sourceWidth=Math.max(1,Math.floor(sourceWidth*(destWidth/oldDestWidth))),panDir>0&&(sourceX=sourceX+oldSourceWidth-sourceWidth),sourceX=Math.floor(sourceX));try{cxt.drawImage(img,Math.max(0,sourceX),sourceY,Math.min(oldSourceWidth,sourceWidth),sourceHeight,destX,destY,Math.min(oldDestWidth,destWidth),destHeight)}catch(e){0}},_setZoomAttr:function(amount){this.zoom=Math.min(this.maxZoom,Math.max(1,amount)),this.zoom==1&&this._centerImg&&this._centerImg._loaded&&(this.isAnimating()||(this.zoomCenterX=this._centerImg.width/2,this.zoomCenterY=this._centerImg.height/2),this.panX=this.panY=0),this.render()},_setZoomCenterXAttr:function(value){value!=this.zoomCenterX&&(this._centerImg&&this._centerImg._loaded&&(value=Math.min(this._centerImg.width,value)),this.zoomCenterX=Math.max(0,Math.round(value)))},_setZoomCenterYAttr:function(value){value!=this.zoomCenterY&&(this._centerImg&&this._centerImg._loaded&&(value=Math.min(this._centerImg.height,value)),this.zoomCenterY=Math.max(0,Math.round(value)))},_setZoomCenterAttr:function(value){if(value.x!=this.zoomCenterX||value.y!=this.zoomCenterY)this.set("zoomCenterX",value.x),this.set("zoomCenterY",value.y),this.render()},_setAnimatedZoomAttr:function(amount){if(this._anim&&this._anim.status()=="playing")return;this._anim=new dojo.Animation({curve:[this.zoom,amount],onAnimate:this._updateAnimatedZoom,onEnd:this._onAnimEnd}),this._anim.play()},_updateAnimatedZoom:function(amount){this._setZoomAttr(amount)},_setCenterUrlAttr:function(urlOrObj){this._setImage("center",urlOrObj)},_setLeftUrlAttr:function(urlOrObj){this._setImage("left",urlOrObj)},_setRightUrlAttr:function(urlOrObj){this._setImage("right",urlOrObj)},_setImage:function(name,urlOrObj){var smallUrl=null,largeUrl=null;dojo.isString(urlOrObj)?largeUrl=urlOrObj:(largeUrl=urlOrObj.large,smallUrl=urlOrObj.small);if(this["_"+name+"Img"]&&this["_"+name+"Img"]._src==largeUrl)return;var largeImg=this["_"+name+"Img"]=new Image;largeImg._type=name,largeImg._loaded=!1,largeImg._src=largeUrl,largeImg._conn=dojo.connect(largeImg,"onload",this.handleLoad);if(smallUrl){var smallImg=this["_"+name+"SmallImg"]=new Image;smallImg._type=name,smallImg._loaded=!1,smallImg._conn=dojo.connect(smallImg,"onload",this.handleLoad),smallImg._isSmall=!0,smallImg._src=smallUrl,smallImg.src=smallUrl}largeImg.src=largeUrl},handleLoad:function(evt){var img=evt.target;img._loaded=!0,dojo.disconnect(img._conn);var type=img._type;switch(type){case"center":this.zoomCenterX=img.width/2,this.zoomCenterY=img.height/2}var height=img.height,width=img.width;width/this.size.w<height/this.size.h?(img._baseHeight=this.canvas.height,img._baseWidth=width/(height/this.size.h)):(img._baseWidth=this.canvas.width,img._baseHeight=height/(width/this.size.w)),img._centerX=width/2,img._centerY=height/2,this.render(),this.onLoad(img._type,img._src,img._isSmall)},onLoad:function(type,url,isSmall){}})})