//>>built
define("dojox/geo/charting/MouseInteractionSupport",["dojo/_base/lang","dojo/_base/declare","dojo/_base/event","dojo/_base/connect","dojo/_base/window","dojo/_base/html","dojo/dom","dojo/_base/sniff"],function(lang,declare,event,connect,win,html,dom,has){return declare("dojox.geo.charting.MouseInteractionSupport",null,{_map:null,_mapClickLocation:null,_screenClickLocation:null,_mouseDragListener:null,_mouseUpListener:null,_mouseUpClickListener:null,_mouseDownListener:null,_mouseMoveListener:null,_mouseWheelListener:null,_currentFeature:null,_cancelMouseClick:null,_zoomEnabled:!1,_panEnabled:!1,_onDragStartListener:null,_onSelectStartListener:null,mouseClickThreshold:2,constructor:function(map,options){this._map=map,this._mapClickLocation={x:0,y:0},this._screenClickLocation={x:0,y:0},this._cancelMouseClick=!1,options&&(this._zoomEnabled=options.enableZoom,this._panEnabled=options.enablePan,options.mouseClickThreshold&&options.mouseClickThreshold>0&&(this.mouseClickThreshold=options.mouseClickThreshold))},setEnableZoom:function(enable){if(enable&&!this._mouseWheelListener){var wheelEventName=has("mozilla")?"DOMMouseScroll":"onmousewheel";this._mouseWheelListener=this._map.surface.connect(wheelEventName,this,this._mouseWheelHandler)}else!enable&&this._mouseWheelListener&&(connect.disconnect(this._mouseWheelListener),this._mouseWheelListener=null);this._zoomEnabled=enable},setEnablePan:function(enable){this._panEnabled=enable},connect:function(){this._mouseMoveListener=this._map.surface.connect("onmousemove",this,this._mouseMoveHandler),this._mouseDownListener=this._map.surface.connect("onmousedown",this,this._mouseDownHandler),has("ie")&&(_onDragStartListener=connect.connect(win.doc,"ondragstart",this,event.stop),_onSelectStartListener=connect.connect(win.doc,"onselectstart",this,event.stop)),this.setEnableZoom(this._zoomEnabled),this.setEnablePan(this._panEnabled)},disconnect:function(){var isZoom=this._zoomEnabled;this.setEnableZoom(!1),this._zoomEnabled=isZoom,this._mouseMoveListener&&(connect.disconnect(this._mouseMoveListener),this._mouseMoveListener=null,connect.disconnect(this._mouseDownListener),this._mouseDownListener=null),this._onDragStartListener&&(connect.disconnect(this._onDragStartListener),this._onDragStartListener=null,connect.disconnect(this._onSelectStartListener),this._onSelectStartListener=null)},_mouseClickHandler:function(mouseEvent){var feature=this._getFeatureFromMouseEvent(mouseEvent);if(feature)feature._onclickHandler(mouseEvent);else{for(var name in this._map.mapObj.features)this._map.mapObj.features[name].select(!1);this._map.onFeatureClick(null)}},_mouseDownHandler:function(mouseEvent){event.stop(mouseEvent),this._map.focused=!0,this._cancelMouseClick=!1,this._screenClickLocation.x=mouseEvent.pageX,this._screenClickLocation.y=mouseEvent.pageY;var containerBounds=this._map._getContainerBounds(),offX=mouseEvent.pageX-containerBounds.x,offY=mouseEvent.pageY-containerBounds.y,mapPoint=this._map.screenCoordsToMapCoords(offX,offY);this._mapClickLocation.x=mapPoint.x,this._mapClickLocation.y=mapPoint.y;if(!has("ie"))this._mouseDragListener=connect.connect(win.doc,"onmousemove",this,this._mouseDragHandler),this._mouseUpClickListener=this._map.surface.connect("onmouseup",this,this._mouseUpClickHandler),this._mouseUpListener=connect.connect(win.doc,"onmouseup",this,this._mouseUpHandler);else{var node=dom.byId(this._map.container);this._mouseDragListener=connect.connect(node,"onmousemove",this,this._mouseDragHandler),this._mouseUpClickListener=this._map.surface.connect("onmouseup",this,this._mouseUpClickHandler),this._mouseUpListener=this._map.surface.connect("onmouseup",this,this._mouseUpHandler),this._map.surface.rawNode.setCapture()}},_mouseUpClickHandler:function(mouseEvent){this._cancelMouseClick||this._mouseClickHandler(mouseEvent),this._cancelMouseClick=!1},_mouseUpHandler:function(mouseEvent){event.stop(mouseEvent),this._map.mapObj.marker._needTooltipRefresh=!0,this._mouseDragListener&&(connect.disconnect(this._mouseDragListener),this._mouseDragListener=null),this._mouseUpClickListener&&(connect.disconnect(this._mouseUpClickListener),this._mouseUpClickListener=null),this._mouseUpListener&&(connect.disconnect(this._mouseUpListener),this._mouseUpListener=null),has("ie")&&this._map.surface.rawNode.releaseCapture()},_getFeatureFromMouseEvent:function(mouseEvent){var feature=null;return mouseEvent.gfxTarget&&mouseEvent.gfxTarget.getParent&&(feature=this._map.mapObj.features[mouseEvent.gfxTarget.getParent().id]),feature},_mouseMoveHandler:function(mouseEvent){if(this._mouseDragListener&&this._panEnabled)return;var feature=this._getFeatureFromMouseEvent(mouseEvent);feature!=this._currentFeature&&(this._currentFeature&&this._currentFeature._onmouseoutHandler(),this._currentFeature=feature,feature&&feature._onmouseoverHandler()),feature&&feature._onmousemoveHandler(mouseEvent)},_mouseDragHandler:function(mouseEvent){event.stop(mouseEvent);var dx=Math.abs(mouseEvent.pageX-this._screenClickLocation.x),dy=Math.abs(mouseEvent.pageY-this._screenClickLocation.y);!this._cancelMouseClick&&(dx>this.mouseClickThreshold||dy>this.mouseClickThreshold)&&(this._cancelMouseClick=!0,this._panEnabled&&this._map.mapObj.marker.hide());if(!this._panEnabled)return;var cBounds=this._map._getContainerBounds(),offX=mouseEvent.pageX-cBounds.x,offY=mouseEvent.pageY-cBounds.y,mapPoint=this._map.screenCoordsToMapCoords(offX,offY),mapOffsetX=mapPoint.x-this._mapClickLocation.x,mapOffsetY=mapPoint.y-this._mapClickLocation.y,currentMapCenter=this._map.getMapCenter();this._map.setMapCenter(currentMapCenter.x-mapOffsetX,currentMapCenter.y-mapOffsetY)},_mouseWheelHandler:function(mouseEvent){event.stop(mouseEvent),this._map.mapObj.marker.hide();var containerBounds=this._map._getContainerBounds(),offX=mouseEvent.pageX-containerBounds.x,offY=mouseEvent.pageY-containerBounds.y,invariantMapPoint=this._map.screenCoordsToMapCoords(offX,offY),power=mouseEvent[has("mozilla")?"detail":"wheelDelta"]/(has("mozilla")?-3:120),scaleFactor=Math.pow(1.2,power);this._map.setMapScaleAt(this._map.getMapScale()*scaleFactor,invariantMapPoint.x,invariantMapPoint.y,!1),this._map.mapObj.marker._needTooltipRefresh=!0}})})