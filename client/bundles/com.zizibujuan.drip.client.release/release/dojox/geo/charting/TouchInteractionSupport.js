//>>built
define("dojox/geo/charting/TouchInteractionSupport",["dojo/_base/lang","dojo/_base/declare","dojo/_base/event","dojo/_base/connect","dojo/_base/window"],function(lang,declare,event,connect,win){return declare("dojox.geo.charting.TouchInteractionSupport",null,{_map:null,_centerTouchLocation:null,_touchMoveListener:null,_touchEndListener:null,_touchEndTapListener:null,_touchStartListener:null,_initialFingerSpacing:null,_initialScale:null,_tapCount:null,_tapThreshold:null,_lastTap:null,_doubleTapPerformed:!1,_oneFingerTouch:!1,_tapCancel:!1,constructor:function(map){this._map=map,this._centerTouchLocation={x:0,y:0},this._tapCount=0,this._lastTap={x:0,y:0},this._tapThreshold=100},connect:function(){this._touchStartListener=this._map.surface.connect("touchstart",this,this._touchStartHandler)},disconnect:function(){this._touchStartListener&&(connect.disconnect(this._touchStartListener),this._touchStartListener=null)},_getTouchBarycenter:function(touchEvent){var touches=touchEvent.touches,firstTouch=touches[0],secondTouch=null;touches.length>1?secondTouch=touches[1]:secondTouch=touches[0];var containerBounds=this._map._getContainerBounds(),middleX=(firstTouch.pageX+secondTouch.pageX)/2-containerBounds.x,middleY=(firstTouch.pageY+secondTouch.pageY)/2-containerBounds.y;return{x:middleX,y:middleY}},_getFingerSpacing:function(touchEvent){var touches=touchEvent.touches,spacing=-1;if(touches.length>=2){var dx=touches[1].pageX-touches[0].pageX,dy=touches[1].pageY-touches[0].pageY;spacing=Math.sqrt(dx*dx+dy*dy)}return spacing},_isDoubleTap:function(touchEvent){var isDoubleTap=!1,touches=touchEvent.touches;if(this._tapCount>0&&touches.length==1){var dx=touches[0].pageX-this._lastTap.x,dy=touches[0].pageY-this._lastTap.y,distance=dx*dx+dy*dy;distance<this._tapThreshold?isDoubleTap=!0:this._tapCount=0}return this._tapCount++,this._lastTap.x=touches[0].pageX,this._lastTap.y=touches[0].pageY,setTimeout(lang.hitch(this,function(){this._tapCount=0}),300),isDoubleTap},_doubleTapHandler:function(touchEvent){var feature=this._getFeatureFromTouchEvent(touchEvent);if(feature)this._map.fitToMapArea(feature._bbox,15,!0);else{var touches=touchEvent.touches,containerBounds=this._map._getContainerBounds(),offX=touches[0].pageX-containerBounds.x,offY=touches[0].pageY-containerBounds.y,mapPoint=this._map.screenCoordsToMapCoords(offX,offY);this._map.setMapCenterAndScale(mapPoint.x,mapPoint.y,this._map.getMapScale()*2,!0)}},_getFeatureFromTouchEvent:function(touchEvent){var feature=null;return touchEvent.gfxTarget&&touchEvent.gfxTarget.getParent&&(feature=this._map.mapObj.features[touchEvent.gfxTarget.getParent().id]),feature},_touchStartHandler:function(touchEvent){event.stop(touchEvent),this._oneFingerTouch=touchEvent.touches.length==1,this._tapCancel=!this._oneFingerTouch,this._doubleTapPerformed=!1;if(this._isDoubleTap(touchEvent)){this._doubleTapHandler(touchEvent),this._doubleTapPerformed=!0;return}var middlePoint=this._getTouchBarycenter(touchEvent),mapPoint=this._map.screenCoordsToMapCoords(middlePoint.x,middlePoint.y);this._centerTouchLocation.x=mapPoint.x,this._centerTouchLocation.y=mapPoint.y,this._initialFingerSpacing=this._getFingerSpacing(touchEvent),this._initialScale=this._map.getMapScale(),this._touchMoveListener||(this._touchMoveListener=connect.connect(win.global,"touchmove",this,this._touchMoveHandler)),this._touchEndTapListener||(this._touchEndTapListener=this._map.surface.connect("touchend",this,this._touchEndTapHandler)),this._touchEndListener||(this._touchEndListener=connect.connect(win.global,"touchend",this,this._touchEndHandler))},_touchEndTapHandler:function(touchEvent){var touches=touchEvent.touches;touches.length==0&&(this._oneFingerTouch&&!this._tapCancel&&(this._oneFingerTouch=!1,setTimeout(lang.hitch(this,function(){if(!this._doubleTapPerformed){var dx=touchEvent.changedTouches[0].pageX-this._lastTap.x,dy=touchEvent.changedTouches[0].pageY-this._lastTap.y,distance=dx*dx+dy*dy;distance<this._tapThreshold&&this._singleTapHandler(touchEvent)}}),350)),this._tapCancel=!1)},_touchEndHandler:function(touchEvent){event.stop(touchEvent);var touches=touchEvent.touches;if(touches.length==0)this._touchMoveListener&&(connect.disconnect(this._touchMoveListener),this._touchMoveListener=null),this._touchEndListener&&(connect.disconnect(this._touchEndListener),this._touchEndListener=null);else{var middlePoint=this._getTouchBarycenter(touchEvent),mapPoint=this._map.screenCoordsToMapCoords(middlePoint.x,middlePoint.y);this._centerTouchLocation.x=mapPoint.x,this._centerTouchLocation.y=mapPoint.y}},_singleTapHandler:function(touchEvent){var feature=this._getFeatureFromTouchEvent(touchEvent);if(feature)feature._onclickHandler(touchEvent);else{for(var name in this._map.mapObj.features)this._map.mapObj.features[name].select(!1);this._map.onFeatureClick(null)}},_touchMoveHandler:function(touchEvent){event.stop(touchEvent);if(!this._tapCancel){var dx=touchEvent.touches[0].pageX-this._lastTap.x,dy=touchEvent.touches[0].pageY-this._lastTap.y,distance=dx*dx+dy*dy;distance>this._tapThreshold&&(this._tapCancel=!0)}var middlePoint=this._getTouchBarycenter(touchEvent),mapPoint=this._map.screenCoordsToMapCoords(middlePoint.x,middlePoint.y),mapOffsetX=mapPoint.x-this._centerTouchLocation.x,mapOffsetY=mapPoint.y-this._centerTouchLocation.y,scaleFactor=1,touches=touchEvent.touches;if(touches.length>=2){var fingerSpacing=this._getFingerSpacing(touchEvent);scaleFactor=fingerSpacing/this._initialFingerSpacing,this._map.setMapScale(this._initialScale*scaleFactor)}var currentMapCenter=this._map.getMapCenter();this._map.setMapCenter(currentMapCenter.x-mapOffsetX,currentMapCenter.y-mapOffsetY)}})})