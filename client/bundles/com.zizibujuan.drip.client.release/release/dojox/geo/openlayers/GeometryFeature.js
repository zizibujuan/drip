//>>built
define("dojox/geo/openlayers/GeometryFeature",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojox/gfx/matrix","./Point","./LineString","./Collection","./Feature"],function(declare,array,lang,matrix,Point,LineString,Collection,Feature){return declare("dojox.geo.openlayers.GeometryFeature",Feature,{constructor:function(geometry){this._geometry=geometry,this._shapeProperties={},this._fill=null,this._stroke=null},_createCollection:function(g){var layer=this.getLayer(),s=layer.getSurface(),c=this.createShape(s,g),vp=layer.getViewport();return vp.add(c),c},_getCollectionShape:function(g){var s=g.shape;return s==null&&(s=this._createCollection(g),g.shape=s),s},renderCollection:function(g){g==undefined&&(g=this._geometry),s=this._getCollectionShape(g);var prop=this.getShapeProperties();s.setShape(prop),array.forEach(g.coordinates,function(item){if(item instanceof Point)this.renderPoint(item);else if(item instanceof LineString)this.renderLineString(item);else{if(!(item instanceof Collection))throw new Error;this.renderCollection(item)}},this),this._applyStyle(g)},render:function(g){g==undefined&&(g=this._geometry);if(g instanceof Point)this.renderPoint(g);else if(g instanceof LineString)this.renderLineString(g);else{if(!(g instanceof Collection))throw new Error;this.renderCollection(g)}},getShapeProperties:function(){return this._shapeProperties},setShapeProperties:function(s){return this._shapeProperties=s,this},createShape:function(s,g){g||(g=this._geometry);var shape=null;if(g instanceof Point)shape=s.createCircle();else if(g instanceof LineString)shape=s.createPolyline();else{if(!(g instanceof Collection))throw new Error;var grp=s.createGroup();array.forEach(g.coordinates,function(item){var shp=this.createShape(s,item);grp.add(shp)},this),shape=grp}return shape},getShape:function(){var g=this._geometry;return g?g.shape?g.shape:(this.render(),g.shape):null},_createPoint:function(g){var layer=this.getLayer(),s=layer.getSurface(),c=this.createShape(s,g),vp=layer.getViewport();return vp.add(c),c},_getPointShape:function(g){var s=g.shape;return s==null&&(s=this._createPoint(g),g.shape=s),s},renderPoint:function(g){g==undefined&&(g=this._geometry);var layer=this.getLayer(),map=layer.getDojoMap();s=this._getPointShape(g);var prop=lang.mixin({},this._defaults.pointShape);prop=lang.mixin(prop,this.getShapeProperties()),s.setShape(prop);var from=this.getCoordinateSystem(),p=map.transform(g.coordinates,from),a=this._getLocalXY(p),cx=a[0],cy=a[1],tr=layer.getViewport().getTransform();tr&&s.setTransform(matrix.translate(cx-tr.dx,cy-tr.dy)),this._applyStyle(g)},_createLineString:function(g){var layer=this.getLayer(),s=layer._surface,shape=this.createShape(s,g),vp=layer.getViewport();return vp.add(shape),g.shape=shape,shape},_getLineStringShape:function(g){var s=g.shape;return s==null&&(s=this._createLineString(g),g.shape=s),s},renderLineString:function(g){g==undefined&&(g=this._geometry);var layer=this.getLayer(),map=layer.getDojoMap(),lss=this._getLineStringShape(g),from=this.getCoordinateSystem(),points=new Array(g.coordinates.length),tr=layer.getViewport().getTransform();array.forEach(g.coordinates,function(c,i,array){var p=map.transform(c,from),a=this._getLocalXY(p);tr&&(a[0]-=tr.dx,a[1]-=tr.dy),points[i]={x:a[0],y:a[1]}},this);var prop=lang.mixin({},this._defaults.lineStringShape);prop=lang.mixin(prop,this.getShapeProperties()),prop=lang.mixin(prop,{points:points}),lss.setShape(prop),this._applyStyle(g)},_applyStyle:function(g){if(!g||!g.shape)return;var f=this.getFill(),fill;!f||lang.isString(f)||lang.isArray(f)?fill=f:(fill=lang.mixin({},this._defaults.fill),fill=lang.mixin(fill,f));var s=this.getStroke(),stroke;!s||lang.isString(s)||lang.isArray(s)?stroke=s:(stroke=lang.mixin({},this._defaults.stroke),stroke=lang.mixin(stroke,s)),this._applyRecusiveStyle(g,stroke,fill)},_applyRecusiveStyle:function(g,stroke,fill){var shp=g.shape;shp.setFill&&shp.setFill(fill),shp.setStroke&&shp.setStroke(stroke),g instanceof Collection&&array.forEach(g.coordinates,function(i){this._applyRecusiveStyle(i,stroke,fill)},this)},setStroke:function(s){return this._stroke=s,this},getStroke:function(){return this._stroke},setFill:function(f){return this._fill=f,this},getFill:function(){return this._fill},remove:function(){var g=this._geometry,shp=g.shape;g.shape=null,shp&&shp.removeShape(),g instanceof Collection&&array.forEach(g.coordinates,function(i){this.remove(i)},this)},_defaults:{fill:null,stroke:null,pointShape:{r:30},lineStringShape:null}})})