//>>built
define("dojox/geo/openlayers/Map",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/dom","dojo/dom-style","./_base","./TouchInteractionSupport","./Layer","./Patch"],function(kernel,declare,lang,array,json,dom,style,openlayers,TouchInteractionSupport,Layer,Patch){return kernel.experimental("dojox.geo.openlayers.Map"),Patch.patchGFX(),declare("dojox.geo.openlayers.Map",null,{olMap:null,_tp:null,constructor:function(div,options){options||(options={}),div=dom.byId(div),this._tp={x:0,y:0};var opts=options.openLayersMapOptions;opts||(opts={controls:[new OpenLayers.Control.ScaleLine({maxWidth:200}),new OpenLayers.Control.Navigation]});if(options.accessible){var kbd=new OpenLayers.Control.KeyboardDefaults;opts.controls||(opts.controls=[]),opts.controls.push(kbd)}var baseLayerType=options.baseLayerType;baseLayerType||(baseLayerType=openlayers.BaseLayerType.OSM);var map=new OpenLayers.Map(div,opts);this.olMap=map,this._layerDictionary={olLayers:[],layers:[]},options.touchHandler&&(this._touchControl=new TouchInteractionSupport(map));var base=this._createBaseLayer(options);this.addLayer(base),this.initialFit(options)},initialFit:function(params){var o=params.initialLocation;o||(o=[-160,70,160,-70]),this.fitTo(o)},setBaseLayerType:function(type){if(type==this.baseLayerType)return null;var o=null;typeof type=="string"?(o={baseLayerName:type,baseLayerType:type},this.baseLayerType=type):typeof type=="object"&&(o=type,this.baseLayerType=o.baseLayerType);var bl=null;if(o!=null){bl=this._createBaseLayer(o);if(bl!=null){var olm=this.olMap,ob=olm.getZoom(),oc=olm.getCenter(),recenter=!!oc&&!!olm.baseLayer&&!!olm.baseLayer.map;if(recenter){var proj=olm.getProjectionObject();proj!=null&&(oc=oc.transform(proj,openlayers.EPSG4326))}var old=olm.baseLayer;if(old!=null){var l=this._getLayer(old);this.removeLayer(l)}bl!=null&&this.addLayer(bl),recenter&&(proj=olm.getProjectionObject(),proj!=null&&(oc=oc.transform(openlayers.EPSG4326,proj)),olm.setCenter(oc,ob))}}return bl},getBaseLayerType:function(){return this.baseLayerType},getScale:function(geodesic){var scale=null,om=this.olMap;if(geodesic){var units=om.getUnits();if(!units)return null;var inches=OpenLayers.INCHES_PER_UNIT;scale=(om.getGeodesicPixelSize().w||1e-6)*inches.km*OpenLayers.DOTS_PER_INCH}else scale=om.getScale();return scale},getOLMap:function(){return this.olMap},_createBaseLayer:function(params){var base=null,type=params.baseLayerType,url=params.baseLayerUrl,name=params.baseLayerName,options=params.baseLayerOptions;name||(name=type),options||(options={});switch(type){case openlayers.BaseLayerType.OSM:options.transitionEffect="resize",base=new Layer(name,{olLayer:new OpenLayers.Layer.OSM(name,url,options)});break;case openlayers.BaseLayerType.WMS:url||(url="http://labs.metacarta.com/wms/vmap0",options.layers||(options.layers="basic")),base=new Layer(name,{olLayer:new OpenLayers.Layer.WMS(name,url,options,{transitionEffect:"resize"})});break;case openlayers.BaseLayerType.GOOGLE:base=new Layer(name,{olLayer:new OpenLayers.Layer.Google(name,options)});break;case openlayers.BaseLayerType.VIRTUAL_EARTH:base=new Layer(name,{olLayer:new OpenLayers.Layer.VirtualEarth(name,options)});break;case openlayers.BaseLayerType.YAHOO:base=new Layer(name,{olLayer:new OpenLayers.Layer.Yahoo(name,options)});break;case openlayers.BaseLayerType.ARCGIS:url||(url="http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer/export"),base=new Layer(name,{olLayer:new OpenLayers.Layer.ArcGIS93Rest(name,url,options,{})})}return base==null&&(type instanceof OpenLayers.Layer?base=type:(options.transitionEffect="resize",base=new Layer(name,{olLayer:new OpenLayers.Layer.OSM(name,url,options)}),this.baseLayerType=openlayers.BaseLayerType.OSM)),base},removeLayer:function(layer){var om=this.olMap,i=array.indexOf(this._layerDictionary.layers,layer);i>0&&this._layerDictionary.layers.splice(i,1);var oll=layer.olLayer,j=array.indexOf(this._layerDictionary.olLayers,oll);j>0&&this._layerDictionary.olLayers.splice(i,j),om.removeLayer(oll,!1)},layerIndex:function(layer,index){var olm=this.olMap;return index?(olm.setLayerIndex(layer.olLayer,index),this._layerDictionary.layers.sort(function(l1,l2){return olm.getLayerIndex(l1.olLayer)-olm.getLayerIndex(l2.olLayer)}),this._layerDictionary.olLayers.sort(function(l1,l2){return olm.getLayerIndex(l1)-olm.getLayerIndex(l2)}),index):olm.getLayerIndex(layer.olLayer)},addLayer:function(layer){layer.dojoMap=this;var om=this.olMap,ol=layer.olLayer;this._layerDictionary.olLayers.push(ol),this._layerDictionary.layers.push(layer),om.addLayer(ol),layer.added()},_getLayer:function(ol){var i=array.indexOf(this._layerDictionary.olLayers,ol);return i!=-1?this._layerDictionary.layers[i]:null},getLayer:function(property,value){var om=this.olMap,ols=om.getBy("layers",property,value),ret=new Array;return array.forEach(ols,function(ol){ret.push(this._getLayer(ol))},this),ret},getLayerCount:function(){var om=this.olMap;return om.layers==null?0:om.layers.length},fitTo:function(o){var map=this.olMap,from=openlayers.EPSG4326;if(o==null){var c=this.transformXY(0,0,from);map.setCenter(new OpenLayers.LonLat(c.x,c.y));return}var b=null;if(typeof o=="string")var j=json.fromJson(o);else j=o;var ul,lr;if(j.hasOwnProperty("bounds")){var a=j.bounds;b=new OpenLayers.Bounds,ul=this.transformXY(a[0],a[1],from),b.left=ul.x,b.top=ul.y,lr=this.transformXY(a[2],a[3],from),b.right=lr.x,b.bottom=lr.y}if(b==null&&j.hasOwnProperty("position")){var p=j.position,e=j.hasOwnProperty("extent")?j.extent:1;typeof e=="string"&&(e=parseFloat(e)),b=new OpenLayers.Bounds,ul=this.transformXY(p[0]-e,p[1]+e,from),b.left=ul.x,b.top=ul.y,lr=this.transformXY(p[0]+e,p[1]-e,from),b.right=lr.x,b.bottom=lr.y}b==null&&o.length==4&&(b=new OpenLayers.Bounds,ul=this.transformXY(o[0],o[1],from),b.left=ul.x,b.top=ul.y,lr=this.transformXY(o[2],o[3],from),b.right=lr.x,b.bottom=lr.y),b!=null&&map.zoomToExtent(b,!0)},transform:function(p,from,to){return this.transformXY(p.x,p.y,from,to)},transformXY:function(x,y,from,to){var tp=this._tp;return tp.x=x,tp.y=y,from||(from=openlayers.EPSG4326),to||(to=this.olMap.getProjectionObject()),tp=OpenLayers.Projection.transform(tp,from,to),tp}})})