//>>built
define("dojox/mdnd/AreaManager",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/window","dojo/_base/array","dojo/_base/sniff","dojo/_base/lang","dojo/query","dojo/topic","dojo/dom-class","dojo/dom-geometry","dojo/dom-construct","dijit/registry","dijit/_Widget","./Moveable"],function(dojo,declare,connect,win,array,sniff,lang,query,topic,domClass,geom,domConstruct,registry,_Widget,Moveable){var am=declare("dojox.mdnd.AreaManager",null,{autoRefresh:!0,areaClass:"dojoxDndArea",dragHandleClass:"dojoxDragHandle",constructor:function(){this._areaList=[],this.resizeHandler=connect.connect(dojo.global,"onresize",this,function(){this._dropMode.updateAreas(this._areaList)}),this._oldIndexArea=this._currentIndexArea=this._oldDropIndex=this._currentDropIndex=this._sourceIndexArea=this._sourceDropIndex=-1},init:function(){this.registerByClass()},registerByNode:function(area,notInitAreas){var index=this._getIndexArea(area);if(area&&index==-1){var acceptType=area.getAttribute("accept"),accept=acceptType?acceptType.split(/\s*,\s*/):["text"],obj={node:area,items:[],coords:{},margin:null,accept:accept,initItems:!1};array.forEach(this._getChildren(area),function(item){this._setMarginArea(obj,item),obj.items.push(this._addMoveableItem(item))},this),this._areaList=this._dropMode.addArea(this._areaList,obj),notInitAreas||this._dropMode.updateAreas(this._areaList),connect.publish("/dojox/mdnd/manager/register",[area])}},registerByClass:function(){query("."+this.areaClass).forEach(function(area){this.registerByNode(area,!0)},this),this._dropMode.updateAreas(this._areaList)},unregister:function(area){var index=this._getIndexArea(area);return index!=-1?(array.forEach(this._areaList[index].items,function(item){this._deleteMoveableItem(item)},this),this._areaList.splice(index,1),this._dropMode.updateAreas(this._areaList),!0):!1},_addMoveableItem:function(node){node.setAttribute("tabIndex","0");var handle=this._searchDragHandle(node),moveable=new Moveable({handle:handle,skip:!0},node);domClass.add(handle||node,"dragHandle");var type=node.getAttribute("dndType"),item={item:moveable,type:type?type.split(/\s*,\s*/):["text"],handlers:[connect.connect(moveable,"onDragStart",this,"onDragStart")]};if(registry&&registry.byNode){var widget=registry.byNode(node);widget&&(item.type=widget.dndType?widget.dndType.split(/\s*,\s*/):["text"],item.handlers.push(connect.connect(widget,"uninitialize",this,function(){this.removeDragItem(node.parentNode,moveable.node)})))}return item},_deleteMoveableItem:function(objItem){array.forEach(objItem.handlers,function(handler){connect.disconnect(handler)});var node=objItem.item.node,handle=this._searchDragHandle(node);domClass.remove(handle||node,"dragHandle"),objItem.item.destroy()},_getIndexArea:function(area){if(area)for(var i=0;i<this._areaList.length;i++)if(this._areaList[i].node===area)return i;return-1},_searchDragHandle:function(node){if(node){var cssArray=this.dragHandleClass.split(" "),length=cssArray.length,queryCss="";return array.forEach(cssArray,function(css,i){queryCss+="."+css,i!=length-1&&(queryCss+=", ")}),query(queryCss,node)[0]}},addDragItem:function(area,node,index,notCheckParent){var add=!0;notCheckParent||(add=area&&node&&(node.parentNode===null||node.parentNode&&node.parentNode.nodeType!==1));if(add){var indexArea=this._getIndexArea(area);if(indexArea!==-1){var item=this._addMoveableItem(node),items=this._areaList[indexArea].items;if(0<=index&&index<items.length){var firstListChild=items.slice(0,index),lastListChild=items.slice(index,items.length);firstListChild[firstListChild.length]=item,this._areaList[indexArea].items=firstListChild.concat(lastListChild),area.insertBefore(node,items[index].item.node)}else this._areaList[indexArea].items.push(item),area.appendChild(node);return this._setMarginArea(this._areaList[indexArea],node),this._areaList[indexArea].initItems=!1,!0}}return!1},removeDragItem:function(area,node){var index=this._getIndexArea(area);if(area&&index!==-1){var items=this._areaList[index].items;for(var j=0;j<items.length;j++)if(items[j].item.node===node)return this._deleteMoveableItem(items[j]),items.splice(j,1),area.removeChild(node)}return null},_getChildren:function(area){var children=[];return array.forEach(area.childNodes,function(child){if(child.nodeType==1)if(registry&&registry.byNode){var widget=registry.byNode(child);widget?widget.dragRestriction||children.push(child):children.push(child)}else children.push(child)}),children},_setMarginArea:function(area,node){area&&area.margin===null&&node&&(area.margin=geom.getMarginExtents(node))},findCurrentIndexArea:function(coords,size){return this._oldIndexArea=this._currentIndexArea,this._currentIndexArea=this._dropMode.getTargetArea(this._areaList,coords,this._currentIndexArea),this._currentIndexArea!=this._oldIndexArea&&(this._oldIndexArea!=-1&&this.onDragExit(coords,size),this._currentIndexArea!=-1&&this.onDragEnter(coords,size)),this._currentIndexArea},_isAccepted:function(type,accept){this._accept=!1;for(var i=0;i<accept.length;++i)for(var j=0;j<type.length;++j)if(type[j]==accept[i]){this._accept=!0;break}},onDragStart:function(node,coords,size){this.autoRefresh&&this._dropMode.updateAreas(this._areaList);var _html=sniff("webkit")?dojo.body():dojo.body().parentNode;this._cover||(this._cover=domConstruct.create("div",{"class":"dndCover"}),this._cover2=lang.clone(this._cover),domClass.add(this._cover2,"dndCover2"));var h=_html.scrollHeight+"px";this._cover.style.height=this._cover2.style.height=h,dojo.body().appendChild(this._cover),dojo.body().appendChild(this._cover2),this._dragStartHandler=connect.connect(node.ownerDocument,"ondragstart",dojo,"stopEvent"),this._sourceIndexArea=this._lastValidIndexArea=this._currentIndexArea=this._getIndexArea(node.parentNode);var sourceArea=this._areaList[this._sourceIndexArea],children=sourceArea.items;for(var i=0;i<children.length;i++)if(children[i].item.node==node){this._dragItem=children[i],this._dragItem.handlers.push(connect.connect(this._dragItem.item,"onDrag",this,"onDrag")),this._dragItem.handlers.push(connect.connect(this._dragItem.item,"onDragEnd",this,"onDrop")),children.splice(i,1),this._currentDropIndex=this._sourceDropIndex=i;break}var nodeRef=null;this._sourceDropIndex!==sourceArea.items.length&&(nodeRef=sourceArea.items[this._sourceDropIndex].item.node),sniff("ie")>7&&(this._eventsIE7=[connect.connect(this._cover,"onmouseover",dojo,"stopEvent"),connect.connect(this._cover,"onmouseout",dojo,"stopEvent"),connect.connect(this._cover,"onmouseenter",dojo,"stopEvent"),connect.connect(this._cover,"onmouseleave",dojo,"stopEvent")]);var s=node.style;s.left=coords.x+"px",s.top=coords.y+"px";if(s.position=="relative"||s.position=="")s.position="absolute";this._cover.appendChild(node),this._dropIndicator.place(sourceArea.node,nodeRef,size),domClass.add(node,"dragNode"),this._accept=!0,connect.publish("/dojox/mdnd/drag/start",[node,sourceArea,this._sourceDropIndex])},onDragEnter:function(coords,size){this._currentIndexArea===this._sourceIndexArea?this._accept=!0:this._isAccepted(this._dragItem.type,this._areaList[this._currentIndexArea].accept)},onDragExit:function(coords,size){this._accept=!1},onDrag:function(node,coords,size,mousePosition){var coordinates=this._dropMode.getDragPoint(coords,size,mousePosition);this.findCurrentIndexArea(coordinates,size),this._currentIndexArea!==-1&&this._accept&&this.placeDropIndicator(coordinates,size)},placeDropIndicator:function(coords,size){this._oldDropIndex=this._currentDropIndex;var area=this._areaList[this._currentIndexArea];return area.initItems||this._dropMode.initItems(area),this._currentDropIndex=this._dropMode.getDropIndex(area,coords),(this._currentIndexArea!==this._oldIndexArea||this._oldDropIndex!==this._currentDropIndex)&&this._placeDropIndicator(size),this._currentDropIndex},_placeDropIndicator:function(size){var oldArea=this._areaList[this._lastValidIndexArea],currentArea=this._areaList[this._currentIndexArea];this._dropMode.refreshItems(oldArea,this._oldDropIndex,size,!1);var node=null;this._currentDropIndex!=-1&&(node=currentArea.items[this._currentDropIndex].item.node),this._dropIndicator.place(currentArea.node,node),this._lastValidIndexArea=this._currentIndexArea,this._dropMode.refreshItems(currentArea,this._currentDropIndex,size,!0)},onDropCancel:function(){if(!this._accept){var index=this._getIndexArea(this._dropIndicator.node.parentNode);index!=-1?this._currentIndexArea=index:this._currentIndexArea=0}},onDrop:function(node){this.onDropCancel();var targetArea=this._areaList[this._currentIndexArea];domClass.remove(node,"dragNode");var style=node.style;style.position="relative",style.left="0",style.top="0",style.width="auto",targetArea.node==this._dropIndicator.node.parentNode?targetArea.node.insertBefore(node,this._dropIndicator.node):(targetArea.node.appendChild(node),this._currentDropIndex=targetArea.items.length);var indexChild=this._currentDropIndex;indexChild==-1&&(indexChild=targetArea.items.length);var children=targetArea.items,firstListArea=children.slice(0,indexChild),lastListArea=children.slice(indexChild,children.length);firstListArea[firstListArea.length]=this._dragItem,targetArea.items=firstListArea.concat(lastListArea),this._setMarginArea(targetArea,node),array.forEach(this._areaList,function(obj){obj.initItems=!1}),connect.disconnect(this._dragItem.handlers.pop()),connect.disconnect(this._dragItem.handlers.pop()),this._resetAfterDrop(),this._cover&&(dojo.body().removeChild(this._cover),dojo.body().removeChild(this._cover2)),connect.publish("/dojox/mdnd/drop",[node,targetArea,indexChild])},_resetAfterDrop:function(){this._accept=!1,this._dragItem=null,this._currentDropIndex=-1,this._currentIndexArea=-1,this._oldDropIndex=-1,this._sourceIndexArea=-1,this._sourceDropIndex=-1,this._dropIndicator.remove(),this._dragStartHandler&&connect.disconnect(this._dragStartHandler),sniff("ie")>7&&array.forEach(this._eventsIE7,connect.disconnect)},destroy:function(){while(this._areaList.length>0)if(!this.unregister(this._areaList[0].node))throw new Error("Error while destroying AreaManager");connect.disconnect(this.resizeHandler),this._dropIndicator.destroy(),this._dropMode.destroy(),dojox.mdnd.autoScroll&&dojox.mdnd.autoScroll.destroy(),this.refreshListener&&connect.unsubscribe(this.refreshListener),this._cover&&(domConstruct.destroy(this._cover),domConstruct.destroy(this._cover2),delete this._cover,delete this._cover2)}});return _Widget&&lang.extend(_Widget,{dndType:"text"}),dojox.mdnd._areaManager=null,dojox.mdnd.areaManager=function(){return dojox.mdnd._areaManager||(dojox.mdnd._areaManager=new dojox.mdnd.AreaManager),dojox.mdnd._areaManager},am})