//>>built
define("dojox/mdnd/adapter/DndFromDojo",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/array","dojo/dom-class","dojo/_base/window","dojox/mdnd/AreaManager","dojo/dnd/Manager"],function(dojo,declare,connect,array,domClass,win,AreaManager,Manager){var dfd=declare("dojox.mdnd.adapter.DndFromDojo",null,{dropIndicatorSize:{w:0,h:50},dropIndicatorSize:{w:0,h:50},_areaManager:null,_dojoManager:null,_currentArea:null,_oldArea:null,_moveHandler:null,_subscribeHandler:null,constructor:function(){this._areaManager=dojox.mdnd.areaManager(),this._dojoManager=Manager.manager(),this._currentArea=null,this._moveHandler=null,this.subscribeDnd()},subscribeDnd:function(){this._subscribeHandler=[connect.subscribe("/dnd/start",this,"onDragStart"),connect.subscribe("/dnd/drop/before",this,"onDrop"),connect.subscribe("/dnd/cancel",this,"onDropCancel"),connect.subscribe("/dnd/source/over",this,"onDndSource")]},unsubscribeDnd:function(){array.forEach(this._subscribeHandler,connect.unsubscribe)},_getHoverArea:function(coords){var x=coords.x,y=coords.y;this._oldArea=this._currentArea,this._currentArea=null;var areas=this._areaManager._areaList;for(var i=0;i<areas.length;i++){var area=areas[i],startX=area.coords.x,endX=startX+area.node.offsetWidth,startY=area.coords.y,endY=startY+area.node.offsetHeight;if(startX<=x&&x<=endX&&startY<=y&&y<=endY){this._areaManager._oldIndexArea=this._areaManager._currentIndexArea,this._areaManager._currentIndexArea=i,this._currentArea=area.node;break}}this._currentArea!=this._oldArea&&(this._currentArea==null?this.onDragExit():this._oldArea==null?this.onDragEnter():(this.onDragExit(),this.onDragEnter()))},onDragStart:function(source,nodes,copy){this._dragNode=nodes[0],this._copy=copy,this._source=source,this._outSourceHandler=connect.connect(this._dojoManager,"outSource",this,function(){this._moveHandler==null&&(this._moveHandler=connect.connect(dojo.doc,"mousemove",this,"onMouseMove"))})},onMouseMove:function(e){var coords={x:e.pageX,y:e.pageY};this._getHoverArea(coords),this._currentArea&&this._areaManager._accept&&(this._areaManager._dropIndicator.node.style.visibility=="hidden"&&(this._areaManager._dropIndicator.node.style.visibility="",domClass.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop")),this._areaManager.placeDropIndicator(coords,this.dropIndicatorSize))},onDragEnter:function(){var _dndType=this._dragNode.getAttribute("dndType"),type=_dndType?_dndType.split(/\s*,\s*/):["text"];this._areaManager._isAccepted(type,this._areaManager._areaList[this._areaManager._currentIndexArea].accept),this._dojoManager.avatar&&(this._areaManager._accept?domClass.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"):domClass.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"))},onDragExit:function(){this._areaManager._accept=!1,this._dojoManager.avatar&&domClass.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"),this._currentArea==null?(this._areaManager._dropMode.refreshItems(this._areaManager._areaList[this._areaManager._oldIndexArea],this._areaManager._oldDropIndex,this.dropIndicatorSize,!1),this._areaManager._resetAfterDrop()):this._areaManager._dropIndicator.remove()},isAccepted:function(node,accept){var type=node.getAttribute("dndType")?node.getAttribute("dndType"):"text";return type&&type in accept?!0:!1},onDndSource:function(source){if(this._currentArea==null)return;if(source){var accept=!1;this._dojoManager.target==source?accept=!0:accept=this.isAccepted(this._dragNode,source.accept);if(accept){connect.disconnect(this._moveHandler),this._currentArea=this._moveHandler=null;var dropIndicator=this._areaManager._dropIndicator.node;dropIndicator&&dropIndicator.parentNode!==null&&dropIndicator.parentNode.nodeType==1&&(dropIndicator.style.visibility="hidden")}else this._resetAvatar()}else this._moveHandler||(this._moveHandler=connect.connect(dojo.doc,"mousemove",this,"onMouseMove")),this._resetAvatar()},_resetAvatar:function(){this._dojoManager.avatar&&(this._areaManager._accept?domClass.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"):domClass.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"))},onDropCancel:function(){this._currentArea==null?(this._areaManager._resetAfterDrop(),connect.disconnect(this._moveHandler),connect.disconnect(this._outSourceHandler),this._currentArea=this._moveHandler=this._outSourceHandler=null):this._areaManager._accept?this.onDrop(this._source,[this._dragNode],this._copy,this._currentArea):(this._currentArea=null,connect.disconnect(this._outSourceHandler),connect.disconnect(this._moveHandler),this._moveHandler=this._outSourceHandler=null)},onDrop:function(source,nodes,copy){connect.disconnect(this._moveHandler),connect.disconnect(this._outSourceHandler),this._moveHandler=this._outSourceHandler=null;if(this._currentArea){var dropIndex=this._areaManager._currentDropIndex;connect.publish("/dnd/drop/after",[source,nodes,copy,this._currentArea,dropIndex]),this._currentArea=null}this._areaManager._dropIndicator.node.style.visibility=="hidden"&&(this._areaManager._dropIndicator.node.style.visibility=""),this._areaManager._resetAfterDrop()}});return dojox.mdnd.adapter._dndFromDojo=null,dojox.mdnd.adapter._dndFromDojo=new dojox.mdnd.adapter.DndFromDojo,dfd})