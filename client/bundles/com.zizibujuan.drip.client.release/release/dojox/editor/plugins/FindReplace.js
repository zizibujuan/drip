//>>built
define("dojox/editor/plugins/FindReplace",["dojo","dijit","dojox","dijit/_base/manager","dijit/_base/popup","dijit/_Widget","dijit/_TemplatedMixin","dijit/_KeyNavContainer","dijit/_WidgetsInTemplateMixin","dijit/TooltipDialog","dijit/Toolbar","dijit/form/CheckBox","dijit/form/_TextBoxMixin","dijit/form/TextBox","dijit/_editor/_Plugin","dijit/form/Button","dijit/form/DropDownButton","dijit/form/ToggleButton","dojox/editor/plugins/ToolbarLineBreak","dojo/_base/connect","dojo/_base/declare","dojo/i18n","dojo/string","dojo/i18n!dojox/editor/plugins/nls/FindReplace"],function(dojo,dijit,dojox,manager,popup,_Widget,_TemplatedMixin,_KeyNavContainer,_WidgetsInTemplateMixin,TooltipDialog,Toolbar,CheckBox,_TextBoxMixin,TextBox,_Plugin){return dojo.experimental("dojox.editor.plugins.FindReplace"),dojo.declare("dojox.editor.plugins._FindReplaceCloseBox",[_Widget,_TemplatedMixin,_WidgetsInTemplateMixin],{btnId:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='float: right' class='dijitInline' tabindex='-1'><button class='dijit dijitReset dijitInline' id='${btnId}' dojoAttachPoint='button' dojoType='dijit.form.Button' tabindex='-1' iconClass='dijitEditorIconsFindReplaceClose' showLabel='false'>X</button></span>",postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.btnId=this.id+"_close",this.inherited(arguments)},startup:function(){this.connect(this.button,"onClick","onClick")},onClick:function(){}}),dojo.declare("dojox.editor.plugins._FindReplaceTextBox",[_Widget,_TemplatedMixin,_WidgetsInTemplateMixin],{textId:"",label:"",toolTip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' class='dijit dijitReset dijitInline dijitEditorFindReplaceTextBox' title='${tooltip}' tabindex='-1'><label class='dijitLeft dijitInline' for='${textId}' tabindex='-1'>${label}</label><input dojoType='dijit.form.TextBox' intermediateChanges='true' class='focusTextBox' tabIndex='0' id='${textId}' dojoAttachPoint='textBox, focusNode' value='' dojoAttachEvent='onKeyPress: _onKeyPress'/></span>",postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.textId=this.id+"_text",this.inherited(arguments)},postCreate:function(){this.textBox.set("value",""),this.disabled=this.textBox.get("disabled"),this.connect(this.textBox,"onChange","onChange"),dojo.attr(this.textBox.textbox,"formnovalidate","true")},_setValueAttr:function(value){this.value=value,this.textBox.set("value",value)},focus:function(){this.textBox.focus()},_setDisabledAttr:function(value){this.disabled=value,this.textBox.set("disabled",value)},onChange:function(val){this.value=val},_onKeyPress:function(evt){var start=0,end=0;evt.target&&!evt.ctrlKey&&!evt.altKey&&!evt.shiftKey&&(evt.keyCode==dojo.keys.LEFT_ARROW?(start=evt.target.selectionStart,end=evt.target.selectionEnd,start<end&&(dijit.selectInputText(evt.target,start,start),dojo.stopEvent(evt))):evt.keyCode==dojo.keys.RIGHT_ARROW&&(start=evt.target.selectionStart,end=evt.target.selectionEnd,start<end&&(dijit.selectInputText(evt.target,end,end),dojo.stopEvent(evt))))}}),dojo.declare("dojox.editor.plugins._FindReplaceCheckBox",[_Widget,_TemplatedMixin,_WidgetsInTemplateMixin],{checkId:"",label:"",tooltip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' tabindex='-1' class='dijit dijitReset dijitInline dijitEditorFindReplaceCheckBox' title='${tooltip}' ><input dojoType='dijit.form.CheckBox' tabIndex='0' id='${checkId}' dojoAttachPoint='checkBox, focusNode' value=''/><label tabindex='-1' class='dijitLeft dijitInline' for='${checkId}'>${label}</label></span>",postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.checkId=this.id+"_check",this.inherited(arguments)},postCreate:function(){this.checkBox.set("checked",!1),this.disabled=this.checkBox.get("disabled"),this.checkBox.isFocusable=function(){return!1}},_setValueAttr:function(value){this.checkBox.set("value",value)},_getValueAttr:function(){return this.checkBox.get("value")},focus:function(){this.checkBox.focus()},_setDisabledAttr:function(value){this.disabled=value,this.checkBox.set("disabled",value)}}),dojo.declare("dojox.editor.plugins._FindReplaceToolbar",Toolbar,{postCreate:function(){this.connectKeyNavHandlers([],[]),this.connect(this.containerNode,"onclick","_onToolbarEvent"),this.connect(this.containerNode,"onkeydown","_onToolbarEvent"),dojo.addClass(this.domNode,"dijitToolbar")},addChild:function(widget,insertIndex){dijit._KeyNavContainer.superclass.addChild.apply(this,arguments)},_onToolbarEvent:function(evt){evt.stopPropagation()}}),dojo.declare("dojox.editor.plugins.FindReplace",[_Plugin],{buttonClass:dijit.form.ToggleButton,iconClassPrefix:"dijitEditorIconsFindReplace",editor:null,button:null,_frToolbar:null,_closeBox:null,_findField:null,_replaceField:null,_findButton:null,_replaceButton:null,_replaceAllButton:null,_caseSensitive:null,_backwards:null,_promDialog:null,_promDialogTimeout:null,_strings:null,_initButton:function(){this._strings=dojo.i18n.getLocalization("dojox.editor.plugins","FindReplace"),this.button=new dijit.form.ToggleButton({label:this._strings.findReplace,showLabel:!1,iconClass:this.iconClassPrefix+" dijitEditorIconFindString",tabIndex:"-1",onChange:dojo.hitch(this,"_toggleFindReplace")}),dojo.isOpera&&this.button.set("disabled",!0),this.connect(this.button,"set",dojo.hitch(this,function(attr,val){attr==="disabled"&&this._toggleFindReplace(!val&&this._displayed,!0,!0)}))},setEditor:function(editor){this.editor=editor,this._initButton()},toggle:function(){this.button.set("checked",!this.button.get("checked"))},_toggleFindReplace:function(show,ignoreState,buttonDisabled){var size=dojo.marginBox(this.editor.domNode);show&&!dojo.isOpera?(dojo.style(this._frToolbar.domNode,"display","block"),this._populateFindField(),ignoreState||(this._displayed=!0)):(dojo.style(this._frToolbar.domNode,"display","none"),ignoreState||(this._displayed=!1),buttonDisabled||this.editor.focus()),this.editor.resize({h:size.h})},_populateFindField:function(){var ed=this.editor,win=ed.window,selectedTxt=ed._sCall("getSelectedText",[null]);this._findField&&this._findField.textBox&&(selectedTxt&&this._findField.textBox.set("value",selectedTxt),this._findField.textBox.focus(),dijit.selectInputText(this._findField.textBox.focusNode))},setToolbar:function(toolbar){this.inherited(arguments);if(!dojo.isOpera){var _tb=this._frToolbar=new dojox.editor.plugins._FindReplaceToolbar;dojo.style(_tb.domNode,"display","none"),dojo.place(_tb.domNode,toolbar.domNode,"after"),_tb.startup(),this._closeBox=new dojox.editor.plugins._FindReplaceCloseBox,_tb.addChild(this._closeBox),this._findField=new dojox.editor.plugins._FindReplaceTextBox({label:this._strings.findLabel,tooltip:this._strings.findTooltip}),_tb.addChild(this._findField),this._replaceField=new dojox.editor.plugins._FindReplaceTextBox({label:this._strings.replaceLabel,tooltip:this._strings.replaceTooltip}),_tb.addChild(this._replaceField),_tb.addChild(new dojox.editor.plugins.ToolbarLineBreak),this._findButton=new dijit.form.Button({label:this._strings.findButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconFind"}),this._findButton.titleNode.title=this._strings.findButtonTooltip,_tb.addChild(this._findButton),this._replaceButton=new dijit.form.Button({label:this._strings.replaceButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplace"}),this._replaceButton.titleNode.title=this._strings.replaceButtonTooltip,_tb.addChild(this._replaceButton),this._replaceAllButton=new dijit.form.Button({label:this._strings.replaceAllButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplaceAll"}),this._replaceAllButton.titleNode.title=this._strings.replaceAllButtonTooltip,_tb.addChild(this._replaceAllButton),this._caseSensitive=new dojox.editor.plugins._FindReplaceCheckBox({label:this._strings.matchCase,tooltip:this._strings.matchCaseTooltip}),_tb.addChild(this._caseSensitive),this._backwards=new dojox.editor.plugins._FindReplaceCheckBox({label:this._strings.backwards,tooltip:this._strings.backwardsTooltip}),_tb.addChild(this._backwards),this._findButton.set("disabled",!0),this._replaceButton.set("disabled",!0),this._replaceAllButton.set("disabled",!0),this.connect(this._findField,"onChange","_checkButtons"),this.connect(this._findField,"onKeyDown","_onFindKeyDown"),this.connect(this._replaceField,"onKeyDown","_onReplaceKeyDown"),this.connect(this._findButton,"onClick","_find"),this.connect(this._replaceButton,"onClick","_replace"),this.connect(this._replaceAllButton,"onClick","_replaceAll"),this.connect(this._closeBox,"onClick","toggle"),this._promDialog=new dijit.TooltipDialog,this._promDialog.startup(),this._promDialog.set("content","")}},_checkButtons:function(){var fText=this._findField.get("value");fText?(this._findButton.set("disabled",!1),this._replaceButton.set("disabled",!1),this._replaceAllButton.set("disabled",!1)):(this._findButton.set("disabled",!0),this._replaceButton.set("disabled",!0),this._replaceAllButton.set("disabled",!0))},_onFindKeyDown:function(evt){evt.keyCode==dojo.keys.ENTER&&(this._find(),dojo.stopEvent(evt))},_onReplaceKeyDown:function(evt){evt.keyCode==dojo.keys.ENTER&&(this._replace()||this._replace(),dojo.stopEvent(evt))},_find:function(showMessage){var txt=this._findField.get("value")||"";if(txt){var caseSensitive=this._caseSensitive.get("value"),backwards=this._backwards.get("value"),isFound=this._findText(txt,caseSensitive,backwards);return!isFound&&showMessage&&(this._promDialog.set("content",dojo.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextFind})),dijit.popup.open({popup:this._promDialog,around:this._findButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,dijit.popup.close(this._promDialog)}),3e3),setTimeout(dojo.hitch(this,function(){this.editor.focus()}),0)),isFound}return!1},_replace:function(showMessage){var isReplaced=!1,ed=this.editor;ed.focus();var txt=this._findField.get("value")||"",repTxt=this._replaceField.get("value")||"";if(txt){var caseSensitive=this._caseSensitive.get("value"),backwards=this._backwards.get("value"),selected=ed._sCall("getSelectedText",[null]);dojo.isMoz&&(txt=dojo.trim(txt),selected=dojo.trim(selected));var regExp=this._filterRegexp(txt,!caseSensitive);return selected&&regExp.test(selected)&&(ed.execCommand("inserthtml",repTxt),isReplaced=!0,backwards&&(this._findText(repTxt,caseSensitive,backwards),ed._sCall("collapse",[!0]))),!this._find(!1)&&showMessage&&(this._promDialog.set("content",dojo.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextReplace})),dijit.popup.open({popup:this._promDialog,around:this._replaceButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,dijit.popup.close(this._promDialog)}),3e3),setTimeout(dojo.hitch(this,function(){this.editor.focus()}),0)),isReplaced}return null},_replaceAll:function(showMessage){var replaced=0,backwards=this._backwards.get("value");backwards?this.editor.placeCursorAtEnd():this.editor.placeCursorAtStart(),this._replace(!1)&&replaced++;var loopBody=dojo.hitch(this,function(){this._replace(!1)?(replaced++,setTimeout(loopBody,10)):showMessage&&(this._promDialog.set("content",dojo.string.substitute(this._strings.replaceDialogText,{0:""+replaced})),dijit.popup.open({popup:this._promDialog,around:this._replaceAllButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,dijit.popup.close(this._promDialog)}),3e3),setTimeout(dojo.hitch(this,function(){this._findField.focus(),this._findField.textBox.focusNode.select()}),0))});loopBody()},_findText:function(txt,caseSensitive,backwards){var ed=this.editor,win=ed.window,found=!1;if(txt)if(win.find)found=win.find(txt,caseSensitive,backwards,!1,!1,!1,!1);else{var doc=ed.document;if(doc.selection){this.editor.focus();var txtRg=doc.body.createTextRange(),curPos=doc.selection?doc.selection.createRange():null;curPos&&(backwards?txtRg.setEndPoint("EndToStart",curPos):txtRg.setEndPoint("StartToEnd",curPos));var flags=caseSensitive?4:0;backwards&&(flags|=1),found=txtRg.findText(txt,txtRg.text.length,flags),found&&txtRg.select()}}return found},_filterRegexp:function(pattern,ignoreCase){var rxp="",c=null;for(var i=0;i<pattern.length;i++){c=pattern.charAt(i);switch(c){case"\\":rxp+=c,i++,rxp+=pattern.charAt(i);break;case"$":case"^":case"/":case"+":case".":case"|":case"(":case")":case"{":case"}":case"[":case"]":rxp+="\\";default:rxp+=c}}return rxp="^"+rxp+"$",ignoreCase?new RegExp(rxp,"mi"):new RegExp(rxp,"m")},updateState:function(){this.button.set("disabled",this.get("disabled"))},destroy:function(){this.inherited(arguments),this._promDialogTimeout&&(clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,dijit.popup.close(this._promDialog)),this._frToolbar&&(this._frToolbar.destroyRecursive(),this._frToolbar=null),this._promDialog&&(this._promDialog.destroyRecursive(),this._promDialog=null)}}),dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(o){if(o.plugin)return;var name=o.args.name.toLowerCase();name==="findreplace"&&(o.plugin=new dojox.editor.plugins.FindReplace({}))}),dojox.editor.plugins.FindReplace})