//>>built
define("dojox/editor/plugins/NormalizeIndentOutdent",["dojo","dijit","dojox","dijit/_editor/_Plugin","dojo/_base/declare"],function(dojo,dijit,dojox,_Plugin){return dojo.declare("dojox.editor.plugins.NormalizeIndentOutdent",_Plugin,{indentBy:40,indentUnits:"px",setEditor:function(editor){this.editor=editor,editor._indentImpl=dojo.hitch(this,this._indentImpl),editor._outdentImpl=dojo.hitch(this,this._outdentImpl),editor._indentoutdent_queryCommandEnabled||(editor._indentoutdent_queryCommandEnabled=editor.queryCommandEnabled),editor.queryCommandEnabled=dojo.hitch(this,this._queryCommandEnabled),editor.customUndo=!0},_queryCommandEnabled:function(command){var c=command.toLowerCase(),ed,sel,range,node,tag,prevNode,style="marginLeft";this._isLtr()||(style="marginRight");if(c==="indent"){ed=this.editor,sel=dijit.range.getSelection(ed.window);if(sel&&sel.rangeCount>0){range=sel.getRangeAt(0),node=range.startContainer;while(node&&node!==ed.document&&node!==ed.editNode){tag=this._getTagName(node);if(tag==="li"){prevNode=node.previousSibling;while(prevNode&&prevNode.nodeType!==1)prevNode=prevNode.previousSibling;return prevNode&&this._getTagName(prevNode)==="li"?!0:!1}if(this._isIndentableElement(tag))return!0;node=node.parentNode}if(this._isRootInline(range.startContainer))return!0}}else{if(c!=="outdent")return this.editor._indentoutdent_queryCommandEnabled(command);ed=this.editor,sel=dijit.range.getSelection(ed.window);if(sel&&sel.rangeCount>0){range=sel.getRangeAt(0),node=range.startContainer;while(node&&node!==ed.document&&node!==ed.editNode){tag=this._getTagName(node);if(tag==="li")return this.editor._indentoutdent_queryCommandEnabled(command);if(this._isIndentableElement(tag)){var cIndent=node.style?node.style[style]:"";if(cIndent){cIndent=this._convertIndent(cIndent);if(cIndent/this.indentBy>=1)return!0}return!1}node=node.parentNode}if(this._isRootInline(range.startContainer))return!1}}return!1},_indentImpl:function(html){var ed=this.editor,sel=dijit.range.getSelection(ed.window);if(sel&&sel.rangeCount>0){var range=sel.getRangeAt(0),node=range.startContainer,tag,start,end,div;if(range.startContainer===range.endContainer)if(this._isRootInline(range.startContainer)){start=range.startContainer;while(start&&start.parentNode!==ed.editNode)start=start.parentNode;while(start&&start.previousSibling&&(this._isTextElement(start)||start.nodeType===1&&this._isInlineFormat(this._getTagName(start))))start=start.previousSibling;start&&start.nodeType===1&&!this._isInlineFormat(this._getTagName(start))&&(start=start.nextSibling);if(start){div=ed.document.createElement("div"),dojo.place(div,start,"after"),div.appendChild(start),end=div.nextSibling;while(end&&(this._isTextElement(end)||end.nodeType===1&&this._isInlineFormat(this._getTagName(end))))div.appendChild(end),end=div.nextSibling;this._indentElement(div),ed._sCall("selectElementChildren",[div]),ed._sCall("collapse",[!0])}}else while(node&&node!==ed.document&&node!==ed.editNode){tag=this._getTagName(node);if(tag==="li"){this._indentList(node);return}if(this._isIndentableElement(tag)){this._indentElement(node);return}node=node.parentNode}else{var curNode;start=range.startContainer,end=range.endContainer;while(start&&this._isTextElement(start)&&start.parentNode!==ed.editNode)start=start.parentNode;while(end&&this._isTextElement(end)&&end.parentNode!==ed.editNode)end=end.parentNode;if(end===ed.editNode||end===ed.document.body){curNode=start;while(curNode.nextSibling&&ed._sCall("inSelection",[curNode]))curNode=curNode.nextSibling;end=curNode;if(end===ed.editNode||end===ed.document.body){tag=this._getTagName(start);if(tag==="li")this._indentList(start);else if(this._isIndentableElement(tag))this._indentElement(start);else if(this._isTextElement(start)||this._isInlineFormat(tag)){div=ed.document.createElement("div"),dojo.place(div,start,"after");var next=start;while(next&&(this._isTextElement(next)||next.nodeType===1&&this._isInlineFormat(this._getTagName(next))))div.appendChild(next),next=div.nextSibling;this._indentElement(div)}return}}end=end.nextSibling,curNode=start;while(curNode&&curNode!==end){if(curNode.nodeType===1){tag=this._getTagName(curNode);if(dojo.isIE&&tag==="p"&&this._isEmpty(curNode)){curNode=curNode.nextSibling;continue}tag==="li"?(div&&(this._isEmpty(div)?div.parentNode.removeChild(div):this._indentElement(div),div=null),this._indentList(curNode)):!this._isInlineFormat(tag)&&this._isIndentableElement(tag)?(div&&(this._isEmpty(div)?div.parentNode.removeChild(div):this._indentElement(div),div=null),curNode=this._indentElement(curNode)):this._isInlineFormat(tag)&&(div?(div.appendChild(curNode),curNode=div):(div=ed.document.createElement("div"),dojo.place(div,curNode,"after"),div.appendChild(curNode),curNode=div))}else this._isTextElement(curNode)&&(div?(div.appendChild(curNode),curNode=div):(div=ed.document.createElement("div"),dojo.place(div,curNode,"after"),div.appendChild(curNode),curNode=div));curNode=curNode.nextSibling}div&&(this._isEmpty(div)?div.parentNode.removeChild(div):this._indentElement(div),div=null)}}},_indentElement:function(node){var style="marginLeft";this._isLtr()||(style="marginRight");var tag=this._getTagName(node);if(tag==="ul"||tag==="ol"){var div=this.editor.document.createElement("div");dojo.place(div,node,"after"),div.appendChild(node),node=div}var cIndent=node.style?node.style[style]:"";return cIndent?(cIndent=this._convertIndent(cIndent),cIndent=parseInt(cIndent,10)+this.indentBy+this.indentUnits):cIndent=this.indentBy+this.indentUnits,dojo.style(node,style,cIndent),node},_outdentElement:function(node){var style="marginLeft";this._isLtr()||(style="marginRight");var cIndent=node.style?node.style[style]:"";cIndent&&(cIndent=this._convertIndent(cIndent),cIndent-this.indentBy>0?cIndent=parseInt(cIndent,10)-this.indentBy+this.indentUnits:cIndent="",dojo.style(node,style,cIndent))},_outdentImpl:function(html){var ed=this.editor,sel=dijit.range.getSelection(ed.window);if(sel&&sel.rangeCount>0){var range=sel.getRangeAt(0),node=range.startContainer,tag;if(range.startContainer===range.endContainer){while(node&&node!==ed.document&&node!==ed.editNode){tag=this._getTagName(node);if(tag==="li")return this._outdentList(node);if(this._isIndentableElement(tag))return this._outdentElement(node);node=node.parentNode}ed.document.execCommand("outdent",!1,html)}else{var start=range.startContainer,end=range.endContainer;while(start&&start.nodeType===3)start=start.parentNode;while(end&&end.nodeType===3)end=end.parentNode;end=end.nextSibling;var curNode=start;while(curNode&&curNode!==end)curNode.nodeType===1&&(tag=this._getTagName(curNode),tag==="li"?this._outdentList(curNode):this._isIndentableElement(tag)&&this._outdentElement(curNode)),curNode=curNode.nextSibling}}return null},_indentList:function(listItem){var ed=this.editor,newList,li,listContainer=listItem.parentNode,prevTag=listItem.previousSibling;while(prevTag&&prevTag.nodeType!==1)prevTag=prevTag.previousSibling;var type=null,tg=this._getTagName(listContainer);tg==="ol"?type="ol":tg==="ul"&&(type="ul");if(type&&prevTag&&prevTag.tagName.toLowerCase()=="li"){var embList;if(prevTag.childNodes){var i;for(i=0;i<prevTag.childNodes.length;i++){var n=prevTag.childNodes[i];if(n.nodeType===3){if(dojo.trim(n.nodeValue)&&embList)break}else{if(n.nodeType!==1||!!embList)break;type===n.tagName.toLowerCase()&&(embList=n)}}}embList?embList.appendChild(listItem):(newList=ed.document.createElement(type),dojo.style(newList,{paddingTop:"0px",paddingBottom:"0px"}),li=ed.document.createElement("li"),dojo.style(li,{listStyleImage:"none",listStyleType:"none"}),prevTag.appendChild(newList),newList.appendChild(listItem)),ed._sCall("selectElementChildren",[listItem]),ed._sCall("collapse",[!0])}},_outdentList:function(listItem){var ed=this.editor,list=listItem.parentNode,type=null,tg=list.tagName?list.tagName.toLowerCase():"",li;tg==="ol"?type="ol":tg==="ul"&&(type="ul");var listParent=list.parentNode,lpTg=this._getTagName(listParent);if(lpTg==="li"||lpTg==="ol"||lpTg==="ul"){if(lpTg==="ol"||lpTg==="ul"){var prevListLi=list.previousSibling;while(prevListLi&&(prevListLi.nodeType!==1||prevListLi.nodeType===1&&this._getTagName(prevListLi)!=="li"))prevListLi=prevListLi.previousSibling;if(prevListLi)prevListLi.appendChild(list),listParent=prevListLi;else{li=listItem;var firstItem=listItem;while(li.previousSibling)li=li.previousSibling,li.nodeType===1&&this._getTagName(li)==="li"&&(firstItem=li);firstItem!==listItem?(dojo.place(firstItem,list,"before"),firstItem.appendChild(list),listParent=firstItem):(li=ed.document.createElement("li"),dojo.place(li,list,"before"),li.appendChild(list),listParent=li),dojo.style(list,{paddingTop:"0px",paddingBottom:"0px"})}}var prevLi=listItem.previousSibling;while(prevLi&&prevLi.nodeType!==1)prevLi=prevLi.previousSibling;var nextLi=listItem.nextSibling;while(nextLi&&nextLi.nodeType!==1)nextLi=nextLi.nextSibling;if(!prevLi)dojo.place(listItem,listParent,"after"),listItem.appendChild(list);else if(!nextLi)dojo.place(listItem,listParent,"after");else{var newList=ed.document.createElement(type);dojo.style(newList,{paddingTop:"0px",paddingBottom:"0px"}),listItem.appendChild(newList);while(listItem.nextSibling)newList.appendChild(listItem.nextSibling);dojo.place(listItem,listParent,"after")}list&&this._isEmpty(list)&&list.parentNode.removeChild(list),listParent&&this._isEmpty(listParent)&&listParent.parentNode.removeChild(listParent),ed._sCall("selectElementChildren",[listItem]),ed._sCall("collapse",[!0])}else ed.document.execCommand("outdent",!1,null)},_isEmpty:function(node){if(node.childNodes){var empty=!0,i;for(i=0;i<node.childNodes.length;i++){var n=node.childNodes[i];if(n.nodeType===1){if(this._getTagName(n)==="p"&&!dojo.trim(n.innerHTML))continue;empty=!1;break}if(!this._isTextElement(n)){empty=!1;break}var nv=dojo.trim(n.nodeValue);if(nv&&nv!=="&nbsp;"&&nv!=="Â "){empty=!1;break}}return empty}return!0},_isIndentableElement:function(tag){switch(tag){case"p":case"div":case"h1":case"h2":case"h3":case"center":case"table":case"ul":case"ol":return!0;default:return!1}},_convertIndent:function(indent){var pxPerEm=12;indent+="",indent=indent.toLowerCase();var curUnit=indent.indexOf("px")>0?"px":indent.indexOf("em")>0?"em":"px";return indent=indent.replace(/(px;?|em;?)/gi,""),curUnit==="px"?this.indentUnits==="em"&&(indent=Math.ceil(indent/pxPerEm)):this.indentUnits==="px"&&(indent*=pxPerEm),indent},_isLtr:function(){var editDoc=this.editor.document.body,cs=dojo.getComputedStyle(editDoc);return cs?cs.direction=="ltr":!0},_isInlineFormat:function(tag){switch(tag){case"a":case"b":case"strong":case"s":case"strike":case"i":case"u":case"em":case"sup":case"sub":case"span":case"font":case"big":case"cite":case"q":case"img":case"small":return!0;default:return!1}},_getTagName:function(node){var tag="";return node&&node.nodeType===1&&(tag=node.tagName?node.tagName.toLowerCase():""),tag},_isRootInline:function(node){var ed=this.editor;if(this._isTextElement(node)&&node.parentNode===ed.editNode)return!0;if(node.nodeType===1&&this._isInlineFormat(node)&&node.parentNode===ed.editNode)return!0;if(this._isTextElement(node)&&this._isInlineFormat(this._getTagName(node.parentNode))){node=node.parentNode;while(node&&node!==ed.editNode&&this._isInlineFormat(this._getTagName(node)))node=node.parentNode;if(node===ed.editNode)return!0}return!1},_isTextElement:function(node){return node&&node.nodeType===3||node.nodeType===4?!0:!1}}),dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(o){if(o.plugin)return;var name=o.args.name.toLowerCase();name==="normalizeindentoutdent"&&(o.plugin=new dojox.editor.plugins.NormalizeIndentOutdent({indentBy:"indentBy"in o.args?o.args.indentBy>0?o.args.indentBy:40:40,indentUnits:"indentUnits"in o.args?o.args.indentUnits.toLowerCase()=="em"?"em":"px":"px"}))}),dojox.editor.plugins.NormalizeIndentOutdent})