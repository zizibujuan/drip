//>>built
define("dojox/form/uploader/_HTML5",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo"],function(declare,lang,arrayUtil,dojo){return declare("dojox.form.uploader._HTML5",[],{errMsg:"Error uploading files. Try checking permissions",uploadType:"html5",postMixInProperties:function(){this.inherited(arguments),this.uploadType!=="html5"},postCreate:function(){this.connectForm(),this.inherited(arguments),this.uploadOnSelect&&this.connect(this,"onChange",function(data){this.upload(data[0])})},_drop:function(e){dojo.stopEvent(e);var dt=e.dataTransfer;this._files=dt.files,this.onChange(this.getFileList())},upload:function(formData){this.onBegin(this.getFileList()),this.uploadWithFormData(formData)},addDropTarget:function(node,onlyConnectDrop){onlyConnectDrop||(this.connect(node,"dragenter",dojo.stopEvent),this.connect(node,"dragover",dojo.stopEvent),this.connect(node,"dragleave",dojo.stopEvent)),this.connect(node,"drop","_drop")},uploadWithFormData:function(data){if(!this.getUrl()){0;return}var fd=new FormData,fieldName=this._getFileFieldName();arrayUtil.forEach(this._files,function(f,i){fd.append(fieldName,f)},this);if(data)for(var nm in data)fd.append(nm,data[nm]);var xhr=this.createXhr();xhr.send(fd)},_xhrProgress:function(evt){if(evt.lengthComputable){var o={bytesLoaded:evt.loaded,bytesTotal:evt.total,type:evt.type,timeStamp:evt.timeStamp};evt.type=="load"?(o.percent="100%",o.decimal=1):(o.decimal=evt.loaded/evt.total,o.percent=Math.ceil(evt.loaded/evt.total*100)+"%"),this.onProgress(o)}},createXhr:function(){var xhr=new XMLHttpRequest,timer;return xhr.upload.addEventListener("progress",lang.hitch(this,"_xhrProgress"),!1),xhr.addEventListener("load",lang.hitch(this,"_xhrProgress"),!1),xhr.addEventListener("error",lang.hitch(this,function(evt){this.onError(evt),clearInterval(timer)}),!1),xhr.addEventListener("abort",lang.hitch(this,function(evt){this.onAbort(evt),clearInterval(timer)}),!1),xhr.onreadystatechange=lang.hitch(this,function(){if(xhr.readyState===4){clearInterval(timer);try{this.onComplete(JSON.parse(xhr.responseText.replace(/^\{\}&&/,"")))}catch(e){var msg="Error parsing server result:";0,0,this.onError(msg,e)}}}),xhr.open("POST",this.getUrl()),xhr.setRequestHeader("Accept","application/json"),timer=setInterval(lang.hitch(this,function(){try{!typeof xhr.statusText}catch(e){clearInterval(timer)}}),250),xhr}})})