//>>built
define("dojox/charting/Chart",["../main","dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/dom-style","dojo/dom","dojo/dom-geometry","dojo/dom-construct","dojo/_base/Color","dojo/sniff","./Element","./SimpleTheme","./Series","./axis2d/common","dojox/gfx/shape","dojox/gfx","dojox/lang/functional","dojox/lang/functional/fold","dojox/lang/functional/reversed"],function(dojox,lang,arr,declare,domStyle,dom,domGeom,domConstruct,Color,has,Element,SimpleTheme,Series,common,shape,g,func){function hSection(stats){return{min:stats.hmin,max:stats.hmax}}function vSection(stats){return{min:stats.vmin,max:stats.vmax}}function hReplace(stats,h){stats.hmin=h.min,stats.hmax=h.max}function vReplace(stats,v){stats.vmin=v.min,stats.vmax=v.max}function combineStats(target,source){return target&&source&&(target.min=Math.min(target.min,source.min),target.max=Math.max(target.max,source.max)),target||source}function calculateAxes(stack,plotArea){var plots={},axes={};arr.forEach(stack,function(plot){var stats=plots[plot.name]=plot.getSeriesStats();plot.hAxis&&(axes[plot.hAxis]=combineStats(axes[plot.hAxis],hSection(stats))),plot.vAxis&&(axes[plot.vAxis]=combineStats(axes[plot.vAxis],vSection(stats)))}),arr.forEach(stack,function(plot){var stats=plots[plot.name];plot.hAxis&&hReplace(stats,axes[plot.hAxis]),plot.vAxis&&vReplace(stats,axes[plot.vAxis]),plot.initializeScalers(plotArea,stats)})}var dc=lang.getObject("charting",!0,dojox),clear=func.lambda("item.clear()"),purge=func.lambda("item.purgeGroup()"),destroy=func.lambda("item.destroy()"),makeClean=func.lambda("item.dirty = false"),makeDirty=func.lambda("item.dirty = true"),getName=func.lambda("item.name"),Chart=declare("dojox.charting.Chart",null,{constructor:function(node,kwArgs){kwArgs||(kwArgs={}),this.margins=kwArgs.margins?kwArgs.margins:{l:10,t:10,r:10,b:10},this.stroke=kwArgs.stroke,this.fill=kwArgs.fill,this.delayInMs=kwArgs.delayInMs||200,this.title=kwArgs.title,this.titleGap=kwArgs.titleGap,this.titlePos=kwArgs.titlePos,this.titleFont=kwArgs.titleFont,this.titleFontColor=kwArgs.titleFontColor,this.chartTitle=null,this.theme=null,this.axes={},this.stack=[],this.plots={},this.series=[],this.runs={},this.dirty=!0,this.node=dom.byId(node);var box=domGeom.getMarginBox(node);this.surface=g.createSurface(this.node,box.w||400,box.h||300),this.surface.declaredClass.indexOf("vml")==-1&&(this._nativeClip=!0)},destroy:function(){arr.forEach(this.series,destroy),arr.forEach(this.stack,destroy),func.forIn(this.axes,destroy),this.surface.destroy(),this.chartTitle&&this.chartTitle.tagName&&domConstruct.destroy(this.chartTitle)},getCoords:function(){var node=this.node,s=domStyle.getComputedStyle(node),coords=domGeom.getMarginBox(node,s),abs=domGeom.position(node,!0);return coords.x=abs.x,coords.y=abs.y,coords},setTheme:function(theme){return this.theme=theme.clone(),this.dirty=!0,this},addAxis:function(name,kwArgs){var axis,axisType=kwArgs&&kwArgs.type||"Default";if(typeof axisType=="string"){if(!dc.axis2d||!dc.axis2d[axisType])throw Error("Can't find axis: "+axisType+" - Check "+"require() dependencies.");axis=new dc.axis2d[axisType](this,kwArgs)}else axis=new axisType(this,kwArgs);return axis.name=name,axis.dirty=!0,name in this.axes&&this.axes[name].destroy(),this.axes[name]=axis,this.dirty=!0,this},getAxis:function(name){return this.axes[name]},removeAxis:function(name){return name in this.axes&&(this.axes[name].destroy(),delete this.axes[name],this.dirty=!0),this},addPlot:function(name,kwArgs){var plot,plotType=kwArgs&&kwArgs.type||"Default";if(typeof plotType=="string"){if(!dc.plot2d||!dc.plot2d[plotType])throw Error("Can't find plot: "+plotType+" - didn't you forget to dojo"+".require() it?");plot=new dc.plot2d[plotType](this,kwArgs)}else plot=new plotType(this,kwArgs);return plot.name=name,plot.dirty=!0,name in this.plots?(this.stack[this.plots[name]].destroy(),this.stack[this.plots[name]]=plot):(this.plots[name]=this.stack.length,this.stack.push(plot)),this.dirty=!0,this},getPlot:function(name){return this.stack[this.plots[name]]},removePlot:function(name){if(name in this.plots){var index=this.plots[name];delete this.plots[name],this.stack[index].destroy(),this.stack.splice(index,1),func.forIn(this.plots,function(idx,name,plots){idx>index&&(plots[name]=idx-1)});var ns=arr.filter(this.series,function(run){return run.plot!=name});ns.length<this.series.length&&(arr.forEach(this.series,function(run){run.plot==name&&run.destroy()}),this.runs={},arr.forEach(ns,function(run,index){this.runs[run.plot]=index},this),this.series=ns),this.dirty=!0}return this},getPlotOrder:function(){return func.map(this.stack,getName)},setPlotOrder:function(newOrder){var names={},order=func.filter(newOrder,function(name){return!(name in this.plots)||name in names?!1:(names[name]=1,!0)},this);order.length<this.stack.length&&func.forEach(this.stack,function(plot){var name=plot.name;name in names||order.push(name)});var newStack=func.map(order,function(name){return this.stack[this.plots[name]]},this);return func.forEach(newStack,function(plot,i){this.plots[plot.name]=i},this),this.stack=newStack,this.dirty=!0,this},movePlotToFront:function(name){if(name in this.plots){var index=this.plots[name];if(index){var newOrder=this.getPlotOrder();return newOrder.splice(index,1),newOrder.unshift(name),this.setPlotOrder(newOrder)}}return this},movePlotToBack:function(name){if(name in this.plots){var index=this.plots[name];if(index<this.stack.length-1){var newOrder=this.getPlotOrder();return newOrder.splice(index,1),newOrder.push(name),this.setPlotOrder(newOrder)}}return this},addSeries:function(name,data,kwArgs){var run=new Series(this,data,kwArgs);return run.name=name,name in this.runs?(this.series[this.runs[name]].destroy(),this.series[this.runs[name]]=run):(this.runs[name]=this.series.length,this.series.push(run)),this.dirty=!0,!("ymin"in run)&&"min"in run&&(run.ymin=run.min),!("ymax"in run)&&"max"in run&&(run.ymax=run.max),this},getSeries:function(name){return this.series[this.runs[name]]},removeSeries:function(name){if(name in this.runs){var index=this.runs[name];delete this.runs[name],this.series[index].destroy(),this.series.splice(index,1),func.forIn(this.runs,function(idx,name,runs){idx>index&&(runs[name]=idx-1)}),this.dirty=!0}return this},updateSeries:function(name,data,offsets){if(name in this.runs){var run=this.series[this.runs[name]];run.update(data),offsets?this.dirty=!0:(this._invalidateDependentPlots(run.plot,!1),this._invalidateDependentPlots(run.plot,!0))}return this},getSeriesOrder:function(plotName){return func.map(func.filter(this.series,function(run){return run.plot==plotName}),getName)},setSeriesOrder:function(newOrder){var plotName,names={},order=func.filter(newOrder,function(name){if(!(name in this.runs)||name in names)return!1;var run=this.series[this.runs[name]];if(plotName){if(run.plot!=plotName)return!1}else plotName=run.plot;return names[name]=1,!0},this);func.forEach(this.series,function(run){var name=run.name;!(name in names)&&run.plot==plotName&&order.push(name)});var newSeries=func.map(order,function(name){return this.series[this.runs[name]]},this);return this.series=newSeries.concat(func.filter(this.series,function(run){return run.plot!=plotName})),func.forEach(this.series,function(run,i){this.runs[run.name]=i},this),this.dirty=!0,this},moveSeriesToFront:function(name){if(name in this.runs){var index=this.runs[name],newOrder=this.getSeriesOrder(this.series[index].plot);if(name!=newOrder[0])return newOrder.splice(index,1),newOrder.unshift(name),this.setSeriesOrder(newOrder)}return this},moveSeriesToBack:function(name){if(name in this.runs){var index=this.runs[name],newOrder=this.getSeriesOrder(this.series[index].plot);if(name!=newOrder[newOrder.length-1])return newOrder.splice(index,1),newOrder.push(name),this.setSeriesOrder(newOrder)}return this},resize:function(width,height){switch(arguments.length){case 1:domGeom.setMarginBox(this.node,width);break;case 2:domGeom.setMarginBox(this.node,{w:width,h:height})}var box=domGeom.getMarginBox(this.node),d=this.surface.getDimensions();return d.width!=box.w||d.height!=box.h?(this.surface.setDimensions(box.w,box.h),this.dirty=!0,this.render()):this},getGeometry:function(){var ret={};return func.forIn(this.axes,function(axis){axis.initialized()&&(ret[axis.name]={name:axis.name,vertical:axis.vertical,scaler:axis.scaler,ticks:axis.ticks})}),ret},setAxisWindow:function(name,scale,offset,zoom){var axis=this.axes[name];return axis&&(axis.setWindow(scale,offset),arr.forEach(this.stack,function(plot){if(plot.hAxis==name||plot.vAxis==name)plot.zoom=zoom})),this},setWindow:function(sx,sy,dx,dy,zoom){return"plotArea"in this||this.calculateGeometry(),func.forIn(this.axes,function(axis){var scale,offset,bounds=axis.getScaler().bounds,s=bounds.span/(bounds.upper-bounds.lower);axis.vertical?(scale=sy,offset=dy/s/scale):(scale=sx,offset=dx/s/scale),axis.setWindow(scale,offset)}),arr.forEach(this.stack,function(plot){plot.zoom=zoom}),this},zoomIn:function(name,range,delayed){var axis=this.axes[name];if(axis){var scale,offset,bounds=axis.getScaler().bounds,lower=Math.min(range[0],range[1]),upper=Math.max(range[0],range[1]);lower=range[0]<bounds.lower?bounds.lower:lower,upper=range[1]>bounds.upper?bounds.upper:upper,scale=(bounds.upper-bounds.lower)/(upper-lower),offset=lower-bounds.lower,this.setAxisWindow(name,scale,offset),delayed?this.delayedRender():this.render()}},calculateGeometry:function(){if(this.dirty)return this.fullGeometry();var dirty=arr.filter(this.stack,function(plot){return plot.dirty||plot.hAxis&&this.axes[plot.hAxis].dirty||plot.vAxis&&this.axes[plot.vAxis].dirty},this);return calculateAxes(dirty,this.plotArea),this},fullGeometry:function(){this._makeDirty(),arr.forEach(this.stack,clear),this.theme||this.setTheme(new SimpleTheme),arr.forEach(this.series,function(run){if(!(run.plot in this.plots)){if(!dc.plot2d||!dc.plot2d.Default)throw Error("Can't find plot: Default - didn't you forget to dojo.require() it?");var plot=new dc.plot2d.Default(this,{});plot.name=run.plot,this.plots[run.plot]=this.stack.length,this.stack.push(plot)}this.stack[this.plots[run.plot]].addSeries(run)},this),arr.forEach(this.stack,function(plot){plot.assignAxes&&plot.assignAxes(this.axes)},this);var dim=this.dim=this.surface.getDimensions();dim.width=g.normalizedLength(dim.width),dim.height=g.normalizedLength(dim.height),func.forIn(this.axes,clear),calculateAxes(this.stack,dim);var offsets=this.offsets={l:0,r:0,t:0,b:0},isRTL=this.isRightToLeft?this.isRightToLeft():!1;func.forIn(this.axes,function(axis){axis.vertical&&isRTL&&(axis.opt.leftBottom=!axis.opt.leftBottom),func.forIn(axis.getOffsets(),function(o,i){offsets[i]=Math.max(o,offsets[i])})});if(this.title){this.titleGap=this.titleGap==0?0:this.titleGap||this.theme.chart.titleGap||20,this.titlePos=this.titlePos||this.theme.chart.titlePos||"top",this.titleFont=this.titleFont||this.theme.chart.titleFont,this.titleFontColor=this.titleFontColor||this.theme.chart.titleFontColor||"black";var tsize=g.normalizedLength(g.splitFontString(this.titleFont).size);offsets[this.titlePos=="top"?"t":"b"]+=tsize+this.titleGap}return func.forIn(this.margins,function(o,i){offsets[i]+=o}),this.plotArea={width:dim.width-offsets.l-offsets.r,height:dim.height-offsets.t-offsets.b},func.forIn(this.axes,clear),calculateAxes(this.stack,this.plotArea),this},render:function(){return this._delayedRenderHandle&&(clearTimeout(this._delayedRenderHandle),this._delayedRenderHandle=null),this.theme&&this.theme.clear(),this.dirty?this.fullRender():(this.calculateGeometry(),func.forEachRev(this.stack,function(plot){plot.render(this.dim,this.offsets)},this),func.forIn(this.axes,function(axis){axis.render(this.dim,this.offsets)},this),this._makeClean(),this)},fullRender:function(){this.fullGeometry();var offsets=this.offsets,dim=this.dim,w=Math.max(0,dim.width-offsets.l-offsets.r),h=Math.max(0,dim.height-offsets.t-offsets.b);arr.forEach(this.series,purge),func.forIn(this.axes,purge),arr.forEach(this.stack,purge);var children=this.surface.children;for(var i=0;i<children.length;++i)shape.dispose(children[i]);this.chartTitle&&this.chartTitle.tagName&&domConstruct.destroy(this.chartTitle),this.surface.clear(),this.chartTitle=null,this._renderChartBackground(dim,offsets),this._nativeClip?this._renderPlotBackground(dim,offsets,w,h):this._renderPlotBackground(dim,offsets,w,h),func.foldr(this.stack,function(z,plot){return plot.render(dim,offsets),0},0),this._nativeClip||this._renderChartBackground(dim,offsets);if(this.title){var forceHtmlLabels=g.renderer=="canvas",labelType=forceHtmlLabels||!has("ie")&&!has("opera")?"html":"gfx",tsize=g.normalizedLength(g.splitFontString(this.titleFont).size);this.chartTitle=common.createText[labelType](this,this.surface,dim.width/2,this.titlePos=="top"?tsize+this.margins.t:dim.height-this.margins.b,"middle",this.title,this.titleFont,this.titleFontColor)}return func.forIn(this.axes,function(axis){axis.render(dim,offsets)}),this._makeClean(),this},_renderChartBackground:function(dim,offsets){var t=this.theme,rect,fill=this.fill!==undefined?this.fill:t.chart&&t.chart.fill,stroke=this.stroke!==undefined?this.stroke:t.chart&&t.chart.stroke;if(fill=="inherit"){var node=this.node;fill=new Color(domStyle.get(node,"backgroundColor"));while(fill.a==0&&node!=document.documentElement)fill=new Color(domStyle.get(node,"backgroundColor")),node=node.parentNode}fill&&(this._nativeClip?(fill=Element.prototype._shapeFill(Element.prototype._plotFill(fill,dim),{x:0,y:0,width:dim.width+1,height:dim.height+1}),this.surface.createRect({width:dim.width+1,height:dim.height+1}).setFill(fill)):(fill=Element.prototype._plotFill(fill,dim,offsets),offsets.l&&(rect={x:0,y:0,width:offsets.l,height:dim.height+1},this.surface.createRect(rect).setFill(Element.prototype._shapeFill(fill,rect))),offsets.r&&(rect={x:dim.width-offsets.r,y:0,width:offsets.r+1,height:dim.height+2},this.surface.createRect(rect).setFill(Element.prototype._shapeFill(fill,rect))),offsets.t&&(rect={x:0,y:0,width:dim.width+1,height:offsets.t},this.surface.createRect(rect).setFill(Element.prototype._shapeFill(fill,rect))),offsets.b&&(rect={x:0,y:dim.height-offsets.b,width:dim.width+1,height:offsets.b+2},this.surface.createRect(rect).setFill(Element.prototype._shapeFill(fill,rect))))),stroke&&this.surface.createRect({width:dim.width-1,height:dim.height-1}).setStroke(stroke)},_renderPlotBackground:function(dim,offsets,w,h){var t=this.theme,fill=t.plotarea&&t.plotarea.fill,stroke=t.plotarea&&t.plotarea.stroke,rect={x:offsets.l-1,y:offsets.t-1,width:w+2,height:h+2};fill&&(fill=Element.prototype._shapeFill(Element.prototype._plotFill(fill,dim,offsets),rect),this.surface.createRect(rect).setFill(fill)),stroke&&this.surface.createRect({x:offsets.l,y:offsets.t,width:w+1,height:h+1}).setStroke(stroke)},delayedRender:function(){return this._delayedRenderHandle||(this._delayedRenderHandle=setTimeout(lang.hitch(this,function(){this.render()}),this.delayInMs)),this},connectToPlot:function(name,object,method){return name in this.plots?this.stack[this.plots[name]].connect(object,method):null},fireEvent:function(seriesName,eventName,index){if(seriesName in this.runs){var plotName=this.series[this.runs[seriesName]].plot;if(plotName in this.plots){var plot=this.stack[this.plots[plotName]];plot&&plot.fireEvent(seriesName,eventName,index)}}return this},_makeClean:function(){arr.forEach(this.axes,makeClean),arr.forEach(this.stack,makeClean),arr.forEach(this.series,makeClean),this.dirty=!1},_makeDirty:function(){arr.forEach(this.axes,makeDirty),arr.forEach(this.stack,makeDirty),arr.forEach(this.series,makeDirty),this.dirty=!0},_invalidateDependentPlots:function(plotName,verticalAxis){if(plotName in this.plots){var plot=this.stack[this.plots[plotName]],axis,axisName=verticalAxis?"vAxis":"hAxis";plot[axisName]?(axis=this.axes[plot[axisName]],axis&&axis.dependOnData()&&(axis.dirty=!0,arr.forEach(this.stack,function(p){p[axisName]&&p[axisName]==plot[axisName]&&(p.dirty=!0)}))):plot.dirty=!0}}});return Chart})