//>>built
define("dojox/charting/action2d/TouchZoomAndPan",["dojo/_base/lang","dojo/_base/declare","dojo/_base/event","dojo/sniff","./ChartAction","../Element","dojox/gesture/tap","../plot2d/common"],function(lang,declare,eventUtil,has,ChartAction,Element,tap,common){var GlassView=declare(Element,{constructor:function(chart){},render:function(){if(!this.isDirty())return;this.cleanGroup(),this.group.createRect({width:this.chart.dim.width,height:this.chart.dim.height}).setFill("rgba(0,0,0,0)")},clear:function(){return this.dirty=!0,this.chart.stack[0]!=this&&this.chart.movePlotToFront(this.name),this},getSeriesStats:function(){return lang.delegate(common.defaultStats)},initializeScalers:function(){return this},isDirty:function(){return this.dirty}});return declare("dojox.charting.action2d.TouchZoomAndPan",ChartAction,{defaultParams:{axis:"x",scaleFactor:1.2,maxScale:100,enableScroll:!0,enableZoom:!0},optionalParams:{},constructor:function(chart,plot,kwArgs){this._listeners=[{eventName:"ontouchstart",methodName:"onTouchStart"},{eventName:"ontouchmove",methodName:"onTouchMove"},{eventName:"ontouchend",methodName:"onTouchEnd"},{eventName:tap.doubletap,methodName:"onDoubleTap"}],kwArgs||(kwArgs={}),this.axis=kwArgs.axis?kwArgs.axis:"x",this.scaleFactor=kwArgs.scaleFactor?kwArgs.scaleFactor:1.2,this.maxScale=kwArgs.maxScale?kwArgs.maxScale:100,this.enableScroll=kwArgs.enableScroll!=undefined?kwArgs.enableScroll:!0,this.enableZoom=kwArgs.enableScroll!=undefined?kwArgs.enableZoom:!0,this._uName="touchZoomPan"+this.axis,this.connect()},connect:function(){this.inherited(arguments),has("ios")&&this.chart.surface.declaredClass.indexOf("svg")!=-1&&this.chart.addPlot(this._uName,{type:GlassView})},disconnect:function(){has("ios")&&this.chart.surface.declaredClass.indexOf("svg")!=-1&&this.chart.removePlot(this._uName),this.inherited(arguments)},onTouchStart:function(event){var chart=this.chart,axis=chart.getAxis(this.axis),length=event.touches.length;this._startPageCoord={x:event.touches[0].pageX,y:event.touches[0].pageY},(this.enableZoom||this.enableScroll)&&chart._delayedRenderHandle&&chart.render();if(this.enableZoom&&length>=2){this._endPageCoord={x:event.touches[1].pageX,y:event.touches[1].pageY};var middlePageCoord={x:(this._startPageCoord.x+this._endPageCoord.x)/2,y:(this._startPageCoord.y+this._endPageCoord.y)/2},scaler=axis.getScaler();this._initScale=axis.getWindowScale();var t=this._initData=this.plot.toData();this._middleCoord=t(middlePageCoord)[this.axis],this._startCoord=scaler.bounds.from,this._endCoord=scaler.bounds.to}else this.enableScroll&&(this._startScroll(axis),eventUtil.stop(event))},onTouchMove:function(event){var chart=this.chart,axis=chart.getAxis(this.axis),length=event.touches.length,pAttr=axis.vertical?"pageY":"pageX",attr=axis.vertical?"y":"x";if(this.enableZoom&&length>=2){var newMiddlePageCoord={x:(event.touches[1].pageX+event.touches[0].pageX)/2,y:(event.touches[1].pageY+event.touches[0].pageY)/2},scale=(this._endPageCoord[attr]-this._startPageCoord[attr])/(event.touches[1][pAttr]-event.touches[0][pAttr]);if(this._initScale/scale>this.maxScale)return;var newMiddleCoord=this._initData(newMiddlePageCoord)[this.axis],newStart=scale*(this._startCoord-newMiddleCoord)+this._middleCoord,newEnd=scale*(this._endCoord-newMiddleCoord)+this._middleCoord;chart.zoomIn(this.axis,[newStart,newEnd]),eventUtil.stop(event)}else if(this.enableScroll){var delta=axis.vertical?this._startPageCoord[attr]-event.touches[0][pAttr]:event.touches[0][pAttr]-this._startPageCoord[attr];this.chart.isRightToLeft&&this.chart.isRightToLeft()&&(delta*=-1),chart.setAxisWindow(this.axis,this._lastScale,this._initOffset-delta/this._lastFactor/this._lastScale),chart.delayedRender(),eventUtil.stop(event)}},onTouchEnd:function(event){var chart=this.chart,axis=chart.getAxis(this.axis);event.touches.length==1&&this.enableScroll&&(this._startPageCoord={x:event.touches[0].pageX,y:event.touches[0].pageY},this._startScroll(axis))},_startScroll:function(axis){var bounds=axis.getScaler().bounds;this._initOffset=axis.getWindowOffset(),this._lastScale=axis.getWindowScale(),this._lastFactor=bounds.span/(bounds.upper-bounds.lower)},onDoubleTap:function(event){var chart=this.chart,axis=chart.getAxis(this.axis),scale=1/this.scaleFactor;if(axis.getWindowScale()==1){var scaler=axis.getScaler(),start=scaler.bounds.from,end=scaler.bounds.to,oldMiddle=(start+end)/2,newMiddle=this.plot.toData(this._startPageCoord)[this.axis],newStart=scale*(start-oldMiddle)+newMiddle,newEnd=scale*(end-oldMiddle)+newMiddle;chart.zoomIn(this.axis,[newStart,newEnd])}else chart.setAxisWindow(this.axis,1,0),chart.render();eventUtil.stop(event)}})})