//>>built
define("dojox/charting/plot2d/Columns",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","./CartesianBase","./_PlotEvents","./common","dojox/lang/functional","dojox/lang/functional/reversed","dojox/lang/utils","dojox/gfx/fx"],function(lang,arr,declare,CartesianBase,_PlotEvents,dc,df,dfr,du,fx){var purgeGroup=dfr.lambda("item.purgeGroup()");return declare("dojox.charting.plot2d.Columns",[CartesianBase,_PlotEvents],{defaultParams:{gap:0,animate:null,enableCache:!1},optionalParams:{minBarSize:1,maxBarSize:1,stroke:{},outline:{},shadow:{},fill:{},styleFunc:null,font:"",fontColor:""},constructor:function(chart,kwArgs){this.opt=lang.clone(lang.mixin(this.opt,this.defaultParams)),du.updateWithObject(this.opt,kwArgs),du.updateWithPattern(this.opt,kwArgs,this.optionalParams),this.animate=this.opt.animate},getSeriesStats:function(){var stats=dc.collectSimpleStats(this.series);return stats.hmin-=.5,stats.hmax+=.5,stats},createRect:function(run,creator,params){var rect;return this.opt.enableCache&&run._rectFreePool.length>0?(rect=run._rectFreePool.pop(),rect.setShape(params),creator.add(rect)):rect=creator.createRect(params),this.opt.enableCache&&run._rectUsePool.push(rect),rect},render:function(dim,offsets){if(this.zoom&&!this.isDataDirty())return this.performZoom(dim,offsets);this.resetEvents(),this.dirty=this.isDirty();var s;this.dirty&&(arr.forEach(this.series,purgeGroup),this._eventSeries={},this.cleanGroup(),s=this.getGroup(),df.forEachRev(this.series,function(item){item.cleanGroup(s)}));var t=this.chart.theme,ht=this._hScaler.scaler.getTransformerFromModel(this._hScaler),vt=this._vScaler.scaler.getTransformerFromModel(this._vScaler),baseline=Math.max(0,this._vScaler.bounds.lower),baselineHeight=vt(baseline),events=this.events(),bar=this.getBarProperties();for(var i=this.series.length-1;i>=0;--i){var run=this.series[i];if(!this.dirty&&!run.dirty){t.skip(),this._reconnectEvents(run.name);continue}run.cleanGroup(),this.opt.enableCache&&(run._rectFreePool=(run._rectFreePool?run._rectFreePool:[]).concat(run._rectUsePool?run._rectUsePool:[]),run._rectUsePool=[]);var theme=t.next("column",[this.opt,run]),eventSeries=new Array(run.data.length);s=run.group;var indexed=arr.some(run.data,function(item){return typeof item=="number"||item&&!item.hasOwnProperty("x")}),min=indexed?Math.max(0,Math.floor(this._hScaler.bounds.from-1)):0,max=indexed?Math.min(run.data.length,Math.ceil(this._hScaler.bounds.to)):run.data.length;for(var j=min;j<max;++j){var value=run.data[j];if(value!=null){var val=this.getValue(value,j,i,indexed),vv=vt(val.y),h=Math.abs(vv-baselineHeight),finalTheme,sshape;if(this.opt.styleFunc||typeof value!="number"){var tMixin=typeof value!="number"?[value]:[];this.opt.styleFunc&&tMixin.push(this.opt.styleFunc(value)),finalTheme=t.addMixin(theme,"column",tMixin,!0)}else finalTheme=t.post(theme,"column");if(bar.width>=1&&h>=0){var rect={x:offsets.l+ht(val.x+.5)+bar.gap+bar.thickness*i,y:dim.height-offsets.b-(val.y>baseline?vv:baselineHeight),width:bar.width,height:h};if(finalTheme.series.shadow){var srect=lang.clone(rect);srect.x+=finalTheme.series.shadow.dx,srect.y+=finalTheme.series.shadow.dy,sshape=this.createRect(run,s,srect).setFill(finalTheme.series.shadow.color).setStroke(finalTheme.series.shadow),this.animate&&this._animateColumn(sshape,dim.height-offsets.b+baselineHeight,h)}var specialFill=this._plotFill(finalTheme.series.fill,dim,offsets);specialFill=this._shapeFill(specialFill,rect);var shape=this.createRect(run,s,rect).setFill(specialFill).setStroke(finalTheme.series.stroke);run.dyn.fill=shape.getFill(),run.dyn.stroke=shape.getStroke();if(events){var o={element:"column",index:j,run:run,shape:shape,shadow:sshape,cx:val.x+.5,cy:val.y,x:indexed?j:run.data[j].x,y:indexed?run.data[j]:run.data[j].y};this._connectEvents(o),eventSeries[j]=o}!isNaN(val.py)&&val.py>baseline&&(rect.height=vv-vt(val.py)),this.createLabel(s,value,rect,finalTheme),this.animate&&this._animateColumn(shape,dim.height-offsets.b-baselineHeight,h)}}}this._eventSeries[run.name]=eventSeries,run.dirty=!1}return this.dirty=!1,this.chart.isRightToLeft&&this.chart.isRightToLeft()&&this.chart.applyMirroring(this.group,dim,offsets),this},getValue:function(value,j,seriesIndex,indexed){var y,x;return indexed?(typeof value=="number"?y=value:y=value.y,x=j):(y=value.y,x=value.x-1),{x:x,y:y}},getBarProperties:function(){var f=dc.calculateBarSize(this._hScaler.bounds.scale,this.opt);return{gap:f.gap,width:f.size,thickness:0}},_animateColumn:function(shape,voffset,vsize){vsize==0&&(vsize=1),fx.animateTransform(lang.delegate({shape:shape,duration:1200,transform:[{name:"translate",start:[0,voffset-voffset/vsize],end:[0,0]},{name:"scale",start:[1,1/vsize],end:[1,1]},{name:"original"}]},this.animate)).play()}})})