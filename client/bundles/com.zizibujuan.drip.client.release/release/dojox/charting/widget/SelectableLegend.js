//>>built
define("dojox/charting/widget/SelectableLegend",["dojo/_base/array","dojo/_base/declare","dojo/query","dojo/_base/connect","dojo/_base/Color","./Legend","dijit/form/CheckBox","../action2d/Highlight","dojox/lang/functional","dojox/gfx/fx","dojo/keys","dojo/dom-construct","dojo/dom-prop"],function(arrayUtil,declare,query,hub,Color,Legend,CheckBox,Highlight,df,fx,keys,dom,domProp){function formatEventType(type){return type=="mouseenter"?"onmouseover":type=="mouseleave"?"onmouseout":"on"+type}var FocusManager=declare(null,{constructor:function(legend){this.legend=legend,this.index=0,this.horizontalLength=this._getHrizontalLength(),arrayUtil.forEach(legend.legends,function(item,i){i>0&&query("input",item).attr("tabindex",-1)}),this.firstLabel=query("input",legend.legends[0])[0],hub.connect(this.firstLabel,"focus",this,function(){this.legend.active=!0}),hub.connect(this.legend.domNode,"keydown",this,"_onKeyEvent")},_getHrizontalLength:function(){var horizontal=this.legend.horizontal;return typeof horizontal=="number"?Math.min(horizontal,this.legend.legends.length):horizontal?this.legend.legends.length:1},_onKeyEvent:function(e){if(!this.legend.active)return;if(e.keyCode==keys.TAB){this.legend.active=!1;return}var max=this.legend.legends.length;switch(e.keyCode){case keys.LEFT_ARROW:this.index--,this.index<0&&(this.index+=max);break;case keys.RIGHT_ARROW:this.index++,this.index>=max&&(this.index-=max);break;case keys.UP_ARROW:this.index-this.horizontalLength>=0&&(this.index-=this.horizontalLength);break;case keys.DOWN_ARROW:this.index+this.horizontalLength<max&&(this.index+=this.horizontalLength);break;default:return}this._moveToFocus(),Event.stop(e)},_moveToFocus:function(){query("input",this.legend.legends[this.index])[0].focus()}}),SelectableLegend=declare("dojox.charting.widget.SelectableLegend",Legend,{outline:!1,transitionFill:null,transitionStroke:null,postCreate:function(){this.legends=[],this.legendAnim={},this._cbs=[],this.inherited(arguments)},refresh:function(){this.legends=[],this._clearLabels(),this.inherited(arguments),this._applyEvents(),new FocusManager(this)},_clearLabels:function(){var cbs=this._cbs;while(cbs.length)cbs.pop().destroyRecursive()},_addLabel:function(dyn,label){this.inherited(arguments);var legendNodes=query("td",this.legendBody),currentLegendNode=legendNodes[legendNodes.length-1];this.legends.push(currentLegendNode);var checkbox=new CheckBox({checked:!0});this._cbs.push(checkbox),dom.place(checkbox.domNode,currentLegendNode,"first");var clabel=query("label",currentLegendNode)[0];domProp.set(clabel,"for",checkbox.id)},_applyEvents:function(){if(this.chart.dirty)return;arrayUtil.forEach(this.legends,function(legend,i){var targetData,shapes=[],plotName,seriesName;this._isPie()?(targetData=this.chart.stack[0],shapes.push(targetData.group.children[i]),plotName=targetData.name,seriesName=this.chart.series[0].name):(targetData=this.chart.series[i],shapes=targetData.group.children,plotName=targetData.plot,seriesName=targetData.name);var originalDyn={fills:df.map(shapes,"x.getFill()"),strokes:df.map(shapes,"x.getStroke()")},legendCheckBox=query(".dijitCheckBox",legend)[0];hub.connect(legendCheckBox,"onclick",this,function(e){this._toggle(shapes,i,legend.vanished,originalDyn,seriesName,plotName),legend.vanished=!legend.vanished,e.stopPropagation()});var legendIcon=query(".dojoxLegendIcon",legend)[0],iconShape=this._getFilledShape(this._surfaces[i].children);arrayUtil.forEach(["onmouseenter","onmouseleave"],function(event){hub.connect(legendIcon,event,this,function(e){this._highlight(e,iconShape,shapes,i,legend.vanished,originalDyn,seriesName,plotName)})},this)},this)},_toggle:function(shapes,index,isOff,dyn,seriesName,plotName){arrayUtil.forEach(shapes,function(shape,i){var startFill=dyn.fills[i],endFill=this._getTransitionFill(plotName),startStroke=dyn.strokes[i],endStroke=this.transitionStroke;startFill&&(endFill&&(typeof startFill=="string"||startFill instanceof Color)?fx.animateFill({shape:shape,color:{start:isOff?endFill:startFill,end:isOff?startFill:endFill}}).play():shape.setFill(isOff?startFill:endFill)),startStroke&&!this.outline&&shape.setStroke(isOff?startStroke:endStroke)},this)},_highlight:function(e,iconShape,shapes,index,isOff,dyn,seriesName,plotName){if(!isOff){var anim=this._getAnim(plotName),isPie=this._isPie(),type=formatEventType(e.type),label={shape:iconShape,index:isPie?"legend"+index:"legend",run:{name:seriesName},type:type};anim.process(label),arrayUtil.forEach(shapes,function(shape,i){shape.setFill(dyn.fills[i]);var o={shape:shape,index:isPie?index:i,run:{name:seriesName},type:type};anim.duration=100,anim.process(o)})}},_getAnim:function(plotName){return this.legendAnim[plotName]||(this.legendAnim[plotName]=new Highlight(this.chart,plotName),this.chart.getPlot(plotName).dirty=!1),this.legendAnim[plotName]},_getTransitionFill:function(plotName){return this.chart.stack[this.chart.plots[plotName]].declaredClass.indexOf("dojox.charting.plot2d.Stacked")!=-1?this.chart.theme.plotarea.fill:null},_getFilledShape:function(shapes){var i=0;while(shapes[i]){if(shapes[i].getFill())return shapes[i];i++}return null},_isPie:function(){return this.chart.stack[0].declaredClass=="dojox.charting.plot2d.Pie"},destroy:function(){this._clearLabels(),this.inherited(arguments)}});return SelectableLegend})