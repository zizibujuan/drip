//>>built
define("dijit/focus",["dojo/aspect","dojo/_base/declare","dojo/dom","dojo/dom-attr","dojo/dom-construct","dojo/Evented","dojo/_base/lang","dojo/on","dojo/domReady","dojo/sniff","dojo/Stateful","dojo/_base/unload","dojo/_base/window","dojo/window","./a11y","./registry","./main"],function(aspect,declare,dom,domAttr,domConstruct,Evented,lang,on,domReady,has,Stateful,unload,win,winUtils,a11y,registry,dijit){var FocusManager=declare([Stateful,Evented],{curNode:null,activeStack:[],constructor:function(){var check=lang.hitch(this,function(node){dom.isDescendant(this.curNode,node)&&this.set("curNode",null),dom.isDescendant(this.prevNode,node)&&this.set("prevNode",null)});aspect.before(domConstruct,"empty",check),aspect.before(domConstruct,"destroy",check)},registerIframe:function(iframe){return this.registerWin(iframe.contentWindow,iframe)},registerWin:function(targetWindow,effectiveNode){var _this=this,mousedownListener=function(evt){_this._justMouseDowned=!0,setTimeout(function(){_this._justMouseDowned=!1},0);if(has("ie")&&evt&&evt.srcElement&&evt.srcElement.parentNode==null)return;_this._onTouchNode(effectiveNode||evt.target||evt.srcElement,"mouse")},doc=has("ie")?targetWindow.document.documentElement:targetWindow.document;if(doc){if(has("ie")){targetWindow.document.body.attachEvent("onmousedown",mousedownListener);var focusinListener=function(evt){if(!evt.srcElement.tagName)return;var tag=evt.srcElement.tagName.toLowerCase();if(tag=="#document"||tag=="body")return;a11y.isTabNavigable(evt.srcElement)?_this._onFocusNode(effectiveNode||evt.srcElement):_this._onTouchNode(effectiveNode||evt.srcElement)};doc.attachEvent("onfocusin",focusinListener);var focusoutListener=function(evt){_this._onBlurNode(effectiveNode||evt.srcElement)};return doc.attachEvent("onfocusout",focusoutListener),{remove:function(){targetWindow.document.detachEvent("onmousedown",mousedownListener),doc.detachEvent("onfocusin",focusinListener),doc.detachEvent("onfocusout",focusoutListener),doc=null}}}doc.body.addEventListener("mousedown",mousedownListener,!0),doc.body.addEventListener("touchstart",mousedownListener,!0);var focusListener=function(evt){_this._onFocusNode(effectiveNode||evt.target)};doc.addEventListener("focus",focusListener,!0);var blurListener=function(evt){_this._onBlurNode(effectiveNode||evt.target)};return doc.addEventListener("blur",blurListener,!0),{remove:function(){doc.body.removeEventListener("mousedown",mousedownListener,!0),doc.body.removeEventListener("touchstart",mousedownListener,!0),doc.removeEventListener("focus",focusListener,!0),doc.removeEventListener("blur",blurListener,!0),doc=null}}}},_onBlurNode:function(node){this._clearFocusTimer&&clearTimeout(this._clearFocusTimer),this._clearFocusTimer=setTimeout(lang.hitch(this,function(){this.set("prevNode",this.curNode),this.set("curNode",null)}),0);if(this._justMouseDowned)return;this._clearActiveWidgetsTimer&&clearTimeout(this._clearActiveWidgetsTimer),this._clearActiveWidgetsTimer=setTimeout(lang.hitch(this,function(){delete this._clearActiveWidgetsTimer,this._setStack([])}),0)},_onTouchNode:function(node,by){this._clearActiveWidgetsTimer&&(clearTimeout(this._clearActiveWidgetsTimer),delete this._clearActiveWidgetsTimer);var newStack=[];try{while(node){var popupParent=domAttr.get(node,"dijitPopupParent");if(popupParent)node=registry.byId(popupParent).domNode;else if(node.tagName&&node.tagName.toLowerCase()=="body"){if(node===win.body())break;node=winUtils.get(node.ownerDocument).frameElement}else{var id=node.getAttribute&&node.getAttribute("widgetId"),widget=id&&registry.byId(id);widget&&(by!="mouse"||!widget.get("disabled"))&&newStack.unshift(id),node=node.parentNode}}}catch(e){}this._setStack(newStack,by)},_onFocusNode:function(node){if(!node)return;if(node.nodeType==9)return;this._clearFocusTimer&&(clearTimeout(this._clearFocusTimer),delete this._clearFocusTimer),this._onTouchNode(node);if(node==this.curNode)return;this.set("prevNode",this.curNode),this.set("curNode",node)},_setStack:function(newStack,by){var oldStack=this.activeStack;this.set("activeStack",newStack);for(var nCommon=0;nCommon<Math.min(oldStack.length,newStack.length);nCommon++)if(oldStack[nCommon]!=newStack[nCommon])break;var widget;for(var i=oldStack.length-1;i>=nCommon;i--)widget=registry.byId(oldStack[i]),widget&&(widget._hasBeenBlurred=!0,widget.set("focused",!1),widget._focusManager==this&&widget._onBlur(by),this.emit("widget-blur",widget,by));for(i=nCommon;i<newStack.length;i++)widget=registry.byId(newStack[i]),widget&&(widget.set("focused",!0),widget._focusManager==this&&widget._onFocus(by),this.emit("widget-focus",widget,by))},focus:function(node){if(node)try{node.focus()}catch(e){}}}),singleton=new FocusManager;domReady(function(){var handle=singleton.registerWin(winUtils.get(win.doc));has("ie")&&unload.addOnWindowUnload(function(){handle&&(handle.remove(),handle=null)})}),dijit.focus=function(node){singleton.focus(node)};for(var attr in singleton)/^_/.test(attr)||(dijit.focus[attr]=typeof singleton[attr]=="function"?lang.hitch(singleton,attr):singleton[attr]);return singleton.watch(function(attr,oldVal,newVal){dijit.focus[attr]=newVal}),singleton})