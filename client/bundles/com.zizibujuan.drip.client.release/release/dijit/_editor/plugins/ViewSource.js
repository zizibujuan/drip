//>>built
define("dijit/_editor/plugins/ViewSource",["dojo/_base/array","dojo/_base/declare","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/i18n","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../../focus","../_Plugin","../../form/ToggleButton","../..","../../registry","dojo/aspect","dojo/i18n!../nls/commands"],function(array,declare,domAttr,domConstruct,domGeometry,domStyle,i18n,keys,lang,on,has,win,winUtils,focus,_Plugin,ToggleButton,dijit,registry,aspect){var ViewSource=declare("dijit._editor.plugins.ViewSource",_Plugin,{stripScripts:!0,stripComments:!0,stripIFrames:!0,readOnly:!1,_fsPlugin:null,toggle:function(){has("webkit")&&(this._vsFocused=!0),this.button.set("checked",!this.button.get("checked"))},_initButton:function(){var strings=i18n.getLocalization("dijit._editor","commands"),editor=this.editor;this.button=new ToggleButton({label:strings.viewSource,ownerDocument:editor.ownerDocument,dir:editor.dir,lang:editor.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:lang.hitch(this,"_showSource")}),has("ie")==7&&(this._ieFixNode=domConstruct.create("div",{style:{opacity:"0",zIndex:"-1000",position:"absolute",top:"-1000px"}},editor.ownerDocumentBody)),this.button.set("readOnly",!1)},setEditor:function(editor){this.editor=editor,this._initButton(),this.editor.addKeyHandler(keys.F12,!0,!0,lang.hitch(this,function(e){this.button.focus(),this.toggle(),e.stopPropagation(),e.preventDefault(),setTimeout(lang.hitch(this,function(){this.editor.focus()}),100)}))},_showSource:function(source){var ed=this.editor,edPlugins=ed._plugins,html;this._sourceShown=source;var self=this;try{this.sourceArea||this._createSourceView();if(source){ed._sourceQueryCommandEnabled=ed.queryCommandEnabled,ed.queryCommandEnabled=function(cmd){return cmd.toLowerCase()==="viewsource"},this.editor.onDisplayChanged(),html=ed.get("value"),html=this._filter(html),ed.set("value",html),array.forEach(edPlugins,function(p){p&&!(p instanceof ViewSource)&&p.isInstanceOf(_Plugin)&&p.set("disabled",!0)}),this._fsPlugin&&(this._fsPlugin._getAltViewNode=function(){return self.sourceArea}),this.sourceArea.value=html,this.sourceArea.style.height=ed.iframe.style.height,this.sourceArea.style.width=ed.iframe.style.width,domStyle.set(ed.iframe,"display","none"),domStyle.set(this.sourceArea,{display:"block"});var resizer=function(){var vp=winUtils.getBox(ed.ownerDocument);if("_prevW"in this&&"_prevH"in this){if(vp.w===this._prevW&&vp.h===this._prevH)return;this._prevW=vp.w,this._prevH=vp.h}else this._prevW=vp.w,this._prevH=vp.h;this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizer=setTimeout(lang.hitch(this,function(){delete this._resizer,this._resize()}),10)};this._resizeHandle=on(window,"resize",lang.hitch(this,resizer)),setTimeout(lang.hitch(this,this._resize),100),this.editor.onNormalizedDisplayChanged(),this.editor.__oldGetValue=this.editor.getValue,this.editor.getValue=lang.hitch(this,function(){var txt=this.sourceArea.value;return txt=this._filter(txt),txt}),this._setListener=aspect.after(this.editor,"setValue",lang.hitch(this,function(htmlTxt){htmlTxt=htmlTxt||"",htmlTxt=this._filter(htmlTxt),this.sourceArea.value=htmlTxt}),!0)}else{if(!ed._sourceQueryCommandEnabled)return;this._setListener.remove(),delete this._setListener,this._resizeHandle.remove(),delete this._resizeHandle,this.editor.__oldGetValue&&(this.editor.getValue=this.editor.__oldGetValue,delete this.editor.__oldGetValue),ed.queryCommandEnabled=ed._sourceQueryCommandEnabled,this._readOnly||(html=this.sourceArea.value,html=this._filter(html),ed.beginEditing(),ed.set("value",html),ed.endEditing()),array.forEach(edPlugins,function(p){p&&p.isInstanceOf(_Plugin)&&p.set("disabled",!1)}),domStyle.set(this.sourceArea,"display","none"),domStyle.set(ed.iframe,"display","block"),delete ed._sourceQueryCommandEnabled,this.editor.onDisplayChanged()}setTimeout(lang.hitch(this,function(){var parent=ed.domNode.parentNode;if(parent){var container=registry.getEnclosingWidget(parent);container&&container.resize&&container.resize()}ed.resize()}),300)}catch(e){0}},updateState:function(){this.button.set("disabled",this.get("disabled"))},_resize:function(){var ed=this.editor,tbH=ed.getHeaderHeight(),fH=ed.getFooterHeight(),eb=domGeometry.position(ed.domNode),containerPadding=domGeometry.getPadBorderExtents(ed.iframe.parentNode),containerMargin=domGeometry.getMarginExtents(ed.iframe.parentNode),extents=domGeometry.getPadBorderExtents(ed.domNode),edb={w:eb.w-extents.w,h:eb.h-(tbH+extents.h+fH)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var vp=winUtils.getBox(ed.ownerDocument);edb.w=vp.w-extents.w,edb.h=vp.h-(tbH+extents.h+fH)}has("ie")&&(edb.h-=2);if(this._ieFixNode){var _ie7zoom=-this._ieFixNode.offsetTop/1e3;edb.w=Math.floor((edb.w+.9)/_ie7zoom),edb.h=Math.floor((edb.h+.9)/_ie7zoom)}domGeometry.setMarginBox(this.sourceArea,{w:edb.w-(containerPadding.w+containerMargin.w),h:edb.h-(containerPadding.h+containerMargin.h)}),domGeometry.setMarginBox(ed.iframe.parentNode,{h:edb.h})},_createSourceView:function(){var ed=this.editor,edPlugins=ed._plugins;this.sourceArea=domConstruct.create("textarea"),this.readOnly&&(domAttr.set(this.sourceArea,"readOnly",!0),this._readOnly=!0),domStyle.set(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),domAttr.set(this.sourceArea,"aria-label",this.editor.id),domConstruct.place(this.sourceArea,ed.iframe,"before"),has("ie")&&ed.iframe.parentNode.lastChild!==ed.iframe&&domStyle.set(ed.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),ed._viewsource_oldFocus=ed.focus;var self=this;ed.focus=function(){if(self._sourceShown)self.setSourceAreaCaret();else try{this._vsFocused?(delete this._vsFocused,focus.focus(ed.editNode)):ed._viewsource_oldFocus()}catch(e){0}};var i,p;for(i=0;i<edPlugins.length;i++){p=edPlugins[i];if(p&&(p.declaredClass==="dijit._editor.plugins.FullScreen"||p.declaredClass===dijit._scopeName+"._editor.plugins.FullScreen")){this._fsPlugin=p;break}}this._fsPlugin&&(this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode,this._fsPlugin._getAltViewNode=function(){return self._sourceShown?self.sourceArea:this._viewsource_getAltViewNode()}),this.own(on(this.sourceArea,"keydown",lang.hitch(this,function(e){this._sourceShown&&e.keyCode==keys.F12&&e.ctrlKey&&e.shiftKey&&(this.button.focus(),this.button.set("checked",!1),setTimeout(lang.hitch(this,function(){ed.focus()}),100),e.stopPropagation(),e.preventDefault())})))},_stripScripts:function(html){return html&&(html=html.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/ig,""),html=html.replace(/<\s*script\b([^<>]|\s)*>?/ig,""),html=html.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/ig,"")),html},_stripComments:function(html){return html&&(html=html.replace(/<!--(.|\s){1,}?-->/g,"")),html},_stripIFrames:function(html){return html&&(html=html.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/ig,"")),html},_filter:function(html){return html&&(this.stripScripts&&(html=this._stripScripts(html)),this.stripComments&&(html=this._stripComments(html)),this.stripIFrames&&(html=this._stripIFrames(html))),html},setSourceAreaCaret:function(){var global=win.global,elem=this.sourceArea;focus.focus(elem);if(this._sourceShown&&!this.readOnly)if(has("ie")){if(this.sourceArea.createTextRange){var range=elem.createTextRange();range.collapse(!0),range.moveStart("character",-99999),range.moveStart("character",0),range.moveEnd("character",0),range.select()}}else global.getSelection&&elem.setSelectionRange&&elem.setSelectionRange(0,0)},destroy:function(){this._ieFixNode&&domConstruct.destroy(this._ieFixNode),this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizeHandle&&(this._resizeHandle.remove(),delete this._resizeHandle),this._setListener&&(this._setListener.remove(),delete this._setListener),this.inherited(arguments)}});return _Plugin.registry.viewSource=_Plugin.registry.viewsource=function(args){return new ViewSource({readOnly:"readOnly"in args?args.readOnly:!1,stripComments:"stripComments"in args?args.stripComments:!0,stripScripts:"stripScripts"in args?args.stripScripts:!0,stripIFrames:"stripIFrames"in args?args.stripIFrames:!0})},ViewSource})