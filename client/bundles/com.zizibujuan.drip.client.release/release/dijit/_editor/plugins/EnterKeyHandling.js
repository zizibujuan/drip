//>>built
define("dijit/_editor/plugins/EnterKeyHandling",["dojo/_base/declare","dojo/dom-construct","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../_Plugin","../RichText","../range","../../_base/focus"],function(declare,domConstruct,keys,lang,on,has,win,winUtils,_Plugin,RichText,rangeapi,baseFocus){return declare("dijit._editor.plugins.EnterKeyHandling",_Plugin,{blockNodeForEnter:"BR",constructor:function(args){args&&("blockNodeForEnter"in args&&(args.blockNodeForEnter=args.blockNodeForEnter.toUpperCase()),lang.mixin(this,args))},setEditor:function(editor){if(this.editor===editor)return;this.editor=editor;if(this.blockNodeForEnter=="BR")this.editor.customUndo=!0,editor.onLoadDeferred.then(lang.hitch(this,function(d){return this.own(on(editor.document,"keydown",lang.hitch(this,function(e){if(e.keyCode==keys.ENTER){var ne=lang.mixin({},e);ne.shiftKey=!0,this.handleEnterKey(ne)||(e.stopPropagation(),e.preventDefault())}}))),has("ie")>=9&&this.own(on(editor.document,"paste",lang.hitch(this,function(e){setTimeout(lang.hitch(this,function(){var r=this.editor.document.selection.createRange();r.move("character",-1),r.select(),r.move("character",1),r.select()}),0)}))),d}));else if(this.blockNodeForEnter){var h=lang.hitch(this,"handleEnterKey");editor.addKeyHandler(13,0,0,h),editor.addKeyHandler(13,0,1,h),this.own(this.editor.on("KeyPressed",lang.hitch(this,"onKeyPressed")))}},onKeyPressed:function(){if(this._checkListLater){if(win.withGlobal(this.editor.window,"isCollapsed",baseFocus)){var liparent=this.editor.selection.getAncestorElement("LI");if(!liparent){RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var block=this.editor.selection.getAncestorElement(this.blockNodeForEnter);if(block){block.innerHTML=this.bogusHtmlContent;if(has("ie")<=9){var r=this.editor.document.selection.createRange();r.move("character",-1),r.select()}}else 0}else{has("mozilla")&&liparent.parentNode.parentNode.nodeName=="LI"&&(liparent=liparent.parentNode.parentNode);var fc=liparent.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){liparent.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var newrange=rangeapi.create(this.editor.window);newrange.setStart(liparent.firstChild,0);var selection=rangeapi.getSelection(this.editor.window,!0);selection.removeAllRanges(),selection.addRange(newrange)}}}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var selection,range,newrange,startNode,endNode,brNode,doc=this.editor.document,br,rs,txt;if(e.shiftKey){var parent=this.editor.selection.getParentElement(),header=rangeapi.getAncestor(parent,this.blockNodes);if(header){if(header.tagName=="LI")return!0;selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0),range.collapsed||(range.deleteContents(),selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0));if(rangeapi.atBeginningOfContainer(header,range.startContainer,range.startOffset))br=doc.createElement("br"),newrange=rangeapi.create(this.editor.window),header.insertBefore(br,header.firstChild),newrange.setStartAfter(br),selection.removeAllRanges(),selection.addRange(newrange);else{if(!rangeapi.atEndOfContainer(header,range.startContainer,range.startOffset))return rs=range.startContainer,rs&&rs.nodeType==3?(txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,range.startOffset)),endNode=doc.createTextNode(txt.substring(range.startOffset)),brNode=doc.createElement("br"),endNode.nodeValue==""&&has("webkit")&&(endNode=doc.createTextNode(" ")),domConstruct.place(startNode,rs,"after"),domConstruct.place(brNode,startNode,"after"),domConstruct.place(endNode,brNode,"after"),domConstruct.destroy(rs),newrange=rangeapi.create(this.editor.window),newrange.setStart(endNode,0),selection.removeAllRanges(),selection.addRange(newrange),!1):!0;newrange=rangeapi.create(this.editor.window),br=doc.createElement("br"),header.appendChild(br),header.appendChild(doc.createTextNode(" ")),newrange.setStart(header.lastChild,0),selection.removeAllRanges(),selection.addRange(newrange)}}else{selection=rangeapi.getSelection(this.editor.window);if(selection.rangeCount){range=selection.getRangeAt(0);if(range&&range.startContainer){range.collapsed||(range.deleteContents(),selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0)),rs=range.startContainer;if(rs&&rs.nodeType==3){var endEmpty=!1,offset=range.startOffset;rs.length<offset&&(ret=this._adjustNodeAndOffset(rs,offset),rs=ret.node,offset=ret.offset),txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,offset)),endNode=doc.createTextNode(txt.substring(offset)),brNode=doc.createElement("br"),endNode.length||(endNode=doc.createTextNode(" "),endEmpty=!0),startNode.length?domConstruct.place(startNode,rs,"after"):startNode=rs,domConstruct.place(brNode,startNode,"after"),domConstruct.place(endNode,brNode,"after"),domConstruct.destroy(rs),newrange=rangeapi.create(this.editor.window),newrange.setStart(endNode,0),newrange.setEnd(endNode,endNode.length),selection.removeAllRanges(),selection.addRange(newrange),endEmpty&&!has("webkit")?this.editor.selection.remove():this.editor.selection.collapse(!0)}else{var targetNode;range.startOffset>=0&&(targetNode=rs.childNodes[range.startOffset]);var brNode=doc.createElement("br"),endNode=doc.createTextNode(" ");targetNode?(domConstruct.place(brNode,targetNode,"before"),domConstruct.place(endNode,brNode,"after")):(rs.appendChild(brNode),rs.appendChild(endNode)),newrange=rangeapi.create(this.editor.window),newrange.setStart(endNode,0),newrange.setEnd(endNode,endNode.length),selection.removeAllRanges(),selection.addRange(newrange),this.editor.selection.collapse(!0)}}}else RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>")}return!1}var _letBrowserHandle=!0;selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0),range.collapsed||(range.deleteContents(),selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0));var block=rangeapi.getBlockAncestor(range.endContainer,null,this.editor.editNode),blockNode=block.blockNode;if(this._checkListLater=blockNode&&(blockNode.nodeName=="LI"||blockNode.parentNode.nodeName=="LI"))return has("mozilla")&&(this._pressedEnterInBlock=blockNode),/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(blockNode.innerHTML)&&(blockNode.innerHTML="",has("webkit")&&(newrange=rangeapi.create(this.editor.window),newrange.setStart(blockNode,0),selection.removeAllRanges(),selection.addRange(newrange)),this._checkListLater=!1),!0;if(!block.blockNode||block.blockNode===this.editor.editNode){try{RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(e2){}block={blockNode:this.editor.selection.getAncestorElement(this.blockNodeForEnter),blockContainer:this.editor.editNode};if(block.blockNode){if(block.blockNode!=this.editor.editNode&&!(block.blockNode.textContent||block.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(block.blockNode),!1}else block.blockNode=this.editor.editNode;selection=rangeapi.getSelection(this.editor.window),range=selection.getRangeAt(0)}var newblock=doc.createElement(this.blockNodeForEnter);newblock.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(block.blockNode);var endOffset=range.endOffset,node=range.endContainer;if(node.length<endOffset){var ret=this._adjustNodeAndOffset(node,endOffset);node=ret.node,endOffset=ret.offset}if(rangeapi.atEndOfContainer(block.blockNode,node,endOffset))block.blockNode===block.blockContainer?block.blockNode.appendChild(newblock):domConstruct.place(newblock,block.blockNode,"after"),_letBrowserHandle=!1,newrange=rangeapi.create(this.editor.window),newrange.setStart(newblock,0),selection.removeAllRanges(),selection.addRange(newrange),this.editor.height&&winUtils.scrollIntoView(newblock);else if(rangeapi.atBeginningOfContainer(block.blockNode,range.startContainer,range.startOffset))domConstruct.place(newblock,block.blockNode,block.blockNode===block.blockContainer?"first":"before"),newblock.nextSibling&&this.editor.height&&(newrange=rangeapi.create(this.editor.window),newrange.setStart(newblock.nextSibling,0),selection.removeAllRanges(),selection.addRange(newrange),winUtils.scrollIntoView(newblock.nextSibling)),_letBrowserHandle=!1;else{block.blockNode===block.blockContainer?block.blockNode.appendChild(newblock):domConstruct.place(newblock,block.blockNode,"after"),_letBrowserHandle=!1,block.blockNode.style&&newblock.style&&block.blockNode.style.cssText&&(newblock.style.cssText=block.blockNode.style.cssText),rs=range.startContainer;var firstNodeMoved;if(rs&&rs.nodeType==3){var nodeToMove,tNode;endOffset=range.endOffset,rs.length<endOffset&&(ret=this._adjustNodeAndOffset(rs,endOffset),rs=ret.node,endOffset=ret.offset),txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,endOffset)),endNode=doc.createTextNode(txt.substring(endOffset,txt.length)),domConstruct.place(startNode,rs,"before"),domConstruct.place(endNode,rs,"after"),domConstruct.destroy(rs);var parentC=startNode.parentNode;while(parentC!==block.blockNode){var tg=parentC.tagName,newTg=doc.createElement(tg);parentC.style&&newTg.style&&parentC.style.cssText&&(newTg.style.cssText=parentC.style.cssText),parentC.tagName==="FONT"&&(parentC.color&&(newTg.color=parentC.color),parentC.face&&(newTg.face=parentC.face),parentC.size&&(newTg.size=parentC.size)),nodeToMove=endNode;while(nodeToMove)tNode=nodeToMove.nextSibling,newTg.appendChild(nodeToMove),nodeToMove=tNode;domConstruct.place(newTg,parentC,"after"),startNode=parentC,endNode=newTg,parentC=parentC.parentNode}nodeToMove=endNode;if(nodeToMove.nodeType==1||nodeToMove.nodeType==3&&nodeToMove.nodeValue)newblock.innerHTML="";firstNodeMoved=nodeToMove;while(nodeToMove)tNode=nodeToMove.nextSibling,newblock.appendChild(nodeToMove),nodeToMove=tNode}newrange=rangeapi.create(this.editor.window);var nodeForCursor,innerMostFirstNodeMoved=firstNodeMoved;if(this.blockNodeForEnter!=="BR"){while(innerMostFirstNodeMoved)nodeForCursor=innerMostFirstNodeMoved,tNode=innerMostFirstNodeMoved.firstChild,innerMostFirstNodeMoved=tNode;nodeForCursor&&nodeForCursor.parentNode?(newblock=nodeForCursor.parentNode,newrange.setStart(newblock,0),selection.removeAllRanges(),selection.addRange(newrange),this.editor.height&&winUtils.scrollIntoView(newblock),has("mozilla")&&(this._pressedEnterInBlock=block.blockNode)):_letBrowserHandle=!0}else newrange.setStart(newblock,0),selection.removeAllRanges(),selection.addRange(newrange),this.editor.height&&winUtils.scrollIntoView(newblock),has("mozilla")&&(this._pressedEnterInBlock=block.blockNode)}return _letBrowserHandle},_adjustNodeAndOffset:function(node,offset){while(node.length<offset&&node.nextSibling&&node.nextSibling.nodeType==3)offset-=node.length,node=node.nextSibling;return{node:node,offset:offset}},removeTrailingBr:function(container){var para=/P|DIV|LI/i.test(container.tagName)?container:this.editor.selection.getParentOfType(container,["P","DIV","LI"]);if(!para)return;para.lastChild&&(para.childNodes.length>1&&para.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(para.lastChild.nodeValue)||para.lastChild.tagName=="BR")&&domConstruct.destroy(para.lastChild),para.childNodes.length||(para.innerHTML=this.bogusHtmlContent)}})})