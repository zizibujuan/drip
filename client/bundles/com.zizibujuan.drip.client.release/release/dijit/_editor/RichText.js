//>>built
define("dijit/_editor/RichText",["dojo/_base/array","dojo/_base/config","dojo/_base/declare","dojo/_base/Deferred","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/_base/kernel","dojo/keys","dojo/_base/lang","dojo/on","dojo/query","dojo/domReady","dojo/sniff","dojo/topic","dojo/_base/unload","dojo/_base/url","dojo/_base/window","../_Widget","../_CssStateMixin","../selection","./range","./html","../focus","../main"],function(array,config,declare,Deferred,dom,domAttr,domClass,domConstruct,domGeometry,domStyle,kernel,keys,lang,on,query,domReady,has,topic,unload,_Url,win,_Widget,_CssStateMixin,selectionapi,rangeapi,htmlapi,focus,dijit){var RichText=declare("dijit._editor.RichText",[_Widget,_CssStateMixin],{constructor:function(params){this.contentPreFilters=[],this.contentPostFilters=[],this.contentDomPreFilters=[],this.contentDomPostFilters=[],this.editingAreaStyleSheets=[],this.events=[].concat(this.events),this._keyHandlers={},params&&lang.isString(params.value)&&(this.value=params.value),this.onLoadDeferred=new Deferred},baseClass:"dijitEditor",inheritWidth:!1,focusOnLoad:!1,name:"",styleSheets:"",height:"300px",minHeight:"1em",isClosed:!0,isLoaded:!1,_SEPARATOR:"@@**%%__RICHTEXTBOUNDRY__%%**@@",_NAME_CONTENT_SEP:"@@**%%:%%**@@",onLoadDeferred:null,isTabIndent:!1,disableSpellCheck:!1,postCreate:function(){"textarea"===this.domNode.tagName.toLowerCase()&&0,this.contentPreFilters=[lang.hitch(this,"_preFixUrlAttributes")].concat(this.contentPreFilters),has("mozilla")&&(this.contentPreFilters=[this._normalizeFontStyle].concat(this.contentPreFilters),this.contentPostFilters=[this._removeMozBogus].concat(this.contentPostFilters)),has("webkit")&&(this.contentPreFilters=[this._removeWebkitBogus].concat(this.contentPreFilters),this.contentPostFilters=[this._removeWebkitBogus].concat(this.contentPostFilters)),has("ie")&&(this.contentPostFilters=[this._normalizeFontStyle].concat(this.contentPostFilters),this.contentDomPostFilters=[lang.hitch(this,this._stripBreakerNodes)].concat(this.contentDomPostFilters)),this.inherited(arguments),topic.publish(dijit._scopeName+"._editor.RichText::init",this),this.open(),this.setupDefaultShortcuts()},setupDefaultShortcuts:function(){var exec=lang.hitch(this,function(cmd,arg){return function(){return!this.execCommand(cmd,arg)}}),ctrlKeyHandlers={b:exec("bold"),i:exec("italic"),u:exec("underline"),a:exec("selectall"),s:function(){this.save(!0)},m:function(){this.isTabIndent=!this.isTabIndent},1:exec("formatblock","h1"),2:exec("formatblock","h2"),3:exec("formatblock","h3"),4:exec("formatblock","h4"),"\\":exec("insertunorderedlist")};has("ie")||(ctrlKeyHandlers.Z=exec("redo"));var key;for(key in ctrlKeyHandlers)this.addKeyHandler(key,!0,!1,ctrlKeyHandlers[key])},events:["onKeyDown","onKeyUp"],captureEvents:[],_editorCommandsLocalized:!1,_localizeEditorCommands:function(){if(RichText._editorCommandsLocalized){this._local2NativeFormatNames=RichText._local2NativeFormatNames,this._native2LocalFormatNames=RichText._native2LocalFormatNames;return}RichText._editorCommandsLocalized=!0,RichText._local2NativeFormatNames={},RichText._native2LocalFormatNames={},this._local2NativeFormatNames=RichText._local2NativeFormatNames,this._native2LocalFormatNames=RichText._native2LocalFormatNames;var formats=["div","p","pre","h1","h2","h3","h4","h5","h6","ol","ul","address"],localhtml="",format,i=0;while(format=formats[i++])format.charAt(1)!=="l"?localhtml+="<"+format+"><span>content</span></"+format+"><br/>":localhtml+="<"+format+"><li>content</li></"+format+"><br/>";var style={position:"absolute",top:"0px",zIndex:10,opacity:.01},div=domConstruct.create("div",{style:style,innerHTML:localhtml});this.ownerDocumentBody.appendChild(div);var inject=lang.hitch(this,function(){var node=div.firstChild;while(node)try{this.selection.selectElement(node.firstChild);var nativename=node.tagName.toLowerCase();this._local2NativeFormatNames[nativename]=document.queryCommandValue("formatblock"),this._native2LocalFormatNames[this._local2NativeFormatNames[nativename]]=nativename,node=node.nextSibling.nextSibling}catch(e){}domConstruct.destroy(div)});this.defer(inject)},open:function(element){if(!this.onLoadDeferred||this.onLoadDeferred.fired>=0)this.onLoadDeferred=new Deferred;this.isClosed||this.close(),topic.publish(dijit._scopeName+"._editor.RichText::open",this),arguments.length===1&&element.nodeName&&(this.domNode=element);var dn=this.domNode,html;if(lang.isString(this.value))html=this.value,delete this.value,dn.innerHTML="";else if(dn.nodeName&&dn.nodeName.toLowerCase()=="textarea"){var ta=this.textarea=dn;this.name=ta.name,html=ta.value,dn=this.domNode=this.ownerDocument.createElement("div"),dn.setAttribute("widgetId",this.id),ta.removeAttribute("widgetId"),dn.cssText=ta.cssText,dn.className+=" "+ta.className,domConstruct.place(dn,ta,"before");var tmpFunc=lang.hitch(this,function(){domStyle.set(ta,{display:"block",position:"absolute",top:"-1000px"});if(has("ie")){var s=ta.style;this.__overflow=s.overflow,s.overflow="hidden"}});has("ie")?this.defer(tmpFunc,10):tmpFunc();if(ta.form){var resetValue=ta.value;this.reset=function(){var current=this.getValue();current!==resetValue&&this.replaceValue(resetValue)},on(ta.form,"submit",lang.hitch(this,function(){domAttr.set(ta,"disabled",this.disabled),ta.value=this.getValue()}))}}else html=htmlapi.getChildrenHtml(dn),dn.innerHTML="";this.value=html,dn.nodeName&&dn.nodeName==="LI"&&(dn.innerHTML=" <br>"),this.header=dn.ownerDocument.createElement("div"),dn.appendChild(this.header),this.editingArea=dn.ownerDocument.createElement("div"),dn.appendChild(this.editingArea),this.footer=dn.ownerDocument.createElement("div"),dn.appendChild(this.footer),this.name||(this.name=this.id+"_AUTOGEN");if(this.name!==""&&(!config.useXDomain||config.allowXdRichTextSave)){var saveTextarea=dom.byId(dijit._scopeName+"._editor.RichText.value");if(saveTextarea&&saveTextarea.value!==""){var datas=saveTextarea.value.split(this._SEPARATOR),i=0,dat;while(dat=datas[i++]){var data=dat.split(this._NAME_CONTENT_SEP);if(data[0]===this.name){html=data[1],datas=datas.splice(i,1),saveTextarea.value=datas.join(this._SEPARATOR);break}}}RichText._globalSaveHandler||(RichText._globalSaveHandler={},unload.addOnUnload(function(){var id;for(id in RichText._globalSaveHandler){var f=RichText._globalSaveHandler[id];lang.isFunction(f)&&f()}})),RichText._globalSaveHandler[this.id]=lang.hitch(this,"_saveContent")}this.isClosed=!1;var ifr=this.editorObject=this.iframe=this.ownerDocument.createElement("iframe");ifr.id=this.id+"_iframe",ifr.style.border="none",ifr.style.width="100%",this._layoutMode?ifr.style.height="100%":has("ie")>=7?(this.height&&(ifr.style.height=this.height),this.minHeight&&(ifr.style.minHeight=this.minHeight)):ifr.style.height=this.height?this.height:this.minHeight,ifr.frameBorder=0,ifr._loadFunc=lang.hitch(this,function(w){this.window=w,this.document=this.window.document,this.selection=new selectionapi.SelectionManager(w),has("ie")&&this._localizeEditorCommands(),this.onLoad(html)});var src=this._getIframeDocTxt(),s="javascript: '"+src.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'";has("ie")>=9?(this.editingArea.appendChild(ifr),ifr.src=s):(ifr.setAttribute("src",s),this.editingArea.appendChild(ifr)),dn.nodeName==="LI"&&(dn.lastChild.style.marginTop="-1.2em"),domClass.add(this.domNode,this.baseClass)},_local2NativeFormatNames:{},_native2LocalFormatNames:{},_getIframeDocTxt:function(){var _cs=domStyle.getComputedStyle(this.domNode),html="",setBodyId=!0;has("ie")||has("webkit")||!this.height&&!has("mozilla")?(html="<div id='dijitEditorBody'></div>",setBodyId=!1):has("mozilla")&&(this._cursorToStart=!0,html="&#160;");var font=[_cs.fontWeight,_cs.fontSize,_cs.fontFamily].join(" "),lineHeight=_cs.lineHeight;lineHeight.indexOf("px")>=0?lineHeight=parseFloat(lineHeight)/parseFloat(_cs.fontSize):lineHeight.indexOf("em")>=0?lineHeight=parseFloat(lineHeight):lineHeight="normal";var userStyle="",self=this;this.style.replace(/(^|;)\s*(line-|font-?)[^;]+/ig,function(match){match=match.replace(/^;/ig,"")+";";var s=match.split(":")[0];if(s){s=lang.trim(s),s=s.toLowerCase();var i,sC="";for(i=0;i<s.length;i++){var c=s.charAt(i);switch(c){case"-":i++,c=s.charAt(i).toUpperCase();default:sC+=c}}domStyle.set(self.domNode,sC,"")}userStyle+=match+";"});var label=query('label[for="'+this.id+'"]'),title="";return label.length?title=label[0].innerHTML:this["aria-label"]?title=this["aria-label"]:this["aria-labelledby"]&&(title=dom.byId(this["aria-labelledby"]).innerHTML),this.iframe.setAttribute("title",title),[this.isLeftToRight()?"<html lang='"+this.lang+"'>\n<head>\n":"<html dir='rtl' lang='"+this.lang+"'>\n<head>\n",title?"<title>"+title+"</title>":"","<meta http-equiv='Content-Type' content='text/html'>\n","<style>\n","	body,html {\n","		background:transparent;\n","		padding: 1px 0 0 0;\n","		margin: -1px 0 0 0;\n",has("webkit")?"		width: 100%;\n":"",has("webkit")?"		height: 100%;\n":"","	}\n","	body{\n","		top:0px;\n","		left:0px;\n","		right:0px;\n","		font:",font,";\n",this.height||has("opera")?"":"		position: fixed;\n","		min-height:",this.minHeight,";\n","		line-height:",lineHeight,";\n","	}\n","	p{ margin: 1em 0; }\n",!setBodyId&&!this.height?"	body,html {overflow-y: hidden;}\n":"","	#dijitEditorBody{overflow-x: auto; overflow-y:"+(this.height?"auto;":"hidden;")+" outline: 0px;}\n","	li > ul:-moz-first-node, li > ol:-moz-first-node{ padding-top: 1.2em; }\n",has("ie")?"":"	li{ min-height:1.2em; }\n","</style>\n",this._applyEditingAreaStyleSheets(),"\n","</head>\n<body role='main' ",setBodyId?"id='dijitEditorBody' ":"","onload='frameElement && frameElement._loadFunc(window,document)' ","style='"+userStyle+"'>",html,"</body>\n</html>"].join("")},_applyEditingAreaStyleSheets:function(){var files=[];this.styleSheets&&(files=this.styleSheets.split(";"),this.styleSheets=""),files=files.concat(this.editingAreaStyleSheets),this.editingAreaStyleSheets=[];var text="",i=0,url;while(url=files[i++]){var abstring=(new _Url(win.global.location,url)).toString();this.editingAreaStyleSheets.push(abstring),text+='<link rel="stylesheet" type="text/css" href="'+abstring+'"/>'}return text},addStyleSheet:function(uri){var url=uri.toString();if(url.charAt(0)==="."||url.charAt(0)!=="/"&&!uri.host)url=(new _Url(win.global.location,url)).toString();if(array.indexOf(this.editingAreaStyleSheets,url)>-1)return;this.editingAreaStyleSheets.push(url),this.onLoadDeferred.then(lang.hitch(this,function(){if(this.document.createStyleSheet)this.document.createStyleSheet(url);else{var head=this.document.getElementsByTagName("head")[0],stylesheet=this.document.createElement("link");stylesheet.rel="stylesheet",stylesheet.type="text/css",stylesheet.href=url,head.appendChild(stylesheet)}}))},removeStyleSheet:function(uri){var url=uri.toString();if(url.charAt(0)==="."||url.charAt(0)!=="/"&&!uri.host)url=(new _Url(win.global.location,url)).toString();var index=array.indexOf(this.editingAreaStyleSheets,url);if(index===-1)return;delete this.editingAreaStyleSheets[index],query('link:[href="'+url+'"]',this.window.document).orphan()},disabled:!1,_mozSettingProps:{styleWithCSS:!1},_setDisabledAttr:function(value){value=!!value,this._set("disabled",value);if(!this.isLoaded)return;if(has("ie")||has("webkit")||has("opera")){var preventIEfocus=has("ie")&&(this.isLoaded||!this.focusOnLoad);preventIEfocus&&(this.editNode.unselectable="on"),this.editNode.contentEditable=!value,preventIEfocus&&this.defer(function(){this.editNode&&(this.editNode.unselectable="off")})}else{try{this.document.designMode=value?"off":"on"}catch(e){return}if(!value&&this._mozSettingProps){var ps=this._mozSettingProps,n;for(n in ps)if(ps.hasOwnProperty(n))try{this.document.execCommand(n,!1,ps[n])}catch(e2){}}}this._disabledOK=!0},onLoad:function(html){this.window.__registeredWindow||(this.window.__registeredWindow=!0,this._iframeRegHandle=focus.registerIframe(this.iframe));if(!has("ie")&&!has("webkit")&&(this.height||has("mozilla")))this.editNode=this.document.body;else{this.editNode=this.document.body.firstChild;var _this=this;has("ie")&&(this.tabStop=domConstruct.create("div",{tabIndex:-1},this.editingArea),this.iframe.onfocus=function(){_this.editNode.setActive()})}this.focusNode=this.editNode;var events=this.events.concat(this.captureEvents),ap=this.iframe?this.document:this.editNode;this.own(array.map(events,function(item){var type=item.toLowerCase().replace(/^on/,"");on(ap,type,lang.hitch(this,item))},this)),this.own(on(ap,"mouseup",lang.hitch(this,"onClick"))),has("ie")?(this.own(on(this.document,"mousedown",lang.hitch(this,"_onIEMouseDown"))),this.editNode.style.zoom=1):this.own(on(this.document,"mousedown",lang.hitch(this,function(){delete this._cursorToStart}))),has("webkit")&&(this._webkitListener=this.own(on(this.document,"mouseup",lang.hitch(this,"onDisplayChanged")))[0],this.own(on(this.document,"mousedown",lang.hitch(this,function(e){var t=e.target;t&&(t===this.document.body||t===this.document)&&this.defer("placeCursorAtEnd")}))));if(has("ie"))try{this.document.execCommand("RespectVisibilityInDesign",!0,null)}catch(e){}this.isLoaded=!0,this.set("disabled",this.disabled);var setContent=lang.hitch(this,function(){this.setValue(html),this.onLoadDeferred&&this.onLoadDeferred.resolve(!0),this.onDisplayChanged(),this.focusOnLoad&&domReady(lang.hitch(this,"defer","focus",this.updateInterval)),this.value=this.getValue(!0)});this.setValueDeferred?this.setValueDeferred.then(setContent):setContent()},onKeyDown:function(e){e.keyCode===keys.TAB&&this.isTabIndent&&(e.stopPropagation(),e.preventDefault(),this.queryCommandEnabled(e.shiftKey?"outdent":"indent")&&this.execCommand(e.shiftKey?"outdent":"indent")),has("ie")&&(e.keyCode==keys.TAB&&!this.isTabIndent?e.shiftKey&&!e.ctrlKey&&!e.altKey?this.iframe.focus():!e.shiftKey&&!e.ctrlKey&&!e.altKey&&this.tabStop.focus():e.keyCode===keys.BACKSPACE&&this.document.selection.type==="Control"&&(e.stopPropagation(),e.preventDefault(),this.execCommand("delete"))),has("ff")&&(e.keyCode===keys.PAGE_UP||e.keyCode===keys.PAGE_DOWN)&&this.editNode.clientHeight>=this.editNode.scrollHeight&&e.preventDefault();var handlers=this._keyHandlers[e.keyCode],args=arguments;return handlers&&!e.altKey&&array.some(handlers,function(h){if(!(h.shift^e.shiftKey)&&!(h.ctrl^(e.ctrlKey||e.metaKey)))return h.handler.apply(this,args)||e.preventDefault(),!0},this),this.defer("onKeyPressed",1),!0},onKeyUp:function(){},setDisabled:function(disabled){kernel.deprecated("dijit.Editor::setDisabled is deprecated",'use dijit.Editor::attr("disabled",boolean) instead',2),this.set("disabled",disabled)},_setValueAttr:function(value){this.setValue(value)},_setDisableSpellCheckAttr:function(disabled){this.document?domAttr.set(this.document.body,"spellcheck",!disabled):this.onLoadDeferred.then(lang.hitch(this,function(){domAttr.set(this.document.body,"spellcheck",!disabled)})),this._set("disableSpellCheck",disabled)},addKeyHandler:function(key,ctrl,shift,handler){typeof key=="string"&&(key=key.toUpperCase().charCodeAt(0)),lang.isArray(this._keyHandlers[key])||(this._keyHandlers[key]=[]),this._keyHandlers[key].push({shift:shift||!1,ctrl:ctrl||!1,handler:handler})},onKeyPressed:function(){this.onDisplayChanged()},onClick:function(e){this.onDisplayChanged(e)},_onIEMouseDown:function(){!this.focused&&!this.disabled&&this.focus()},_onBlur:function(e){this.inherited(arguments);var newValue=this.getValue(!0);newValue!==this.value&&this.onChange(newValue),this._set("value",newValue)},_onFocus:function(e){this.disabled||(this._disabledOK||this.set("disabled",!1),this.inherited(arguments))},blur:function(){!has("ie")&&this.window.document.documentElement&&this.window.document.documentElement.focus?this.window.document.documentElement.focus():this.ownerDocumentBody.focus&&this.ownerDocumentBody.focus()},focus:function(){if(!this.isLoaded){this.focusOnLoad=!0;return}if(this._cursorToStart){delete this._cursorToStart;if(this.editNode.childNodes){this.placeCursorAtStart();return}}has("ie")?this.editNode&&this.editNode.focus&&this.iframe.fireEvent("onfocus",document.createEventObject()):focus.focus(this.iframe)},updateInterval:200,_updateTimer:null,onDisplayChanged:function(){this._updateTimer&&this._updateTimer.remove(),this._updateTimer=this.defer("onNormalizedDisplayChanged",this.updateInterval)},onNormalizedDisplayChanged:function(){delete this._updateTimer},onChange:function(){},_normalizeCommand:function(cmd,argument){var command=cmd.toLowerCase();return command==="formatblock"?has("safari")&&argument===undefined&&(command="heading"):command==="hilitecolor"&&!has("mozilla")&&(command="backcolor"),command},_qcaCache:{},queryCommandAvailable:function(command){var ca=this._qcaCache[command];return ca!==undefined?ca:this._qcaCache[command]=this._queryCommandAvailable(command)},_queryCommandAvailable:function(command){function isSupportedBy(browsers){return{ie:Boolean(browsers&ie),mozilla:Boolean(browsers&mozilla),webkit:Boolean(browsers&webkit),opera:Boolean(browsers&opera)}}var ie=1,mozilla=2,webkit=4,opera=8,supportedBy=null;switch(command.toLowerCase()){case"bold":case"italic":case"underline":case"subscript":case"superscript":case"fontname":case"fontsize":case"forecolor":case"hilitecolor":case"justifycenter":case"justifyfull":case"justifyleft":case"justifyright":case"delete":case"selectall":case"toggledir":supportedBy=isSupportedBy(mozilla|ie|webkit|opera);break;case"createlink":case"unlink":case"removeformat":case"inserthorizontalrule":case"insertimage":case"insertorderedlist":case"insertunorderedlist":case"indent":case"outdent":case"formatblock":case"inserthtml":case"undo":case"redo":case"strikethrough":case"tabindent":supportedBy=isSupportedBy(mozilla|ie|opera|webkit);break;case"blockdirltr":case"blockdirrtl":case"dirltr":case"dirrtl":case"inlinedirltr":case"inlinedirrtl":supportedBy=isSupportedBy(ie);break;case"cut":case"copy":case"paste":supportedBy=isSupportedBy(ie|mozilla|webkit|opera);break;case"inserttable":supportedBy=isSupportedBy(mozilla|ie);break;case"insertcell":case"insertcol":case"insertrow":case"deletecells":case"deletecols":case"deleterows":case"mergecells":case"splitcell":supportedBy=isSupportedBy(ie|mozilla);break;default:return!1}return has("ie")&&supportedBy.ie||has("mozilla")&&supportedBy.mozilla||has("webkit")&&supportedBy.webkit||has("opera")&&supportedBy.opera},execCommand:function(command,argument){var returnValue;this.focus(),command=this._normalizeCommand(command,argument);if(argument!==undefined){if(command==="heading")throw new Error("unimplemented");command==="formatblock"&&has("ie")&&(argument="<"+argument+">")}var implFunc="_"+command+"Impl";if(this[implFunc])returnValue=this[implFunc](argument);else{argument=arguments.length>1?argument:null;if(argument||command!=="createlink")returnValue=this.document.execCommand(command,!1,argument)}return this.onDisplayChanged(),returnValue},queryCommandEnabled:function(command){if(this.disabled||!this._disabledOK)return!1;command=this._normalizeCommand(command);var implFunc="_"+command+"EnabledImpl";return this[implFunc]?this[implFunc](command):this._browserQueryCommandEnabled(command)},queryCommandState:function(command){if(this.disabled||!this._disabledOK)return!1;command=this._normalizeCommand(command);try{return this.document.queryCommandState(command)}catch(e){return!1}},queryCommandValue:function(command){if(this.disabled||!this._disabledOK)return!1;var r;command=this._normalizeCommand(command);if(has("ie")&&command==="formatblock")r=this._native2LocalFormatNames[this.document.queryCommandValue(command)];else if(has("mozilla")&&command==="hilitecolor"){var oldValue;try{oldValue=this.document.queryCommandValue("styleWithCSS")}catch(e){oldValue=!1}this.document.execCommand("styleWithCSS",!1,!0),r=this.document.queryCommandValue(command),this.document.execCommand("styleWithCSS",!1,oldValue)}else r=this.document.queryCommandValue(command);return r},_sCall:function(name,args){return this.selection[name].apply(this.selection,args)},placeCursorAtStart:function(){this.focus();var isvalid=!1;if(has("mozilla")){var first=this.editNode.firstChild;while(first){if(first.nodeType===3){if(first.nodeValue.replace(/^\s+|\s+$/g,"").length>0){isvalid=!0,this.selection.selectElement(first);break}}else if(first.nodeType===1){isvalid=!0;var tg=first.tagName?first.tagName.toLowerCase():"";/br|input|img|base|meta|area|basefont|hr|link/.test(tg)?this.selection.selectElement(first):this.selection.selectElementChildren(first);break}first=first.nextSibling}}else isvalid=!0,this.selection.selectElementChildren(this.editNode);isvalid&&this.selection.collapse(!0)},placeCursorAtEnd:function(){this.focus();var isvalid=!1;if(has("mozilla")){var last=this.editNode.lastChild;while(last){if(last.nodeType===3){if(last.nodeValue.replace(/^\s+|\s+$/g,"").length>0){isvalid=!0,this.selection.selectElement(last);break}}else if(last.nodeType===1){isvalid=!0,this.selection.selectElement(last.lastChild||last);break}last=last.previousSibling}}else isvalid=!0,this.selection.selectElementChildren(this.editNode);isvalid&&this.selection.collapse(!1)},getValue:function(nonDestructive){if(this.textarea)if(this.isClosed||!this.isLoaded)return this.textarea.value;return this._postFilterContent(null,nonDestructive)},_getValueAttr:function(){return this.getValue(!0)},setValue:function(html){if(!this.isLoaded){this.onLoadDeferred.then(lang.hitch(this,function(){this.setValue(html)}));return}this._cursorToStart=!0;if(this.textarea&&(this.isClosed||!this.isLoaded))this.textarea.value=html;else{html=this._preFilterContent(html);var node=this.isClosed?this.domNode:this.editNode;html&&has("mozilla")&&html.toLowerCase()==="<p></p>"&&(html="<p>&#160;</p>"),!html&&has("webkit")&&(html="&#160;"),node.innerHTML=html,this._preDomFilterContent(node)}this.onDisplayChanged(),this._set("value",this.getValue(!0))},replaceValue:function(html){this.isClosed?this.setValue(html):this.window&&this.window.getSelection&&!has("mozilla")?this.setValue(html):this.window&&this.window.getSelection?(html=this._preFilterContent(html),this.execCommand("selectall"),html||(this._cursorToStart=!0,html="&#160;"),this.execCommand("inserthtml",html),this._preDomFilterContent(this.editNode)):this.document&&this.document.selection&&this.setValue(html),this._set("value",this.getValue(!0))},_preFilterContent:function(html){var ec=html;return array.forEach(this.contentPreFilters,function(ef){ef&&(ec=ef(ec))}),ec},_preDomFilterContent:function(dom){dom=dom||this.editNode,array.forEach(this.contentDomPreFilters,function(ef){ef&&lang.isFunction(ef)&&ef(dom)},this)},_postFilterContent:function(dom,nonDestructive){var ec;return lang.isString(dom)?ec=dom:(dom=dom||this.editNode,this.contentDomPostFilters.length&&(nonDestructive&&(dom=lang.clone(dom)),array.forEach(this.contentDomPostFilters,function(ef){dom=ef(dom)})),ec=htmlapi.getChildrenHtml(dom)),lang.trim(ec.replace(/^\xA0\xA0*/,"").replace(/\xA0\xA0*$/,"")).length||(ec=""),array.forEach(this.contentPostFilters,function(ef){ec=ef(ec)}),ec},_saveContent:function(){var saveTextarea=dom.byId(dijit._scopeName+"._editor.RichText.value");saveTextarea&&(saveTextarea.value&&(saveTextarea.value+=this._SEPARATOR),saveTextarea.value+=this.name+this._NAME_CONTENT_SEP+this.getValue(!0))},escapeXml:function(str,noSingleQuotes){return str=str.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;"),noSingleQuotes||(str=str.replace(/'/gm,"&#39;")),str},getNodeHtml:function(node){return kernel.deprecated("dijit.Editor::getNodeHtml is deprecated","use dijit/_editor/html::getNodeHtml instead",2),htmlapi.getNodeHtml(node)},getNodeChildrenHtml:function(dom){return kernel.deprecated("dijit.Editor::getNodeChildrenHtml is deprecated","use dijit/_editor/html::getChildrenHtml instead",2),htmlapi.getChildrenHtml(dom)},close:function(save){if(this.isClosed)return;arguments.length||(save=!0),save&&this._set("value",this.getValue(!0)),this.interval&&clearInterval(this.interval),this._webkitListener&&(this.disconnect(this._webkitListener),delete this._webkitListener),has("ie")&&(this.iframe.onfocus=null),this.iframe._loadFunc=null,this._iframeRegHandle&&(this._iframeRegHandle.remove(),delete this._iframeRegHandle);if(this.textarea){var s=this.textarea.style;s.position="",s.left=s.top="",has("ie")&&(s.overflow=this.__overflow,this.__overflow=null),this.textarea.value=this.value,domConstruct.destroy(this.domNode),this.domNode=this.textarea}else this.domNode.innerHTML=this.value;delete this.iframe,domClass.remove(this.domNode,this.baseClass),this.isClosed=!0,this.isLoaded=!1,delete this.editNode,delete this.focusNode,this.window&&this.window._frameElement&&(this.window._frameElement=null),this.window=null,this.document=null,this.editingArea=null,this.editorObject=null},destroy:function(){this.isClosed||this.close(!1),this._updateTimer&&this._updateTimer.remove(),this.inherited(arguments),RichText._globalSaveHandler&&delete RichText._globalSaveHandler[this.id]},_removeMozBogus:function(html){return html.replace(/\stype="_moz"/gi,"").replace(/\s_moz_dirty=""/gi,"").replace(/_moz_resizing="(true|false)"/gi,"")},_removeWebkitBogus:function(html){return html=html.replace(/\sclass="webkit-block-placeholder"/gi,""),html=html.replace(/\sclass="apple-style-span"/gi,""),html=html.replace(/<meta charset=\"utf-8\" \/>/gi,""),html},_normalizeFontStyle:function(html){return html.replace(/<(\/)?strong([ \>])/gi,"<$1b$2").replace(/<(\/)?em([ \>])/gi,"<$1i$2")},_preFixUrlAttributes:function(html){return html.replace(/(?:(<a(?=\s).*?\shref=)("|')(.*?)\2)|(?:(<a\s.*?href=)([^"'][^ >]+))/gi,"$1$4$2$3$5$2 _djrealurl=$2$3$5$2").replace(/(?:(<img(?=\s).*?\ssrc=)("|')(.*?)\2)|(?:(<img\s.*?src=)([^"'][^ >]+))/gi,"$1$4$2$3$5$2 _djrealurl=$2$3$5$2")},_browserQueryCommandEnabled:function(command){if(!command)return!1;var elem=has("ie")?this.document.selection.createRange():this.document;try{return elem.queryCommandEnabled(command)}catch(e){return!1}},_createlinkEnabledImpl:function(){var enabled=!0;if(has("opera")){var sel=this.window.getSelection();sel.isCollapsed?enabled=!0:enabled=this.document.queryCommandEnabled("createlink")}else enabled=this._browserQueryCommandEnabled("createlink");return enabled},_unlinkEnabledImpl:function(){var enabled=!0;return has("mozilla")||has("webkit")?enabled=this.selection.hasAncestorElement("a"):enabled=this._browserQueryCommandEnabled("unlink"),enabled},_inserttableEnabledImpl:function(){var enabled=!0;return has("mozilla")||has("webkit")?enabled=!0:enabled=this._browserQueryCommandEnabled("inserttable"),enabled},_cutEnabledImpl:function(){var enabled=!0;if(has("webkit")){var sel=this.window.getSelection();sel&&(sel=sel.toString()),enabled=!!sel}else enabled=this._browserQueryCommandEnabled("cut");return enabled},_copyEnabledImpl:function(){var enabled=!0;if(has("webkit")){var sel=this.window.getSelection();sel&&(sel=sel.toString()),enabled=!!sel}else enabled=this._browserQueryCommandEnabled("copy");return enabled},_pasteEnabledImpl:function(){var enabled=!0;return has("webkit")?!0:(enabled=this._browserQueryCommandEnabled("paste"),enabled)},_inserthorizontalruleImpl:function(argument){return has("ie")?this._inserthtmlImpl("<hr>"):this.document.execCommand("inserthorizontalrule",!1,argument)},_unlinkImpl:function(argument){if(this.queryCommandEnabled("unlink")&&(has("mozilla")||has("webkit"))){var a=this.selection.getAncestorElement("a");return this.selection.selectElement(a),this.document.execCommand("unlink",!1,null)}return this.document.execCommand("unlink",!1,argument)},_hilitecolorImpl:function(argument){var returnValue,isApplied=this._handleTextColorOrProperties("hilitecolor",argument);return isApplied||(has("mozilla")?(this.document.execCommand("styleWithCSS",!1,!0),0,returnValue=this.document.execCommand("hilitecolor",!1,argument),this.document.execCommand("styleWithCSS",!1,!1)):returnValue=this.document.execCommand("hilitecolor",!1,argument)),returnValue},_backcolorImpl:function(argument){has("ie")&&(argument=argument?argument:null);var isApplied=this._handleTextColorOrProperties("backcolor",argument);return isApplied||(isApplied=this.document.execCommand("backcolor",!1,argument)),isApplied},_forecolorImpl:function(argument){has("ie")&&(argument=argument?argument:null);var isApplied=!1;return isApplied=this._handleTextColorOrProperties("forecolor",argument),isApplied||(isApplied=this.document.execCommand("forecolor",!1,argument)),isApplied},_inserthtmlImpl:function(argument){argument=this._preFilterContent(argument);var rv=!0;if(has("ie")){var insertRange=this.document.selection.createRange();if(this.document.selection.type.toUpperCase()==="CONTROL"){var n=insertRange.item(0);while(insertRange.length)insertRange.remove(insertRange.item(0));n.outerHTML=argument}else insertRange.pasteHTML(argument);insertRange.select()}else has("mozilla")&&!argument.length?this.selection.remove():rv=this.document.execCommand("inserthtml",!1,argument);return rv},_boldImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("bold")),applied||(applied=this.document.execCommand("bold",!1,argument)),applied},_italicImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("italic")),applied||(applied=this.document.execCommand("italic",!1,argument)),applied},_underlineImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("underline")),applied||(applied=this.document.execCommand("underline",!1,argument)),applied},_strikethroughImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("strikethrough")),applied||(applied=this.document.execCommand("strikethrough",!1,argument)),applied},_superscriptImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("superscript")),applied||(applied=this.document.execCommand("superscript",!1,argument)),applied},_subscriptImpl:function(argument){var applied=!1;return has("ie")&&(this._adaptIESelection(),applied=this._adaptIEFormatAreaAndExec("subscript")),applied||(applied=this.document.execCommand("subscript",!1,argument)),applied},_fontnameImpl:function(argument){var isApplied;return has("ie")&&(isApplied=this._handleTextColorOrProperties("fontname",argument)),isApplied||(isApplied=this.document.execCommand("fontname",!1,argument)),isApplied},_fontsizeImpl:function(argument){var isApplied;return has("ie")&&(isApplied=this._handleTextColorOrProperties("fontsize",argument)),isApplied||(isApplied=this.document.execCommand("fontsize",!1,argument)),isApplied},_insertorderedlistImpl:function(argument){var applied=!1;return has("ie")&&(applied=this._adaptIEList("insertorderedlist",argument)),applied||(applied=this.document.execCommand("insertorderedlist",!1,argument)),applied},_insertunorderedlistImpl:function(argument){var applied=!1;return has("ie")&&(applied=this._adaptIEList("insertunorderedlist",argument)),applied||(applied=this.document.execCommand("insertunorderedlist",!1,argument)),applied},getHeaderHeight:function(){return this._getNodeChildrenHeight(this.header)},getFooterHeight:function(){return this._getNodeChildrenHeight(this.footer)},_getNodeChildrenHeight:function(node){var h=0;if(node&&node.childNodes){var i;for(i=0;i<node.childNodes.length;i++){var size=domGeometry.position(node.childNodes[i]);h+=size.h}}return h},_isNodeEmpty:function(node,startOffset){return node.nodeType===1?node.childNodes.length>0?this._isNodeEmpty(node.childNodes[0],startOffset):!0:node.nodeType===3?node.nodeValue.substring(startOffset)==="":!1},_removeStartingRangeFromRange:function(node,range){if(node.nextSibling)range.setStart(node.nextSibling,0);else{var parent=node.parentNode;while(parent&&parent.nextSibling==null)parent=parent.parentNode;parent&&range.setStart(parent.nextSibling,0)}return range},_adaptIESelection:function(){var selection=rangeapi.getSelection(this.window);if(selection&&selection.rangeCount&&!selection.isCollapsed){var range=selection.getRangeAt(0),firstNode=range.startContainer,startOffset=range.startOffset;while(firstNode.nodeType===3&&startOffset>=firstNode.length&&firstNode.nextSibling)startOffset-=firstNode.length,firstNode=firstNode.nextSibling;var lastNode=null;while(this._isNodeEmpty(firstNode,startOffset)&&firstNode!==lastNode)lastNode=firstNode,range=this._removeStartingRangeFromRange(firstNode,range),firstNode=range.startContainer,startOffset=0;selection.removeAllRanges(),selection.addRange(range)}},_adaptIEFormatAreaAndExec:function(command){var selection=rangeapi.getSelection(this.window),doc=this.document,rs,ret,range,txt,startNode,endNode,breaker,sNode;if(!(command&&selection&&selection.isCollapsed))return!1;var isApplied=this.queryCommandValue(command);if(isApplied){var nNames=this._tagNamesForCommand(command);range=selection.getRangeAt(0);var fs=range.startContainer;if(fs.nodeType===3){var offset=range.endOffset;fs.length<offset&&(ret=this._adjustNodeAndOffset(rs,offset),fs=ret.node,offset=ret.offset)}var topNode;while(fs&&fs!==this.editNode){var tName=fs.tagName?fs.tagName.toLowerCase():"";if(array.indexOf(nNames,tName)>-1){topNode=fs;break}fs=fs.parentNode}if(topNode){rs=range.startContainer;var newblock=doc.createElement(topNode.tagName);domConstruct.place(newblock,topNode,"after");if(rs&&rs.nodeType===3){var nodeToMove,tNode,endOffset=range.endOffset;rs.length<endOffset&&(ret=this._adjustNodeAndOffset(rs,endOffset),rs=ret.node,endOffset=ret.offset),txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,endOffset));var endText=txt.substring(endOffset,txt.length);endText&&(endNode=doc.createTextNode(endText)),domConstruct.place(startNode,rs,"before"),endNode&&(breaker=doc.createElement("span"),breaker.className="ieFormatBreakerSpan",domConstruct.place(breaker,rs,"after"),domConstruct.place(endNode,breaker,"after"),endNode=breaker),domConstruct.destroy(rs);var parentC=startNode.parentNode,tagList=[],tagData;while(parentC!==topNode){var tg=parentC.tagName;tagData={tagName:tg},tagList.push(tagData);var newTg=doc.createElement(tg);parentC.style&&newTg.style&&parentC.style.cssText&&(newTg.style.cssText=parentC.style.cssText,tagData.cssText=parentC.style.cssText),parentC.tagName==="FONT"&&(parentC.color&&(newTg.color=parentC.color,tagData.color=parentC.color),parentC.face&&(newTg.face=parentC.face,tagData.face=parentC.face),parentC.size&&(newTg.size=parentC.size,tagData.size=parentC.size)),parentC.className&&(newTg.className=parentC.className,tagData.className=parentC.className);if(endNode){nodeToMove=endNode;while(nodeToMove)tNode=nodeToMove.nextSibling,newTg.appendChild(nodeToMove),nodeToMove=tNode}newTg.tagName==parentC.tagName?(breaker=doc.createElement("span"),breaker.className="ieFormatBreakerSpan",domConstruct.place(breaker,parentC,"after"),domConstruct.place(newTg,breaker,"after")):domConstruct.place(newTg,parentC,"after"),startNode=parentC,endNode=newTg,parentC=parentC.parentNode}if(endNode){nodeToMove=endNode;if(nodeToMove.nodeType===1||nodeToMove.nodeType===3&&nodeToMove.nodeValue)newblock.innerHTML="";while(nodeToMove)tNode=nodeToMove.nextSibling,newblock.appendChild(nodeToMove),nodeToMove=tNode}var newrange;if(tagList.length){tagData=tagList.pop();var newContTag=doc.createElement(tagData.tagName);tagData.cssText&&newContTag.style&&(newContTag.style.cssText=tagData.cssText),tagData.className&&(newContTag.className=tagData.className),tagData.tagName==="FONT"&&(tagData.color&&(newContTag.color=tagData.color),tagData.face&&(newContTag.face=tagData.face),tagData.size&&(newContTag.size=tagData.size)),domConstruct.place(newContTag,newblock,"before");while(tagList.length){tagData=tagList.pop();var newTgNode=doc.createElement(tagData.tagName);tagData.cssText&&newTgNode.style&&(newTgNode.style.cssText=tagData.cssText),tagData.className&&(newTgNode.className=tagData.className),tagData.tagName==="FONT"&&(tagData.color&&(newTgNode.color=tagData.color),tagData.face&&(newTgNode.face=tagData.face),tagData.size&&(newTgNode.size=tagData.size)),newContTag.appendChild(newTgNode),newContTag=newTgNode}sNode=doc.createTextNode("."),breaker.appendChild(sNode),newContTag.appendChild(sNode),newrange=rangeapi.create(this.window),newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange),this.selection.collapse(!1),sNode.parentNode.innerHTML=""}else breaker=doc.createElement("span"),breaker.className="ieFormatBreakerSpan",sNode=doc.createTextNode("."),breaker.appendChild(sNode),domConstruct.place(breaker,newblock,"before"),newrange=rangeapi.create(this.window),newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange),this.selection.collapse(!1),sNode.parentNode.innerHTML="";return newblock.firstChild||domConstruct.destroy(newblock),!0}}return!1}range=selection.getRangeAt(0),rs=range.startContainer;if(rs&&rs.nodeType===3){var offset=range.startOffset;rs.length<offset&&(ret=this._adjustNodeAndOffset(rs,offset),rs=ret.node,offset=ret.offset),txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,offset));var endText=txt.substring(offset);endText!==""&&(endNode=doc.createTextNode(txt.substring(offset))),breaker=doc.createElement("span"),sNode=doc.createTextNode("."),breaker.appendChild(sNode),startNode.length?domConstruct.place(startNode,rs,"after"):startNode=rs,domConstruct.place(breaker,startNode,"after"),endNode&&domConstruct.place(endNode,breaker,"after"),domConstruct.destroy(rs);var newrange=rangeapi.create(this.window);return newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange),doc.execCommand(command),domConstruct.place(breaker.firstChild,breaker,"before"),domConstruct.destroy(breaker),newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange),this.selection.collapse(!1),sNode.parentNode.innerHTML="",!0}},_adaptIEList:function(command){var selection=rangeapi.getSelection(this.window);if(selection.isCollapsed&&selection.rangeCount&&!this.queryCommandValue(command)){var range=selection.getRangeAt(0),sc=range.startContainer;if(sc&&sc.nodeType==3&&!range.startOffset){var lType="ul";command==="insertorderedlist"&&(lType="ol");var list=this.document.createElement(lType),li=domConstruct.create("li",null,list);domConstruct.place(list,sc,"before"),li.appendChild(sc),domConstruct.create("br",null,list,"after");var newrange=rangeapi.create(this.window);return newrange.setStart(sc,0),newrange.setEnd(sc,sc.length),selection.removeAllRanges(),selection.addRange(newrange),this.selection.collapse(!0),!0}}return!1},_handleTextColorOrProperties:function(command,argument){var selection=rangeapi.getSelection(this.window),doc=this.document,rs,ret,range,txt,startNode,endNode,breaker,sNode;argument=argument||null;if(command&&selection&&selection.isCollapsed&&selection.rangeCount){range=selection.getRangeAt(0),rs=range.startContainer;if(rs&&rs.nodeType===3){var offset=range.startOffset;rs.length<offset&&(ret=this._adjustNodeAndOffset(rs,offset),rs=ret.node,offset=ret.offset),txt=rs.nodeValue,startNode=doc.createTextNode(txt.substring(0,offset));var endText=txt.substring(offset);endText!==""&&(endNode=doc.createTextNode(txt.substring(offset))),breaker=doc.createElement("span"),sNode=doc.createTextNode("."),breaker.appendChild(sNode);var extraSpan=doc.createElement("span");breaker.appendChild(extraSpan),startNode.length?domConstruct.place(startNode,rs,"after"):startNode=rs,domConstruct.place(breaker,startNode,"after"),endNode&&domConstruct.place(endNode,breaker,"after"),domConstruct.destroy(rs);var newrange=rangeapi.create(this.window);newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange);if(has("webkit")){var style="color";if(command==="hilitecolor"||command==="backcolor")style="backgroundColor";domStyle.set(breaker,style,argument),this.selection.remove(),domConstruct.destroy(extraSpan),breaker.innerHTML="&#160;",this.selection.selectElement(breaker),this.focus()}else this.execCommand(command,argument),domConstruct.place(breaker.firstChild,breaker,"before"),domConstruct.destroy(breaker),newrange.setStart(sNode,0),newrange.setEnd(sNode,sNode.length),selection.removeAllRanges(),selection.addRange(newrange),this.selection.collapse(!1),sNode.parentNode.removeChild(sNode);return!0}}return!1},_adjustNodeAndOffset:function(node,offset){while(node.length<offset&&node.nextSibling&&node.nextSibling.nodeType===3)offset-=node.length,node=node.nextSibling;return{node:node,offset:offset}},_tagNamesForCommand:function(command){return command==="bold"?["b","strong"]:command==="italic"?["i","em"]:command==="strikethrough"?["s","strike"]:command==="superscript"?["sup"]:command==="subscript"?["sub"]:command==="underline"?["u"]:[]},_stripBreakerNodes:function(node){if(!this.isLoaded)return;return query(".ieFormatBreakerSpan",node).forEach(function(b){while(b.firstChild)domConstruct.place(b.firstChild,b,"before");domConstruct.destroy(b)}),node}});return RichText})