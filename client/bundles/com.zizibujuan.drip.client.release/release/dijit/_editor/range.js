//>>built
define("dijit/_editor/range",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang"],function(array,declare,lang){var rangeapi={getIndex:function(node,parent){var ret=[],retR=[],onode=node,pnode,n;while(node!=parent){var i=0;pnode=node.parentNode;while(n=pnode.childNodes[i++])if(n===node){--i;break}ret.unshift(i),retR.unshift(i-pnode.childNodes.length),node=pnode}if(ret.length>0&&onode.nodeType==3){n=onode.previousSibling;while(n&&n.nodeType==3)ret[ret.length-1]--,n=n.previousSibling;n=onode.nextSibling;while(n&&n.nodeType==3)retR[retR.length-1]++,n=n.nextSibling}return{o:ret,r:retR}},getNode:function(index,parent){if(!lang.isArray(index)||index.length==0)return parent;var node=parent;return array.every(index,function(i){return i>=0&&i<node.childNodes.length?(node=node.childNodes[i],!0):(node=null,!1)}),node},getCommonAncestor:function(n1,n2,root){root=root||n1.ownerDocument.body;var getAncestors=function(n){var as=[];while(n){as.unshift(n);if(n===root)break;n=n.parentNode}return as},n1as=getAncestors(n1),n2as=getAncestors(n2),m=Math.min(n1as.length,n2as.length),com=n1as[0];for(var i=1;i<m;i++){if(n1as[i]!==n2as[i])break;com=n1as[i]}return com},getAncestor:function(node,regex,root){root=root||node.ownerDocument.body;while(node&&node!==root){var name=node.nodeName.toUpperCase();if(regex.test(name))return node;node=node.parentNode}return null},BlockTagNames:/^(?:P|DIV|H1|H2|H3|H4|H5|H6|ADDRESS|PRE|OL|UL|LI|DT|DE)$/,getBlockAncestor:function(node,regex,root){root=root||node.ownerDocument.body,regex=regex||rangeapi.BlockTagNames;var block=null,blockContainer;while(node&&node!==root){var name=node.nodeName.toUpperCase();!block&&regex.test(name)&&(block=node),!blockContainer&&/^(?:BODY|TD|TH|CAPTION)$/.test(name)&&(blockContainer=node),node=node.parentNode}return{blockNode:block,blockContainer:blockContainer||node.ownerDocument.body}},atBeginningOfContainer:function(container,node,offset){var atBeginning=!1,offsetAtBeginning=offset==0;!offsetAtBeginning&&node.nodeType==3&&/^[\s\xA0]+$/.test(node.nodeValue.substr(0,offset))&&(offsetAtBeginning=!0);if(offsetAtBeginning){var cnode=node;atBeginning=!0;while(cnode&&cnode!==container){if(cnode.previousSibling){atBeginning=!1;break}cnode=cnode.parentNode}}return atBeginning},atEndOfContainer:function(container,node,offset){var atEnd=!1,offsetAtEnd=offset==(node.length||node.childNodes.length);!offsetAtEnd&&node.nodeType==3&&/^[\s\xA0]+$/.test(node.nodeValue.substr(offset))&&(offsetAtEnd=!0);if(offsetAtEnd){var cnode=node;atEnd=!0;while(cnode&&cnode!==container){if(cnode.nextSibling){atEnd=!1;break}cnode=cnode.parentNode}}return atEnd},adjacentNoneTextNode:function(startnode,next){var node=startnode,len=0-startnode.length||0,prop=next?"nextSibling":"previousSibling";while(node){if(node.nodeType!=3)break;len+=node.length,node=node[prop]}return[node,len]},create:function(win){return win=win||window,win.getSelection?win.document.createRange():new W3CRange},getSelection:function(window,ignoreUpdate){if(window.getSelection)return window.getSelection();var s=new ie.selection(window);return ignoreUpdate||s._getCurrentSelection(),s}};if(!window.getSelection)var ie=rangeapi.ie={cachedSelection:{},selection:function(window){this._ranges=[],this.addRange=function(r,internal){this._ranges.push(r),internal||r._select(),this.rangeCount=this._ranges.length},this.removeAllRanges=function(){this._ranges=[],this.rangeCount=0};var _initCurrentRange=function(){var r=window.document.selection.createRange(),type=window.document.selection.type.toUpperCase();return type=="CONTROL"?new W3CRange(ie.decomposeControlRange(r)):new W3CRange(ie.decomposeTextRange(r))};this.getRangeAt=function(i){return this._ranges[i]},this._getCurrentSelection=function(){this.removeAllRanges();var r=_initCurrentRange();r?(this.addRange(r,!0),this.isCollapsed=r.collapsed):this.isCollapsed=!0}},decomposeControlRange:function(range){var firstnode=range.item(0),lastnode=range.item(range.length-1),startContainer=firstnode.parentNode,endContainer=lastnode.parentNode,startOffset=rangeapi.getIndex(firstnode,startContainer).o[0],endOffset=rangeapi.getIndex(lastnode,endContainer).o[0]+1;return[startContainer,startOffset,endContainer,endOffset]},getEndPoint:function(range,end){var atmrange=range.duplicate();atmrange.collapse(!end);var cmpstr="EndTo"+(end?"End":"Start"),parentNode=atmrange.parentElement(),startnode,startOffset,lastNode;parentNode.childNodes.length>0?array.every(parentNode.childNodes,function(node,i){var calOffset;if(node.nodeType!=3){atmrange.moveToElementText(node);if(atmrange.compareEndPoints(cmpstr,range)>0){if(!lastNode||lastNode.nodeType!=3)return startnode=parentNode,startOffset=i,!1;startnode=lastNode,calOffset=!0}else if(i==parentNode.childNodes.length-1)return startnode=parentNode,startOffset=parentNode.childNodes.length,!1}else i==parentNode.childNodes.length-1&&(startnode=node,calOffset=!0);if(calOffset&&startnode){var prevnode=rangeapi.adjacentNoneTextNode(startnode)[0];prevnode?startnode=prevnode.nextSibling:startnode=parentNode.firstChild;var prevnodeobj=rangeapi.adjacentNoneTextNode(startnode);prevnode=prevnodeobj[0];var lenoffset=prevnodeobj[1];return prevnode?(atmrange.moveToElementText(prevnode),atmrange.collapse(!1)):atmrange.moveToElementText(parentNode),atmrange.setEndPoint(cmpstr,range),startOffset=atmrange.text.length-lenoffset,!1}return lastNode=node,!0}):(startnode=parentNode,startOffset=0);if(!end&&startnode.nodeType==1&&startOffset==startnode.childNodes.length){var nextnode=startnode.nextSibling;nextnode&&nextnode.nodeType==3&&(startnode=nextnode,startOffset=0)}return[startnode,startOffset]},setEndPoint:function(range,container,offset){var atmrange=range.duplicate(),node,len;if(container.nodeType!=3)if(offset>0){node=container.childNodes[offset-1];if(node)if(node.nodeType==3)container=node,offset=node.length;else if(node.nextSibling&&node.nextSibling.nodeType==3)container=node.nextSibling,offset=0;else{atmrange.moveToElementText(node.nextSibling?node:container);var parent=node.parentNode,tempNode=parent.insertBefore(node.ownerDocument.createTextNode(" "),node.nextSibling);atmrange.collapse(!1),parent.removeChild(tempNode)}}else atmrange.moveToElementText(container),atmrange.collapse(!0);if(container.nodeType==3){var prevnodeobj=rangeapi.adjacentNoneTextNode(container),prevnode=prevnodeobj[0];len=prevnodeobj[1],prevnode?(atmrange.moveToElementText(prevnode),atmrange.collapse(!1),prevnode.contentEditable!="inherit"&&len++):(atmrange.moveToElementText(container.parentNode),atmrange.collapse(!0),atmrange.move("character",1),atmrange.move("character",-1)),offset+=len,offset>0&&atmrange.move("character",offset)!=offset&&0}return atmrange},decomposeTextRange:function(range){var tmpary=ie.getEndPoint(range),startContainer=tmpary[0],startOffset=tmpary[1],endContainer=tmpary[0],endOffset=tmpary[1];return range.htmlText.length&&(range.htmlText==range.text?endOffset=startOffset+range.text.length:(tmpary=ie.getEndPoint(range,!0),endContainer=tmpary[0],endOffset=tmpary[1])),[startContainer,startOffset,endContainer,endOffset]},setRange:function(range,startContainer,startOffset,endContainer,endOffset,collapsed){var start=ie.setEndPoint(range,startContainer,startOffset);range.setEndPoint("StartToStart",start);if(!collapsed)var end=ie.setEndPoint(range,endContainer,endOffset);return range.setEndPoint("EndToEnd",end||start),range}},W3CRange=rangeapi.W3CRange=declare(null,{constructor:function(){arguments.length>0?(this.setStart(arguments[0][0],arguments[0][1]),this.setEnd(arguments[0][2],arguments[0][3])):(this.commonAncestorContainer=null,this.startContainer=null,this.startOffset=0,this.endContainer=null,this.endOffset=0,this.collapsed=!0)},_updateInternal:function(){this.startContainer!==this.endContainer?this.commonAncestorContainer=rangeapi.getCommonAncestor(this.startContainer,this.endContainer):this.commonAncestorContainer=this.startContainer,this.collapsed=this.startContainer===this.endContainer&&this.startOffset==this.endOffset},setStart:function(node,offset){offset=parseInt(offset);if(this.startContainer===node&&this.startOffset==offset)return;delete this._cachedBookmark,this.startContainer=node,this.startOffset=offset,this.endContainer?this._updateInternal():this.setEnd(node,offset)},setEnd:function(node,offset){offset=parseInt(offset);if(this.endContainer===node&&this.endOffset==offset)return;delete this._cachedBookmark,this.endContainer=node,this.endOffset=offset,this.startContainer?this._updateInternal():this.setStart(node,offset)},setStartAfter:function(node,offset){this._setPoint("setStart",node,offset,1)},setStartBefore:function(node,offset){this._setPoint("setStart",node,offset,0)},setEndAfter:function(node,offset){this._setPoint("setEnd",node,offset,1)},setEndBefore:function(node,offset){this._setPoint("setEnd",node,offset,0)},_setPoint:function(what,node,offset,ext){var index=rangeapi.getIndex(node,node.parentNode).o;this[what](node.parentNode,index.pop()+ext)},_getIERange:function(){var r=(this._body||this.endContainer.ownerDocument.body).createTextRange();return ie.setRange(r,this.startContainer,this.startOffset,this.endContainer,this.endOffset,this.collapsed),r},getBookmark:function(){return this._getIERange(),this._cachedBookmark},_select:function(){var r=this._getIERange();r.select()},deleteContents:function(){var s=this.startContainer,r=this._getIERange();s.nodeType===3&&!this.startOffset&&this.setStartBefore(s),r.pasteHTML(""),this.endContainer=this.startContainer,this.endOffset=this.startOffset,this.collapsed=!0},cloneRange:function(){var r=new W3CRange([this.startContainer,this.startOffset,this.endContainer,this.endOffset]);return r._body=this._body,r},detach:function(){this._body=null,this.commonAncestorContainer=null,this.startContainer=null,this.startOffset=0,this.endContainer=null,this.endOffset=0,this.collapsed=!0}});return lang.setObject("dijit.range",rangeapi),rangeapi})