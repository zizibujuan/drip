//>>built
define("dijit/form/_SearchMixin",["dojo/_base/declare","dojo/keys","dojo/_base/lang","dojo/query","dojo/string","dojo/when","../registry"],function(declare,keys,lang,query,string,when,registry){return declare("dijit.form._SearchMixin",null,{pageSize:Infinity,store:null,fetchProperties:{},query:{},searchDelay:200,searchAttr:"name",queryExpr:"${0}*",ignoreCase:!0,_patternToRegExp:function(pattern){return new RegExp("^"+pattern.replace(/(\\.)|(\*)|(\?)|\W/g,function(str,literal,star,question){return star?".*":question?".":literal?literal:"\\"+str})+"$",this.ignoreCase?"mi":"m")},_abortQuery:function(){this.searchTimer&&(this.searchTimer=this.searchTimer.remove()),this._queryDeferHandle&&(this._queryDeferHandle=this._queryDeferHandle.remove()),this._fetchHandle&&(this._fetchHandle.abort&&(this._cancelingQuery=!0,this._fetchHandle.abort(),this._cancelingQuery=!1),this._fetchHandle.cancel&&(this._cancelingQuery=!0,this._fetchHandle.cancel(),this._cancelingQuery=!1),this._fetchHandle=null)},_processInput:function(evt){if(this.disabled||this.readOnly)return;var key=evt.charOrCode;if(evt.type.substring(0,3)=="key"&&(evt.altKey||(evt.ctrlKey||evt.metaKey)&&key!="x"&&key!="v"||key==keys.SHIFT))return;var doSearch=!1;this._prev_key_backspace=!1;switch(key){case keys.DELETE:case keys.BACKSPACE:this._prev_key_backspace=!0,this._maskValidSubsetError=!0,doSearch=!0;break;default:doSearch=typeof key=="string"||key==229}doSearch&&(this.store?this.searchTimer=this.defer("_startSearchFromInput",1):this.onSearch())},onSearch:function(){},_startSearchFromInput:function(){this._startSearch(this.focusNode.value.replace(/([\\\*\?])/g,"\\$1"))},_startSearch:function(text){this._abortQuery();var _this=this,query=lang.clone(this.query),options={start:0,count:this.pageSize,queryOptions:{ignoreCase:this.ignoreCase,deep:!0}},qs=string.substitute(this.queryExpr,[text]),q,startQuery=function(){var resPromise=_this._fetchHandle=_this.store.query(query,options);if(_this.disabled||_this.readOnly||q!==_this._lastQuery)return;when(resPromise,function(res){_this._fetchHandle=null,!_this.disabled&&!_this.readOnly&&q===_this._lastQuery&&when(resPromise.total,function(total){res.total=total;var pageSize=_this.pageSize;if(isNaN(pageSize)||pageSize>res.total)pageSize=res.total;res.nextPage=function(direction){options.direction=direction=direction!==!1,options.count=pageSize,direction?(options.start+=res.length,options.start>=res.total&&(options.count=0)):(options.start-=pageSize,options.start<0&&(options.count=Math.max(pageSize+options.start,0),options.start=0)),options.count<=0?(res.length=0,_this.onSearch(res,query,options)):startQuery()},_this.onSearch(res,query,options)})},function(err){_this._fetchHandle=null,_this._cancelingQuery||0})};lang.mixin(options,this.fetchProperties),this.store._oldAPI?q=qs:(q=this._patternToRegExp(qs),q.toString=function(){return qs}),this._lastQuery=query[this.searchAttr]=q,this._queryDeferHandle=this.defer(startQuery,this.searchDelay)},constructor:function(){this.query={},this.fetchProperties={}},postMixInProperties:function(){if(!this.store){var list=this.list;list&&(this.store=registry.byId(list))}this.inherited(arguments)}})})