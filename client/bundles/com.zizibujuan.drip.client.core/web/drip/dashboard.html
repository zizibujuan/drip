<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link type="text/css" rel="stylesheet" href="/drip/resources/app.css" />
<link type="text/css" rel="stylesheet" href="/drip/resources/font-awesome/css/font-awesome.css" />
<title>我的首页 孜孜不倦 · 协作写笔记，快乐做习题。</title>
<script type="text/javascript" 
	data-dojo-config="
		async:true,
		parseOnLoad:false,
		isDebug:true" 
	src="/dojo/dojo.js"></script>
<script type="text/javascript" src="drip/renren.js"></script>
<script type="text/javascript">
require(["dojo/ready",
         "dojo/_base/event",
         "dojo/_base/array",
		 "dojo/on",
         "dojo/dom",
         "dojo/dom-class",
         "dojo/dom-construct",
         "dojo/request/xhr",
         "dojo/store/JsonRest",
         "dijit/registry",
         "drip/widget/Header",
         "drip/user",
         "drip/Activity",
         "dojo/domReady!"],function(
        		 ready,
        		 event,
        		 array,
        		 on,
        		 dom,
        		 domClass,
        		 domConstruct,
        		 xhr,
        		 JsonRest,
        		 registry,
        		 Header,
        		 user){
	var header = new Header({}, "header");
	
	// 加载左侧栏目中的数据，因为左侧没有用dijit部件，所无需放在ready方法中
	user.getLoggedUserInfo().then(function(userInfo){
		console.log("登录用户信息:", userInfo);
		// 在右侧用户信息区域显示
		var profileImg = dom.byId("profileImage");
		var displayName = userInfo.nickName;
		profileImg.alt = displayName;
		profileImg.src = userInfo.largeImageUrl || "/drip/resources/images/profile_180_180.gif";
		dom.byId("userName").innerHTML = displayName;
		
		
		// 在关注和粉丝的链接上加上登录者的用户标识
		// 切记：出现在rest链接中的，只能是本地用户标识，而不是第三方网站或映射用户标识
		dom.byId("following_link").href = "/following/" + userInfo.digitalId;
		dom.byId("follower_link").href = "/followers/" + userInfo.digitalId;
		
	});
	
	user.getLoggedUserStatistics().then(function(statistics){
		dom.byId("follow_count").innerHTML = statistics.followCount;
		dom.byId("fan_count").innerHTML = statistics.fanCount;
		// 在页面顶级tab中显示
		dom.byId("my_answer_count").innerHTML = statistics.answerCount;
		dom.byId("my_exer_count").innerHTML = statistics.exerciseCount;
	});
	
	var store = new JsonRest({
		 target:"/activities/"
	 });
	
	var followingNoDataMessage = "没有活动，快去录入新题目，或到题库中解答习题";
	var myAnswerNoDataMessage = "还没有回答问题，快到题库中解答习题";
	var myExerciseNoDataMessage = "您还没有录入过习题，快去录入新题目";
	
	var activities = new Activity({
		store: store,
		query: {type:"following"},
		// <i class="icon-spinner icon-spin icon-large"></i>
		loadingMessage:"<i class=\"icon-refresh icon-spin icon-large\"></i>  加载中...", 
		noDataMessage:followingNoDataMessage
	});
	activities.placeAt("activitiesContainer");
	
	var following = dom.byId("following");
	var myAnswer = dom.byId("myAnswer");
	var myExercise = dom.byId("myExercise");
	
	// 两个动作，一个是刷新，一个是切换。
	// 都使用一个store，然后传入不同的条件刷新
	on(following, "click", function(e){
		event.stop(e);
		if(!domClass.contains(following,"selected")){
			domClass.add(following,"selected");
			// TODO:如何刷新tab上的统计数据呢？
			// 或者在这个界面上有一个增加统计值的操作，就触发一个时间，从后台刷新一下，或者在前台更新一下
			// 而不在切换时刷新。
			activities.noDataMessage = followingNoDataMessage;
			activities.setQuery({type:"following"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(myAnswer, "selected");
		domClass.remove(myExercise, "selected");
		
		
	});
	
	on(myAnswer, "click", function(e){
		event.stop(e);
		if(!domClass.contains(myAnswer,"selected")){
			domClass.add(myAnswer,"selected");
			
			activities.noDataMessage = myAnswerNoDataMessage;
			activities.setQuery({type:"myAnswer"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(following, "selected");
		domClass.remove(myExercise, "selected");
	});
	
	on(myExercise, "click", function(e){
		event.stop(e);
		if(!domClass.contains(myExercise,"selected")){
			domClass.add(myExercise,"selected");
			
			activities.noDataMessage = myExerciseNoDataMessage;
			activities.setQuery({type:"myExercise"});
		}else{
			// 刷新
			activities.setQuery();
		}
		domClass.remove(following, "selected");
		domClass.remove(myAnswer, "selected");
	});
	
	
	// 加载登录用户发起的项目列表
	// 如果没有传递用户信息，则获取登录用户的项目列表
	var projectList = dom.byId("my_project_list");
	xhr.get("/projects/",{handleAs:"json"}).then(function(data){
		if(data.length == 0){
			projectList.innerHTML = "您还没有发起项目";
		}else{
			array.forEach(data, function(item, index){
				var li = domConstruct.create("li", null, projectList);
				var projectUrl = "/projects/" + item.createUserName + "/" + item.name;
				var a = domConstruct.create("a", {href: projectUrl}, li);
				domConstruct.create("span", {innerHTML: item.createUserName}, a);
				var textNode = document.createTextNode("/");
				a.appendChild(textNode);
				domConstruct.create("span", {innerHTML: item.name}, a);
			});
			
		}
	}, function(error){
		
	});
	
	ready(function(){
		/*
		var btnNewExercise = registry.byId("btnNewExercise");
		btnNewExercise.on("click",function(e){
			window.location.href = "/exercises/new";
		});
		
		// 进入题库页面
		registry.byId("btnExercises").on("click", function(e){
			window.location.href = "/exercises";
		});
		*/
	});
});
</script>

<script type="text/javascript">
function sendRenrenRequest(){
	var uiOptions = {
		url: "request",
		display: "popup",
		params: { // TODO：这里的文本需要反复优化
			"accept_url":"http://www.zizibujuan.com/login/renren",// 接受邀请按钮url
			"accept_label":"好的,一起学习",//接受文本
			"redirect_uri":"http://www.zizibujuan.com/drip/closeRenrenInviteWindow.html",// 点击确定或取消后跳转的url,需要在这个url中在drip中保存数据。 TODO
			"actiontext":"邀请好友一起学习",// 好友喊你来学习
			"selector_mode":"1",//2,3
			"app_msg":"孜孜不倦诚邀您与大家一起学习",
			"send_btn_label":"邀请"
		},
		//access_token	
		onSuccess: function(a,b,c){
			console.log(a,b,c);
		},
		onFailure: function(a,b,c){
			console.log(a,b,c);
		}
	};
	Renren.ui(uiOptions);
}
</script>
 
</head>
<body  class="claro">
<script type="text/javascript">
	/* TODO：appId不能在这里硬编码*/
	Renren.init({appId:220706});
</script>

<div id="wrapper" class="drip_body">
	<div id="header" style="min-height:43px"></div>
	<div class="pageHeader clearfix ">
		<!-- 放置操作按钮 -->
		<div class="container">

				<ul class="pageHeader-actions">

					<li>
						<!-- FIXME：需要提供选择项目的选项，将最近使用的项目放在最上面 -->
						<a class="minibutton" href="#">写笔记</a>
					</li>

					<li>
					<!-- 录入习题 
							<li><a  class="minibutton primary"><i class="icon-edit"></i> 录入习题</a></li>
					-->
						<a href="/exercises/new" title="录入新习题" class="minibutton"></i> 录数学题</a>
					</li>


				</ul>














			</div>
	</div>
	<div class="container">
		<div>
			<div class="drip_main">
				<div class="clearfix">
						<div class="drip_main_center">
							<!-- 个人首页的链接tab -->
							<div class="drip_tab_nav">
								<ul class="drip_tab_nav_tabs">
									<li>
										<a href="#" id="following" class="selected drip_tab_nav_tab">好友动态</a>
									</li>
									<li>
										<a href="#" id="myAnswer" class="drip_tab_nav_tab">我答的习题 <span class="counter" id="my_answer_count">0</span></a>
									</li>
									<li>
										<a href="#" id="myExercise" class="drip_tab_nav_tab">我录的习题 <span class="counter" id="my_exer_count">0</span></a>
									</li>
									<!-- 添加一个我的作业 -->
								</ul>
							</div>
							<div id="activitiesContainer" class="drip_activity_list" style="padding-top:20px">
								
							</div>
						</div>
						<div class="drip_main_right">
							<div style="padding-left:20px">
								<div class="profile" style="margin-top: 10px;">
							 		<div class="clearfix">
							 			<div style="float:left">
							 				<a id="largeImageLink" href="#">
							 					<img id="profileImage" width="80px" height="80px">
							 				</a>
							 			</div>
							 			<div style="padding-left: 10px; padding-top: 5px;float:left">
							 				<a style="font-size: 14px; font-weight: bold;text-decoration: none;color: #333" id="userName"></a>
							 				<div>
							 				</div>
							 			</div>
							 		</div>
							 		<div class="clearfix">
							 			<ul style="list-style: none;padding-left: 0px; margin-top: 20px">
											<li style="float:left">
												<a href="#" id="following_link" style="text-decoration: none;color:#333">
												<strong id="follow_count" style="display:block;font-size: 20px"></strong>
												<span style="display: block;text-align: center;">关注</span>
												</a>
											</li>
											<li style="float:left; margin-left: 10px;">
												<a href="#" id="follower_link" style="text-decoration: none;color:#333">
													<strong id="fan_count" style="display:block;font-size: 20px"></strong>
													<span style="display: block;text-align: center;">粉丝</span>
												</a>
											</li>
										</ul>
							 		</div>
								 </div>
							 	<div style="margin-top: 20px;">
							 		<!-- 根据第三方网站用户的来源，显示不同的邀请文本 -->
							 		<!-- 
							 		<button class="minibutton" onclick="sendRenrenRequest();"><i class="icon-bullhorn icon-large"></i> 邀请人人好友一起学习</button>
							 		 -->
							 	</div>
							 	
							 	<div class="box box-small">
							 		<div class="box-header">
							 			<a href="/projects/new" class="minibutton primary new-project">发起新项目</a>
							 			<h3 class="box-title">我的项目</h3>
							 		</div>
							 		<div class="box-body">
							 			<ul class="project-list" id="my_project_list"></ul>
							 		</div>
							 	</div>
							</div>
						</div>
					
				</div>
				
			</div>
		</div>
	</div>
	
	<div class="footer">footer</div>
</div>

<script type="text/javascript" defer="defer"
   src="/mathJax/MathJax.js?config=MML_HTMLorMML">
</script>
</body>
</html>










<!-- 在弹出的个人介绍中，加“来自人人”标识 -->





